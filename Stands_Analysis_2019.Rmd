---
title: "Stands_data"
author: "Zhehan"
date: "February 10, 2020"
output: html_document
---

#Package
```{r}
library(sjPlot)
library(psycho)
library(corrplot)
library(Hmisc)
library(ggpubr)
library(PerformanceAnalytics)
library(RColorBrewer)
library(ggplot2)
library(ggsci)
library(ggthemes)
library(dplyr)
library(lubridate)
library(RColorBrewer)
library(wesanderson)
library(tidyr)
library(reshape2)
library(gridExtra)
library(GeoLight)
library(raster)
library(readxl)
library(zoo)
library(oce)
library(lme4)
library(rstatix)
library(broom)
```


#Read data
```{r}
path_stands <- "C:/Users/zt92/Box Sync/BIOSTIMULANT TRIAL - SEASON 2/ZHEHAN/Stands"
gs <- read.csv(file.path(path_stands, "S.STANDS.csv"))

str(gs)
names(gs)

#cleaning
names(gs)[3] <- "TIMESTAMP"
gs$TIMESTAMP <- as.POSIXct(gs$TIMESTAMP, format = "%m/%d/%Y %H:%M")

#calculate reflectance
gs <- gs %>% mutate(R532 = X532OUT/X532IN)
gs <- gs %>% mutate(R570 = X570OUT/X570IN)
gs <- gs %>% mutate(R650 = X650OUT/X650IN)
gs <- gs %>% mutate(R810 = X810OUT/X810IN)
#calculate PRI and NDVI
gs <- gs %>% mutate(PRI = (R532-R570)/(R532+R570))
gs <- gs %>% mutate(NDVI = (R810-R650)/(R810+R650))
#Add date and huor
gs <- gs %>% mutate(Date = lubridate::date(TIMESTAMP))
gs <- gs %>% mutate(Time = lubridate::hour(TIMESTAMP)+minute(TIMESTAMP)/60+second(TIMESTAMP)/3600)
#Add ID 
gs <- gs %>% mutate(ID = paste(BLOCK, TREATMENT, by = " "))
#remove the first and last day 
gs <- subset(gs, Date >= "2019-05-11" & Date <= "2019-09-04")
gs <- subset(gs, Time >= 7 & Time <= 20)
```

#Function to select only noon time 
```{r}
noon_selection <- function(data, early, late){
  data_noon <- data[data$Time >= early & data$Time <= late,]
  return(data_noon)
}
date_selection <- function(data, begin, end){
  data_date_selection <- data[data$Date >= begin & data$Date <= end,]
  return(data_date_selection)
}
```

#Weather data
##Read weather data
```{r}
path_stands <- "C:/Users/zt92/Box Sync/BIOSTIMULANT TRIAL - SEASON 2/ZHEHAN/Stands"
weather <- read.csv(file.path(path_stands, "S.WEATHER.csv"))
head(weather)
names(weather)[1] <- "TIMESTAMP"
weather$TIMESTAMP <- as.POSIXct(weather$TIMESTAMP, format = "%m/%d/%Y %H:%M")
names(weather)

#subset columns
weather <- weather[,c("TIMESTAMP","RADIATION.WM2","AIR.TEMP.CELSIUS","VPD.KPA")]
names(weather) <- c("TIMESTAMP","Radiation","AirTemp","VPD")
unique(date(weather$TIMESTAMP))
hist(weather$Radiation)
hist(weather$AirTemp)
hist(weather$VPD)
#subset dates
weather <- weather %>% mutate(Date = date(TIMESTAMP) ,Time=lubridate::hour(TIMESTAMP)+minute(TIMESTAMP)/60+second(TIMESTAMP)/3600)
weather <- subset(weather,Date >= "2019-05-11" & Date <= "2019-09-04")
sort(unique(weather$Date))



weather_day <- subset(weather, Time >= 7 & Time <=20) 
dim(weather_day) #=18369*6

temp_ls <- split(gs, gs$ID)
length(temp_ls)
for(i in 1:length(temp_ls)){
  temp_ls[[i]] <- merge(temp_ls[[i]], weather_day[,c("TIMESTAMP","Radiation","AirTemp","VPD")], by = "TIMESTAMP", all.y = TRUE)
}
gssb <- do.call(rbind, temp_ls)
dim(gssb) #=183690*32


#calculate PAR_SR
gssb$PAR_SR <- gssb$Radiation*0.5
weather$PAR_SR <- weather$Radiation * 0.5

```
##Daily average
```{r}
#daily average from entire day
weather_daily_all <- aggregate(weather[,c('Radiation','AirTemp','VPD')], list("Date"= weather$Date), function(x){mean(x,na.rm = TRUE)})

#from 11:00-15:00
temp_df <- subset(weather, Time > 11 & Time < 15)
weather_daily_noon <- aggregate(temp_df[,c('Radiation','AirTemp','VPD')], list("Date"= temp_df$Date), function(x){mean(x,na.rm = TRUE)})

#combine them together with different names
weather_season <- merge(weather_daily_all, weather_daily_noon, by = "Date")
head(weather_season)
names(weather_season) <- c("Date","Radiation.all","AirTemp.all","VPD.all","Radiation.noon","AirTemp.noon","VPD.noon")
```



#Dirunal cycle
##Check the incoming radiation 
```{r}
#X532IN
ggplot(subset(gs, Date == "2019-06-01"), aes(x = TIMESTAMP, y = X532IN, color = as.factor(ID))) + geom_point() + ggtitle("Incoming Radiation In532 2019-06-01") + scale_color_d3()
ggplot(subset(gs, Date == "2019-07-01"), aes(x = TIMESTAMP, y = X532IN, color = as.factor(ID))) + geom_point() + ggtitle("Incoming Radiation In532 2019-07-01") + scale_color_d3()
ggplot(subset(gs, Date == "2019-08-01"), aes(x = TIMESTAMP, y = X532IN, color = as.factor(ID))) + geom_point() + ggtitle("Incoming Radiation In532 2019-08-01") + scale_color_d3()
ggplot(subset(gs, Date == "2019-09-01"), aes(x = TIMESTAMP, y = X532IN, color = as.factor(ID))) + geom_point() + ggtitle("Incoming Radiation In532 2019-09-01") + scale_color_d3()

#X570IN
ggplot(subset(gs, Date == "2019-06-01"), aes(x = TIMESTAMP, y = X570IN, color = as.factor(ID))) + geom_point() + ggtitle("Incoming Radiation In570 2019-06-01") + scale_color_d3()
ggplot(subset(gs, Date == "2019-07-01"), aes(x = TIMESTAMP, y = X570IN, color = as.factor(ID))) + geom_point() + ggtitle("Incoming Radiation In570 2019-07-01") + scale_color_d3()
ggplot(subset(gs, Date == "2019-08-01"), aes(x = TIMESTAMP, y = X570IN, color = as.factor(ID))) + geom_point() + ggtitle("Incoming Radiation In570 2019-08-01") + scale_color_d3()
ggplot(subset(gs, Date == "2019-09-01"), aes(x = TIMESTAMP, y = X570IN, color = as.factor(ID))) + geom_point() + ggtitle("Incoming Radiation In570 2019-09-01") + scale_color_d3()

#X650IN
ggplot(subset(gs, Date == "2019-06-01"), aes(x = TIMESTAMP, y = X650IN, color = as.factor(ID))) + geom_point() + ggtitle("Incoming Radiation In650 2019-06-01") + scale_color_d3()
ggplot(subset(gs, Date == "2019-07-01"), aes(x = TIMESTAMP, y = X650IN, color = as.factor(ID))) + geom_point() + ggtitle("Incoming Radiation In650 2019-07-01") + scale_color_d3()
ggplot(subset(gs, Date == "2019-08-01"), aes(x = TIMESTAMP, y = X650IN, color = as.factor(ID))) + geom_point() + ggtitle("Incoming Radiation In650 2019-08-01") + scale_color_d3()
ggplot(subset(gs, Date == "2019-09-01"), aes(x = TIMESTAMP, y = X650IN, color = as.factor(ID))) + geom_point() + ggtitle("Incoming Radiation In650 2019-09-01") + scale_color_d3()

#X810IN
ggplot(subset(gs, Date == "2019-06-01"), aes(x = TIMESTAMP, y = X810IN, color = as.factor(ID))) + geom_point() + ggtitle("Incoming Radiation In810 2019-06-01") + scale_color_d3()
ggplot(subset(gs, Date == "2019-07-01"), aes(x = TIMESTAMP, y = X810IN, color = as.factor(ID))) + geom_point() + ggtitle("Incoming Radiation In810 2019-07-01") + scale_color_d3()
ggplot(subset(gs, Date == "2019-08-01"), aes(x = TIMESTAMP, y = X810IN, color = as.factor(ID))) + geom_point() + ggtitle("Incoming Radiation In810 2019-08-01") + scale_color_d3()
ggplot(subset(gs, Date == "2019-09-01"), aes(x = TIMESTAMP, y = X810IN, color = as.factor(ID))) + geom_point() + ggtitle("Incoming Radiation In810 2019-09-01") + scale_color_d3()


#Quantify the difference between them 
temp_agg <- aggregate(gs[,c("X532IN","X570IN","X650IN","X810IN")], list("TIMESTAMP" = gs$TIMESTAMP), FUN = function(x){sd(x, na.rm =  TRUE)})
IR_sd <- tidyr::gather(temp_agg, wavelength, sd, X532IN:X810IN, factor_key = TRUE)
IR_sd <- IR_sd %>% mutate(Date = lubridate::date(TIMESTAMP),
                          Time = hour(TIMESTAMP)+minute(TIMESTAMP)/60+second(TIMESTAMP)/3600)
head(temp_agg)
ggplot(IR_sd, aes(x = TIMESTAMP, y = sd, color = wavelength))+geom_point() + scale_color_d3()
ggplot(noon_selection(IR_sd, 8, 18), aes(x = TIMESTAMP, y = sd, color = wavelength)) + geom_point() +scale_color_d3() + ylab("Standard Deviation") + xlab("Date")
```
##Check the upward radiation
```{r}
#X532OUT
ggplot(subset(gs, Date == "2019-06-01"), aes(x = TIMESTAMP, y = X532OUT, color = as.factor(ID))) + geom_point() + ggtitle("Incoming Radiation In532 2019-06-01") + scale_color_d3()
ggplot(subset(gs, Date == "2019-07-01"), aes(x = TIMESTAMP, y = X532OUT, color = as.factor(ID))) + geom_point() + ggtitle("Incoming Radiation In532 2019-07-01") + scale_color_d3()
ggplot(subset(gs, Date == "2019-08-01"), aes(x = TIMESTAMP, y = X532OUT, color = as.factor(ID))) + geom_point() + ggtitle("Incoming Radiation In532 2019-08-01") + scale_color_d3()
ggplot(subset(gs, Date == "2019-09-01"), aes(x = TIMESTAMP, y = X532OUT, color = as.factor(ID))) + geom_point() + ggtitle("Incoming Radiation In532 2019-09-01") + scale_color_d3()

#X570OUT
ggplot(subset(gs, Date == "2019-06-01"), aes(x = TIMESTAMP, y = X570OUT, color = as.factor(ID))) + geom_point() + ggtitle("Incoming Radiation In570 2019-06-01") + scale_color_d3()
ggplot(subset(gs, Date == "2019-07-01"), aes(x = TIMESTAMP, y = X570OUT, color = as.factor(ID))) + geom_point() + ggtitle("Incoming Radiation In570 2019-07-01") + scale_color_d3()
ggplot(subset(gs, Date == "2019-08-01"), aes(x = TIMESTAMP, y = X570OUT, color = as.factor(ID))) + geom_point() + ggtitle("Incoming Radiation In570 2019-08-01") + scale_color_d3()
ggplot(subset(gs, Date == "2019-09-01"), aes(x = TIMESTAMP, y = X570OUT, color = as.factor(ID))) + geom_point() + ggtitle("Incoming Radiation In570 2019-09-01") + scale_color_d3()

#X650OUT
ggplot(subset(gs, Date == "2019-06-01"), aes(x = TIMESTAMP, y = X650OUT, color = as.factor(ID))) + geom_point() + ggtitle("Incoming Radiation In650 2019-06-01") + scale_color_d3()
ggplot(subset(gs, Date == "2019-07-01"), aes(x = TIMESTAMP, y = X650OUT, color = as.factor(ID))) + geom_point() + ggtitle("Incoming Radiation In650 2019-07-01") + scale_color_d3()
ggplot(subset(gs, Date == "2019-08-01"), aes(x = TIMESTAMP, y = X650OUT, color = as.factor(ID))) + geom_point() + ggtitle("Incoming Radiation In650 2019-08-01") + scale_color_d3()
ggplot(subset(gs, Date == "2019-09-01"), aes(x = TIMESTAMP, y = X650OUT, color = as.factor(ID))) + geom_point() + ggtitle("Incoming Radiation In650 2019-09-01") + scale_color_d3()

#X810OUT
ggplot(subset(gs, Date == "2019-06-01"), aes(x = TIMESTAMP, y = X810OUT, color = as.factor(ID))) + geom_point() + ggtitle("Incoming Radiation In810 2019-06-01") + scale_color_d3()
ggplot(subset(gs, Date == "2019-07-01"), aes(x = TIMESTAMP, y = X810OUT, color = as.factor(ID))) + geom_point() + ggtitle("Incoming Radiation In810 2019-07-01") + scale_color_d3()
ggplot(subset(gs, Date == "2019-08-01"), aes(x = TIMESTAMP, y = X810OUT, color = as.factor(ID))) + geom_point() + ggtitle("Incoming Radiation In810 2019-08-01") + scale_color_d3()
ggplot(subset(gs, Date == "2019-09-01"), aes(x = TIMESTAMP, y = X810OUT, color = as.factor(ID))) + geom_point() + ggtitle("Incoming Radiation In810 2019-09-01") + scale_color_d3()

```

##Average the incoming radiation 
```{r}
#aggregate over time 
temp_agg <- aggregate(gssb[,c("X532IN","X570IN","X650IN","X810IN")], list("TIMESTAMP" = gssb$TIMESTAMP), FUN = function(x){mean(x, na.rm =  TRUE, trim = 0.2)}) #average of 5 
names(temp_agg) <- c("TIMESTAMP","X532IN_mean","X570IN_mean","X650IN_mean","X810IN_mean")
#add these 4 new columns 
gssb <- merge(gssb, temp_agg, by = "TIMESTAMP")
head(gssb)

#calculate reflectance and PRI, NDVI again 
gssb <- gssb %>% mutate(R532m = X532OUT/X532IN_mean, 
                    R570m = X570OUT/X570IN_mean,
                    R650m = X650OUT/X650IN_mean,
                    R810m = X810OUT/X810IN_mean,
                    PRIm = (R532m-R570m)/(R532m+R570m),
                    NDVIm = (R810m-R650m)/(R810m+R650m))


```

##Deal with missing values 
```{r}
gssb <- subset(gssb, ID!= "10 CIMIS  ")
#gssb <- subset(gssb, ID != "5 CONTROL DDD  " & ID!= "10 CIMIS  ")
gssb <- subset(gssb, Date >= "2019-05-11" & Date <= "2019-09-04")
unique(gssb$ID)
names(gssb)

sum(is.na(gssb$PRIm)) #13 NAs 
sum(is.na(gssb$NDVIm)) #6 NAs
sum(is.na(gssb$TIMESTAMP))

temp_split <- split(gssb, list(gssb$ID, gssb$Date))
length(temp_split)
ma_split <- lapply(temp_split, function(x){
  x$PRIm.ma <- rollmean(x$PRIm, k = 6, fill = NA)
  return(x)
})
gssb <- do.call(rbind, ma_split)


```

##Visualize the diurnal cycle of PRI 
```{r}
#For the dates that have ground measurements 
#PRIm from 7:00 to 20:00
ggplot(subset(a, Date == "2019-05-30" & Time > 7 & Time < 19), aes(x = Time, y = PRIm, color = as.factor(ID))) + geom_point() + ggtitle("PRI 2019-05-30") + scale_color_d3() + ylab("PRI") + xlab("Time")+facet_wrap(~ID, nrow = 3, ncol = 3)+theme_bw()+theme(legend.position = 'None')
ggplot(subset(a, Date == "2019-05-31" & Time > 7 & Time < 19), aes(x = Time, y = PRIm, color = as.factor(ID))) + geom_point() + ggtitle("PRI 2019-05-31") + scale_color_d3() + ylab("PRI") + xlab("Time")+facet_wrap(~ID, nrow = 3, ncol = 3)+theme_bw()+theme(legend.position = 'None')
ggplot(subset(a, Date == "2019-06-01" & Time > 7 & Time < 19), aes(x = Time, y = PRIm, color = as.factor(ID))) + geom_point() + ggtitle("PRI 2019-06-01") + scale_color_d3() + ylab("PRI") + xlab("Time")+facet_wrap(~ID, nrow = 3, ncol = 3)+theme_bw()+theme(legend.position = 'None')
ggplot(subset(a, Date == "2019-06-10" & Time > 7 & Time < 19), aes(x = Time, y = PRIm, color = as.factor(ID))) + geom_point() + ggtitle("PRI 2019-06-10") + scale_color_d3() + ylab("PRI") + xlab("Time")+facet_wrap(~ID, nrow = 3, ncol = 3)+theme_bw()+theme(legend.position = 'None')
ggplot(subset(a, Date == "2019-06-11" & Time > 7 & Time < 19), aes(x = Time, y = PRIm, color = as.factor(ID))) + geom_point() + ggtitle("PRI 2019-06-11") + scale_color_d3() + ylab("PRI") + xlab("Time")+facet_wrap(~ID, nrow = 3, ncol = 3)+theme_bw()+theme(legend.position = 'None')
ggplot(subset(a, Date == "2019-06-12" & Time > 7 & Time < 19), aes(x = Time, y = PRIm, color = as.factor(ID))) + geom_point() + ggtitle("PRI 2019-06-12") + scale_color_d3() + ylab("PRI") + xlab("Time")+facet_wrap(~ID, nrow = 3, ncol = 3)+theme_bw()+theme(legend.position = 'None')
ggplot(subset(a, Date == "2019-06-25" & Time > 7 & Time < 19), aes(x = Time, y = PRIm, color = as.factor(ID))) + geom_point() + ggtitle("PRI 2019-06-25") + scale_color_d3() + ylab("PRI") + xlab("Time")+facet_wrap(~ID, nrow = 3, ncol = 3)+theme_bw()+theme(legend.position = 'None')
ggplot(subset(a, Date == "2019-06-26" & Time > 7 & Time < 19), aes(x = Time, y = PRIm, color = as.factor(ID))) + geom_point() + ggtitle("PRI 2019-06-26") + scale_color_d3() + ylab("PRI") + xlab("Time")+facet_wrap(~ID, nrow = 3, ncol = 3)+theme_bw()+theme(legend.position = 'None')
ggplot(subset(a, Date == "2019-06-27" & Time > 7 & Time < 19), aes(x = Time, y = PRIm, color = as.factor(ID))) + geom_point() + ggtitle("PRI 2019-06-27") + scale_color_d3() + ylab("PRI") + xlab("Time")+facet_wrap(~ID, nrow = 3, ncol = 3)+theme_bw()+theme(legend.position = 'None')
ggplot(subset(a, Date == "2019-07-17" & Time > 7 & Time < 19), aes(x = Time, y = PRIm, color = as.factor(ID))) + geom_point() + ggtitle("PRI 2019-07-17") + scale_color_d3() + ylab("PRI") + xlab("Time")+facet_wrap(~ID, nrow = 3, ncol = 3)+theme_bw()+theme(legend.position = 'None')
ggplot(subset(a, Date == "2019-07-18" & Time > 7 & Time < 19), aes(x = Time, y = PRIm, color = as.factor(ID))) + geom_point() + ggtitle("PRI 2019-07-18") + scale_color_d3() + ylab("PRI") + xlab("Time")+facet_wrap(~ID, nrow = 3, ncol = 3)+theme_bw()+theme(legend.position = 'None')
ggplot(subset(a, Date == "2019-07-19" & Time > 7 & Time < 19), aes(x = Time, y = PRIm, color = as.factor(ID))) + geom_point() + ggtitle("PRI 2019-07-19") + scale_color_d3() + ylab("PRI") + xlab("Time")+facet_wrap(~ID, nrow = 3, ncol = 3)+theme_bw()+theme(legend.position = 'None')
ggplot(subset(a, Date == "2019-07-25" & Time > 7 & Time < 19), aes(x = Time, y = PRIm, color = as.factor(ID))) + geom_point() + ggtitle("PRI 2019-07-25") + scale_color_d3() + ylab("PRI") + xlab("Time")+facet_wrap(~ID, nrow = 3, ncol = 3)+theme_bw()+theme(legend.position = 'None')
ggplot(subset(a, Date == "2019-07-26" & Time > 7 & Time < 19), aes(x = Time, y = PRIm, color = as.factor(ID))) + geom_point() + ggtitle("PRI 2019-07-26") + scale_color_d3() + ylab("PRI") + xlab("Time")+facet_wrap(~ID, nrow = 3, ncol = 3)+theme_bw()+theme(legend.position = 'None')
ggplot(subset(a, Date == "2019-07-27" & Time > 7 & Time < 19), aes(x = Time, y = PRIm, color = as.factor(ID))) + geom_point() + ggtitle("PRI 2019-07-27") + scale_color_d3() + ylab("PRI") + xlab("Time")+facet_wrap(~ID, nrow = 3, ncol = 3)+theme_bw()+theme(legend.position = 'None')
ggplot(subset(a, Date == "2019-08-01" & Time > 7 & Time < 19), aes(x = Time, y = PRIm, color = as.factor(ID))) + geom_point() + ggtitle("PRI 2019-08-01") + scale_color_d3() + ylab("PRI") + xlab("Time")+facet_wrap(~ID, nrow = 3, ncol = 3)+theme_bw()+theme(legend.position = 'None')
ggplot(subset(a, Date == "2019-08-02" & Time > 7 & Time < 19), aes(x = Time, y = PRIm, color = as.factor(ID))) + geom_point() + ggtitle("PRI 2019-08-02") + scale_color_d3() + ylab("PRI") + xlab("Time")+facet_wrap(~ID, nrow = 3, ncol = 3)+theme_bw()+theme(legend.position = 'None')
ggplot(subset(a, Date == "2019-08-03" & Time > 7 & Time < 19), aes(x = Time, y = PRIm, color = as.factor(ID))) + geom_point() + ggtitle("PRI 2019-08-03") + scale_color_d3() + ylab("PRI") + xlab("Time")+facet_wrap(~ID, nrow = 3, ncol = 3)+theme_bw()+theme(legend.position = 'None')
ggplot(subset(a, Date == "2019-08-08" & Time > 7 & Time < 19), aes(x = Time, y = PRIm, color = as.factor(ID))) + geom_point() + ggtitle("PRI 2019-08-08") + scale_color_d3() + ylab("PRI") + xlab("Time")+facet_wrap(~ID, nrow = 3, ncol = 3)+theme_bw()+theme(legend.position = 'None')
ggplot(subset(a, Date == "2019-08-09" & Time > 7 & Time < 19), aes(x = Time, y = PRIm, color = as.factor(ID))) + geom_point() + ggtitle("PRI 2019-08-09") + scale_color_d3() + ylab("PRI") + xlab("Time")+facet_wrap(~ID, nrow = 3, ncol = 3)+theme_bw()+theme(legend.position = 'None')
ggplot(subset(a, Date == "2019-08-10" & Time > 7 & Time < 19), aes(x = Time, y = PRIm, color = as.factor(ID))) + geom_point() + ggtitle("PRI 2019-08-10") + scale_color_d3() + ylab("PRI") + xlab("Time")+facet_wrap(~ID, nrow = 3, ncol = 3)+theme_bw()+theme(legend.position = 'None')
ggplot(subset(a, Date == "2019-08-14" & Time > 7 & Time < 19), aes(x = Time, y = PRIm, color = as.factor(ID))) + geom_point() + ggtitle("PRI 2019-08-14") + scale_color_d3() + ylab("PRI") + xlab("Time")+facet_wrap(~ID, nrow = 3, ncol = 3)+theme_bw()+theme(legend.position = 'None')
ggplot(subset(a, Date == "2019-08-15" & Time > 7 & Time < 19), aes(x = Time, y = PRIm, color = as.factor(ID))) + geom_point() + ggtitle("PRI 2019-08-15") + scale_color_d3() + ylab("PRI") + xlab("Time")+facet_wrap(~ID, nrow = 3, ncol = 3)+theme_bw()+theme(legend.position = 'None')
ggplot(subset(a, Date == "2019-08-16" & Time > 7 & Time < 19), aes(x = Time, y = PRIm, color = as.factor(ID))) + geom_point() + ggtitle("PRI 2019-08-16") + scale_color_d3() + ylab("PRI") + xlab("Time")+facet_wrap(~ID, nrow = 3, ncol = 3)+theme_bw()+theme(legend.position = 'None')









ggplot(subset(gssb, Date == "2019-09-01" & Time > 7 & Time < 19), aes(x = TIMESTAMP, y = PRIm.ma, color = as.factor(ID))) + geom_point() + ggtitle("PRI 2019-09-01") + scale_color_d3() + ylab("PRI") + xlab("Time")


#PRIm from 9:00 to 18:00, choose the date that have ground measurements
p1 = ggplot(subset(gssb, Date == "2019-05-31" & Time > 9 & Time < 18), aes(x = TIMESTAMP, y = PRIm, color = as.factor(ID))) + geom_point() + ggtitle("PRI 2019-05-31") + scale_color_d3() + ylab("PRI") + xlab("Time") + ylim(-0.125, 0.1) + theme(legend.position = "none")
p2 = ggplot(subset(gssb, Date == "2019-06-12" & Time > 9 & Time < 18), aes(x = TIMESTAMP, y = PRIm, color = as.factor(ID))) + geom_point() + ggtitle("PRI 2019-06-12") + scale_color_d3() + ylab("PRI") + xlab("Time") + ylim(-0.125, 0.1) + theme(legend.position = "none")
p3 = ggplot(subset(gssb, Date == "2019-06-26" & Time > 9 & Time < 18), aes(x = TIMESTAMP, y = PRIm, color = as.factor(ID))) + geom_point() + ggtitle("PRI 2019-06-26") + scale_color_d3() + ylab("PRI") + xlab("Time") + ylim(-0.125, 0.1) + theme(legend.position = "none")
p4 = ggplot(subset(gssb, Date == "2019-07-18" & Time > 9 & Time < 18), aes(x = TIMESTAMP, y = PRIm, color = as.factor(ID))) + geom_point() + ggtitle("PRI 2019-07-18") + scale_color_d3() + ylab("PRI") + xlab("Time") + ylim(-0.125, 0.1) + theme(legend.position = "none")
p5 = ggplot(subset(gssb, Date == "2019-07-26" & Time > 9 & Time < 18), aes(x = TIMESTAMP, y = PRIm, color = as.factor(ID))) + geom_point() + ggtitle("PRI 2019-07-26") + scale_color_d3() + ylab("PRI") + xlab("Time") + ylim(-0.125, 0.1) + theme(legend.position = "none")
p6 = ggplot(subset(gssb, Date == "2019-08-02" & Time > 9 & Time < 18), aes(x = TIMESTAMP, y = PRIm, color = as.factor(ID))) + geom_point() + ggtitle("PRI 2019-08-02") + scale_color_d3() + ylab("PRI") + xlab("Time") + ylim(-0.125, 0.1) + theme(legend.position = "none")
p7 = ggplot(subset(gssb, Date == "2019-08-09" & Time > 9 & Time < 18), aes(x = TIMESTAMP, y = PRIm, color = as.factor(ID))) + geom_point() + ggtitle("PRI 2019-08-09") + scale_color_d3() + ylab("PRI") + xlab("Time") + ylim(-0.125, 0.1) + theme(legend.position = "none")
p8 = ggplot(subset(gssb, Date == "2019-08-15" & Time > 9 & Time < 18), aes(x = TIMESTAMP, y = PRIm, color = as.factor(ID))) + geom_point() + ggtitle("PRI 2019-08-15") + scale_color_d3() + ylab("PRI") + xlab("Time") + ylim(-0.125, 0.1) + theme(legend.position = "none")
grid.arrange(p1,p2,p3,p4,p5,p6,p7,p8,nrow = 2, ncol =4) 
#To generate the legend
ggplot(subset(gssb, Date == "2019-08-15" & Time > 9 & Time < 18), aes(x = TIMESTAMP, y = PRIm, color = as.factor(ID))) + geom_point() + ggtitle("PRI 2019-08-15") + scale_color_d3() + ylab("PRI") + xlab("Time") + ylim(-0.125, 0.1)


```
##How about PRIm.ma
```{r}
#For the dates that have ground measurements 
#PRIm from 7:00 to 20:00
ggplot(subset(gssb, Date == "2019-05-30" & Time > 7 & Time < 19), aes(x = TIMESTAMP, y = PRIm.ma, color = as.factor(ID))) + geom_point() + ggtitle("PRI 2019-05-30") + scale_color_d3() + ylab("PRI") + xlab("Time")
ggplot(subset(gssb, Date == "2019-05-31" & Time > 7 & Time < 19), aes(x = TIMESTAMP, y = PRIm.ma, color = as.factor(ID))) + geom_point() + ggtitle("PRI 2019-05-31") + scale_color_d3() + ylab("PRI") + xlab("Time")
ggplot(subset(gssb, Date == "2019-06-01" & Time > 7 & Time < 19), aes(x = TIMESTAMP, y = PRIm.ma, color = as.factor(ID))) + geom_point() + ggtitle("PRI 2019-06-01") + scale_color_d3() + ylab("PRI") + xlab("Time")
ggplot(subset(gssb, Date == "2019-06-10" & Time > 7 & Time < 19), aes(x = TIMESTAMP, y = PRIm.ma, color = as.factor(ID))) + geom_point() + ggtitle("PRI 2019-06-10") + scale_color_d3() + ylab("PRI") + xlab("Time")
ggplot(subset(gssb, Date == "2019-06-11" & Time > 7 & Time < 19), aes(x = TIMESTAMP, y = PRIm.ma, color = as.factor(ID))) + geom_point() + ggtitle("PRI 2019-06-11") + scale_color_d3() + ylab("PRI") + xlab("Time")
ggplot(subset(gssb, Date == "2019-06-12" & Time > 7 & Time < 19), aes(x = TIMESTAMP, y = PRIm.ma, color = as.factor(ID))) + geom_point() + ggtitle("PRI 2019-06-12") + scale_color_d3() + ylab("PRI") + xlab("Time")
ggplot(subset(gssb, Date == "2019-06-25" & Time > 7 & Time < 19), aes(x = TIMESTAMP, y = PRIm.ma, color = as.factor(ID))) + geom_point() + ggtitle("PRI 2019-06-25") + scale_color_d3() + ylab("PRI") + xlab("Time")
ggplot(subset(gssb, Date == "2019-06-26" & Time > 7 & Time < 19), aes(x = TIMESTAMP, y = PRIm.ma, color = as.factor(ID))) + geom_point() + ggtitle("PRI 2019-06-26") + scale_color_d3() + ylab("PRI") + xlab("Time")
ggplot(subset(gssb, Date == "2019-06-27" & Time > 7 & Time < 19), aes(x = TIMESTAMP, y = PRIm.ma, color = as.factor(ID))) + geom_point() + ggtitle("PRI 2019-06-27") + scale_color_d3() + ylab("PRI") + xlab("Time")
ggplot(subset(gssb, Date == "2019-07-17" & Time > 7 & Time < 19), aes(x = TIMESTAMP, y = PRIm.ma, color = as.factor(ID))) + geom_point() + ggtitle("PRI 2019-07-17") + scale_color_d3() + ylab("PRI") + xlab("Time")
ggplot(subset(gssb, Date == "2019-07-18" & Time > 7 & Time < 19), aes(x = TIMESTAMP, y = PRIm.ma, color = as.factor(ID))) + geom_point() + ggtitle("PRI 2019-07-18") + scale_color_d3() + ylab("PRI") + xlab("Time")
ggplot(subset(gssb, Date == "2019-07-19" & Time > 7 & Time < 19), aes(x = TIMESTAMP, y = PRIm.ma, color = as.factor(ID))) + geom_point() + ggtitle("PRI 2019-07-19") + scale_color_d3() + ylab("PRI") + xlab("Time")
ggplot(subset(gssb, Date == "2019-07-25" & Time > 7 & Time < 19), aes(x = TIMESTAMP, y = PRIm.ma, color = as.factor(ID))) + geom_point() + ggtitle("PRI 2019-07-25") + scale_color_d3() + ylab("PRI") + xlab("Time")
ggplot(subset(gssb, Date == "2019-07-26" & Time > 7 & Time < 19), aes(x = TIMESTAMP, y = PRIm.ma, color = as.factor(ID))) + geom_point() + ggtitle("PRI 2019-07-26") + scale_color_d3() + ylab("PRI") + xlab("Time")
ggplot(subset(gssb, Date == "2019-07-27" & Time > 7 & Time < 19), aes(x = TIMESTAMP, y = PRIm.ma, color = as.factor(ID))) + geom_point() + ggtitle("PRI 2019-07-27") + scale_color_d3() + ylab("PRI") + xlab("Time")
ggplot(subset(gssb, Date == "2019-08-01" & Time > 7 & Time < 19), aes(x = TIMESTAMP, y = PRIm.ma, color = as.factor(ID))) + geom_point() + ggtitle("PRI 2019-08-01") + scale_color_d3() + ylab("PRI") + xlab("Time")
ggplot(subset(gssb, Date == "2019-08-02" & Time > 7 & Time < 19), aes(x = TIMESTAMP, y = PRIm.ma, color = as.factor(ID))) + geom_point() + ggtitle("PRI 2019-08-02") + scale_color_d3() + ylab("PRI") + xlab("Time")
ggplot(subset(gssb, Date == "2019-08-03" & Time > 7 & Time < 19), aes(x = TIMESTAMP, y = PRIm.ma, color = as.factor(ID))) + geom_point() + ggtitle("PRI 2019-08-03") + scale_color_d3() + ylab("PRI") + xlab("Time")
ggplot(subset(gssb, Date == "2019-08-08" & Time > 7 & Time < 19), aes(x = TIMESTAMP, y = PRIm.ma, color = as.factor(ID))) + geom_point() + ggtitle("PRI 2019-08-08") + scale_color_d3() + ylab("PRI") + xlab("Time")
ggplot(subset(gssb, Date == "2019-08-09" & Time > 7 & Time < 19), aes(x = TIMESTAMP, y = PRIm.ma, color = as.factor(ID))) + geom_point() + ggtitle("PRI 2019-08-09") + scale_color_d3() + ylab("PRI") + xlab("Time")
ggplot(subset(gssb, Date == "2019-08-10" & Time > 7 & Time < 19), aes(x = TIMESTAMP, y = PRIm.ma, color = as.factor(ID))) + geom_point() + ggtitle("PRI 2019-08-10") + scale_color_d3() + ylab("PRI") + xlab("Time")
ggplot(subset(gssb, Date == "2019-08-14" & Time > 7 & Time < 19), aes(x = TIMESTAMP, y = PRIm.ma, color = as.factor(ID))) + geom_point() + ggtitle("PRI 2019-08-14") + scale_color_d3() + ylab("PRI") + xlab("Time")
ggplot(subset(gssb, Date == "2019-08-15" & Time > 7 & Time < 19), aes(x = TIMESTAMP, y = PRIm.ma, color = as.factor(ID))) + geom_point() + ggtitle("PRI 2019-08-15") + scale_color_d3() + ylab("PRI") + xlab("Time")
ggplot(subset(gssb, Date == "2019-08-13" & Time > 7 & Time < 19), aes(x = TIMESTAMP, y = PRIm.ma, color = as.factor(ID))) + geom_point() + ggtitle("PRI 2019-08-13") + scale_color_d3() + ylab("PRI") + xlab("Time")
```

##How about NDVI
```{r}
#NDVIm from 9:00 to 18:00, choose the date that have ground measurements
p1 = ggplot(subset(gssb, Date == "2019-05-31" & Time > 9 & Time < 18), aes(x = TIMESTAMP, y = NDVIm, color = as.factor(ID))) + geom_point() + ggtitle("NDVI 2019-05-31") + scale_color_d3() + ylab("NDVI") + xlab("Time")  + theme(legend.position = "none")+ ylim(0.4, 1)
p2 = ggplot(subset(gssb, Date == "2019-06-12" & Time > 9 & Time < 18), aes(x = TIMESTAMP, y = NDVIm, color = as.factor(ID))) + geom_point() + ggtitle("NDVI 2019-06-12") + scale_color_d3() + ylab("NDVI") + xlab("Time")  + theme(legend.position = "none")+ ylim(0.4, 1)
p3 = ggplot(subset(gssb, Date == "2019-06-26" & Time > 9 & Time < 18), aes(x = TIMESTAMP, y = NDVIm, color = as.factor(ID))) + geom_point() + ggtitle("NDVI 2019-06-26") + scale_color_d3() + ylab("NDVI") + xlab("Time")  + theme(legend.position = "none")+ ylim(0.4, 1)
p4 = ggplot(subset(gssb, Date == "2019-07-18" & Time > 9 & Time < 18), aes(x = TIMESTAMP, y = NDVIm, color = as.factor(ID))) + geom_point() + ggtitle("NDVI 2019-07-18") + scale_color_d3() + ylab("NDVI") + xlab("Time")  + theme(legend.position = "none")+ ylim(0.4, 1)
p5 = ggplot(subset(gssb, Date == "2019-07-26" & Time > 9 & Time < 18), aes(x = TIMESTAMP, y = NDVIm, color = as.factor(ID))) + geom_point() + ggtitle("NDVI 2019-07-26") + scale_color_d3() + ylab("NDVI") + xlab("Time")  + theme(legend.position = "none")+ ylim(0.4, 1)
p6 = ggplot(subset(gssb, Date == "2019-08-02" & Time > 9 & Time < 18), aes(x = TIMESTAMP, y = NDVIm, color = as.factor(ID))) + geom_point() + ggtitle("NDVI 2019-08-02") + scale_color_d3() + ylab("NDVI") + xlab("Time")  + theme(legend.position = "none")+ ylim(0.4, 1)
p7 = ggplot(subset(gssb, Date == "2019-08-09" & Time > 9 & Time < 18), aes(x = TIMESTAMP, y = NDVIm, color = as.factor(ID))) + geom_point() + ggtitle("NDVI 2019-08-09") + scale_color_d3() + ylab("NDVI") + xlab("Time")  + theme(legend.position = "none")+ ylim(0.4, 1)
p8 = ggplot(subset(gssb, Date == "2019-08-15" & Time > 9 & Time < 18), aes(x = TIMESTAMP, y = NDVIm, color = as.factor(ID))) + geom_point() + ggtitle("NDVI 2019-08-15") + scale_color_d3() + ylab("NDVI") + xlab("Time")  + theme(legend.position = "none")+ ylim(0.4, 1)
grid.arrange(p1,p2,p3,p4,p5,p6,p7,p8,nrow = 2, ncol =4) 

```

##Calculate PRI0
###Local minimum and maximum 
####Function 
```{r}
which.peaks <- function(x,partial=TRUE,decreasing=FALSE){
  if (decreasing){
    if (partial){
      which(diff(c(TRUE,diff(x)<=0,FALSE))>0)
    }else {
      which(diff(diff(x)<=0)>0)
    }    
  }else {
    if (partial){
      which(diff(c(TRUE,diff(x)>=0,FALSE))<0)
    }else {
      which(diff(diff(x)>=0)<0)
    }
    
  }
}

ts_max<-function(signal)  
{
  points_max=which(diff(sign(diff(signal)))==-2)+1
  return(points_max)
}

ts_min<-function(signal)  
{
  points_min=which(diff(sign(diff(-signal)))==-2)+1
  return(points_min)
}

argmax <- function(x, y, w=1, ...) {
  require(zoo)
  n <- length(y)
  y.smooth <- loess(y ~ x, ...)$fitted
  y.max <- rollapply(zoo(y.smooth), 2*w+1, max, align="center")
  delta <- y.max - y.smooth[-c(1:w, n+1-1:w)]
  i.max <- which(delta <= 0) + w
  list(x=x[i.max], i=i.max, y.hat=y.smooth)
}

Calc_PRI0_PRImin <- function(x){
  #fit with loess to further smooth the data
  #morning period 
  morning <- subset(x, Time < 10)
  morning_loess <- loess(morning$PRIm.ma~morning$Time)
  #find the index of local maximum 
  max_ind <- extrema(morning_loess$fitted)
  max_ind <- max_ind$maxima[2,1]
  #the local maximum value 
  PRI0 <- morning$PRIm.ma[max_ind]
  
  #noon period
  noon <- subset(x, Time>10 & Time < 15)
  noon_loess <- loess(noon$PRIm.ma~noon$Time)
  #find the index of local minimum 
  min_ind <- extrema(noon_loess$fitted)
  min_ind <- min_ind[2,1]
  #the local minimum value 
  PRImin <- noon$PRIm.ma[min_ind]
  
  #combine them together
  newlist <- list(PRI0, PRImin)
  return(newlist)
}

Calc_PRI0 <- function(x){
  #fit with loess to further smooth the data
  #morning period 
  morning <- subset(x, Time < 10)[,c("PRIm","PRIm.ma","Time")]
  if(dim(morning)[1] < 20){
    PRI0 <- max(morning$PRIm, na.rm = TRUE)
    return(list(morning[morning$PRIm==PRI0,3], morning[morning$PRIm==PRI0,1]))
  }else{
    morning_loess <- loess(morning$PRIm.ma~morning$Time)
    #find the index of local maximum 
    max_ind <- extrema(morning_loess$fitted)
    max_ind <- max_ind$maxima[2,1]
    #the local maximum value 
    PRI0 <- morning$PRIm.ma[max_ind]
    return(list(morning$Time[max_ind], PRI0))
  }
}
```
####Implementation 
```{r}
#split by ID and Date
temp_ls <- split(gssb, list(gssb$ID,gssb$Date))
length(temp_ls) #1053 = 117*9 
hist(sapply(temp_ls, function(x){dim(x)[1]}))
#ls_PRI0 <- lapply(temp_ls, Calc_PRI0)
ls_PRI0 <- list()
for(i in 1:length(temp_ls)){
  
  ls_PRI0[[i]] <- Calc_PRI0(temp_ls[[i]])
  #print(names(temp_ls)[i])
  #print(ls_PRI0[[i]][1])
  temp_ls[[i]]$Time_PRI0 <- ls_PRI0[[i]][[1]]
  temp_ls[[i]]$PRI0.locmax <- ls_PRI0[[i]][[2]]
}
gssb_new <- do.call(rbind, temp_ls)
unique(gssb_new$Time_PRI0)

dim(a); dim(gssb)
b <- gssb_new %>% group_by(ID) %>% mutate(Time_PRI00 = mean(Time_PRI0)) %>% ungroup

ggplot(subset(gssb_new, Date == "2019-06-26" & Time > 7 & Time < 19), aes(x = Time, y = PRIm, color = as.factor(ID))) + geom_point() + ggtitle("PRI 2019-06-26") + scale_color_d3() + ylab("PRI") + xlab("Time")+facet_wrap(~ID, nrow = 3, ncol = 3)+theme_bw()+theme(legend.position = 'None') + geom_vline(data = subset(gssb_new, Date == "2019-06-26" & Time > 7 & Time < 19), aes(xintercept = Time_PRI0))





#use an example 
max_1 <- argmax(x = subset(temp_ls$`2 CONTROL WW  .2019-05-30`, Time < 10)$Time, y = subset(temp_ls$`2 CONTROL WW  .2019-05-30`, Time < 10)$PRIm.ma, w = 3)
plot(x = subset(temp_ls$`2 CONTROL WW  .2019-05-30`, Time < 10)$Time, y = subset(temp_ls$`2 CONTROL WW  .2019-05-30`, Time < 10)$PRIm.ma)
abline(v = max_1$x, col = "red")

max_2 <- argmax(x = subset(temp_ls$`2 CONTROL WW  .2019-05-30`, Time < 10)$Time, y = subset(temp_ls$`2 CONTROL WW  .2019-05-30`, Time < 10)$PRIm.ma, w = 2)
min_2 <- argmax(x = subset(temp_ls$`2 CONTROL WW  .2019-05-30`, Time < 10)$Time, y = -subset(temp_ls$`2 CONTROL WW  .2019-05-30`, Time < 10)$PRIm.ma, w = 2)
plot(x = subset(temp_ls$`2 CONTROL WW  .2019-05-30`, Time < 10)$Time, y = subset(temp_ls$`2 CONTROL WW  .2019-05-30`, Time < 10)$PRIm.ma)
abline(v = max_2$x, col = "red")
abline(v = min_2$x, col = "blue")
x = subset(temp_ls$`2 CONTROL WW  .2019-05-30`, Time < 10)$Time
y = subset(temp_ls$`2 CONTROL WW  .2019-05-30`, Time < 10)$PRIm
test(2, 0.05)
#run function 


for(i in 1:length(temp_ls)){
  #fit with loess to further smooth the data
  #morning period 
  morning <- subset(temp_ls[[i]], Time < 10)
  morning_loess <- loess(morning$PRIm.ma~morning$Time)
  #find the index of local maximum 
  max_ind <- extrema(morning_loess$fitted)
  max_ind <- max_ind$maxima[2,1]
  #the local maximum value 
  PRI0 <- morning$PRIm.ma[max_ind]
  
  #noon period
  noon <- subset(temp_ls[[i]], Time>10 & Time < 15)
  noon_loess <- loess(noon$PRIm.ma~noon$Time)
  #find the index of local minimum 
  min_ind <- extrema(noon_loess$fitted)
  min_ind <- min_ind[2,1]
  #the local minimum value 
  PRImin <- noon$PRIm.ma[min_ind]
}

```

PRI0 is the data when the solar zenith is smaller than 40 degree
###Filter by zenith anlge and PAR
```{r}
#calculate the solar zenith angle 
gssb$SunAngle <- oce::sunAngle(t = gssb$TIMESTAMP, latitude = 38.5346, longitude = -121.7711)$altitude

#Filter
gssb_filt <- subset(gssb, SunAngle > 25 & PAR_SR > 100)
#gssb_filt <- subset(gssb, SunAngle > 25), add PAR_SR remove more outliers
unique(gssb_filt$Time)

```
###PRI0 
```{r}
temp_ls <- split(gssb_filt, list(gssb_filt$ID, gssb_filt$Date))
length(temp_ls)

PRI0_daily <- data.frame("Date"= NA, "ID" = NA, Time0 = NA, PRI0  = NA, PRI0.ma = NA)
PRI0_daily$Date <- as.Date(PRI0_daily$Date)
for(i in 1:length(temp_ls)){
  temp_df <- temp_ls[[i]][order(temp_ls[[i]]$Time),c("Date","ID","Time","PRIm","PRIm.ma")]
  NonNAindex <- which(!is.na(temp_df$PRIm.ma))
  firstNonNA <- min(NonNAindex)
  #print(firstNonNA)
  PRI0_daily[i,] <- temp_df[firstNonNA,]
}
head(PRI0_daily)
dim(PRI0_daily)
row.names(PRI0_daily) <- NULL
#PRI0
#PRI0_daily <- gssb_filt %>% group_by(ID, Date) %>% summarise(Time0 = first(Time), PRI0.ma = first(PRIm.ma), PRI0 = first(PRIm))
#head(PRI0_daily)
#merge with gssb_filt
gssb_filt <- merge(gssb_filt, PRI0_daily, by = c("ID", "Date"))

ggplot(gssb_filt, aes(x = Date, y = PRI0.ma, color = ID)) + geom_point() + scale_color_d3() + theme_bw() + ylab("PRI0") 

ggplot(gssb_filt, aes(x = Date, y = PRI0, color = ID)) + geom_point() + scale_color_d3() + theme_bw() + ylab("PRI0")

```
###Calculate PRIdelta in diurnal cycle
```{r}
gssb_filt <- gssb_filt %>% mutate(PRIdelta = PRIm - PRI0, PRIdelta.ma = PRIm.ma - PRI0.ma)




p1 = ggplot(subset(gssb_filt, Date == "2019-05-31" & Time > 9 & Time < 18), aes(x = TIMESTAMP, y = PRIdelta.ma, color = as.factor(ID))) + geom_point() + ggtitle("PRIdelta 2019-05-31") + scale_color_d3() + ylab("PRIdelta") + xlab("Time") + ylim(-0.125, 0.1) + theme_bw() + theme(legend.position = "none")
p2 = ggplot(subset(gssb_filt, Date == "2019-06-12" & Time > 9 & Time < 18), aes(x = TIMESTAMP, y = PRIdelta.ma, color = as.factor(ID))) + geom_point() + ggtitle("PRIdelta 2019-06-12") + scale_color_d3() + ylab("PRIdelta") + xlab("Time") + ylim(-0.125, 0.1) + theme_bw() + theme(legend.position = "none")
p3 = ggplot(subset(gssb_filt, Date == "2019-06-26" & Time > 9 & Time < 18), aes(x = TIMESTAMP, y = PRIdelta.ma, color = as.factor(ID))) + geom_point() + ggtitle("PRIdelta 2019-06-26") + scale_color_d3() + ylab("PRIdelta") + xlab("Time") + ylim(-0.125, 0.1)+ theme_bw() + theme(legend.position = "none")
p4 = ggplot(subset(gssb_filt, Date == "2019-07-18" & Time > 9 & Time < 18), aes(x = TIMESTAMP, y = PRIdelta.ma, color = as.factor(ID))) + geom_point() + ggtitle("PRIdelta 2019-07-18") + scale_color_d3() + ylab("PRIdelta") + xlab("Time") + ylim(-0.125, 0.1)+ theme_bw() + theme(legend.position = "none")
p5 = ggplot(subset(gssb_filt, Date == "2019-07-26" & Time > 9 & Time < 18), aes(x = TIMESTAMP, y = PRIdelta.ma, color = as.factor(ID))) + geom_point() + ggtitle("PRIdelta 2019-07-26") + scale_color_d3() + ylab("PRIdelta") + xlab("Time") + ylim(-0.125, 0.1)+ theme_bw() + theme(legend.position = "none")
p6 = ggplot(subset(gssb_filt, Date == "2019-08-02" & Time > 9 & Time < 18), aes(x = TIMESTAMP, y = PRIdelta.ma, color = as.factor(ID))) + geom_point() + ggtitle("PRIdelta 2019-08-02") + scale_color_d3() + ylab("PRIdelta") + xlab("Time") + ylim(-0.125, 0.1)+ theme_bw() + theme(legend.position = "none")
p7 = ggplot(subset(gssb_filt, Date == "2019-08-09" & Time > 9 & Time < 18), aes(x = TIMESTAMP, y = PRIdelta.ma, color = as.factor(ID))) + geom_point() + ggtitle("PRIdelta 2019-08-09") + scale_color_d3() + ylab("PRIdelta") + xlab("Time") + ylim(-0.125, 0.1)+ theme_bw() + theme(legend.position = "none")
p8 = ggplot(subset(gssb_filt, Date == "2019-08-15" & Time > 9 & Time < 18), aes(x = TIMESTAMP, y = PRIdelta.ma, color = as.factor(ID))) + geom_point() + ggtitle("PRIdelta 2019-08-15") + scale_color_d3() + ylab("PRIdelta") + xlab("Time") + ylim(-0.125, 0.1)+ theme_bw() + theme(legend.position = "none")
grid.arrange(p1,p2,p3,p4,p5,p6,p7,p8,nrow = 2, ncol =4) 

#for legend
p8 = ggplot(subset(gssb_filt, Date == "2019-08-15" & Time > 9 & Time < 18), aes(x = TIMESTAMP, y = PRIdelta.ma, color = as.factor(ID))) + geom_point() + ggtitle("PRIdelta 2019-08-15") + scale_color_d3() + ylab("PRIdelta") + xlab("Time") + ylim(-0.125, 0.1)+ theme_bw()
p8
```

#Seasonal Change
##function to calculate daily average
```{r}
DayAve <- function(data, early, late, begin, end, colnum, FUN){
  #between certain dates
  df_date <- date_selection(data, begin, end)
  #noon average
  df_date_noon <- noon_selection(df_date, early, late)
  #split by date
  df_split <- split(df_date_noon, df_date_noon$Date)
  #lapply to calculate average
  df_ave <- lapply(lapply(df_split, "[[", colnum), function(x){FUN(x, na.rm = TRUE)})
  df_ave <- data.frame("Date" = ymd(names(df_ave)), "Value" = unlist(df_ave))
  #result
  row.names(df_ave) <- NULL
  return(df_ave)
}

PRIm_dayave <- function(data, early, late, begin, end){
  #between certain dates
  PRIm_date <- date_selection(data, begin, end)
  #noon average
  PRIm_date_noon <- noon_selection(PRIm_date, early, late)
  #split
  PRIm_split <- split(PRIm_date_noon, PRIm_date_noon$Date)
  #lapply
  PRIm_ave <- lapply(lapply(PRIm_split, "[[", 44), function(x){mean(x, na.rm = TRUE, trim = 0.2)})
  PRIm_ave <- data.frame("Date" = ymd(names(PRIm_ave)), "PRIm" = unlist(PRIm_ave))
  #result
  row.names(PRIm_ave) <- NULL
  return(PRIm_ave)
}

NDVIm_dayave <- function(data, early, late, begin, end){
  #between certain dates
  NDVIm_date <- date_selection(data, begin, end)
  #noon average
  NDVIm_date_noon <- noon_selection(NDVIm_date, early, late)
  #split
  NDVIm_split <- split(NDVIm_date_noon, NDVIm_date_noon$Date)
  #lapply
  NDVIm_ave <- lapply(lapply(NDVIm_split, "[[", 39), function(x){mean(x, na.rm = TRUE, trim = 0.2)})
  NDVIm_ave <- data.frame("Date" = ymd(names(NDVIm_ave)), "NDVIm" = unlist(NDVIm_ave))
  #result
  row.names(NDVIm_ave) <- NULL
  return(NDVIm_ave)
}
```

##Calculate daily average
###PRImin-PRI0 (follow Troy's paper) with moving average
```{r}
temp_split <- split(gssb_filt, gssb_filt$ID)
names(temp_split[[1]]) #PRIm.ma 44, NDVIm 43, PRI0.ma 48, PRIdelta.ma 50

#PRImin
temp_ls <- lapply(temp_split, function(x){DayAve(x, 11, 15, "2019-05-11", "2019-09-04", 44, min)})
for(i in 1:length(temp_ls)){
  temp_ls[[i]]$ID = names(temp_ls)[i]
}
PRImin.ma_season <- do.call(rbind, temp_ls)
row.names(PRImin.ma_season) <- NULL
head(PRImin.ma_season)
#is there any NAs
sum(is.na(PRImin.ma_season$Value))
names(PRImin.ma_season)[2] <- "PRImin.ma"

#PRI0
temp_ls <- lapply(temp_split, function(x){DayAve(x, 11, 15, "2019-05-11", "2019-09-04", 48, unique)})
for(i in 1:length(temp_ls)){
  temp_ls[[i]]$ID = names(temp_ls)[i]
}
PRI0.ma_season <- do.call(rbind, temp_ls)
row.names(PRI0.ma_season) <- NULL
head(PRI0.ma_season)
sum(is.na(PRI0.ma_season$Value))
names(PRI0.ma_season)[2] <- "PRI0.ma"

#calculate PRIdelta
PRImin_0.ma_season <- merge(PRImin.ma_season, PRI0.ma_season, by = c("Date","ID"))
PRImin_0.ma_season <- PRImin_0.ma_season %>% mutate(PRImin_PRI0.ma = PRImin.ma - PRI0.ma)
ggplot(PRImin_0.ma_season, aes(x = Date, y = PRImin_PRI0.ma, color = ID)) + geom_point()  + scale_color_d3() + theme_bw() + ylab("PRImin - PRI0")  + ggtitle("Seasonal Change of PRImin - PRI0") + geom_smooth(se = FALSE)#+ ylim(c(-0.1, 0.025))
```
###PRImin - PRI0 without moving average
```{r}
temp_split <- split(gssb_filt, gssb_filt$ID)
names(temp_split[[1]]) #PRIm 42, PRIm.ma 44, NDVIm 43, PRI0 47, PRI0.ma 48, PRIdelta.ma 50

#PRImin
temp_ls <- lapply(temp_split, function(x){DayAve(x, 11, 15, "2019-05-11", "2019-09-04", 42, min)})
for(i in 1:length(temp_ls)){
  temp_ls[[i]]$ID = names(temp_ls)[i]
}
PRImin_season <- do.call(rbind, temp_ls)
row.names(PRImin_season) <- NULL
head(PRImin_season)
#is there any NAs
sum(is.na(PRImin_season$Value))
names(PRImin_season)[2] <- "PRImin"

#PRI0
temp_ls <- lapply(temp_split, function(x){DayAve(x, 11, 15, "2019-05-11", "2019-09-04", 47, unique)})
for(i in 1:length(temp_ls)){
  temp_ls[[i]]$ID = names(temp_ls)[i]
}
PRI0_season <- do.call(rbind, temp_ls)
row.names(PRI0_season) <- NULL
head(PRI0_season)
sum(is.na(PRI0_season$Value))
names(PRI0_season)[2] <- "PRI0"

#calculate PRIdelta
PRImin_0_season <- merge(PRImin_season, PRI0_season, by = c("Date","ID"))
PRImin_0_season <- PRImin_0_season %>% mutate(PRImin_PRI0 = PRImin - PRI0)
ggplot(PRImin_0_season, aes(x = Date, y = PRImin_PRI0, color = ID)) + geom_point()  + scale_color_d3() + theme_bw() + ylab("PRImin - PRI0")  + ggtitle("Seasonal Change of PRImin - PRI0")+ylim(-0.15, 0.025) #+ geom_smooth(se = FALSE)+ ylim(c(-0.1, 0.025))

```
###PRIdelta average with moving average
```{r}
temp_split <- split(gssb_filt, gssb_filt$ID)
names(temp_split[[1]]) #PRIm 42, PRIm.ma 44, NDVIm 43, PRI0 47, PRI0.ma 48, PRIdelta 49, PRIdelta.ma 50

#PRIdelta.ma
temp_ls <- lapply(temp_split, function(x){DayAve(x, 11, 15, "2019-05-11", "2019-09-04", 50, mean)})
for(i in 1:length(temp_ls)){
  temp_ls[[i]]$ID = names(temp_ls)[i]
}
PRIdelta.ma_season <- do.call(rbind, temp_ls)
row.names(PRIdelta.ma_season) <- NULL
head(PRIdelta.ma_season)
#is there any NAs
sum(is.na(PRIdelta.ma_season$Value))
names(PRIdelta.ma_season)[2] <- "PRIdelta.ma"

ggplot(PRIdelta.ma_season, aes(x = Date, y = PRIdelta.ma, color = ID)) + geom_point() + scale_color_d3() + theme_bw() + ylab("PRIdelta") + ggtitle("Seasonal Change of PRIdelta") + geom_smooth(se = FALSE)

```
###PRIdelta average without moving average
```{r}
#PRIdelta
temp_ls <- lapply(temp_split, function(x){DayAve(x, 11, 15, "2019-05-11", "2019-09-04", 49, mean)})
for(i in 1:length(temp_ls)){
  temp_ls[[i]]$ID = names(temp_ls)[i]
}
PRIdelta_season <- do.call(rbind, temp_ls)
row.names(PRIdelta_season) <- NULL
head(PRIdelta_season)
sum(is.na(PRIdelta_season$Value))
names(PRIdelta_season)[2] <- "PRIdelta"

ggplot(PRIdelta_season, aes(x = Date, y = PRIdelta, color = ID)) + geom_point() + scale_color_d3() + theme_bw() + ylab("PRIdelta") + ggtitle("Seasonal Change of PRIdelta")

```
###PRIm, PRIm.ma, NDVI
```{r}
temp_split <- split(gssb_filt, gssb_filt$ID)
names(temp_split[[1]]) #PRIm 42, PRIm.ma 44, NDVIm 43, PRI0 47, PRI0.ma 48, PRIdelta 49, PRIdelta.ma 50


#PRIm 42
temp_ls <- lapply(temp_split, function(x){DayAve(x, 11, 15, "2019-05-11", "2019-09-04", 42, mean)})
for(i in 1:length(temp_ls)){
  temp_ls[[i]]$ID = names(temp_ls)[i]
}
PRIm_season <- do.call(rbind, temp_ls)
row.names(PRIm_season) <- NULL
head(PRIm_season)
#is there any NAs
sum(is.na(PRIm_season$Value))
names(PRIm_season)[2] <- "PRIm"
ggplot(PRIm_season, aes(x = Date, y = PRIm, color = ID)) + geom_point() + scale_color_d3() + theme_bw() + ylab("PRI") + ggtitle("Seasonal Change of PRI") + geom_smooth(se = FALSE)



#PRIm.ma 44
temp_ls <- lapply(temp_split, function(x){DayAve(x, 11, 15, "2019-05-11", "2019-09-04", 44, mean)})
for(i in 1:length(temp_ls)){
  temp_ls[[i]]$ID = names(temp_ls)[i]
}
PRIm.ma_season <- do.call(rbind, temp_ls)
row.names(PRIm.ma_season) <- NULL
head(PRIm.ma_season)
#is there any NAs
sum(is.na(PRIm.ma_season$Value))
names(PRIm.ma_season)[2] <- "PRIm.ma"
ggplot(PRIm.ma_season, aes(x = Date, y = PRIm.ma, color = ID)) + geom_point() + scale_color_d3() + theme_bw() + ylab("PRI") + ggtitle("Seasonal Change of PRI") + geom_smooth(se = FALSE)

#NDVIm 43
temp_ls <- lapply(temp_split, function(x){DayAve(x, 11, 15, "2019-05-11", "2019-09-04", 43, mean)})
for(i in 1:length(temp_ls)){
  temp_ls[[i]]$ID = names(temp_ls)[i]
}
NDVIm_season <- do.call(rbind, temp_ls)
row.names(NDVIm_season) <- NULL
head(NDVIm_season)
#is there any NAs
sum(is.na(NDVIm_season$Value))
names(NDVIm_season)[2] <- "NDVIm"
ggplot(NDVIm_season, aes(x = Date, y = NDVIm, color = ID)) + geom_point() + scale_color_d3() + theme_bw() + ylab("NDVI") + ggtitle("Seasonal Change of NDVI") + geom_smooth(se = FALSE)


```
###Merge all seasonal change df together
```{r}
df_season <- merge(PRImin_0.ma_season, PRImin_0_season, by = c("ID","Date"))
dim(df_season)
dim(PRImin_0_season)
head(df_season)

df_season <- merge(df_season, PRIdelta_season, by = c("ID","Date"))
df_season <- merge(df_season, PRIdelta.ma_season, by = c("ID","Date"))
df_season <- merge(df_season, PRIm_season, by = c("ID","Date"))
dim(PRIm_season)
df_season <- merge(df_season, PRIm.ma_season, by =  c("ID","Date"))
df_season <- merge(df_season, NDVIm_season, by = c("ID","Date"))
head(df_season)

```
###PRI and NDVI combined
```{r}
names(df_season)
df_season <- df_season %>% mutate(PRI.NDVI = PRIm/NDVIm, 
                                  PRI.NDVI.ma = PRIm.ma/NDVIm, 
                                  PRI_scale = (PRIm - min(PRIm, na.rm = TRUE))/(max(PRIm, na.rm = TRUE) - min(PRIm, na.rm = TRUE)), 
                                  NDVI_scale = (NDVIm - min(NDVIm, na.rm = TRUE))/(max(NDVIm, na.rm = TRUE) - min(NDVIm, na.rm = TRUE)),
                                  PRI.ma_scale = (PRIm.ma - min(PRIm.ma, na.rm = TRUE))/(max(PRIm.ma, na.rm = TRUE) - min(PRIm.ma, na.rm = TRUE)),
                                  PRI_NDVI_scale = PRI_scale - NDVI_scale, 
                                  PRI_NDVI.ma_scale = PRI.ma_scale - NDVI_scale,
                                  PRI.NDVI = PRI_scale/NDVI_scale,
                                  PRI.NDVI.ma = PRI.ma_scale/NDVI_scale, 
                                  PRI.NDVI_scale  = PRI_scale/NDVI_scale, 
                                  PRI.NDVI.ma_scale = PRI.ma_scale/NDVI_scale)
```



#Include physiology measurement
##Read data
```{r}
path_phys <- "C:/Users/zt92/Box Sync/BIOSTIMULANT TRIAL - SEASON 2/ZHEHAN/Physiology"
SWP_BA <- read_excel(file.path(path_phys, "SWP_2019_BlockAve.xlsx"))
NPQ_BA <- read_excel(file.path(path_phys, "NPQ_2019_BlockAve.xlsx"))
LICOR_BA <- read_excel(file.path(path_phys, "LICOR_2019_BlockAve.xlsx"))
FAPAR_BA <- read_excel(file.path(path_phys, "FAPAR_2019_BlockAve.xlsx"))
CHL_BA <- read_excel(file.path(path_phys, "CHL_2019_BlockAve.xlsx"))

#merge them together
phys_BA <- merge(SWP_BA, LICOR_BA, by = c("Date","BLOCK","PLOT","TREATMENT"))
phys_BA <- merge(phys_BA, FAPAR_BA, by = c("Date","BLOCK","PLOT","TREATMENT"))
phys_BA <- merge(phys_BA, CHL_BA, by = c("Date","BLOCK","PLOT","TREATMENT"))
phys_BA <- merge(phys_BA, NPQ_BA, by = c("Date","BLOCK","PLOT","TREATMENT"))
head(phys_BA)
dim(phys_BA)
str(phys_BA)

#change format
phys_BA$Date <- as.Date(phys_BA$Date)
phys_BA$BLOCK <- as.factor(phys_BA$BLOCK)
phys_BA$PLOT <- as.factor(phys_BA$PLOT)
phys_BA$TREATMENT <- as.factor(phys_BA$TREATMENT)

#add ID column
phys_BA$ID <- paste(phys_BA$BLOCK, phys_BA$TREATMENT, sep = " ")


```
##Combine with PRI data and weather data
```{r}
head(df_season)
head(phys_BA)
dim(df_season) #936,22
dim(phys_BA) #140, 12


unique(phys_BA$ID)
#trim the space
unique(df_season$ID)
df_season$ID <- trimws(df_season$ID, which = "right")

#merge together
df_PRI_phys <- merge(df_season, phys_BA, by = c("Date","ID"))
dim(df_PRI_phys)
unique(df_PRI_phys)

#merge with weather
df_PRI_weather <- merge(df_season, weather_season, by = c("Date"))
dim(df_PRI_weather)
dim(df_season)

#merge all together
phys_weather_PRI <- merge(df_PRI_phys, weather_season, by = c("Date"))
dim(phys_weather_PRI)
dim(df_PRI_phys)

```


#PRI and structureal effects
##PRI and NDVI
```{r}
names(df_PRI_weather)
#PRI seasonal change
ggplot(df_PRI_weather, aes(x = Date, y = PRIm.ma)) + geom_line(aes(color = ID)) +scale_color_d3() + theme_bw()
ggplot(df_PRI_weather, aes(x = Date, y = NDVIm)) + geom_line(aes(color = ID), size =1) +scale_color_d3() + theme_bw() + ylab("NDVI") + geom_vline(xintercept = as.Date(c("2019-05-31","2019-06-11","2019-06-25")), color = "darkgreen", linetype = "dashed") + geom_vline(xintercept = as.Date(c("2019-07-17","2019-07-25","2019-08-01","2019-08-08","2019-08-14")), color = "orange", linetype = "dashed")

#PRI vs NDVI
##Before 07-01
ggplot(subset(df_PRI_weather,Date<"2019-07-01"), aes(x = NDVIm, y = PRIm)) + geom_point(aes(color = ID)) + scale_color_d3() + theme_bw() + geom_smooth(method = "lm", formula = y~x) + xlab("NDVI") + ylab("PRI") + ggtitle("Before Maximum Canopy Cover")
ggplot(subset(df_PRI_weather,Date<"2019-07-01"), aes(x = NDVIm, y = PRIm)) + geom_point(aes(color = ID)) + scale_color_d3() + theme_bw() + geom_smooth()
lm1 <- lm(PRIm~NDVIm, data= subset(df_PRI_weather, Date < "2019-07-01"))
summary(lm1)
##After 07-01
ggplot(subset(df_PRI_weather,Date>"2019-07-01" & ID!= "4 CONTROL DDD"), aes(x = NDVIm, y = PRIm)) + geom_point(aes(color = ID)) + scale_color_d3() + theme_bw() + geom_smooth(method = "lm", formula = y~x)+ xlab("NDVI") + ylab("PRI") + ggtitle("After Maximum Canopy Cover")
lm2 <- lm(PRIm~NDVIm, data= subset(df_PRI_weather, Date > "2019-07-01"& ID!= "4 CONTROL DDD"))
summary(lm2)

#PRI vs Chlorophyll content
ggplot(subset(df_PRI_phys,Date>"2019-07-01"), aes(x = CHL, y = PRIm)) + geom_point(aes(color = as.factor(Date))) + scale_color_d3() + theme_bw() + geom_smooth(method = "lm", formula = y~x) + xlab("Chlorophyll Content (ug cm-2)") + ylab("PRI")
lm3 <- lm(PRIm~CHL, data =subset(df_PRI_phys, Date>"2019-07-01"))
summary(lm3)



#PRI0 vs NDVI
ggplot(subset(df_PRI_weather,Date<"2019-07-01"), aes(x = NDVIm, y = PRI0.ma)) + geom_point(aes(color = ID)) + scale_color_d3() + theme_bw() + geom_smooth(method = "lm", formula = y~x) + xlab("NDVI") + ylab("PRI0") + ggtitle("Before Maximum Canopy Cover")
ggplot(subset(df_PRI_weather,Date>"2019-07-01"), aes(x = NDVIm, y = PRI0.ma)) + geom_point(aes(color = ID)) + scale_color_d3() + theme_bw() + geom_smooth(method = "lm", formula = y~x) + xlab("NDVI") + ylab("PRI0") + ggtitle("After Maximum Canopy Cover")
ggplot(subset(df_PRI_weather), aes(x = NDVIm, y = PRI0.ma)) + geom_point(aes(color = ID)) + scale_color_d3() + theme_bw() + geom_smooth(method = "lm", formula = y~x) + xlab("NDVI") + ylab("PRI0") 
lm4 <- lm(PRI0.ma~NDVIm, data = df_PRI_weather)
summary(lm4)

#PRImin-PRI0.ma vs NDVI
ggplot(subset(df_PRI_weather), aes(x = NDVIm, y = PRImin_PRI0.ma)) + geom_point(aes(color = ID)) + scale_color_d3() + theme_bw() + geom_smooth(method = "lm", formula = y~x) + xlab("NDVI") + ylab("PRImin - PRI0") + ylim(-0.1,0.025) 
ggplot(subset(df_PRI_weather), aes(x = NDVIm, y = PRImin_PRI0.ma)) + geom_point(aes(color = ID)) + scale_color_d3() + theme_bw() + geom_smooth(method = "lm", formula = y~x) + xlab("NDVI") + ylab("PRImin - PRI0") 

#PRImin
ggplot(subset(df_PRI_weather), aes(x = NDVIm, y = PRImin.ma)) + geom_point(aes(color = ID)) + scale_color_d3() + theme_bw() + geom_smooth(method = "lm", formula = y~x) + xlab("NDVI") + ylab("PRImin") 

#PRIscale-NDVIscale
ggplot(subset(df_PRI_weather), aes(x = NDVIm, y = PRI_NDVI.ma_scale)) + geom_point(aes(color = ID)) + scale_color_d3() + theme_bw() + geom_smooth(method = "lm", formula = y~x) + xlab("NDVI") + ylab("PRIcor") 
lm5 <- lm(PRI_NDVI.ma_scale ~ NDVIm, data = df_PRI_weather)
summary(lm5)

#PRIscale/NDVIscale
ggplot(subset(df_PRI_weather), aes(x = NDVIm, y = PRI.NDVI.ma_scale)) + geom_point(aes(color = ID)) + scale_color_d3() + theme_bw() + geom_smooth(method = "lm", formula = y~x) + xlab("NDVI") + ylab("PRIcor") + ylim(c(0, 10))


#PRI
names(df_PRI_weather)
```
##PRI and Chlorophyll
```{r}
names(df_PRI_phys)





ggplot(df_PRI_phys, aes(x = Photo, y= PRImin_PRI0.ma)) + geom_point(aes(color = ID)) + scale_color_d3() + theme_bw()
lm1

ggplot(subset(df_PRI_phys, Date>="2019-07-01"), aes(y = SWP, x= PRI_NDVI.ma_scale)) + geom_point(aes(color = as.factor(Date))) + scale_color_d3() + theme_bw() + geom_smooth(method = "lm")

ggplot(subset(df_PRI_phys, Date<="2019-07-01"), aes(y = SWP, x= PRI_NDVI.ma_scale)) + geom_point(aes(color = as.factor(Date))) + scale_color_d3() + theme_bw() + geom_smooth(method = "lm")

```


#PRI and weather conditions

##Seasonal Average
```{r}
ggplot(df_PRI_weather, aes(y = PRI_NDVI.ma_scale, x = AirTemp.noon)) + geom_point(aes(color = ID)) + theme_bw() + scale_color_d3() + geom_smooth(method=  "lm", formula = y~x+I(1/x)) + xlab("Air Temperature (°C)") + ylab("PRIscale -  NDVIscale") + ggtitle("Seasonal Mean Air Temperature")
lm6 <- lm(PRI_NDVI.ma_scale~AirTemp.noon, data = df_PRI_weather)
summary(lm6)  #R2=0.235
lm7 <- lm(PRI_NDVI.ma_scale~AirTemp.noon+I(1/AirTemp.noon), data = df_PRI_weather)
summary(lm7)  #R2=0.293, RSE = 0.1483

ggplot(df_PRI_weather, aes(y = PRI_NDVI.ma_scale, x = VPD.noon)) + geom_point(aes(color = ID)) + theme_bw() + scale_color_d3() + geom_smooth(method=  "lm", formula = y~x+I(1/x)) + xlab("Vapor Pressure Deficit (kPa)") + ylab("PRIscale -  NDVIscale")+ggtitle("Seasonal Mean VPD")
lm8 <- lm(PRI_NDVI.ma_scale~VPD.noon, data = df_PRI_weather)
summary(lm8)  #R2=0.1385
lm9 <- lm(PRI_NDVI.ma_scale~VPD.noon+I(1/VPD.noon), data = df_PRI_weather)
summary(lm9)  #R2=0.212, RSE = 0.1565

ggplot(df_PRI_weather, aes(y = PRImin_PRI0.ma, x = AirTemp.noon)) + geom_point(aes(color = ID)) + theme_bw() + scale_color_d3() + geom_smooth(method=  "lm", formula = y~x+I(1/x)) + xlab("Air Temperature (°C)") + 


dim(df_PRI_weather) #936, 28
names(df_PRI_weather)
plot(y = df_PRI_weather$PRImin_PRI0.ma, x = df_PRI_weather$AirTemp.noon, ylim = c(-0.1,0.025))
ggplot(subset(df_PRI_weather, PRImin_PRI0.ma > -0.1), aes(x = VPD.noon, y = PRImin_PRI0.ma)) + geom_point(aes(color = ID)) + theme_bw() + scale_color_d3() + geom_smooth(se = FALSE, method= "lm", formula = y~x)
ggplot(subset(df_PRI_weather, PRImin_PRI0.ma > -0.1), aes(x = VPD.all, y = PRImin_PRI0.ma)) + geom_point(aes(color = ID)) + theme_bw() + scale_color_d3() + geom_smooth(se = FALSE, method= "lm", formula = y~x)
ggplot(subset(df_PRI_weather, PRImin_PRI0.ma > -0.1), aes(x = AirTemp.all, y = PRImin_PRI0.ma)) + geom_point(aes(color = ID)) + theme_bw() + scale_color_d3() + geom_smooth(se = FALSE, method= "lm", formula = y~x)
ggplot(subset(df_PRI_weather, PRImin_PRI0.ma > -0.1), aes(x = AirTemp.noon, y = PRImin_PRI0.ma)) + geom_point(aes(color = ID)) + theme_bw() + scale_color_d3() + geom_smooth(se = FALSE,method= "lm", formula = y~x)
ggplot(subset(df_PRI_weather, PRImin_PRI0.ma > -0.1), aes(x = AirTemp.noon, y = PRImin_PRI0.ma)) + geom_point(aes(color = ID)) + theme_bw() + scale_color_d3() + geom_smooth(se = FALSE)



ggplot(df_PRI_weather, aes(x = AirTemp.noon, y = PRI_NDVI.ma_scale)) + geom_point(aes(color = ID)) + theme_bw()+scale_color_d3() + geom_smooth(method = "lm", formula = y~x)
names(df_PRI_weather)
ggplot(df_PRI_weather, aes(x = AirTemp.noon, y = PRI_NDVI.ma_scale)) + geom_point(aes(color = ID)) + theme_bw()+scale_color_d3() + geom_smooth(se = TRUE, method = "lm", formula = y~I(1/x))

```
###Diurnally (Not finished)
```{r}

ggplot(subset(gssb_filt, Date == "2019-06-05" & Time < 17), aes(x = Time, y = AirTemp)) + geom_line()


names(gssb_filt)
p1 <- ggplot(subset(gssb_filt, Date == "2019-08-05" & Time < 17), aes(x = Time, y = PRIdelta.ma)) + geom_point(aes(color = ID)) + scale_color_d3() + theme_bw()
p1
p1 + geom_line(aes(y = AirTemp*0.003-0.085))+ scale_y_continuous(sec.axis = sec_axis(~(.+0.085)/0.003))
names(gssb_filt)
ggplot(gssb_filt, aes(x = VPD, y = PRIm)) + geom_point(aes(color = as.factor(BLOCK), shape = TREATMENT)) + theme_bw() + ylim(-0.2,0.2)
```

#PRI and Biophysical Parameters
```{r}
names(phys_weather_PRI)

#SWP
ggplot(phys_weather_PRI, aes(x = Date , y= -SWP, color =ID)) + geom_point() + scale_color_d3() + theme_bw()
ggplot(phys_weather_PRI, aes(x = Date , y= PRI_NDVI_scale, color =ID)) + geom_point() + scale_color_d3() + theme_bw()
ggplot(df_PRI_weather, aes(x = Date, y = PRI_NDVI_scale, color = ID)) + geom_point() + scale_color_d3()+theme_bw()
ggplot()


ggplot(phys_weather_PRI, aes(x = SWP, y = PRIm)) + geom_point(aes(color = ID)) + scale_color_d3() + theme_bw()
ggplot(phys_weather_PRI, aes(x = SWP, y = PRImin_PRI0.ma)) + geom_point(aes(color = ID)) + scale_color_d3() + theme_bw() + geom_smooth()


ggplot(subset(phys_weather_PRI,Date>"2019-07-01"), aes(x = SWP, y = PRIm)) + geom_point(aes(color = as.factor(Date))) + scale_color_d3() + theme_bw() + geom_smooth(method = "lm")
#PRI and SWP
ggplot(subset(phys_weather_PRI), aes(x = -SWP, y = PRIm)) + geom_point(aes(color = as.factor(Date))) + scale_color_d3() + theme_bw() + geom_smooth(method = "lm") + xlab("Stem Water Potential (Bars)") + ylab("PRI")
lm9 <- lm(PRIm~SWP, data = subset(phys_weather_PRI))
summary(lm9) #R2=0.5542, n = 40

ggplot(df_PRI_weather, aes(x =Date,y=PRI_NDVI.ma_scale)) + geom_point(aes(color = ID)) + scale_color_d3() + theme_bw() + geom_smooth(se =  FALSE) + ylab("PRIscale-NDVIscale")
ggplot(subset(phys_weather_PRI,Date>"2019-07-01"), aes(x = -SWP, y = PRIm)) + geom_point(aes(color = as.factor(Date))) + scale_color_d3() + theme_bw() + geom_smooth(method = "lm") + xlab("Stem Water Potential (Bars)") + ylab("PRI")
lm10 <- lm(PRIm~SWP, data = subset(phys_weather_PRI,Date>"2019-07-01"))
summary(lm10) #R2=0.5542, n = 40
ggplot(subset(phys_weather_PRI,Date<"2019-07-01"), aes(x = SWP, y = PRI_NDVI.ma_scale)) + geom_point(aes(color = as.factor(Date))) + scale_color_d3() + theme_bw() + geom_smooth(method = "lm")
lm11 <- lm(PRI_NDVI.ma_scale~SWP, data = subset(phys_weather_PRI,Date>"2019-07-01"))
summary(lm11) #R2=0.3547

ggplot(subset(phys_weather_PRI,Date>"2019-07-01"), aes(x = Cond, y = PRIm)) + geom_point(aes(color = as.factor(Date))) + scale_color_d3() + theme_bw() + geom_smooth(method = "lm") 

#ggplot(subset(phys_weather_PRI,Date>"2019-07-01"), aes(x = NPQ, y = PRIm)) + geom_point(aes(color = as.factor(Date))) + scale_color_d3() + theme_bw() + geom_smooth(method = "lm")



ggplot(phys_weather_PRI, aes(x = SWP, y = PRIdelta)) + geom_point(aes(color = as.factor(Date))) + scale_color_d3() + theme_bw() + geom_smooth()

#Conductance
ggplot(phys_weather_PRI, aes(x = Cond, y = PRIm)) + geom_point(aes(color = as.factor(Date))) + scale_color_d3() + theme_bw() + geom_smooth(formula = y~x, method= "lm")+ xlab("Stomatal Conductance (mmol m-2 s-1)")+ylab("PRI")
lm12 <- lm(PRIm~Cond, data = subset(phys_weather_PRI))
summary(lm12) #R2=0.2414
ggplot(subset(phys_weather_PRI, Date >"2019-07-01"), aes(x = Cond, y = PRIm)) + geom_point(aes(color = as.factor(Date))) + scale_color_d3() + theme_bw() + geom_smooth(formula = y~x, method= "lm")+ xlab("Stomatal Conductance (mmol m-2 s-1)")+ylab("PRI")
lm13 <- lm(PRIm~Cond, data = subset(phys_weather_PRI, Date >"2019-07-01" ))
summary(lm13) #R2=0.2728


ggplot(phys_weather_PRI, aes(x = Cond, y = PRIdelta)) + geom_point(aes(color = as.factor(Date))) + scale_color_d3() + theme_bw() + geom_smooth(method = "lm") + xlab("Stomatal Conductance (mmol m-2 s-1)")+ylab("PRIdelta")




ggplot(phys_weather_PRI, aes(x = Cond, y = PRImin_PRI0.ma)) + geom_point(aes(color = as.factor(Date))) + scale_color_d3() + theme_bw() + geom_smooth(formula = y~x, method= "lm")
ggplot(phys_weather_PRI, aes(x = Cond, y = PRI_NDVI_scale)) + geom_point(aes(color = as.factor(Date))) + scale_color_d3() + theme_bw() + geom_smooth(formula = y~x, method= "lm")

#NPQ
ggplot(phys_weather_PRI, aes(x = NPQ, y = PRI_NDVI_scale)) + geom_point(aes(color = as.factor(Date))) + scale_color_d3() + theme_bw() + geom_smooth(formula = y~x, method= "lm")
ggplot(phys_weather_PRI, aes(x = NPQ, y = PRIm)) + geom_point(aes(color = as.factor(Date))) + scale_color_d3() + theme_bw() + geom_smooth(formula = y~x, method= "lm")
ggplot(phys_weather_PRI, aes(x = NPQ, y = PRI.NDVI.ma_scale)) + geom_point(aes(color = as.factor(Date))) + scale_color_d3() + theme_bw() + geom_smooth(formula = y~x, method= "lm")
ggplot(phys_weather_PRI, aes(x = NPQ, y = PRI0)) + geom_point(aes(color = as.factor(Date))) + scale_color_d3() + theme_bw() + geom_smooth(formula = y~x, method= "lm")





ggplot(phys_weather_PRI, aes(x = PRI_NDVI.ma_scale, y = SWP)) + geom_point(aes(color = ID)) + scale_color_d3() + theme_bw()
ggplot(phys_weather_PRI, aes(x = PRI_NDVI.ma_scale, y = SWP)) + geom_point(aes(color = ID)) + scale_color_d3() + theme_bw()

#Cond
ggplot()
```

```{r}
cor1 <- cor(phys_weather_PRI[,c(26:38)], phys_weather_PRI$PRImin.ma,use = "complete.obs")
chart.Correlation(phys_weather_PRI[,c(3,26:38)], histogram = FALSE)

cor2 <- cor(phys_weather_PRI[,c(26:38)], phys_weather_PRI$PRI0.ma,use = "complete.obs")
cor2
chart.Correlation(phys_weather_PRI[,c(4,26:38)], histogram = FALSE)

cor3 <- cor(subset(phys_weather_PRI,Date!= "2019-05-31")[,c(26:38)], subset(phys_weather_PRI,Date!="2019-05-31")$PRImin_PRI0.ma,use = "complete.obs")
cor3
chart.Correlation(subset(phys_weather_PRI, Date!= "2019-05-31")[,c(5,26:38)], histogram = FALSE)


```

```{r}
res <- rcorr(as.matrix(phys_weather_PRI[,-c(1,2,23,24,25)]))
res
chart.Correlation(phys_weather_PRI[,-c(1,2,23,24,25)], histogram = FALSE, pch = 19)

```

##Plots
```{r}
#correlations
names(phys_weather_PRI)
str(phys_weather_PRI)

a <- cor(phys_weather_PRI[,-c(1,2,23,24,25)])
corrplot(a, type ="upper",  col = brewer.pal(n =8, name = "RdYlBu"))
ggplot(phys_weather_PRI, aes(x = PRI_NDVI_scale, y = -SWP)) + geom_point(aes(color = as.factor(Date)))+scale_color_d3() + geom_smooth(method = "lm") + ylab("Stem Water Potential (Bars)") + xlab("PRIsc-NDVIsc") + theme_bw()

cor1 <- cor(phys_weather_PRI[,c(26:38)], phys_weather_PRI$PRImin.ma,use = "complete.obs")
cor1
corrplot(cor1)

plot(phys_weather_PRI$PRImin.ma)


ggplot(subset(gs_daily_swp, Date != "2019-05-31"), aes(x = Date, y = PRI_NDVI_scale, color = ID)) + geom_point() + scale_color_d3()
ggplot(subset(gs_daily_swp, Date != "2019-05-31"), aes(x = Date, y = -SWP, color = ID)) + geom_point() + scale_color_d3()

ggplot(subset(gs_daily_swp, Date != "2019-05-31"), aes(y = -SWP, x = PRI_NDVI_scale)) + geom_point(aes(color = as.factor(Date))) + scale_color_d3() + geom_smooth(method = "lm") + ylab("Stem Water Potential (Bars)") + xlab("PRIsc-NDVIsc")


lm1 <- lm(-SWP~PRI_NDVI_scale, subset(gs_daily_swp, Date != "2019-05-31"))
summary(lm1)
cor(subset(gs_daily_swp, Date != "2019-05-31")$PRI_NDVI_scale, subset(gs_daily_swp, Date != "2019-05-31")$SWP)^2

```
##Predict functions
###SWP
```{r}
names(phys_weather_PRI)
#PRIm
lmSWP2 <- lm(-SWP~PRIm+NDVIm+Radiation.noon+VPD.noon+AirTemp.noon, data = phys_weather_PRI)
summary(lmSWP2) #0.5098
lmSWP2 <- lm(-SWP~PRIm+Radiation.noon+VPD.noon+AirTemp.noon, data = phys_weather_PRI)
summary(lmSWP2) #0.5098
plot(lmSWP2$fitted.values, -phys_weather_PRI$SWP)
res_modelSWP <- data.frame


#PRI_NDVI_scale
lmSWP3 <- lm(-SWP~PRI_NDVI.ma_scale+Radiation.noon+VPD.noon+AirTemp.noon, data = phys_weather_PRI)
summary(lmSWP3) #0.3526

#PRI.NDVI
lmSWP3 <- lm(-SWP~PRIm+PRI.NDVI.ma+Radiation.noon+VPD.noon+AirTemp.noon, data = phys_weather_PRI)
summary(lmSWP3) #0.4252
plot(lmSWP3)

lmSWP3 <- lm(-SWP~PRI.NDVI+Radiation.noon+AirTemp.noon+AirTemp.noon, data = phys_weather_PRI)
summary(lmSWP3) #0.3356

#PRImin_PRI0.ma
lmSWP4 <- lm(-SWP~PRImin_PRI0.ma+Radiation.noon+VPD.noon+AirTemp.noon, data = phys_weather_PRI)
summary(lmSWP4) #0.2598

#PRI.NDVI, PRImin_PRI0.ma
lmSWP5 <- lm(-SWP~PRImin_PRI0.ma+PRI.NDVI.ma+Radiation.noon+VPD.noon+AirTemp.noon, data = phys_weather_PRI)
summary(lmSWP5) #0.4313

#

```

```{r}
lmCond <- lm(Cond~PRIm+NDVIm+VPD.noon+Radiation.noon+AirTemp.noon, data = phys_weather_PRI)
summary(lmCond)
lmSWP <- lm(SWP~PRIm+NDVIm+VPD.noon+Radiation.noon, data = phys_weather_PRI)
summary(lmSWP)

lmSWP2 <- lm(SWP~PRIm+NDVIm+Radiation.noon+, data = phys_weather_PRI)
summary(lmSWP2)

fullmodel_lmSWP <- lm(SWP~PRIm+NDVIm+PRI.NDVI+Radiation.noon+VPD.noon+AirTemp.noon, data= phys_weather_PRI)
stepmodel_lmSWP <- stepAIC(fullmodel_lmSWP, direction = "both", trace = FALSE)
summary(stepmodel_lmSWP)

stepmodel_lmSWP <- stepAIC(fullmodel_lmSWP, direction = "both", trace = FALSE)


fullmodel_lmSWP2 <- lm(SWP~PRI_NDVI.ma_scale+PRI.NDVI.ma+PRIdelta.ma+PRImin_PRI0.ma+Radiation.noon+VPD.noon+AirTemp.noon, data= phys_weather_PRI)
stepmodel_lmSWP2 <- stepAIC(fullmodel_lmSWP2, direction = "both", trace = FALSE)
summary(stepmodel_lmSWP2)
stepmodel_lmSWP2$coefficients
plot(stepmodel_lmSWP2$fitted.values, phys_weather_PRI$SWP)

modelSWP <- regsubsets(SWP~PRI_NDVI.ma_scale+PRI.NDVI.ma+PRIdelta.ma+PRImin_PRI0.ma+Radiation.noon+VPD.noon+AirTemp.noon, data = phys_weather_PRI, nvmax = 4,method = "exhaustive")
summary(modelSWP, all.best = TRUE)


```

##ANCOVA
```{r}
lm15 <- lm(PRI_NDVI.ma_scale ~ Radiation.noon + TREATMENT, data = df_PRI_weather)
summary(lm15)
anova(lm15)
Anova(lm15)

lm16 <- lm(PRI_NDVI.ma_scale ~ Radiation.noon + TREATMENT, data = subset(df_PRI_weather, TREATMENT != "CONTROL DDD"))
summary(lm16)
anova(lm16)

lm17 <- lm(PRI_NDVI.ma_scale ~ AirTemp.noon + TREATMENT, data = subset(df_PRI_weather, TREATMENT != "CONTROL DDD"))
summary(lm17)
anova(lm17)

lm18 <- lm(PRI_NDVI.ma_scale ~ VPD.noon + TREATMENT, data = subset(df_PRI_weather, TREATMENT != "CONTROL DDD"))
summary(lm18)
anova(lm18)



res.aov <- df_PRI_weather %>% anova_test(PRI_NDVI.ma_scale ~ Radiation.noon + TREATMENT)
res.aov
get_anova_table(res.aov)

pwc <- df_PRI_weather %>% emmeans_test(PRI_NDVI.ma_scale ~ TREATMENT, covariate = Radiation.noon, p.adjust.method = "bonferroni")
pwc

ggplot(df_PRI_weather, aes(x = Radiation.noon, y = PRImin_PRI0.ma, shape = TREATMENT))+geom_point(aes(color = TREATMENT))+theme_bw()+facet_wrap(~BLOCK)+geom_smooth(method = "lm", aes(color = TREATMENT), se = FALSE) + xlab("Radiation (W/m2)") + ylab("PRIscale-NDVIscale")

ggplot(df_PRI_weather, aes(x = Radiation.noon, y = PRI_NDVI.ma_scale, shape = TREATMENT))+geom_point(aes(color = TREATMENT))+theme_bw()+geom_smooth(method = "lm", aes(color = TREATMENT), se = FALSE) + xlab("Radiation (W/m2)") + ylab("PRIscale-NDVIscale") + facet_wrap(~BLOCK)


```

##Mixed-effect model
```{r}
gs_daily$BLOCK <- sapply(strsplit(gs_daily$ID, split = " "),'[',1)

df_PRI_weather$BLOCK <- sapply(strsplit(df_PRI_weather$ID, split = " "),"[",1)
df_PRI_weather$BLOCK <- as.factor(df_PRI_weather$BLOCK)
df_PRI_weather$TREATMENT <- sapply(strsplit(df_PRI_weather$ID, split = " "),"[",2)
df_PRI_weather$TREATMENT <- substr(df_PRI_weather$ID, start = 3, stop = nchar(df_PRI_weather$ID))
df_PRI_weather$TREATMENT <- as.factor(df_PRI_weather$TREATMENT)
unique(df_PRI_weather$TREATMENT)

names(df_PRI_weather)

mixlm1 <- lmer(PRIm~Radiation.noon+TREATMENT+(1|BLOCK), data = df_PRI_weather, REML = FALSE)
summary(mixlm1)
plot(mixlm1)
qqnorm(resid(mixlm1))
qqline(resid(mixlm1))
anova(mixlm1)
Anova(mixlm1)

mixlm2 <- lmer(PRI_NDVI_scale~Radiation.noon+TREATMENT+(1|BLOCK), data = df_PRI_weather, REML = FALSE)
mixlm3 <- lm(PRI_NDVI_scale~Radiation.noon+TREATMENT, data = df_PRI_weather)
anova(mixlm2, mixlm3)
summary(mixlm2)
qqnorm(resid(mixlm2))
qqline(resid(mixlm2))
res_mixlm2 <- analyze(mixlm2, CI=95)


ggplot(df_PRI_weather, aes(x = Radiation.all, y = PRIdelta)) + geom_point(aes(color = ID))
ggplot(df_PRI_weather, aes(x = Radiation.noon, y = PRI_NDVI_scale)) + geom_point(aes(color = ID))+geom_smooth(method = "lm", formula = y~I(1/x))

```

##SWP
```{r}
path_phys <- "C:/Users/zt92/Box Sync/BIOSTIMULANT TRIAL - SEASON 2/ZHEHAN/Physiology"
SWP_stands <- read_excel(file.path(path_phys, "SWP_stands.xlsx"))

head(SWP_stands)
unique(SWP_stands$TREATMENT)
str(SWP_stands)

SWP_stands$Date <- as.Date(SWP_stands$Date)
SWP_stands$ID <- paste(SWP_stands$BLOCK, SWP_stands$TREATMENT, sep = " ")
unique(SWP_stands$ID)

#trim the space 
gs_daily$ID <- trimws(gs_daily$ID, which  = "right")

#merge 
gs_daily_swp <- merge(gs_daily, SWP_stands, by = c("ID","Date"))
dim(gs_daily_swp)
dim(gs_daily)
dim(SWP_stands)

#plot
ggplot(subset(gs_daily_swp, Date != "2019-05-31"), aes(x = Date, y = PRI_NDVI_scale, color = ID)) + geom_point() + scale_color_d3()
ggplot(subset(gs_daily_swp, Date != "2019-05-31"), aes(x = Date, y = -SWP, color = ID)) + geom_point() + scale_color_d3()

ggplot(subset(gs_daily_swp, Date != "2019-05-31"), aes(y = -SWP, x = PRI_NDVI_scale)) + geom_point(aes(color = as.factor(Date))) + scale_color_d3() + geom_smooth(method = "lm") + ylab("Stem Water Potential (Bars)") + xlab("PRIsc-NDVIsc")
ggplot(subset(gs_daily_swp, Date != "2019-05-31"), aes(y = -SWP, x = PRI_NDVI_scale)) + geom_point(aes(color = as.factor(Date))) + scale_color_d3() + geom_smooth(method = "lm") + ylab("Stem Water Potential (Bars)") + xlab("PRIsc-NDVIsc")

ggplot(subset(gs_daily_swp), aes(y = -SWP, x = PRI_NDVI_scale)) + geom_point(aes(color = as.factor(Date))) + scale_color_d3() + geom_smooth(method = "lm") + ylab("Stem Water Potential (Bars)") + xlab("PRIsc-NDVIsc")



lm1 <- lm(-SWP~PRI_NDVI_scale, subset(gs_daily_swp, Date != "2019-05-31"))
summary(lm1)
cor(subset(gs_daily_swp, Date != "2019-05-31")$PRI_NDVI_scale, subset(gs_daily_swp, Date != "2019-05-31")$SWP)^2
```
#Soil Moisture data 
```{r}
path_stands <- "C:/Users/zt92/Box Sync/BIOSTIMULANT TRIAL - SEASON 2/ZHEHAN/Stands"


gssoil <- read.csv(file.path(path_stands, "S.STANDS.Soil.csv"))
names(gssoil)[3] <- "TIMESTAMP"
gssoil$TIMESTAMP <- as.POSIXct(gssoil$TIMESTAMP, format = "%m/%d/%Y %H:%M")
gssoil <- gssoil %>% mutate(Date = date(TIMESTAMP),
                            Time = hour(TIMESTAMP)+minute(TIMESTAMP)/60+second(TIMESTAMP)/3600,
                            ID = paste(BLOCK, TREATMENT, by = " "))
head(gssoil)
#remove the days
gssoil <- subset(gssoil, Date >= "2019-05-11" & Date <= "2019-09-04")

hist(gssoil$VWC)
#remove the outliers
gssoil <- subset(gssoil, VWC<800 & VWC > 0)
#remove the cimis one
gssoil <- subset(gssoil, TREATMENT != "CIMIS")

#calculate daily data
##subset to 5am-6am in the morning
gssoil_morn <- subset(gssoil, Time >= 5 & Time <=6)
VWC_daily <- aggregate(gssoil_morn$VWC, list("Date"=gssoil_morn$Date, "ID"=gssoil_morn$ID, "BLOCK"=gssoil_morn$BLOCK, "TREATMENT"=gssoil_morn$TREATMENT), function(x){mean(x, na.rm = TRUE)})
names(VWC_daily)[5] <- "VWC_morn"
ggplot(VWC_daily, aes(x = Date, y = VWC_morn)) + geom_point(aes(color = ID)) + theme_bw() + scale_color_d3() + facet_wrap(~TREATMENT,nrow = 3)+ylim(0.2, 0.35)+geom_vline(xintercept=as.Date(c("2019-07-07","2019-08-26")), linetype="dashed")
ggplot(VWC_daily, aes(x = Date, y = VWC_morn)) + geom_point(aes(color = ID)) + theme_bw() + scale_color_d3() + facet_wrap(~TREATMENT)+ylim(0.2, 0.35)+geom_vline(xintercept=as.Date(c("2019-07-07","2019-08-26")), linetype="dashed")

##only Control DDD 
ggplot(subset(VWC_daily,TREATMENT == "CONTROL DDD"), aes(x = Date, y = VWC_morn)) + geom_point(aes(color = ID)) + theme_bw() + scale_color_d3() +ylim(0.2, 0.35) + geom_vline(xintercept=as.Date(c("2019-07-07","2019-08-26")), linetype="dashed")


```


#Include UAV data
##Shapefiles
```{r}
path_shp <- "C:/Users/zt92/Box Sync/BIOSTIMULANT TRIAL - SEASON 2/ZHEHAN/tomato_GCPs"
sensors_shp <- shapefile(file.path(path_shp, "sensors_tomato_2019.shp"))

path_macaw <- "C:/Users/zt92/Box Sync/BIOSTIMULANT FIELD SCREENING MASTER FOLDER/DRONE/macaw_pri"
macaw_pri_062819 <- raster(file.path(path_macaw, 'pri_062819.tif'))
macaw_pri_080219 <- raster(file.path(path_macaw, 'pri_080219.tif'))
macaw_pri_081019 <- raster(file.path(path_macaw, 'pri_081019.tif'))
macaw_pri_081519 <- raster(file.path(path_macaw, 'pri_081519.tif'))
macaw_pri_082219 <- raster(file.path(path_macaw, 'pri_082219.tif'))

uav_pri_062819 <- extract()

```

#---------------------------------------------------------#
#Not Useful at present, delete later
```{r}

#Seasonal Change of NDVI
temp_ls <- lapply(temp_split, function(x){NDVIm_dayave(x, 11, 15, "2019-05-07", "2019-09-05")})
for(i in 1:length(temp_ls)){
  temp_ls[[i]]$ID = names(temp_ls)[i]
}
NDVIm_daily <- do.call(rbind, temp_ls)
row.names(NDVIm_daily) <- NULL
ggplot(NDVIm_daily, aes(x = Date, y = NDVIm, color = ID)) + geom_line(size = 1) + scale_color_d3()+ylab("NDVI")+ggtitle("NDVI Seasonal Change")

#merge daily NDVI and daily PRI
gs_daily <- merge(PRIm_daily, NDVIm_daily, by = c("Date","ID"))
#add block name
gs_daily$BLOCK <- sapply(strsplit(gs_daily$ID, split = " "),'[',1)

#Divide into different blocks
##PRI
p1 = ggplot(subset(gs_daily, BLOCK == 2), aes(x = Date, y = PRIm, color = ID)) + geom_line(size = 1) + scale_color_d3()+ylab("PRI")+ggtitle("PRI Seasonal Change Block 2") + ylim(-0.1, 0.04)
p2 = ggplot(subset(gs_daily, BLOCK == 4), aes(x = Date, y = PRIm, color = ID)) + geom_line(size = 1) + scale_color_d3()+ylab("PRI")+ggtitle("PRI Seasonal Change Block 4")+ ylim(-0.1, 0.04)
p3 = ggplot(subset(gs_daily, BLOCK == 5), aes(x = Date, y = PRIm, color = ID)) + geom_line(size = 1) + scale_color_d3()+ylab("PRI")+ggtitle("PRI Seasonal Change Block 5")+ ylim(-0.1, 0.04)
grid.arrange(p1,p2,p3,nrow=3)
##NDVI
p1 = ggplot(subset(gs_daily, BLOCK == 2), aes(x = Date, y = NDVIm, color = ID)) + geom_line(size = 1) + scale_color_d3()+ylab("NDVI")+ggtitle("NDVI Seasonal Change Block 2")
p2 = ggplot(subset(gs_daily, BLOCK == 4), aes(x = Date, y = NDVIm, color = ID)) + geom_line(size = 1) + scale_color_d3()+ylab("NDVI")+ggtitle("NDVI Seasonal Change Block 4")
p3 = ggplot(subset(gs_daily, BLOCK == 5), aes(x = Date, y = NDVIm, color = ID)) + geom_line(size = 1) + scale_color_d3()+ylab("NDVI")+ggtitle("NDVI Seasonal Change Block 5")
grid.arrange(p1,p2,p3,nrow=3)
```
###PRI/NDVI
```{r}
gs_daily <- gs_daily %>% mutate(PRI.NDVI = PRIm/NDVIm)

##Plot
p1 = ggplot(subset(gs_daily, BLOCK == 2), aes(x = Date, y = PRI.NDVI, color = ID)) + geom_line(size = 1) + scale_color_d3()+ylab("PRI/NDVI")+ggtitle("PRI/NDVI Seasonal Change Block 2")
p2 = ggplot(subset(gs_daily, BLOCK == 4), aes(x = Date, y = PRI.NDVI, color = ID)) + geom_line(size = 1) + scale_color_d3()+ylab("PRI/NDVI")+ggtitle("PRI/NDVI Seasonal Change Block 4")
p3 = ggplot(subset(gs_daily, BLOCK == 5), aes(x = Date, y = PRI.NDVI, color = ID)) + geom_line(size = 1) + scale_color_d3()+ylab("PRI/NDVI")+ggtitle("PRI/NDVINDVI Seasonal Change Block 5")
grid.arrange(p1,p2,p3,nrow=3)

##Subset after June
p1 = ggplot(subset(gs_daily, BLOCK == 2 & Date >= "2019-05-31"), aes(x = Date, y = PRI.NDVI, color = ID)) + geom_line(size = 1) + scale_color_d3()+ylab("PRI/NDVI")+ggtitle("PRI/NDVI Seasonal Change Block 2")
p2 = ggplot(subset(gs_daily, BLOCK == 4 & Date >= "2019-05-31"), aes(x = Date, y = PRI.NDVI, color = ID)) + geom_line(size = 1) + scale_color_d3()+ylab("PRI/NDVI")+ggtitle("PRI/NDVI Seasonal Change Block 4")
p3 = ggplot(subset(gs_daily, BLOCK == 5 & Date >= "2019-05-31"), aes(x = Date, y = PRI.NDVI, color = ID)) + geom_line(size = 1) + scale_color_d3()+ylab("PRI/NDVI")+ggtitle("PRI/NDVINDVI Seasonal Change Block 5")
grid.arrange(p1,p2,p3,nrow=3)

```
###PRIscale-NDVIscale
```{r}
#scale both PRI and NDVI to (0,1) range
gs_daily <- gs_daily %>% mutate(PRI_scale = PRIm-min(PRIm, na.rm = TRUE)/(max(PRIm, na.rm = TRUE) - min(PRIm, na.rm = TRUE)),
                                NDVI_scale = NDVIm-min(NDVIm, na.rm = TRUE)/(max(NDVIm, na.rm = TRUE) - min(NDVIm, na.rm = TRUE)),
                                PRI_NDVI_scale = PRI_scale - NDVI_scale)

p1 = ggplot(subset(gs_daily, BLOCK == 2 & Date >= "2019-05-31"), aes(x = Date, y = PRI_NDVI_scale, color = ID)) + geom_line(size = 1) + scale_color_d3()+ylab("PRIsc-NDVIsc")+ggtitle("PRI-NDVI Seasonal Change Block 2")
p2 = ggplot(subset(gs_daily, BLOCK == 4 & Date >= "2019-05-31"), aes(x = Date, y = PRI_NDVI_scale, color = ID)) + geom_line(size = 1) + scale_color_d3()+ylab("PRIsc-NDVIsc")+ggtitle("PRI-NDVI Seasonal Change Block 4")
p3 = ggplot(subset(gs_daily, BLOCK == 5 & Date >= "2019-05-31"), aes(x = Date, y = PRI_NDVI_scale, color = ID)) + geom_line(size = 1) + scale_color_d3()+ylab("PRIsc-NDVIsc")+ggtitle("PRI-NDVINDVI Seasonal Change Block 5")
grid.arrange(p1,p2,p3,nrow=3)


```
