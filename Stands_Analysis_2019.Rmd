---
title: "Stands_data"
author: "Zhehan"
date: "February 10, 2020"
output: html_document
---

#Package
```{r}
library(ggplot2)
library(ggsci)
library(ggthemes)
library(dplyr)
library(lubridate)
library(RColorBrewer)
library(wesanderson)
library(tidyr)
library(reshape2)
library(gridExtra)
library(GeoLight)
library(raster)
library(readxl)
library(zoo)
library(oce)
library(lme4)
```


#Read data
```{r}
path_stands <- "C:/Users/zt92/Box Sync/BIOSTIMULANT TRIAL - SEASON 2/ZHEHAN/Stands"
gs <- read.csv(file.path(path_stands, "S.STANDS.csv"))

str(gs)
names(gs)

#cleaning
names(gs)[3] <- "TIMESTAMP"
gs$TIMESTAMP <- as.POSIXct(gs$TIMESTAMP, format = "%m/%d/%Y %H:%M")

#calculate reflectance
gs <- gs %>% mutate(R532 = X532OUT/X532IN)
gs <- gs %>% mutate(R570 = X570OUT/X570IN)
gs <- gs %>% mutate(R650 = X650OUT/X650IN)
gs <- gs %>% mutate(R810 = X810OUT/X810IN)
#calculate PRI and NDVI
gs <- gs %>% mutate(PRI = (R532-R570)/(R532+R570))
gs <- gs %>% mutate(NDVI = (R810-R650)/(R810+R650))
#Add date and huor
gs <- gs %>% mutate(Date = lubridate::date(TIMESTAMP))
gs <- gs %>% mutate(Time = lubridate::hour(TIMESTAMP)+minute(TIMESTAMP)/60+second(TIMESTAMP)/3600)
#Add ID 
gs <- gs %>% mutate(ID = paste(BLOCK, TREATMENT, by = " "))
#remove the first and last day 
gs <- subset(gs, Date >= "2019-05-11" & Date <= "2019-09-04")
gs <- subset(gs, Time >= 7 & Time <= 20)
```

#Function to select only noon time 
```{r}
noon_selection <- function(data, early, late){
  data_noon <- data[data$Time >= early & data$Time <= late,]
  return(data_noon)
}
date_selection <- function(data, begin, end){
  data_date_selection <- data[data$Date >= begin & data$Date <= end,]
  return(data_date_selection)
}
```

#Weather data
##Read weather data
```{r}
path_stands <- "C:/Users/zt92/Box Sync/BIOSTIMULANT TRIAL - SEASON 2/ZHEHAN/Stands"
weather <- read.csv(file.path(path_stands, "S.WEATHER.csv"))
head(weather)
names(weather)[1] <- "TIMESTAMP"
weather$TIMESTAMP <- as.POSIXct(weather$TIMESTAMP, format = "%m/%d/%Y %H:%M")
names(weather)

#subset columns
weather <- weather[,c("TIMESTAMP","RADIATION.WM2","AIR.TEMP.CELSIUS","VPD.KPA")]
names(weather) <- c("TIMESTAMP","Radiation","AirTemp","VPD")
unique(date(weather$TIMESTAMP))
hist(weather$Radiation)
hist(weather$AirTemp)
hist(weather$VPD)
#subset dates
weather <- weather %>% mutate(Date = date(TIMESTAMP) ,Time=lubridate::hour(TIMESTAMP)+minute(TIMESTAMP)/60+second(TIMESTAMP)/3600)
weather <- subset(weather,Date >= "2019-05-11" & Date <= "2019-09-04")
sort(unique(weather$Date))



weather_day <- subset(weather, Time >= 7 & Time <=20) 
dim(weather_day) #=18369*6

temp_ls <- split(gs, gs$ID)
length(temp_ls)
for(i in 1:length(temp_ls)){
  temp_ls[[i]] <- merge(temp_ls[[i]], weather_day[,c("TIMESTAMP","Radiation","AirTemp","VPD")], by = "TIMESTAMP", all.y = TRUE)
}
gssb <- do.call(rbind, temp_ls)
dim(gssb) #=183690*32


#calculate PAR_SR
gssb$PAR_SR <- gssb$Radiation*0.5
weather$PAR_SR <- weather$Radiation * 0.5

```
##Daily average
```{r}
#daily average from entire day
weather_daily_all <- aggregate(weather[,c('Radiation','AirTemp','VPD')], list("Date"= weather$Date), function(x){mean(x,na.rm = TRUE)})

#from 11:00-15:00
temp_df <- subset(weather, Time > 11 & Time < 15)
weather_daily_noon <- aggregate(temp_df[,c('Radiation','AirTemp','VPD')], list("Date"= temp_df$Date), function(x){mean(x,na.rm = TRUE)})
```



#Dirunal cycle
##Check the incoming radiation 
```{r}
#X532IN
ggplot(subset(gs, Date == "2019-06-01"), aes(x = TIMESTAMP, y = X532IN, color = as.factor(ID))) + geom_point() + ggtitle("Incoming Radiation In532 2019-06-01") + scale_color_d3()
ggplot(subset(gs, Date == "2019-07-01"), aes(x = TIMESTAMP, y = X532IN, color = as.factor(ID))) + geom_point() + ggtitle("Incoming Radiation In532 2019-07-01") + scale_color_d3()
ggplot(subset(gs, Date == "2019-08-01"), aes(x = TIMESTAMP, y = X532IN, color = as.factor(ID))) + geom_point() + ggtitle("Incoming Radiation In532 2019-08-01") + scale_color_d3()
ggplot(subset(gs, Date == "2019-09-01"), aes(x = TIMESTAMP, y = X532IN, color = as.factor(ID))) + geom_point() + ggtitle("Incoming Radiation In532 2019-09-01") + scale_color_d3()

#X570IN
ggplot(subset(gs, Date == "2019-06-01"), aes(x = TIMESTAMP, y = X570IN, color = as.factor(ID))) + geom_point() + ggtitle("Incoming Radiation In570 2019-06-01") + scale_color_d3()
ggplot(subset(gs, Date == "2019-07-01"), aes(x = TIMESTAMP, y = X570IN, color = as.factor(ID))) + geom_point() + ggtitle("Incoming Radiation In570 2019-07-01") + scale_color_d3()
ggplot(subset(gs, Date == "2019-08-01"), aes(x = TIMESTAMP, y = X570IN, color = as.factor(ID))) + geom_point() + ggtitle("Incoming Radiation In570 2019-08-01") + scale_color_d3()
ggplot(subset(gs, Date == "2019-09-01"), aes(x = TIMESTAMP, y = X570IN, color = as.factor(ID))) + geom_point() + ggtitle("Incoming Radiation In570 2019-09-01") + scale_color_d3()

#X650IN
ggplot(subset(gs, Date == "2019-06-01"), aes(x = TIMESTAMP, y = X650IN, color = as.factor(ID))) + geom_point() + ggtitle("Incoming Radiation In650 2019-06-01") + scale_color_d3()
ggplot(subset(gs, Date == "2019-07-01"), aes(x = TIMESTAMP, y = X650IN, color = as.factor(ID))) + geom_point() + ggtitle("Incoming Radiation In650 2019-07-01") + scale_color_d3()
ggplot(subset(gs, Date == "2019-08-01"), aes(x = TIMESTAMP, y = X650IN, color = as.factor(ID))) + geom_point() + ggtitle("Incoming Radiation In650 2019-08-01") + scale_color_d3()
ggplot(subset(gs, Date == "2019-09-01"), aes(x = TIMESTAMP, y = X650IN, color = as.factor(ID))) + geom_point() + ggtitle("Incoming Radiation In650 2019-09-01") + scale_color_d3()

#X810IN
ggplot(subset(gs, Date == "2019-06-01"), aes(x = TIMESTAMP, y = X810IN, color = as.factor(ID))) + geom_point() + ggtitle("Incoming Radiation In810 2019-06-01") + scale_color_d3()
ggplot(subset(gs, Date == "2019-07-01"), aes(x = TIMESTAMP, y = X810IN, color = as.factor(ID))) + geom_point() + ggtitle("Incoming Radiation In810 2019-07-01") + scale_color_d3()
ggplot(subset(gs, Date == "2019-08-01"), aes(x = TIMESTAMP, y = X810IN, color = as.factor(ID))) + geom_point() + ggtitle("Incoming Radiation In810 2019-08-01") + scale_color_d3()
ggplot(subset(gs, Date == "2019-09-01"), aes(x = TIMESTAMP, y = X810IN, color = as.factor(ID))) + geom_point() + ggtitle("Incoming Radiation In810 2019-09-01") + scale_color_d3()


#Quantify the difference between them 
temp_agg <- aggregate(gs[,c("X532IN","X570IN","X650IN","X810IN")], list("TIMESTAMP" = gs$TIMESTAMP), FUN = function(x){sd(x, na.rm =  TRUE)})
IR_sd <- tidyr::gather(temp_agg, wavelength, sd, X532IN:X810IN, factor_key = TRUE)
IR_sd <- IR_sd %>% mutate(Date = lubridate::date(TIMESTAMP),
                          Time = hour(TIMESTAMP)+minute(TIMESTAMP)/60+second(TIMESTAMP)/3600)
head(temp_agg)
ggplot(IR_sd, aes(x = TIMESTAMP, y = sd, color = wavelength))+geom_point() + scale_color_d3()
ggplot(noon_selection(IR_sd, 8, 18), aes(x = TIMESTAMP, y = sd, color = wavelength)) + geom_point() +scale_color_d3() + ylab("Standard Deviation") + xlab("Date")
```

##Average the incoming radiation 
```{r}
#aggregate over time 
temp_agg <- aggregate(gssb[,c("X532IN","X570IN","X650IN","X810IN")], list("TIMESTAMP" = gssb$TIMESTAMP), FUN = function(x){mean(x, na.rm =  TRUE, trim = 0.2)}) #average of 5 
names(temp_agg) <- c("TIMESTAMP","X532IN_mean","X570IN_mean","X650IN_mean","X810IN_mean")
#add these 4 new columns 
gssb <- merge(gssb, temp_agg, by = "TIMESTAMP")
head(gssb)

#calculate reflectance and PRI, NDVI again 
gssb <- gssb %>% mutate(R532m = X532OUT/X532IN_mean, 
                    R570m = X570OUT/X570IN_mean,
                    R650m = X650OUT/X650IN_mean,
                    R810m = X810OUT/X810IN_mean,
                    PRIm = (R532m-R570m)/(R532m+R570m),
                    NDVIm = (R810m-R650m)/(R810m+R650m))


```

##Deal with missing values 
```{r}
gssb <- subset(gssb, ID != "5 CONTROL DDD  " & ID!= "10 CIMIS  ")
gssb <- subset(gssb, Date >= "2019-05-11" & Date <= "2019-09-04")
unique(gssb$ID)
names(gssb)

sum(is.na(gssb$PRIm)) #13 NAs
sum(is.na(gssb$NDVIm)) #6 NAs
sum(is.na(gssb$TIMESTAMP))

temp_split <- split(gssb, list(gssb$ID, gssb$Date))
length(temp_split)
ma_split <- lapply(temp_split, function(x){
  x$PRIm.ma <- rollmean(x$PRIm, k = 6, fill = NA)
  return(x)
})
gssb <- do.call(rbind, ma_split)


```

##Visualize the diurnal cycle of PRI 
```{r}

#PRIm from 7:00 to 20:00
ggplot(subset(gssb, Date == "2019-06-01" & Time > 7 & Time < 19), aes(x = TIMESTAMP, y = PRIm, color = as.factor(ID))) + geom_point() + ggtitle("PRI 2019-06-01") + scale_color_d3() + ylab("PRI") + xlab("Time")
ggplot(subset(gssb, Date == "2019-07-01" & Time > 7 & Time < 19), aes(x = TIMESTAMP, y = PRIm, color = as.factor(ID))) + geom_point() + ggtitle("PRI 2019-07-01") + scale_color_d3() + ylab("PRI") + xlab("Time")
ggplot(subset(gssb, Date == "2019-08-01" & Time > 7 & Time < 19), aes(x = TIMESTAMP, y = PRIm, color = as.factor(ID))) + geom_point() + ggtitle("PRI 2019-08-01") + scale_color_d3() + ylab("PRI") + xlab("Time")
ggplot(subset(gssb, Date == "2019-09-01" & Time > 7 & Time < 19), aes(x = TIMESTAMP, y = PRIm, color = as.factor(ID))) + geom_point() + ggtitle("PRI 2019-09-01") + scale_color_d3() + ylab("PRI") + xlab("Time")


ggplot(subset(gssb, Date == "2019-09-01" & Time > 7 & Time < 19), aes(x = TIMESTAMP, y = PRIm.ma, color = as.factor(ID))) + geom_point() + ggtitle("PRI 2019-09-01") + scale_color_d3() + ylab("PRI") + xlab("Time")


#PRIm from 9:00 to 18:00, choose the date that have ground measurements
p1 = ggplot(subset(gssb, Date == "2019-05-31" & Time > 9 & Time < 18), aes(x = TIMESTAMP, y = PRIm, color = as.factor(ID))) + geom_point() + ggtitle("PRI 2019-05-31") + scale_color_d3() + ylab("PRI") + xlab("Time") + ylim(-0.125, 0.1) + theme(legend.position = "none")
p2 = ggplot(subset(gssb, Date == "2019-06-12" & Time > 9 & Time < 18), aes(x = TIMESTAMP, y = PRIm, color = as.factor(ID))) + geom_point() + ggtitle("PRI 2019-06-12") + scale_color_d3() + ylab("PRI") + xlab("Time") + ylim(-0.125, 0.1) + theme(legend.position = "none")
p3 = ggplot(subset(gssb, Date == "2019-06-26" & Time > 9 & Time < 18), aes(x = TIMESTAMP, y = PRIm, color = as.factor(ID))) + geom_point() + ggtitle("PRI 2019-06-26") + scale_color_d3() + ylab("PRI") + xlab("Time") + ylim(-0.125, 0.1) + theme(legend.position = "none")
p4 = ggplot(subset(gssb, Date == "2019-07-18" & Time > 9 & Time < 18), aes(x = TIMESTAMP, y = PRIm, color = as.factor(ID))) + geom_point() + ggtitle("PRI 2019-07-18") + scale_color_d3() + ylab("PRI") + xlab("Time") + ylim(-0.125, 0.1) + theme(legend.position = "none")
p5 = ggplot(subset(gssb, Date == "2019-07-26" & Time > 9 & Time < 18), aes(x = TIMESTAMP, y = PRIm, color = as.factor(ID))) + geom_point() + ggtitle("PRI 2019-07-26") + scale_color_d3() + ylab("PRI") + xlab("Time") + ylim(-0.125, 0.1) + theme(legend.position = "none")
p6 = ggplot(subset(gssb, Date == "2019-08-02" & Time > 9 & Time < 18), aes(x = TIMESTAMP, y = PRIm, color = as.factor(ID))) + geom_point() + ggtitle("PRI 2019-08-02") + scale_color_d3() + ylab("PRI") + xlab("Time") + ylim(-0.125, 0.1) + theme(legend.position = "none")
p7 = ggplot(subset(gssb, Date == "2019-08-09" & Time > 9 & Time < 18), aes(x = TIMESTAMP, y = PRIm, color = as.factor(ID))) + geom_point() + ggtitle("PRI 2019-08-09") + scale_color_d3() + ylab("PRI") + xlab("Time") + ylim(-0.125, 0.1) + theme(legend.position = "none")
p8 = ggplot(subset(gssb, Date == "2019-08-15" & Time > 9 & Time < 18), aes(x = TIMESTAMP, y = PRIm, color = as.factor(ID))) + geom_point() + ggtitle("PRI 2019-08-15") + scale_color_d3() + ylab("PRI") + xlab("Time") + ylim(-0.125, 0.1) + theme(legend.position = "none")
grid.arrange(p1,p2,p3,p4,p5,p6,p7,p8,nrow = 2, ncol =4) 
#To generate the legend
ggplot(subset(gssb, Date == "2019-08-15" & Time > 9 & Time < 18), aes(x = TIMESTAMP, y = PRIm, color = as.factor(ID))) + geom_point() + ggtitle("PRI 2019-08-15") + scale_color_d3() + ylab("PRI") + xlab("Time") + ylim(-0.125, 0.1)


```
##How about NDVI
```{r}
#NDVIm from 9:00 to 18:00, choose the date that have ground measurements
p1 = ggplot(subset(gssb, Date == "2019-05-31" & Time > 9 & Time < 18), aes(x = TIMESTAMP, y = NDVIm, color = as.factor(ID))) + geom_point() + ggtitle("NDVI 2019-05-31") + scale_color_d3() + ylab("NDVI") + xlab("Time")  + theme(legend.position = "none")+ ylim(0.4, 1)
p2 = ggplot(subset(gssb, Date == "2019-06-12" & Time > 9 & Time < 18), aes(x = TIMESTAMP, y = NDVIm, color = as.factor(ID))) + geom_point() + ggtitle("NDVI 2019-06-12") + scale_color_d3() + ylab("NDVI") + xlab("Time")  + theme(legend.position = "none")+ ylim(0.4, 1)
p3 = ggplot(subset(gssb, Date == "2019-06-26" & Time > 9 & Time < 18), aes(x = TIMESTAMP, y = NDVIm, color = as.factor(ID))) + geom_point() + ggtitle("NDVI 2019-06-26") + scale_color_d3() + ylab("NDVI") + xlab("Time")  + theme(legend.position = "none")+ ylim(0.4, 1)
p4 = ggplot(subset(gssb, Date == "2019-07-18" & Time > 9 & Time < 18), aes(x = TIMESTAMP, y = NDVIm, color = as.factor(ID))) + geom_point() + ggtitle("NDVI 2019-07-18") + scale_color_d3() + ylab("NDVI") + xlab("Time")  + theme(legend.position = "none")+ ylim(0.4, 1)
p5 = ggplot(subset(gssb, Date == "2019-07-26" & Time > 9 & Time < 18), aes(x = TIMESTAMP, y = NDVIm, color = as.factor(ID))) + geom_point() + ggtitle("NDVI 2019-07-26") + scale_color_d3() + ylab("NDVI") + xlab("Time")  + theme(legend.position = "none")+ ylim(0.4, 1)
p6 = ggplot(subset(gssb, Date == "2019-08-02" & Time > 9 & Time < 18), aes(x = TIMESTAMP, y = NDVIm, color = as.factor(ID))) + geom_point() + ggtitle("NDVI 2019-08-02") + scale_color_d3() + ylab("NDVI") + xlab("Time")  + theme(legend.position = "none")+ ylim(0.4, 1)
p7 = ggplot(subset(gssb, Date == "2019-08-09" & Time > 9 & Time < 18), aes(x = TIMESTAMP, y = NDVIm, color = as.factor(ID))) + geom_point() + ggtitle("NDVI 2019-08-09") + scale_color_d3() + ylab("NDVI") + xlab("Time")  + theme(legend.position = "none")+ ylim(0.4, 1)
p8 = ggplot(subset(gssb, Date == "2019-08-15" & Time > 9 & Time < 18), aes(x = TIMESTAMP, y = NDVIm, color = as.factor(ID))) + geom_point() + ggtitle("NDVI 2019-08-15") + scale_color_d3() + ylab("NDVI") + xlab("Time")  + theme(legend.position = "none")+ ylim(0.4, 1)
grid.arrange(p1,p2,p3,p4,p5,p6,p7,p8,nrow = 2, ncol =4) 

```
##Calculate PRI0
PRI0 is the data when the solar zenith is smaller than 40 degree
###Filter by zenith anlge and PAR
```{r}
#calculate the solar zenith angle 
gssb$SunAngle <- oce::sunAngle(t = gssb$TIMESTAMP, latitude = 38.5346, longitude = -121.7711)$altitude

#Filter
gssb_filt <- subset(gssb, SunAngle > 25 & PAR_SR > 100)
unique(gssb_filt$Time)

```
###PRI0 
```{r}
temp_ls <- split(gssb_filt, list(gssb_filt$ID, gssb_filt$Date))
length(temp_ls)

PRI0_daily <- data.frame("Date"= NA, "ID" = NA, Time0 = NA, PRI0  = NA, PRI0.ma = NA)
PRI0_daily$Date <- as.Date(PRI0_daily$Date)
for(i in 1:length(temp_ls)){
  temp_df <- temp_ls[[i]][order(temp_ls[[i]]$Time),c("Date","ID","Time","PRIm","PRIm.ma")]
  NonNAindex <- which(!is.na(temp_df$PRIm.ma))
  firstNonNA <- min(NonNAindex)
  #print(firstNonNA)
  PRI0_daily[i,] <- temp_df[firstNonNA,]
}
head(PRI0_daily)
dim(PRI0_daily)
row.names(PRI0_daily) <- NULL
#PRI0
#PRI0_daily <- gssb_filt %>% group_by(ID, Date) %>% summarise(Time0 = first(Time), PRI0.ma = first(PRIm.ma), PRI0 = first(PRIm))
#head(PRI0_daily)
#merge with gssb_filt
gssb_filt <- merge(gssb_filt, PRI0_daily, by = c("ID", "Date"))

ggplot(gssb_filt, aes(x = Date, y = PRI0.ma, color = ID)) + geom_point() + scale_color_d3() + theme_bw() + ylab("PRI0") 

ggplot(gssb_filt, aes(x = Date, y = PRI0, color = ID)) + geom_point() + scale_color_d3() + theme_bw() + ylab("PRI0")

```
###Calculate PRIdelta in diurnal cycle
```{r}
gssb_filt <- gssb_filt %>% mutate(PRIdelta = PRIm - PRI0, PRIdelta.ma = PRIm.ma - PRI0.ma)




p1 = ggplot(subset(gssb_filt, Date == "2019-05-31" & Time > 9 & Time < 18), aes(x = TIMESTAMP, y = PRIdelta.ma, color = as.factor(ID))) + geom_point() + ggtitle("PRIdelta 2019-05-31") + scale_color_d3() + ylab("PRIdelta") + xlab("Time") + ylim(-0.125, 0.1) + theme_bw() + theme(legend.position = "none")
p2 = ggplot(subset(gssb_filt, Date == "2019-06-12" & Time > 9 & Time < 18), aes(x = TIMESTAMP, y = PRIdelta.ma, color = as.factor(ID))) + geom_point() + ggtitle("PRIdelta 2019-06-12") + scale_color_d3() + ylab("PRIdelta") + xlab("Time") + ylim(-0.125, 0.1) + theme_bw() + theme(legend.position = "none")
p3 = ggplot(subset(gssb_filt, Date == "2019-06-26" & Time > 9 & Time < 18), aes(x = TIMESTAMP, y = PRIdelta.ma, color = as.factor(ID))) + geom_point() + ggtitle("PRIdelta 2019-06-26") + scale_color_d3() + ylab("PRIdelta") + xlab("Time") + ylim(-0.125, 0.1)+ theme_bw() + theme(legend.position = "none")
p4 = ggplot(subset(gssb_filt, Date == "2019-07-18" & Time > 9 & Time < 18), aes(x = TIMESTAMP, y = PRIdelta.ma, color = as.factor(ID))) + geom_point() + ggtitle("PRIdelta 2019-07-18") + scale_color_d3() + ylab("PRIdelta") + xlab("Time") + ylim(-0.125, 0.1)+ theme_bw() + theme(legend.position = "none")
p5 = ggplot(subset(gssb_filt, Date == "2019-07-26" & Time > 9 & Time < 18), aes(x = TIMESTAMP, y = PRIdelta.ma, color = as.factor(ID))) + geom_point() + ggtitle("PRIdelta 2019-07-26") + scale_color_d3() + ylab("PRIdelta") + xlab("Time") + ylim(-0.125, 0.1)+ theme_bw() + theme(legend.position = "none")
p6 = ggplot(subset(gssb_filt, Date == "2019-08-02" & Time > 9 & Time < 18), aes(x = TIMESTAMP, y = PRIdelta.ma, color = as.factor(ID))) + geom_point() + ggtitle("PRIdelta 2019-08-02") + scale_color_d3() + ylab("PRIdelta") + xlab("Time") + ylim(-0.125, 0.1)+ theme_bw() + theme(legend.position = "none")
p7 = ggplot(subset(gssb_filt, Date == "2019-08-09" & Time > 9 & Time < 18), aes(x = TIMESTAMP, y = PRIdelta.ma, color = as.factor(ID))) + geom_point() + ggtitle("PRIdelta 2019-08-09") + scale_color_d3() + ylab("PRIdelta") + xlab("Time") + ylim(-0.125, 0.1)+ theme_bw() + theme(legend.position = "none")
p8 = ggplot(subset(gssb_filt, Date == "2019-08-15" & Time > 9 & Time < 18), aes(x = TIMESTAMP, y = PRIdelta.ma, color = as.factor(ID))) + geom_point() + ggtitle("PRIdelta 2019-08-15") + scale_color_d3() + ylab("PRIdelta") + xlab("Time") + ylim(-0.125, 0.1)+ theme_bw() + theme(legend.position = "none")
grid.arrange(p1,p2,p3,p4,p5,p6,p7,p8,nrow = 2, ncol =4) 

#for legend
p8 = ggplot(subset(gssb_filt, Date == "2019-08-15" & Time > 9 & Time < 18), aes(x = TIMESTAMP, y = PRIdelta.ma, color = as.factor(ID))) + geom_point() + ggtitle("PRIdelta 2019-08-15") + scale_color_d3() + ylab("PRIdelta") + xlab("Time") + ylim(-0.125, 0.1)+ theme_bw()
p8
```

#Seasonal Change
##function to calculate daily average
```{r}
DayAve <- function(data, early, late, begin, end, colnum, FUN){
  #between certain dates
  df_date <- date_selection(data, begin, end)
  #noon average
  df_date_noon <- noon_selection(df_date, early, late)
  #split by date
  df_split <- split(df_date_noon, df_date_noon$Date)
  #lapply to calculate average
  df_ave <- lapply(lapply(df_split, "[[", colnum), function(x){FUN(x, na.rm = TRUE)})
  df_ave <- data.frame("Date" = ymd(names(df_ave)), "Value" = unlist(df_ave))
  #result
  row.names(df_ave) <- NULL
  return(df_ave)
}

PRIm_dayave <- function(data, early, late, begin, end){
  #between certain dates
  PRIm_date <- date_selection(data, begin, end)
  #noon average
  PRIm_date_noon <- noon_selection(PRIm_date, early, late)
  #split
  PRIm_split <- split(PRIm_date_noon, PRIm_date_noon$Date)
  #lapply
  PRIm_ave <- lapply(lapply(PRIm_split, "[[", 44), function(x){mean(x, na.rm = TRUE, trim = 0.2)})
  PRIm_ave <- data.frame("Date" = ymd(names(PRIm_ave)), "PRIm" = unlist(PRIm_ave))
  #result
  row.names(PRIm_ave) <- NULL
  return(PRIm_ave)
}

NDVIm_dayave <- function(data, early, late, begin, end){
  #between certain dates
  NDVIm_date <- date_selection(data, begin, end)
  #noon average
  NDVIm_date_noon <- noon_selection(NDVIm_date, early, late)
  #split
  NDVIm_split <- split(NDVIm_date_noon, NDVIm_date_noon$Date)
  #lapply
  NDVIm_ave <- lapply(lapply(NDVIm_split, "[[", 39), function(x){mean(x, na.rm = TRUE, trim = 0.2)})
  NDVIm_ave <- data.frame("Date" = ymd(names(NDVIm_ave)), "NDVIm" = unlist(NDVIm_ave))
  #result
  row.names(NDVIm_ave) <- NULL
  return(NDVIm_ave)
}
```

##Calculate daily average
###PRImin-PRI0 (follow Troy's paper) with moving average
```{r}
temp_split <- split(gssb_filt, gssb_filt$ID)
names(temp_split[[1]]) #PRIm.ma 44, NDVIm 43, PRI0.ma 48, PRIdelta.ma 50

#PRImin
temp_ls <- lapply(temp_split, function(x){DayAve(x, 11, 15, "2019-05-11", "2019-09-04", 44, min)})
for(i in 1:length(temp_ls)){
  temp_ls[[i]]$ID = names(temp_ls)[i]
}
PRImin.ma_season <- do.call(rbind, temp_ls)
row.names(PRImin.ma_season) <- NULL
head(PRImin.ma_season)
#is there any NAs
sum(is.na(PRImin.ma_season$Value))
names(PRImin.ma_season)[2] <- "PRImin.ma"

#PRI0
temp_ls <- lapply(temp_split, function(x){DayAve(x, 11, 15, "2019-05-11", "2019-09-04", 48, unique)})
for(i in 1:length(temp_ls)){
  temp_ls[[i]]$ID = names(temp_ls)[i]
}
PRI0.ma_season <- do.call(rbind, temp_ls)
row.names(PRI0.ma_season) <- NULL
head(PRI0.ma_season)
sum(is.na(PRI0.ma_season$Value))
names(PRI0.ma_season)[2] <- "PRI0.ma"

#calculate PRIdelta
PRImin_0.ma_season <- merge(PRImin.ma_season, PRI0.ma_season, by = c("Date","ID"))
PRImin_0.ma_season <- PRImin_0.ma_season %>% mutate(PRImin_PRI0.ma = PRImin.ma - PRI0.ma)
ggplot(PRImin_0.ma_season, aes(x = Date, y = PRImin_PRI0.ma, color = ID)) + geom_point()  + scale_color_d3() + theme_bw() + ylab("PRImin - PRI0")  + ggtitle("Seasonal Change of PRImin - PRI0") + geom_smooth(se = FALSE)#+ ylim(c(-0.1, 0.025))
```
###PRImin - PRI0 without moving average
```{r}
temp_split <- split(gssb_filt, gssb_filt$ID)
names(temp_split[[1]]) #PRIm 42, PRIm.ma 44, NDVIm 43, PRI0 47, PRI0.ma 48, PRIdelta.ma 50

#PRImin
temp_ls <- lapply(temp_split, function(x){DayAve(x, 11, 15, "2019-05-11", "2019-09-04", 42, min)})
for(i in 1:length(temp_ls)){
  temp_ls[[i]]$ID = names(temp_ls)[i]
}
PRImin_season <- do.call(rbind, temp_ls)
row.names(PRImin_season) <- NULL
head(PRImin_season)
#is there any NAs
sum(is.na(PRImin_season$Value))
names(PRImin_season)[2] <- "PRImin"

#PRI0
temp_ls <- lapply(temp_split, function(x){DayAve(x, 11, 15, "2019-05-11", "2019-09-04", 47, unique)})
for(i in 1:length(temp_ls)){
  temp_ls[[i]]$ID = names(temp_ls)[i]
}
PRI0_season <- do.call(rbind, temp_ls)
row.names(PRI0_season) <- NULL
head(PRI0_season)
sum(is.na(PRI0_season$Value))
names(PRI0_season)[2] <- "PRI0"

#calculate PRIdelta
PRImin_0_season <- merge(PRImin_season, PRI0_season, by = c("Date","ID"))
PRImin_0_season <- PRImin_0_season %>% mutate(PRImin_PRI0 = PRImin - PRI0)
ggplot(PRImin_0_season, aes(x = Date, y = PRImin_PRI0, color = ID)) + geom_point()  + scale_color_d3() + theme_bw() + ylab("PRImin - PRI0")  + ggtitle("Seasonal Change of PRImin - PRI0")+ylim(-0.15, 0.025) #+ geom_smooth(se = FALSE)+ ylim(c(-0.1, 0.025))

```
###PRIdelta average with moving average
```{r}
temp_split <- split(gssb_filt, gssb_filt$ID)
names(temp_split[[1]]) #PRIm 42, PRIm.ma 44, NDVIm 43, PRI0 47, PRI0.ma 48, PRIdelta 49, PRIdelta.ma 50

#PRIdelta.ma
temp_ls <- lapply(temp_split, function(x){DayAve(x, 11, 15, "2019-05-11", "2019-09-04", 50, mean)})
for(i in 1:length(temp_ls)){
  temp_ls[[i]]$ID = names(temp_ls)[i]
}
PRIdelta.ma_season <- do.call(rbind, temp_ls)
row.names(PRIdelta.ma_season) <- NULL
head(PRIdelta.ma_season)
#is there any NAs
sum(is.na(PRIdelta.ma_season$Value))
names(PRIdelta.ma_season)[2] <- "PRIdelta.ma"

ggplot(PRIdelta.ma_season, aes(x = Date, y = PRIdelta.ma, color = ID)) + geom_point() + scale_color_d3() + theme_bw() + ylab("PRIdelta") + ggtitle("Seasonal Change of PRIdelta") + geom_smooth(se = FALSE)

```
###PRIdelta average without moving average
```{r}
#PRIdelta
temp_ls <- lapply(temp_split, function(x){DayAve(x, 11, 15, "2019-05-11", "2019-09-04", 49, mean)})
for(i in 1:length(temp_ls)){
  temp_ls[[i]]$ID = names(temp_ls)[i]
}
PRIdelta_season <- do.call(rbind, temp_ls)
row.names(PRIdelta_season) <- NULL
head(PRIdelta_season)
sum(is.na(PRIdelta_season$Value))
names(PRIdelta_season)[2] <- "PRIdelta"

ggplot(PRIdelta_season, aes(x = Date, y = PRIdelta, color = ID)) + geom_point() + scale_color_d3() + theme_bw() + ylab("PRIdelta") + ggtitle("Seasonal Change of PRIdelta")

```
###PRIm, PRIm.ma, NDVI
```{r}
temp_split <- split(gssb_filt, gssb_filt$ID)
names(temp_split[[1]]) #PRIm 42, PRIm.ma 44, NDVIm 43, PRI0 47, PRI0.ma 48, PRIdelta 49, PRIdelta.ma 50


#PRIm 42
temp_ls <- lapply(temp_split, function(x){DayAve(x, 11, 15, "2019-05-11", "2019-09-04", 42, mean)})
for(i in 1:length(temp_ls)){
  temp_ls[[i]]$ID = names(temp_ls)[i]
}
PRIm_season <- do.call(rbind, temp_ls)
row.names(PRIm_season) <- NULL
head(PRIm_season)
#is there any NAs
sum(is.na(PRIm_season$Value))
names(PRIm_season)[2] <- "PRIm"
ggplot(PRIm_season, aes(x = Date, y = PRIm, color = ID)) + geom_point() + scale_color_d3() + theme_bw() + ylab("PRI") + ggtitle("Seasonal Change of PRI") + geom_smooth(se = FALSE)



#PRIm.ma 44
temp_ls <- lapply(temp_split, function(x){DayAve(x, 11, 15, "2019-05-11", "2019-09-04", 44, mean)})
for(i in 1:length(temp_ls)){
  temp_ls[[i]]$ID = names(temp_ls)[i]
}
PRIm.ma_season <- do.call(rbind, temp_ls)
row.names(PRIm.ma_season) <- NULL
head(PRIm.ma_season)
#is there any NAs
sum(is.na(PRIm.ma_season$Value))
names(PRIm.ma_season)[2] <- "PRIm.ma"
ggplot(PRIm.ma_season, aes(x = Date, y = PRIm.ma, color = ID)) + geom_point() + scale_color_d3() + theme_bw() + ylab("PRI") + ggtitle("Seasonal Change of PRI") + geom_smooth(se = FALSE)

#NDVIm 43
temp_ls <- lapply(temp_split, function(x){DayAve(x, 11, 15, "2019-05-11", "2019-09-04", 43, mean)})
for(i in 1:length(temp_ls)){
  temp_ls[[i]]$ID = names(temp_ls)[i]
}
NDVIm_season <- do.call(rbind, temp_ls)
row.names(NDVIm_season) <- NULL
head(NDVIm_season)
#is there any NAs
sum(is.na(NDVIm_season$Value))
names(NDVIm_season)[2] <- "NDVIm"
ggplot(NDVIm_season, aes(x = Date, y = NDVIm, color = ID)) + geom_point() + scale_color_d3() + theme_bw() + ylab("NDVI") + ggtitle("Seasonal Change of NDVI") + geom_smooth(se = FALSE)


```
###Merge all seasonal change df together
```{r}
df_season <- merge(PRImin_0.ma_season, PRImin_0_season, by = c("ID","Date"))
dim(df_season)
dim(PRImin_0_season)
head(df_season)

df_season <- merge(df_season, PRIdelta_season, by = c("ID","Date"))
df_season <- merge(df_season, PRIdelta.ma_season, by = c("ID","Date"))
df_season <- merge(df_season, PRIm_season, by = c("ID","Date"))
dim(PRIm_season)
df_season <- merge(df_season, PRIm.ma_season, by =  c("ID","Date"))
df_season <- merge(df_season, NDVIm_season, by = c("ID","Date"))
head(df_season)

```
###PRI and NDVI combined
####PRI/NDVI ratio 
```{r}
names(df_season)
df_season <- df_season %>% mutate(PRI.NDVI = PRIm/NDVIm, 
                                  PRI.NDVI.ma = PRIm.ma/NDVIm, 
                                  PRI_scale = (PRIm - min(PRIm, na.rm = TRUE))/(max(PRIm, na.rm = TRUE) - min(PRIm, na.rm = TRUE)), 
                                  NDVI_scale = (NDVIm - min(NDVIm, na.rm = TRUE))/(max(NDVIm, na.rm = TRUE) - min(NDVIm, na.rm = TRUE)),
                                  PRI.ma_scale = (PRIm.ma - min(PRIm.ma, na.rm = TRUE))/(max(PRIm.ma, na.rm = TRUE) - min(PRIm.ma, na.rm = TRUE)),
                                  PRI_NDVI_scale = PRI_scale - NDVI_scale, 
                                  PRI_NDVI.ma_scale = PRI.ma_scale - NDVI_scale,
                                  PRI.NDVI = PRI_scale/NDVI_scale,
                                  PRI.NDVI.ma = PRI.ma_scale/NDVI_scale, 
                                  PRI.NDVI_scale  = PRI_scale/NDVI_scale, 
                                  PRI.NDVI.ma_scale = PRI.ma_scale/NDVI_scale)
```
####PRIscale-NDVIscale
```{r}

#gs_daily <- gs_daily %>% mutate(PRI_scale = PRIm-min(PRIm, na.rm = TRUE)/(max(PRIm, na.rm = TRUE) - min(PRIm, na.rm = TRUE)),
                                NDVI_scale = NDVIm-min(NDVIm, na.rm = TRUE)/(max(NDVIm, na.rm = TRUE) - min(NDVIm, na.rm = TRUE)),
                                PRI_NDVI_scale = PRI_scale - NDVI_scale)

```


###PRI/NDVI
```{r}
gs_daily <- gs_daily %>% mutate(PRI.NDVI = PRIm/NDVIm)

##Plot
p1 = ggplot(subset(gs_daily, BLOCK == 2), aes(x = Date, y = PRI.NDVI, color = ID)) + geom_line(size = 1) + scale_color_d3()+ylab("PRI/NDVI")+ggtitle("PRI/NDVI Seasonal Change Block 2")
p2 = ggplot(subset(gs_daily, BLOCK == 4), aes(x = Date, y = PRI.NDVI, color = ID)) + geom_line(size = 1) + scale_color_d3()+ylab("PRI/NDVI")+ggtitle("PRI/NDVI Seasonal Change Block 4")
p3 = ggplot(subset(gs_daily, BLOCK == 5), aes(x = Date, y = PRI.NDVI, color = ID)) + geom_line(size = 1) + scale_color_d3()+ylab("PRI/NDVI")+ggtitle("PRI/NDVINDVI Seasonal Change Block 5")
grid.arrange(p1,p2,p3,nrow=3)

##Subset after June
p1 = ggplot(subset(gs_daily, BLOCK == 2 & Date >= "2019-05-31"), aes(x = Date, y = PRI.NDVI, color = ID)) + geom_line(size = 1) + scale_color_d3()+ylab("PRI/NDVI")+ggtitle("PRI/NDVI Seasonal Change Block 2")
p2 = ggplot(subset(gs_daily, BLOCK == 4 & Date >= "2019-05-31"), aes(x = Date, y = PRI.NDVI, color = ID)) + geom_line(size = 1) + scale_color_d3()+ylab("PRI/NDVI")+ggtitle("PRI/NDVI Seasonal Change Block 4")
p3 = ggplot(subset(gs_daily, BLOCK == 5 & Date >= "2019-05-31"), aes(x = Date, y = PRI.NDVI, color = ID)) + geom_line(size = 1) + scale_color_d3()+ylab("PRI/NDVI")+ggtitle("PRI/NDVINDVI Seasonal Change Block 5")
grid.arrange(p1,p2,p3,nrow=3)

```
###PRIscale-NDVIscale
```{r}
#scale both PRI and NDVI to (0,1) range
gs_daily <- gs_daily %>% mutate(PRI_scale = PRIm-min(PRIm, na.rm = TRUE)/(max(PRIm, na.rm = TRUE) - min(PRIm, na.rm = TRUE)),
                                NDVI_scale = NDVIm-min(NDVIm, na.rm = TRUE)/(max(NDVIm, na.rm = TRUE) - min(NDVIm, na.rm = TRUE)),
                                PRI_NDVI_scale = PRI_scale - NDVI_scale)

p1 = ggplot(subset(gs_daily, BLOCK == 2 & Date >= "2019-05-31"), aes(x = Date, y = PRI_NDVI_scale, color = ID)) + geom_line(size = 1) + scale_color_d3()+ylab("PRIsc-NDVIsc")+ggtitle("PRI-NDVI Seasonal Change Block 2")
p2 = ggplot(subset(gs_daily, BLOCK == 4 & Date >= "2019-05-31"), aes(x = Date, y = PRI_NDVI_scale, color = ID)) + geom_line(size = 1) + scale_color_d3()+ylab("PRIsc-NDVIsc")+ggtitle("PRI-NDVI Seasonal Change Block 4")
p3 = ggplot(subset(gs_daily, BLOCK == 5 & Date >= "2019-05-31"), aes(x = Date, y = PRI_NDVI_scale, color = ID)) + geom_line(size = 1) + scale_color_d3()+ylab("PRIsc-NDVIsc")+ggtitle("PRI-NDVINDVI Seasonal Change Block 5")
grid.arrange(p1,p2,p3,nrow=3)


```
#Include physiology measurement
##SWP
```{r}
path_phys <- "C:/Users/zt92/Box Sync/BIOSTIMULANT TRIAL - SEASON 2/ZHEHAN/Physiology"
SWP_stands <- read_excel(file.path(path_phys, "SWP_stands.xlsx"))

head(SWP_stands)
unique(SWP_stands$TREATMENT)
str(SWP_stands)

SWP_stands$Date <- as.Date(SWP_stands$Date)
SWP_stands$ID <- paste(SWP_stands$BLOCK, SWP_stands$TREATMENT, sep = " ")
unique(SWP_stands$ID)

#trim the space 
gs_daily$ID <- trimws(gs_daily$ID, which  = "right")

#merge 
gs_daily_swp <- merge(gs_daily, SWP_stands, by = c("ID","Date"))
dim(gs_daily_swp)
dim(gs_daily)
dim(SWP_stands)

#plot
ggplot(subset(gs_daily_swp, Date != "2019-05-31"), aes(x = Date, y = PRI_NDVI_scale, color = ID)) + geom_point() + scale_color_d3()
ggplot(subset(gs_daily_swp, Date != "2019-05-31"), aes(x = Date, y = -SWP, color = ID)) + geom_point() + scale_color_d3()

ggplot(subset(gs_daily_swp, Date != "2019-05-31"), aes(y = -SWP, x = PRI_NDVI_scale)) + geom_point(aes(color = as.factor(Date))) + scale_color_d3() + geom_smooth(method = "lm") + ylab("Stem Water Potential (Bars)") + xlab("PRIsc-NDVIsc")


lm1 <- lm(-SWP~PRI_NDVI_scale, subset(gs_daily_swp, Date != "2019-05-31"))
summary(lm1)
cor(subset(gs_daily_swp, Date != "2019-05-31")$PRI_NDVI_scale, subset(gs_daily_swp, Date != "2019-05-31")$SWP)^2
```


#Include UAV data
##Shapefiles
```{r}
path_shp <- "C:/Users/zt92/Box Sync/BIOSTIMULANT TRIAL - SEASON 2/ZHEHAN/tomato_GCPs"
sensors_shp <- shapefile(file.path(path_shp, "sensors_tomato_2019.shp"))

path_macaw <- "C:/Users/zt92/Box Sync/BIOSTIMULANT FIELD SCREENING MASTER FOLDER/DRONE/macaw_pri"
macaw_pri_062819 <- raster(file.path(path_macaw, 'pri_062819.tif'))
macaw_pri_080219 <- raster(file.path(path_macaw, 'pri_080219.tif'))
macaw_pri_081019 <- raster(file.path(path_macaw, 'pri_081019.tif'))
macaw_pri_081519 <- raster(file.path(path_macaw, 'pri_081519.tif'))
macaw_pri_082219 <- raster(file.path(path_macaw, 'pri_082219.tif'))

uav_pri_062819 <- extract()

```

#---------------------------------------------------------#
#Not Useful at present, delete later
```{r}

#Seasonal Change of NDVI
temp_ls <- lapply(temp_split, function(x){NDVIm_dayave(x, 11, 15, "2019-05-07", "2019-09-05")})
for(i in 1:length(temp_ls)){
  temp_ls[[i]]$ID = names(temp_ls)[i]
}
NDVIm_daily <- do.call(rbind, temp_ls)
row.names(NDVIm_daily) <- NULL
ggplot(NDVIm_daily, aes(x = Date, y = NDVIm, color = ID)) + geom_line(size = 1) + scale_color_d3()+ylab("NDVI")+ggtitle("NDVI Seasonal Change")

#merge daily NDVI and daily PRI
gs_daily <- merge(PRIm_daily, NDVIm_daily, by = c("Date","ID"))
#add block name
gs_daily$BLOCK <- sapply(strsplit(gs_daily$ID, split = " "),'[',1)

#Divide into different blocks
##PRI
p1 = ggplot(subset(gs_daily, BLOCK == 2), aes(x = Date, y = PRIm, color = ID)) + geom_line(size = 1) + scale_color_d3()+ylab("PRI")+ggtitle("PRI Seasonal Change Block 2") + ylim(-0.1, 0.04)
p2 = ggplot(subset(gs_daily, BLOCK == 4), aes(x = Date, y = PRIm, color = ID)) + geom_line(size = 1) + scale_color_d3()+ylab("PRI")+ggtitle("PRI Seasonal Change Block 4")+ ylim(-0.1, 0.04)
p3 = ggplot(subset(gs_daily, BLOCK == 5), aes(x = Date, y = PRIm, color = ID)) + geom_line(size = 1) + scale_color_d3()+ylab("PRI")+ggtitle("PRI Seasonal Change Block 5")+ ylim(-0.1, 0.04)
grid.arrange(p1,p2,p3,nrow=3)
##NDVI
p1 = ggplot(subset(gs_daily, BLOCK == 2), aes(x = Date, y = NDVIm, color = ID)) + geom_line(size = 1) + scale_color_d3()+ylab("NDVI")+ggtitle("NDVI Seasonal Change Block 2")
p2 = ggplot(subset(gs_daily, BLOCK == 4), aes(x = Date, y = NDVIm, color = ID)) + geom_line(size = 1) + scale_color_d3()+ylab("NDVI")+ggtitle("NDVI Seasonal Change Block 4")
p3 = ggplot(subset(gs_daily, BLOCK == 5), aes(x = Date, y = NDVIm, color = ID)) + geom_line(size = 1) + scale_color_d3()+ylab("NDVI")+ggtitle("NDVI Seasonal Change Block 5")
grid.arrange(p1,p2,p3,nrow=3)
```

