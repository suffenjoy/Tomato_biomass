---
title: "tomato_macaw_2019"
author: "Zhehan"
date: "January 6, 2020"
output: html_document
---
#Packages
```{r}
library(raster)
library(ggplot2)
library(dplyr)
library(qdapRegex)
library(MASS)
library(leaps)
library(stringr)
library(EBImage)
library(readxl)
library(caret)
library(caTools)
library(Metrics)
library(tidyr)
library(ggthemes)
library(ggpubr)
library(stringi)
library(tidyr)
library(stringi)
library(agricolae)
```

#Shapefiles
##From the server
```{r}
path_shp <- "/z0/zt92/Tomato_biomass/tomato_analysis_2019/shapefiles"
#path_shp <- "Z:/CC_UCD_atRR/data2/UAV_MeeraeTomato/shapefiles"

rows_2019 <- shapefile(file.path(path_shp, "tomato_rows_2019.shp"))



rows_2019_cen1ft <- shapefile(file.path(path_shp, "tomato_rows_2019_cen1ft"))
rows_2019_cen2ft <- shapefile(file.path(path_shp, "tomato_rows_2019_cen2ft"))
rows_2019_cen3ft <- shapefile(file.path(path_shp, "tomato_rows_2019_cen3ft"))

```
##From laptop
```{r}
path_shp <- "C:/Users/tangz/Box Sync/BIOSTIMULANT TRIAL - SEASON 2/ZHEHAN/shapefiles"
#use the adjusted one
flagbuff_2019 <- shapefile(file.path(path_shp, "flags_tomato_2019_adj_buffer_corrected.shp"))
rows_2019 <- shapefile(file.path(path_shp, "tomato_rows_2019.shp"))
rows_2019_cen1ft <- shapefile(file.path(path_shp, "tomato_rows_2019_cen1ft"))
rows_2019_cen2ft <- shapefile(file.path(path_shp, "tomato_rows_2019_cen2ft"))
rows_2019_cen3ft <- shapefile(file.path(path_shp, "tomato_rows_2019_cen3ft"))

#subset 
rows_2019_sb <- subset(rows_2019, Treatment %in% c("CONTROL DDD","CONTROL WW","BAYER 16 (SOIL) WW"))  #20
rows_2019_conddd <- subset(rows_2019, Treatment == "CONTROL DDD")  #5
rows_2019_conww <- subset(rows_2019, Treatment == "CONTROL WW" & Block != "CHBIO") #5
rows_2019_bayww <- subset(rows_2019, Treatment == "BAYER 16 (SOIL) WW")  #5

#output
shapefile(rows_2019_sb, file.path(path_shp, "rows_2019_sb.shp"))
shapefile(rows_2019_conddd, file.path(path_shp, "rows_2019_conddd.shp"))
shapefile(rows_2019_conww, file.path(path_shp, "rows_2019_conww.shp"),overwrite = TRUE)
shapefile(rows_2019_bayww, file.path(path_shp, "rows_2019_bayww.shp"))

length(unique(flagbuff_2019$Row))
length(unique(flagbuff_2019$Plot))
unique(flagbuff_2019$Plot)
unique(flagbuff_2019$Row)
ls_flag <- split(flagbuff_2019, flagbuff_2019$Row)
ls_flag[[1]]
plot(ls_flag[[1]])
```

#Read Micasense imgs
##function 
```{r}
read_uav <- function(path, stacks){
  #read raster layer, and crop with the extent
  uav_stacks <- raster::brick(file.path(path, stacks))
  #rename the bands
  names(uav_stacks) <- c("blue","green","red","rededge","nir","ndvi")
  
  return(uav_stacks)
}
```
##read micasense 
```{r}
path_uav <- "C:/Users/tangz/Box Sync/BIOSTIMULANT TRIAL - SEASON 2/ZHEHAN/UAV processed images"
uav_061219 <- read_uav(path_uav, "tomato_061219_stacks2.tif")
uav_062819 <- read_uav(path_uav, "tomato_062819_stacks2.tif")
uav_071219 <- read_uav(path_uav, "tomato_071219_stacks.dat")
uav_071719 <- read_uav(path_uav, "tomato_071719_stacks2.tif")
uav_072619 <- read_uav(path_uav, "tomato_072619_stacks2.tif")
uav_080219 <- read_uav(path_uav, "tomato_080219_stacks2.tif")
uav_081019 <- read_uav(path_uav, "tomato_081019_stacks2.tif")
uav_081519 <- read_uav(path_uav, "tomato_081519_stacks2.tif")
uav_082219 <- read_uav(path_uav, "tomato_082219_stacks2.tif")
```
##crop to boundary and calculate NDVI histogram
```{r}
path_shp <- "C:/Users/tangz/Box Sync/BIOSTIMULANT TRIAL - SEASON 2/ZHEHAN/shapefiles"
BND <- shapefile(file.path(path_shp, "tomato_BND_2019.shp"))
plot(BND)
uav_061219 <- raster::crop(uav_061219, BND)
values(uav_061219)[values(uav_061219) == -10000] <- NA
uav_062819 <- raster::crop(uav_062819, BND)
values(uav_062819)[values(uav_062819) == -10000] <- NA
uav_071219 <- raster::crop(uav_071219, BND)
values(uav_071219)[values(uav_071219) == -10000] <- NA
uav_071719 <- raster::crop(uav_071719, BND)
values(uav_071719)[values(uav_071719) == -10000] <- NA
uav_072619 <- raster::crop(uav_072619, BND)
values(uav_072619)[values(uav_072619) == -10000] <- NA
uav_080219 <- raster::crop(uav_080219, BND)
values(uav_080219)[values(uav_080219) == -10000] <- NA
uav_081019 <- raster::crop(uav_081019, BND)
values(uav_081019)[values(uav_081019) == -10000] <- NA
uav_081519 <- raster::crop(uav_081519, BND)
values(uav_081519)[values(uav_081519) == -10000] <- NA
uav_082219 <- raster::crop(uav_082219, BND)
values(uav_082219)[values(uav_082219) == -10000] <- NA


#convert to array and apply Otsu method
##0612
temp_arr <- raster::as.array(uav_061219$ndvi)
thr_uavndvi_061219 <- EBImage::otsu(temp_arr, range = c(min(temp_arr, na.rm = TRUE), max(temp_arr, na.rm = TRUE)), levels = 256)
thr_uavndvi_061219  #0.5409
hist(temp_arr, main = "UAV NDVI 061219", xlab = "NDVI")
##0628
temp_arr <- raster::as.array(uav_062819$ndvi)
thr_uavndvi_062819 <- EBImage::otsu(temp_arr, range = c(min(temp_arr, na.rm = TRUE), max(temp_arr, na.rm = TRUE)), levels = 256)
thr_uavndvi_062819  #0.5890
hist(temp_arr, main = "UAV NDVI 062819", xlab = "NDVI")
##0712
temp_arr <- raster::as.array(uav_071219$ndvi)
thr_uavndvi_071219 <- EBImage::otsu(temp_arr, range = c(min(temp_arr, na.rm = TRUE), max(temp_arr, na.rm = TRUE)), levels = 256)
thr_uavndvi_071219  #0.5974
hist(temp_arr, main = "UAV NDVI 071219", xlab = "NDVI")
##0717
temp_arr <- raster::as.array(uav_071719$ndvi)
thr_uavndvi_071719 <- EBImage::otsu(temp_arr, range = c(min(temp_arr, na.rm = TRUE), max(temp_arr, na.rm = TRUE)), levels = 256)
thr_uavndvi_071719  #0.5978
hist(temp_arr, main = "UAV NDVI 071719", xlab = "NDVI")
##0726
temp_arr <- raster::as.array(uav_072619$ndvi)
thr_uavndvi_072619 <- EBImage::otsu(temp_arr, range = c(min(temp_arr, na.rm = TRUE), max(temp_arr, na.rm = TRUE)), levels = 256)
thr_uavndvi_072619  #0.5940
hist(temp_arr, main = "UAV NDVI 072619", xlab = "NDVI")
##0802
temp_arr <- raster::as.array(uav_080219$ndvi)
thr_uavndvi_080219 <- EBImage::otsu(temp_arr, range = c(min(temp_arr, na.rm = TRUE), max(temp_arr, na.rm = TRUE)), levels = 256)
thr_uavndvi_080219  #0.6093
hist(temp_arr, main = "UAV NDVI 080219", xlab = "NDVI")
##0810
temp_arr <- raster::as.array(uav_081019$ndvi)
thr_uavndvi_081019 <- EBImage::otsu(temp_arr, range = c(min(temp_arr, na.rm = TRUE), max(temp_arr, na.rm = TRUE)), levels = 256)
thr_uavndvi_081019  #0.5409
hist(temp_arr, main = "UAV NDVI 081019", xlab = "NDVI")
##0815
temp_arr <- raster::as.array(uav_081519$ndvi)
thr_uavndvi_081519 <- EBImage::otsu(temp_arr, range = c(min(temp_arr, na.rm = TRUE), max(temp_arr, na.rm = TRUE)), levels = 256)
thr_uavndvi_081519  #0.5409
hist(temp_arr, main = "UAV NDVI 081519", xlab = "NDVI")
##0822
temp_arr <- raster::as.array(uav_082219$ndvi)
thr_uavndvi_082219 <- EBImage::otsu(temp_arr, range = c(min(temp_arr, na.rm = TRUE), max(temp_arr, na.rm = TRUE)), levels = 256)
thr_uavndvi_082219  #0.5409
hist(temp_arr, main = "UAV NDVI 082219", xlab = "NDVI")
```

##Vegetation Mask
###Use a threshold as 0.6
```{r}
#vegetation mask
veg_061219_ms_0.6 <- reclassify(uav_061219$ndvi, cbind(-Inf, 0.6, NA))
veg_061219_ms_0.5 <- reclassify(uav_061219$ndvi, cbind(-Inf, 0.5, NA))
veg_062819_ms_0.6 <- reclassify(uav_062819$ndvi, cbind(-Inf, 0.6, NA))
veg_062819_ms_0.5 <- reclassify(uav_062819$ndvi, cbind(-Inf, 0.5, NA))
veg_071219_ms_0.6 <- reclassify(uav_071219$ndvi, cbind(-Inf, 0.6, NA))
veg_071219_ms_0.5 <- reclassify(uav_071219$ndvi, cbind(-Inf, 0.5, NA))
veg_071719_ms_0.6 <- reclassify(uav_071719$ndvi, cbind(-Inf, 0.6, NA))
veg_071719_ms_0.5 <- reclassify(uav_071719$ndvi, cbind(-Inf, 0.5, NA))
veg_072619_ms_0.6 <- reclassify(uav_072619$ndvi, cbind(-Inf, 0.6, NA))
veg_072619_ms_0.5 <- reclassify(uav_072619$ndvi, cbind(-Inf, 0.5, NA))
veg_080219_ms_0.6 <- reclassify(uav_080219$ndvi, cbind(-Inf, 0.6, NA))
veg_080219_ms_0.5 <- reclassify(uav_080219$ndvi, cbind(-Inf, 0.5, NA))
veg_081019_ms_0.6 <- reclassify(uav_081019$ndvi, cbind(-Inf, 0.6, NA))
veg_081019_ms_0.5 <- reclassify(uav_081019$ndvi, cbind(-Inf, 0.5, NA))
veg_081519_ms_0.6 <- reclassify(uav_081519$ndvi, cbind(-Inf, 0.6, NA))
veg_081519_ms_0.5 <- reclassify(uav_081519$ndvi, cbind(-Inf, 0.5, NA))
veg_082219_ms_0.6 <- reclassify(uav_082219$ndvi, cbind(-Inf, 0.6, NA))
veg_082219_ms_0.5 <- reclassify(uav_082219$ndvi, cbind(-Inf, 0.5, NA))

#apply the mask
uav_061219_masked0.5 <- raster::mask(uav_061219, veg_061219_ms_0.5)
uav_061219_masked0.6 <- raster::mask(uav_061219, veg_061219_ms_0.6)
uav_062819_masked0.5 <- raster::mask(uav_062819, veg_062819_ms_0.5)
uav_062819_masked0.6 <- raster::mask(uav_062819, veg_062819_ms_0.6)
uav_071219_masked0.5 <- raster::mask(uav_071219, veg_071219_ms_0.5)
uav_071219_masked0.6 <- raster::mask(uav_071219, veg_071219_ms_0.6)
uav_071719_masked0.5 <- raster::mask(uav_071719, veg_071719_ms_0.5)
uav_071719_masked0.6 <- raster::mask(uav_071719, veg_071719_ms_0.6)
uav_072619_masked0.5 <- raster::mask(uav_072619, veg_072619_ms_0.5)
uav_072619_masked0.6 <- raster::mask(uav_072619, veg_072619_ms_0.6)
uav_080219_masked0.5 <- raster::mask(uav_080219, veg_080219_ms_0.5)
uav_080219_masked0.6 <- raster::mask(uav_080219, veg_080219_ms_0.6)
uav_081019_masked0.5 <- raster::mask(uav_081019, veg_081019_ms_0.5)
uav_081019_masked0.6 <- raster::mask(uav_081019, veg_081019_ms_0.6)
uav_081519_masked0.5 <- raster::mask(uav_081519, veg_081519_ms_0.5)
uav_081519_masked0.6 <- raster::mask(uav_081519, veg_081519_ms_0.6)
uav_082219_masked0.5 <- raster::mask(uav_082219, veg_082219_ms_0.5)
uav_082219_masked0.6 <- raster::mask(uav_082219, veg_082219_ms_0.6)

#write the result
path_output_ms <- "D:/Micasense_tomato/Outputs"
writeRaster(uav_061219_masked0.5, file.path(path_output_ms, "uav_061219_masked0.5.tif"))
writeRaster(uav_061219_masked0.6, file.path(path_output_ms, "uav_061219_masked0.6.tif"))
writeRaster(uav_062819_masked0.5, file.path(path_output_ms, "uav_062819_masked0.5.tif"))
writeRaster(uav_062819_masked0.6, file.path(path_output_ms, "uav_062819_masked0.6.tif"))
writeRaster(uav_071219_masked0.5, file.path(path_output_ms, "uav_071219_masked0.5.tif"))
writeRaster(uav_071219_masked0.6, file.path(path_output_ms, "uav_071219_masked0.6.tif"))
writeRaster(uav_071719_masked0.5, file.path(path_output_ms, "uav_071719_masked0.5.tif"))
writeRaster(uav_071719_masked0.6, file.path(path_output_ms, "uav_071719_masked0.6.tif"))
writeRaster(uav_072619_masked0.5, file.path(path_output_ms, "uav_072619_masked0.5.tif"))
writeRaster(uav_072619_masked0.6, file.path(path_output_ms, "uav_072619_masked0.6.tif"))
writeRaster(uav_080219_masked0.5, file.path(path_output_ms, "uav_080219_masked0.5.tif"))
writeRaster(uav_080219_masked0.6, file.path(path_output_ms, "uav_080219_masked0.6.tif"))
writeRaster(uav_081019_masked0.5, file.path(path_output_ms, "uav_081019_masked0.5.tif"))
writeRaster(uav_081019_masked0.6, file.path(path_output_ms, "uav_081019_masked0.6.tif"))
writeRaster(uav_081519_masked0.5, file.path(path_output_ms, "uav_081519_masked0.5.tif"))
writeRaster(uav_081519_masked0.6, file.path(path_output_ms, "uav_081519_masked0.6.tif"))
writeRaster(uav_082219_masked0.5, file.path(path_output_ms, "uav_082219_masked0.5.tif"))
writeRaster(uav_082219_masked0.6, file.path(path_output_ms, "uav_082219_masked0.6.tif"))

#write the veg mask
writeRaster(veg_061219_ms_0.5, file.path(path_output_ms, "veg_061219_ms_0.5.tif"))
writeRaster(veg_061219_ms_0.6, file.path(path_output_ms, "veg_061219_ms_0.6.tif"))
writeRaster(veg_062819_ms_0.5, file.path(path_output_ms, "veg_062819_ms_0.5.tif"))
writeRaster(veg_062819_ms_0.6, file.path(path_output_ms, "veg_062819_ms_0.6.tif"))
writeRaster(veg_071219_ms_0.5, file.path(path_output_ms, "veg_071219_ms_0.5.tif"))
writeRaster(veg_071219_ms_0.6, file.path(path_output_ms, "veg_071219_ms_0.6.tif"))
writeRaster(veg_071719_ms_0.5, file.path(path_output_ms, "veg_071719_ms_0.5.tif"))
writeRaster(veg_071719_ms_0.6, file.path(path_output_ms, "veg_071719_ms_0.6.tif"))
writeRaster(veg_072619_ms_0.5, file.path(path_output_ms, "veg_072619_ms_0.5.tif"))
writeRaster(veg_072619_ms_0.6, file.path(path_output_ms, "veg_072619_ms_0.6.tif"))
writeRaster(veg_080219_ms_0.5, file.path(path_output_ms, "veg_080219_ms_0.5.tif"))
writeRaster(veg_080219_ms_0.6, file.path(path_output_ms, "veg_080219_ms_0.6.tif"))
writeRaster(veg_081019_ms_0.5, file.path(path_output_ms, "veg_081019_ms_0.5.tif"))
writeRaster(veg_081019_ms_0.6, file.path(path_output_ms, "veg_081019_ms_0.6.tif"))
writeRaster(veg_081519_ms_0.5, file.path(path_output_ms, "veg_081519_ms_0.5.tif"))
writeRaster(veg_081519_ms_0.6, file.path(path_output_ms, "veg_081519_ms_0.6.tif"))
writeRaster(veg_082219_ms_0.5, file.path(path_output_ms, "veg_082219_ms_0.5.tif"))
writeRaster(veg_082219_ms_0.6, file.path(path_output_ms, "veg_082219_ms_0.6.tif"))
#read from the laptop 

#remove the ndvi layers
rm(veg_061219_ms_0.5);rm(veg_061219_ms_0.6);rm(veg_062819_ms_0.5);rm(veg_062819_ms_0.6);rm(veg_071219_ms_0.5);rm(veg_071219_ms_0.6);rm(veg_071719_ms_0.5);rm(veg_071719_ms_0.6);rm(veg_072619_ms_0.5);rm(veg_072619_ms_0.6);rm(veg_080219_ms_0.5);rm(veg_080219_ms_0.6);rm(veg_081019_ms_0.5);rm(veg_081019_ms_0.6);rm(veg_081519_ms_0.5);rm(veg_081519_ms_0.6);rm(veg_082219_ms_0.5);rm(veg_082219_ms_0.6)
```
##Fruit mask

```{r}
hist(veg_082219_ms_0.6)
hist(uav_082219_masked0.6$ndvi)
temp_arr <- raster::as.array(uav_082219_masked0.6$ndvi)
thr_test <- EBImage::otsu(temp_arr, range = c(min(temp_arr, na.rm = TRUE), max(temp_arr, na.rm = TRUE)), levels = 65536)
thr_test #0.776





#calculate redness
fruit_082219_1 <- uav_082219_masked0.6$red/uav_082219_masked0.6$green
writeRaster(fruit_082219_1, file.path(path_output_ms, "fruit_082219_1.tif"))

#calculate ExR
ExR_082219 <- uav_082219_masked0.6$red*1.4 - uav_082219_masked0.6$green
ExG_082219 <- uav_082219_masked0.6$green*2 - uav_082219_masked0.6$red - uav_082219_masked0.6$blue
ExGExR_082219 <- ExG_082219 - ExR_082219
writeRaster(ExR_082219, file.path(path_output_ms, "ExR_082219.tif"),overwrite = TRUE)
writeRaster(ExG_082219, file.path(path_output_ms, "ExG_082219.tif"),overwrite = TRUE)
writeRaster(ExGExR_082219, file.path(path_output_ms, "ExGExR_082219.tif"),overwrite = TRUE)
hist(ExR_082219)
hist(ExGExR_082219)
fruit_thr_082219 <- EBImage::otsu(as.array(ExGExR_082219), range = c(min(as.array(ExGExR_082219), na.rm = TRUE), max(as.array(ExGExR_082219), na.rm = TRUE)),levels = 65536)  #0.0648

#build the fruit mask 
fruit_ms_082219 <- reclassify(ExGExR_082219, cbind(-Inf, 0, NA))
#fruit_ms_082219 <- reclassify(ExGExR_082219, cbind(-Inf, fruit_thr_082219, NA))
writeRaster(fruit_ms_082219, file.path(path_output_ms, "fruit_ms_082219.tif"))
uav_082219_masked0.6_maskedfruit2 <- raster::mask(uav_082219_masked0.6, fruit_ms_082219)
writeRaster(uav_082219_masked0.6_maskedfruit2, file.path(path_output_ms, "uav_082219_masked0.6_maskedfruit2.tif"))
```
##buffer
```{r}
fruit_ms_082219_buff <- gBuffer(fruit_ms_082219, width = -0.027567)

```

##Erosion
```{r}
#combine two masks into one
vegfruitmask_082219 <- raster::merge(veg_082219_ms_0.6, fruit_ms_082219)
writeRaster(vegfruitmask_082219, file.path(path_output_ms,"vegfruitmask_082219.tif"))
erosion_082219 <- EBImage::erode(as.array(uav_082219_masked0.6_maskedfruit$ndvi), kern = makeBrush(3))
class(erosion_082219)
plot(erosion_082219)
a <- as.raster(erosion_082219)
```

##Shadow mask
###Function to calculate HSV
```{r}
rgbtohsv <- function(r,g,b){
  v = 1/3*(r+g+b)
  s = 1-3/(r+g+b)*min(r,g,b)
  ndi = (s-v)/(s+v)
  return(ndi)
}

hsv_test1 <- rgbtohsv(r = subset(uav_082219_masked0.6, 3), g = subset(uav_082219_masked0.6, 2), b = subset(uav_082219_masked0.6, 1))
#output
plot(hsv_test1)
hist(hsv_test1)
shadow_thr <- EBImage::otsu(as.array(hsv_test1), range = c(min(as.array(hsv_test1),na.rm = TRUE), max(as.array(hsv_test1), na.rm = TRUE)), levels = 65536) #0.6514
writeRaster(hsv_test1, file.path(path_output_ms, "hsvNDI_082219.tif"))


#build the binary mask 
shadow_ms_082219 <- reclassify(hsv_test1, cbind(shadow_thr, Inf, NA))
writeRaster(shadow_ms_082219, file.path(path_output_ms, "shadow_ms_082219.tif"))
#apply the mask
#uav_061219_masked0.5 <- raster::mask(uav_061219, veg_061219_ms_0.5)
uav_082219_masked0.6_maskedfruit_maskedshad <- raster::mask(uav_082219_masked0.6_maskedfruit, shadow_ms_082219)
writeRaster(uav_082219_masked0.6_maskedfruit_maskedshad, file.path(path_output_ms, "uav_082219_masked0.6_maskedfruit_maskedshad.tif"))
```

```{r}

hsv_test1 <- rgb2hsv(r = subset(uav_082219_masked0.6, 3), g = subset(uav_082219_masked0.6, 2), b = subset(uav_082219_masked0.6, 1), maxColorValue = 1)
hsv_test1 <- overlay(subset(uav_082219_masked0.6, 1:3), fun=rgb2hsv)
hsv_test <- raster::overlay(as.matrix(subset(uav_082219_masked0.6, 1:3)), fun = function(x){rgb2hsv(x, maxColorValue = 1)})
```
##Erosion morphological  
```{r}
test_erosion <- EBImage::erode()
```

##Extraction of the flag average
###Function of extraction
```{r}
ref_extract <- function(uav,shp, FUN, buff){
  ext_uav <- raster::extract(uav, shp, fun = FUN, na.rm = TRUE, df = TRUE, buffer = buff)
  ext_uav$Treatment <- shp$Treatment
  ext_uav$Side <- shp$Side
  ext_uav$Block <- shp$Block
  ext_uav$Row <- shp$Row
  #ext_uav$Plot <- shp$Plot
  return(ext_uav)
}

#for flagmean extraction 
ref_extract_flag <- function(uav,shp, FUN, buff){
  ext_uav <- raster::extract(uav, shp, fun = FUN, na.rm = TRUE, df = TRUE, buffer = buff)
  ext_uav$Treatment <- shp$Treatment
  ext_uav$Side <- shp$Side
  ext_uav$Block <- shp$Block
  ext_uav$Row <- shp$Row
  ext_uav$id <- shp$id
  ext_uav$Plant <- shp$Plant
  #ext_uav$Plot <- shp$Plot
  return(ext_uav)
}
```
###Extract different versions of mask  
```{r}
#read micasense img
uav_062819_masked0.6 <- read_uav(path_output_ms, "uav_062819_masked0.6.tif")
uav_080219_masked0.6 <- read_uav(path_output_ms, "uav_080219_masked0.6.tif")
uav_081519_masked0.6 <- read_uav(path_output_ms, "uav_081519_masked0.6.tif")
names(uav_062819_masked0.6)
plot(uav_062819_masked0.6)

uav_061219_masked0.5 <- read_uav(path_output_ms, "uav_061219_masked0.5.tif")
uav_062819_masked0.5 <- read_uav(path_output_ms, "uav_062819_masked0.5.tif")
uav_071219_masked0.5 <- read_uav(path_output_ms, "uav_071219_masked0.5.tif")
uav_071719_masked0.5 <- read_uav(path_output_ms, "uav_071719_masked0.5.tif")
uav_072619_masked0.5 <- read_uav(path_output_ms, "uav_072619_masked0.5.tif")
uav_080219_masked0.5 <- read_uav(path_output_ms, "uav_080219_masked0.5.tif")
uav_081019_masked0.5 <- read_uav(path_output_ms, "uav_081019_masked0.5.tif")
uav_081519_masked0.5 <- read_uav(path_output_ms, "uav_081519_masked0.5.tif")

#read_uav(path_uav, "tomato_061219_stacks2.tif")

#0.5 as threshold
flagmean_uav_061219_masked0.5 <- ref_extract_flag(uav_061219_masked0.5, flagbuff_2019, mean, 0)
flagmean_uav_062819_masked0.5 <- ref_extract_flag(uav_062819_masked0.5, flagbuff_2019, mean, 0)
flagmean_uav_071219_masked0.5 <- ref_extract_flag(uav_071219_masked0.5, flagbuff_2019, mean, 0)
flagmean_uav_071719_masked0.5 <- ref_extract_flag(uav_071719_masked0.5, flagbuff_2019, mean, 0)
flagmean_uav_072619_masked0.5 <- ref_extract_flag(uav_072619_masked0.5, flagbuff_2019, mean, 0)
flagmean_uav_080219_masked0.5 <- ref_extract_flag(uav_080219_masked0.5, flagbuff_2019, mean, 0)
flagmean_uav_081019_masked0.5 <- ref_extract_flag(uav_081019_masked0.5, flagbuff_2019, mean, 0)
flagmean_uav_081519_masked0.5 <- ref_extract_flag(uav_081519_masked0.5, flagbuff_2019, mean, 0)
flagmean_uav_082219_masked0.5 <- ref_extract_flag(uav_082219_masked0.5, flagbuff_2019, mean, 0)
#0.6 as threshold
flagmean_uav_061219_masked0.6 <- ref_extract_flag(uav_061219_masked0.6, flagbuff_2019, mean, 0)
flagmean_uav_062819_masked0.6 <- ref_extract_flag(uav_062819_masked0.6, flagbuff_2019, mean, 0)
flagmean_uav_071219_masked0.6 <- ref_extract_flag(uav_071219_masked0.6, flagbuff_2019, mean, 0)
flagmean_uav_071719_masked0.6 <- ref_extract_flag(uav_071719_masked0.6, flagbuff_2019, mean, 0)
flagmean_uav_072619_masked0.6 <- ref_extract_flag(uav_072619_masked0.6, flagbuff_2019, mean, 0)
flagmean_uav_080219_masked0.6 <- ref_extract_flag(uav_080219_masked0.6, flagbuff_2019, mean, 0)
flagmean_uav_081019_masked0.6 <- ref_extract_flag(uav_081019_masked0.6, flagbuff_2019, mean, 0)
flagmean_uav_081519_masked0.6 <- ref_extract_flag(uav_081519_masked0.6, flagbuff_2019, mean, 0)
flagmean_uav_082219_masked0.6 <- ref_extract_flag(uav_082219_masked0.6, flagbuff_2019, mean, 0)
#no mask 
flagmean_uav_061219_nomask <- ref_extract_flag(uav_061219, flagbuff_2019, mean, 0)
flagmean_uav_062819_nomask <- ref_extract_flag(uav_062819, flagbuff_2019, mean, 0)
flagmean_uav_071219_nomask <- ref_extract_flag(uav_071219, flagbuff_2019, mean, 0)
flagmean_uav_071719_nomask <- ref_extract_flag(uav_071719, flagbuff_2019, mean, 0)
flagmean_uav_072619_nomask <- ref_extract_flag(uav_072619, flagbuff_2019, mean, 0)
flagmean_uav_080219_nomask <- ref_extract_flag(uav_080219, flagbuff_2019, mean, 0)
flagmean_uav_081019_nomask <- ref_extract_flag(uav_081019, flagbuff_2019, mean, 0)
flagmean_uav_081519_nomask <- ref_extract_flag(uav_081519, flagbuff_2019, mean, 0)
flagmean_uav_082219_nomask <- ref_extract_flag(uav_082219, flagbuff_2019, mean, 0)

```
###Combine different dates together
```{r}
#0.5
#add date
flagmean_uav_061219_masked0.5$Date <- as.Date("2019-06-12")
flagmean_uav_062819_masked0.5$Date <- as.Date("2019-06-28")
flagmean_uav_071219_masked0.5$Date <- as.Date("2019-07-12")
flagmean_uav_071719_masked0.5$Date <- as.Date("2019-07-17")
flagmean_uav_072619_masked0.5$Date <- as.Date("2019-07-26")
flagmean_uav_080219_masked0.5$Date <- as.Date("2019-08-02")
flagmean_uav_081019_masked0.5$Date <- as.Date("2019-08-10")
flagmean_uav_081519_masked0.5$Date <- as.Date("2019-08-15")
flagmean_uav_082219_masked0.5$Date <- as.Date("2019-08-22")
#combine them together
#flagmean_uav_masked0.6 <- rbind(flagmean_uav_062819_masked0.6, flagmean_uav_080219_masked0.6, flagmean_uav_081519_masked0.6)

flagmean_uav_masked0.5 <- rbind(flagmean_uav_061219_masked0.5, flagmean_uav_062819_masked0.5, flagmean_uav_071219_masked0.5, flagmean_uav_071719_masked0.5, flagmean_uav_072619_masked0.5, flagmean_uav_080219_masked0.5, flagmean_uav_081019_masked0.5, flagmean_uav_081519_masked0.5)

#0.6
#add date
flagmean_uav_061219_masked0.6$Date <- as.Date("2019-06-12")
flagmean_uav_062819_masked0.6$Date <- as.Date("2019-06-28")
flagmean_uav_071219_masked0.6$Date <- as.Date("2019-07-12")
flagmean_uav_071719_masked0.6$Date <- as.Date("2019-07-17")
flagmean_uav_072619_masked0.6$Date <- as.Date("2019-07-26")
flagmean_uav_080219_masked0.6$Date <- as.Date("2019-08-02")
flagmean_uav_081019_masked0.6$Date <- as.Date("2019-08-10")
flagmean_uav_081519_masked0.6$Date <- as.Date("2019-08-15")
flagmean_uav_082219_masked0.6$Date <- as.Date("2019-08-22")
#combine them together
flagmean_uav_masked0.5 <- rbind(flagmean_uav_062819_masked0.5, flagmean_uav_080219_masked0.5, flagmean_uav_081519_masked0.5)
#flagmean_uav_masked0.6 <- rbind(flagmean_uav_061219_masked0.6, flagmean_uav_062819_masked0.6, flagmean_uav_071219_masked0.6, flagmean_uav_071719_masked0.6, flagmean_uav_072619_masked0.6, flagmean_uav_080219_masked0.6, flagmean_uav_081019_masked0.6, flagmean_uav_081519_masked0.6, flagmean_uav_082219_masked0.6)

#add date
flagmean_uav_061219_nomask$Date <- as.Date("2019-06-12")
flagmean_uav_062819_nomask$Date <- as.Date("2019-06-28")
flagmean_uav_071219_nomask$Date <- as.Date("2019-07-12")
flagmean_uav_071719_nomask$Date <- as.Date("2019-07-17")
flagmean_uav_072619_nomask$Date <- as.Date("2019-07-26")
flagmean_uav_080219_nomask$Date <- as.Date("2019-08-02")
flagmean_uav_081019_nomask$Date <- as.Date("2019-08-10")
flagmean_uav_081519_nomask$Date <- as.Date("2019-08-15")
flagmean_uav_082219_nomask$Date <- as.Date("2019-08-22")
#combine them together
flagmean_uav_nomask <- rbind(flagmean_uav_061219_nomask, flagmean_uav_062819_nomask, flagmean_uav_071219_nomask, flagmean_uav_071719_nomask, flagmean_uav_072619_nomask, flagmean_uav_080219_nomask, flagmean_uav_081019_nomask, flagmean_uav_081519_nomask, flagmean_uav_082219_nomask)

```

###Boxplot
```{r}
flagmean_uav_masked0.5$Treatment <- factor(flagmean_uav_masked0.5$Treatment, levels = c("BAYER 16 (SOIL) WW", "CONTROL WW", "CONTROL DDD"), order = TRUE)
flagmean_uav_masked0.6$Treatment <- factor(flagmean_uav_masked0.6$Treatment, levels = c("BAYER 16 (SOIL) WW", "CONTROL WW", "CONTROL DDD"), order = TRUE)
#flagmean_macaw_phys$Treatment2 <- factor(flagmean_macaw_phys$Treatment, levels = c("BAYER 16 (SOIL) WW", "CONTROL WW", "CONTROL DDD"), order = TRUE)

ggplot(flagmean_uav_masked0.5, aes(x = as.factor(Date), y = ndvi, fill = Treatment)) + geom_boxplot(position = position_dodge(0.75))+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("NDVI") + scale_fill_tableau() + ggtitle("NDVI from Micasense Plant Average")
ggplot(flagmean_uav_masked0.5, aes(x = as.factor(Date), y = nir, fill = Treatment)) + geom_boxplot(position = position_dodge(0.75))+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("NIR") + scale_fill_tableau() + ggtitle("NIR from Micasense Plant Average")
ggplot(flagmean_uav_masked0.5, aes(x = as.factor(Date), y = rededge, fill = Treatment)) + geom_boxplot(position = position_dodge(0.75))+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("Rededge") + scale_fill_tableau() + ggtitle("Rededge from Micasense Plant Average")
ggplot(flagmean_uav_masked0.5, aes(x = as.factor(Date), y = red, fill = Treatment)) + geom_boxplot(position = position_dodge(0.75))+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("Red") + scale_fill_tableau() + ggtitle("Red from Micasense Plant Average")
ggplot(flagmean_uav_masked0.5, aes(x = as.factor(Date), y = green, fill = Treatment)) + geom_boxplot(position = position_dodge(0.75))+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("Green") + scale_fill_tableau() + ggtitle("Green from Micasense Plant Average")
ggplot(flagmean_uav_masked0.5, aes(x = as.factor(Date), y = blue, fill = Treatment)) + geom_boxplot(position = position_dodge(0.75))+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("Blue") + scale_fill_tableau() + ggtitle("Blue from Micasense Plant Average")


ggplot(flagmean_uav_masked0.6, aes(x = as.factor(Date), y = ndvi, fill = Treatment)) + geom_boxplot(position = position_dodge(0.75))+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("NDVI") + scale_fill_tableau() + ggtitle("NDVI from Micasense Plant Average")
ggplot(flagmean_uav_masked0.6, aes(x = as.factor(Date), y = nir, fill = Treatment)) + geom_boxplot(position = position_dodge(0.75))+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("NIR") + scale_fill_tableau() + ggtitle("NIR from Micasense Plant Average")
ggplot(flagmean_uav_masked0.6, aes(x = as.factor(Date), y = rededge, fill = Treatment)) + geom_boxplot(position = position_dodge(0.75))+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("Rededge") + scale_fill_tableau() + ggtitle("Rededge from Micasense Plant Average")
ggplot(flagmean_uav_masked0.6, aes(x = as.factor(Date), y = red, fill = Treatment)) + geom_boxplot(position = position_dodge(0.75))+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("Red") + scale_fill_tableau() + ggtitle("Red from Micasense Plant Average")
ggplot(flagmean_uav_masked0.6, aes(x = as.factor(Date), y = green, fill = Treatment)) + geom_boxplot(position = position_dodge(0.75))+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("Green") + scale_fill_tableau() + ggtitle("Green from Micasense Plant Average")
ggplot(flagmean_uav_masked0.6, aes(x = as.factor(Date), y = blue, fill = Treatment)) + geom_boxplot(position = position_dodge(0.75))+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("Blue") + scale_fill_tableau() + ggtitle("Blue from Micasense Plant Average")


```
##Extraction of the Row Average
```{r}
path_df <- "C:/Users/tangz/Box Sync/BIOSTIMULANT TRIAL - SEASON 2/ZHEHAN/dataframes"
list.files(path_df)
rowmean_uav_3ft_masked <- read.csv(file.path(path_df, "rowmean_uav_3ft_masked.csv"))
View(rowmean_uav_masked)
#subset
rowmean_uav_3ft_masked_sb <- subset(rowmean_uav_3ft_masked, Treatment %in% c("BAYER 16 (SOIL) WW", "CONTROL WW", "CONTROL DDD"))
rowmean_uav_3ft_masked_sb$Treatment <- factor(rowmean_uav_3ft_masked_sb$Treatment, levels = c("BAYER 16 (SOIL) WW", "CONTROL WW", "CONTROL DDD"), order = TRUE)
rowmean_uav_3ft_masked_sb <- subset(rowmean_uav_3ft_masked_sb, Row <= 179)
#flagmean_uav_masked0.5$Treatment <- factor(flagmean_uav_masked0.5$Treatment, levels = c("BAYER 16 (SOIL) WW", "CONTROL WW", "CONTROL DDD"), order = TRUE)

```

###Boxplot
```{r}


ggplot(subset(rowmean_uav_3ft_masked_sb), aes(x = as.factor(Date), y = ndvi, fill = Treatment)) + geom_boxplot(position = position_dodge(0.75))+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("NDVI") + scale_fill_tableau() + ggtitle("NDVI from Micasense Row Average")

ggplot(subset(rowmean_uav_3ft_masked_sb, Date %in% c("2019-06-28","2019-08-02","2019-08-15")), aes(x = as.factor(Date), y = ndvi, fill = Treatment)) + geom_boxplot(position = position_dodge(0.75))+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("NDVI") + scale_fill_tableau() + ggtitle("NDVI from Micasense Row Average")


ggplot(subset(rowmean_uav_3ft_masked_sb, Date %in% c("2019-06-28","2019-08-02","2019-08-15")), aes(x = as.factor(Date), y = ndvi, fill = Treatment)) + geom_dotplot(binaxis = 'y', stackdir = 'center', position = position_dodge(0.75))

#ggplot(subset(flagmean_macaw,Date!="2019-05-31"), aes(x = Date, y =  pri, fill=Treatment))+ geom_dotplot(binaxis = 'y', stackdir = 'center', position = position_dodge(0.75))

```

#-----------------------------------------------------------------
#Read macaw imgs
##read 12band macaw function 
```{r}
path_12bands <- "D:/MACAW_tomato"


read_12band <- function(path, stacks){
  uav_stacks <- raster::brick(file.path(path, stacks))
  #subset to 1:12
  uav_stacks <- subset(uav_stacks, 1:12)
  #rename 
  names(uav_stacks) <- c("X800","X450","X480","X530","X550","X570","X670","X700","X720","X740","X900","X970")
  return(uav_stacks)
}
```

##(Useless currently)read macaw function  
```{r}
read_macaw <- function(path, stacks){
  #read raster layer, and crop with the extent
  uav_stacks <- raster::brick(file.path(path, stacks))
  #rename the bands
  names(uav_stacks) <- c("p800","p570","p530")
  
  return(uav_stacks)
}


```
##Read 12band macaw from mobile hard drive
```{r}
path_12band <- "D:/MACAW_tomato"
macaw_082219 <- read_12band(path_12band, "agisoft_20190822_12bands_withgcps.tif")
macaw_082219
macaw_081519 <- read_12band(path_12band, "agisoft_20190815_12bands_withgcps.tif")
macaw_081519
macaw_081019 <- read_12band(path_12band, "agisoft_20190810_12bands_withgcps.tif")
macaw_081019
macaw_080219 <- read_12band(path_12band, "agisoft_20190802_12bands_withgcps.tif")
macaw_080219
macaw_062819 <- read_12band(path_12band, "agisoft_20190628_12bands_withgcps.tif")
macaw_062819
macaw_053119 <- read_12band(path_12band, "agisoft_20190531_12bands_withgcps.tif")
macaw_053119

```

##(Not useful)Read from local computer
```{r}
path_pri <- "C:/Users/tangz/Box Sync/BIOSTIMULANT FIELD SCREENING MASTER FOLDER/DRONE/macaw_pri"

#0822
macaw_082219 <- read_macaw(path_pri, "tomato_macawrgbpri_082219.tif")
pri_082219 <- (macaw_082219$p530 - macaw_082219$p570)/((macaw_082219$p530 + macaw_082219$p570))
writeRaster(pri_082219, file.path(path_pri, "pri_082219.tif"))
#0815
macaw_081519 <- read_macaw(path_pri, "tomato_macawrgbpri_081519.tif")
pri_081519 <- (macaw_081519$p530 - macaw_081519$p570)/((macaw_081519$p530 + macaw_081519$p570))
writeRaster(pri_081519, file.path(path_pri, "pri_081519.tif"))
#0810
macaw_081019 <- read_macaw(path_pri, "tomato_macawrgbpri_081019.tif")
pri_081019 <- (macaw_081019$p530 - macaw_081019$p570)/((macaw_081019$p530 + macaw_081019$p570))
writeRaster(pri_081019, file.path(path_pri, "pri_081019.tif"))
#0802
macaw_080219 <- read_macaw(path_pri, "tomato_macawrgbpri_080219.tif")
pri_080219 <- (macaw_080219$p530 - macaw_080219$p570)/((macaw_080219$p530 + macaw_080219$p570))
writeRaster(pri_080219, file.path(path_pri, "pri_080219.tif"))
#0628
macaw_062819 <- read_macaw(path_pri, "tomato_macawrgbpri_062819.tif")
pri_062819 <- (macaw_062819$p530 - macaw_062819$p570)/((macaw_062819$p530 + macaw_062819$p570))
writeRaster(pri_062819, file.path(path_pri, "pri_062819.tif"))


```


##Read fom the server
```{r}
path_pri_server <- "/z0/zt92/Tomato_biomass/tomato_analysis_2019/outputs"
pri_062819 <- raster(file.path(path_pri_server, 'pri_062819.tif'))
pri_080219 <- raster(file.path(path_pri_server, 'pri_080219.tif'))
pri_081019 <- raster(file.path(path_pri_server, 'pri_081019.tif'))
pri_081519 <- raster(file.path(path_pri_server, 'pri_081519.tif'))
pri_082219 <- raster(file.path(path_pri_server, 'pri_082219.tif'))
```


#Vegetation mask
##Calculate NDVI
```{r}
ndvi_053119 <- (macaw_053119$X800-macaw_053119$X670)/(macaw_053119$X800+macaw_053119$X670)
ndvi_062819 <- (macaw_062819$X800-macaw_062819$X670)/(macaw_062819$X800+macaw_062819$X670)
ndvi_080219 <- (macaw_080219$X800-macaw_080219$X670)/(macaw_080219$X800+macaw_080219$X670)
#ndvi_081019 <- (macaw_081019$X800-macaw_081019$X670)/(macaw_081019$X800+macaw_081019$X670)
ndvi_081519 <- (macaw_081519$X800-macaw_081519$X670)/(macaw_081519$X800+macaw_081519$X670)
ndvi_082219 <- (macaw_082219$X800-macaw_082219$X670)/(macaw_082219$X800+macaw_082219$X670)

#add layer to the raster brick 
macaw_053119 <- addLayer(macaw_053119, ndvi_053119)
names(macaw_053119)[13] <- "NDVI"
macaw_062819 <- addLayer(macaw_062819, ndvi_062819)
names(macaw_062819)[13] <- "NDVI"
macaw_080219 <- addLayer(macaw_080219, ndvi_080219)
names(macaw_080219)[13] <- "NDVI"
#macaw_081019 <- addLayer(macaw_081019, ndvi_081019)
#names(macaw_081019)[13] <- "NDVI"
macaw_081519 <- addLayer(macaw_081519, ndvi_081519)
names(macaw_081519)[13] <- "NDVI"
macaw_082219 <- addLayer(macaw_082219, ndvi_082219)
names(macaw_082219)[13] <- "NDVI"

#Output
path_output <- "D:/MACAW_tomato/Outputs"
writeRaster(ndvi_082219, file.path(path_output, "NDVI_082219.tif"))
writeRaster(ndvi_081519, file.path(path_output, "NDVI_081519.tif"))
writeRaster(ndvi_081019, file.path(path_output, "NDVI_081019.tif"))
writeRaster(ndvi_080219, file.path(path_output, "NDVI_080219.tif"))
writeRaster(ndvi_062819, file.path(path_output, "NDVI_062819.tif"))
writeRaster(ndvi_053119, file.path(path_output, "NDVI_053119.tif"))


#read ndvi 
path_output <- "D:/MACAW_tomato/Outputs"
ndvi_053119 <- raster(file.path(path_output, "NDVI_053119.tif"))
ndvi_062819 <- raster(file.path(path_output, "NDVI_062819.tif"))
ndvi_080219 <- raster(file.path(path_output, "NDVI_080219.tif"))
ndvi_081019 <- raster(file.path(path_output, "NDVI_081019.tif"))
ndvi_081519 <- raster(file.path(path_output, "NDVI_081519.tif"))


```
###Crop to boundary
```{r}
BND <- shapefile(file.path(path_shp, "tomato_BND_2019.shp"))
plot(BND, add = TRUE)
macaw_053119 <- raster::crop(macaw_053119, BND)
macaw_062819 <- raster::crop(macaw_062819, BND)
macaw_080219 <- raster::crop(macaw_080219, BND)
macaw_081019 <- raster::crop(macaw_081019, BND)
macaw_081519 <- raster::crop(macaw_081519, BND)
macaw_082219 <- raster::crop(macaw_082219, BND)

ndvi_053119 <- raster::crop(ndvi_053119, BND)
ndvi_062819 <- raster::crop(ndvi_062819, BND)
ndvi_080219 <- raster::crop(ndvi_080219, BND)
#ndvi_081019 <- raster::crop(ndvi_081019, BND)
ndvi_081519 <- raster::crop(ndvi_081519, BND)

```

##Vegetation mask
###use a threshold as 0.5
```{r}
#vegetation mask
veg_053119 <- reclassify(macaw_053119$NDVI, cbind(-Inf, 0.5, NA))
veg_062819 <- reclassify(macaw_062819$NDVI, cbind(-Inf, 0.5, NA))
veg_080219 <- reclassify(macaw_080219$NDVI, cbind(-Inf, 0.5, NA))
#veg_081019 <- reclassify(macaw_081019$NDVI, cbind(-Inf, 0.5, NA))
veg_081519 <- reclassify(macaw_081519$NDVI, cbind(-Inf, 0.5, NA))
veg_082219 <- reclassify(macaw_082219$NDVI, cbind(-Inf, 0.5, NA))

#apply the mask
macaw_053119_masked <- raster::mask(macaw_053119, veg_053119)
macaw_062819_masked <- raster::mask(macaw_062819, veg_062819)
macaw_080219_masked <- raster::mask(macaw_080219, veg_080219)
#macaw_081019_masked <- raster::mask(macaw_081019, veg_081019)
macaw_081519_masked <- raster::mask(macaw_081519, veg_081519)
macaw_082219_masked <- raster::mask(macaw_082219, veg_082219)

#write the result
path_output <- "D:/MACAW_tomato/Outputs"
writeRaster(macaw_053119_masked, file.path(path_output, "macaw_053119_masked0.5.tif"), overwrite = TRUE)
writeRaster(macaw_062819_masked, file.path(path_output, "macaw_062819_masked0.5.tif"), overwrite = TRUE)
writeRaster(macaw_080219_masked, file.path(path_output, "macaw_080219_masked0.5.tif"), overwrite = TRUE)
#writeRaster(macaw_081019_masked, file.path(path_output, "macaw_081019_masked0.5.tif"))
writeRaster(macaw_081519_masked, file.path(path_output, "macaw_081519_masked0.5.tif"),overwrite=  TRUE)
writeRaster(macaw_082219_masked, file.path(path_output, "macaw_082219_masked0.5.tif"), overwrite = TRUE)

#read from the laptop 

#remove the ndvi layers
rm(veg_062819);rm(veg_080219);rm(veg_081019);rm(veg_081519);rm(veg_082219)
rm(ndvi_062819);rm(ndvi_080219);rm(ndvi_081019);rm(ndvi_081519);rm(ndvi_082219)

```
###Buffer over the vegetation mask 
```{r}
#nonveg_053119 <- reclassify(ndvi_053119, cbind(0.5, Inf, NA))
nonveg_053119 <- reclassify(ndvi_053119, rbind(c(0.5, Inf, 0),c(-Inf, 0.5, 1)))
nonveg_062819 <- reclassify(ndvi_062819, rbind(c(0.5, Inf, 0),c(-Inf, 0.5, 1)))
nonveg_080219 <- reclassify(ndvi_080219, rbind(c(0.5, Inf, 0),c(-Inf, 0.5, 1)))
nonveg_081519 <- reclassify(ndvi_081519, rbind(c(0.5, Inf, 0),c(-Inf, 0.5, 1)))
#output the nonveg mask 
writeRaster(nonveg_053119, file.path(path_output, "nonveg_053119.tif"))
writeRaster(nonveg_062819, file.path(path_output, "nonveg_062819.tif"))
writeRaster(nonveg_080219, file.path(path_output, "nonveg_080219.tif"))
writeRaster(nonveg_081519, file.path(path_output, "nonveg_081519.tif"))
#convert raster to shapefile
nonveg_053119_shp <- raster::rasterToPolygons(nonveg_053119, fun = function(x){x>0})
nonveg_062819_shp <- raster::rasterToPolygons(nonveg_062819, fun = function(x){x>0})
nonveg_080219_shp <- raster::rasterToPolygons(nonveg_080219, fun = function(x){x>0})
nonveg_081519_shp <- raster::rasterToPolygons(nonveg_081519, fun = function(x){x>0})
#output the shapefile
shapefile(nonveg_053119_shp, filename = file.path(path_output, "nonveg_053119_shp.shp"))
shapefile(nonveg_062819_shp, filename = file.path(path_output, "nonveg_062819_shp.shp"))
shapefile(nonveg_080219_shp, filename = file.path(path_output, "nonveg_080219_shp.shp"))
shapefile(nonveg_081519_shp, filename = file.path(path_output, "nonveg_081519_shp.shp"))
#buffer around the shapefile 
nonveg_053119_shp_buff <- raster::buffer(nonveg_053119_shp, width = res(nonveg_053119)[1]*3)
nonveg_062819_shp_buff <- raster::buffer(nonveg_062819_shp, width = res(nonveg_053119)[1]*3)
nonveg_080219_shp_buff <- raster::buffer(nonveg_080219_shp, width = res(nonveg_053119)[1]*3)
nonveg_081519_shp_buff <- raster::buffer(nonveg_081519_shp, width = res(nonveg_053119)[1]*3)
#output the shapefile 
shapefile(nonveg_053119_shp_buff, filename = file.path(path_output, "nonveg_053119_shp_buff.shp"))
shapefile(nonveg_062819_shp_buff, filename = file.path(path_output, "nonveg_062819_shp_buff.shp"))
shapefile(nonveg_080219_shp_buff, filename = file.path(path_output, "nonveg_080219_shp_buff.shp"))
shapefile(nonveg_081519_shp_buff, filename = file.path(path_output, "nonveg_081519_shp_buff.shp"))


#convert raster to shapefile
nonveg_053119_shp <- raster::rasterToPolygons(nonveg_053119_2, fun = function(x){x>0})
writeRaster(nonveg_053119, file.path(path_output, "nonveg_053119.tif"))
writeRaster(nonveg_053119_2, file.path(path_output, "nonveg_053119_2.tif"))


```


#Read the masked MACAW images
```{r}
path_output <- "D:/MACAW_tomato/Outputs"
macaw_053119_masked <- raster::brick(file.path(path_output, "macaw_053119_masked0.5.tif"))
names(macaw_053119_masked) <- c("X800","X450","X480","X530","X550","X570","X670","X700","X720","X740","X900","X970","NDVI")
macaw_062819_masked <- raster::brick(file.path(path_output, "macaw_062819_masked0.5.tif"))
names(macaw_062819_masked) <- c("X800","X450","X480","X530","X550","X570","X670","X700","X720","X740","X900","X970","NDVI")
macaw_080219_masked <- raster::brick(file.path(path_output, "macaw_080219_masked0.5.tif"))
names(macaw_080219_masked) <- c("X800","X450","X480","X530","X550","X570","X670","X700","X720","X740","X900","X970","NDVI")
macaw_081519_masked <- raster::brick(file.path(path_output, "macaw_081519_masked0.5.tif"))
names(macaw_081519_masked) <- c("X800","X450","X480","X530","X550","X570","X670","X700","X720","X740","X900","X970","NDVI")


```
#Apply a buffer around the veg mask 
```{r}

veg_062819 <- reclassify(macaw_062819$NDVI, cbind(-Inf, 0.5, NA))

```

##Fruit mask
###before the veg mask 
```{r}
#062819
#ExR = 1.4Red-Green
ExR_062819_macaw_masked <- macaw_062819_masked$X670*1.4 - macaw_062819_masked$X550
#ExG = 2Green - Red - Blue
ExG_062819_macaw_masked <- macaw_062819_masked$X550*2 - macaw_062819_masked$X670 - macaw_062819_masked$X450
ExGExR_062819_macaw_masked <- ExG_062819_macaw_masked - ExR_062819_macaw_masked
hist(ExGExR_062819_macaw_masked)
#output
writeRaster(ExGExR_062819_macaw_masked, file.path(path_output, "ExGExR_062819_macaw_masked.tif"))
#calculate the threshold 
temp_arr <- as.array(ExGExR_062819_macaw_masked)
temp_thr <- EBImage::otsu(temp_arr, range = c(min(temp_arr, na.rm = TRUE), max(temp_arr, na.rm = TRUE)), levels = 65536)  #-27366,92
#build the fruit mask
veg_exgexr_062819_macaw_masked <- reclassify(ExGExR_062819_macaw_masked, cbind(-Inf,0,NA))
macaw_062819_exgexrmasked <- raster::mask(macaw_062819_masked, veg_exgexr_062819_macaw_masked)
writeRaster(macaw_062819_exgexrmasked, file.path(path_output, "macaw_062819_exgexrmasked.tif"),overwrite = TRUE)


#080219 
#ExR = 1.4Red-Green
ExR_080219_macaw_masked <- macaw_080219_masked$X670*1.4 - macaw_080219_masked$X550
#ExG = 2Green - Red - Blue
ExG_080219_macaw_masked <- macaw_080219_masked$X550*2 - macaw_080219_masked$X670 - macaw_080219_masked$X450
ExGExR_080219_macaw_masked <- ExG_080219_macaw_masked - ExR_080219_macaw_masked
hist(ExGExR_080219_macaw_masked)
#output
writeRaster(ExGExR_080219_macaw_masked, file.path(path_output, "ExGExR_080219_macaw_masked.tif"))
#calculate the threshold 
temp_arr <- as.array(ExGExR_080219_macaw_masked)
temp_thr <- EBImage::otsu(temp_arr, range = c(min(temp_arr, na.rm = TRUE), max(temp_arr, na.rm = TRUE)), levels = 65536)  #-50047.14
temp_thr
#build the fruit mask
veg_exgexr_080219_macaw_masked <- reclassify(ExGExR_080219_macaw_masked, cbind(-Inf,0,NA))
macaw_080219_exgexrmasked <- raster::mask(macaw_080219_masked, veg_exgexr_080219_macaw_masked)
writeRaster(macaw_080219_exgexrmasked, file.path(path_output, "macaw_080219_exgexrmasked.tif"), overwrite = TRUE)

#0815
#081519
#ExR = 1.4Red-Green
ExR_081519_macaw_masked <- macaw_081519_masked$X670*1.4 - macaw_081519_masked$X550
#ExG = 2Green - Red - Blue
ExG_081519_macaw_masked <- macaw_081519_masked$X550*2 - macaw_081519_masked$X670 - macaw_081519_masked$X450
ExGExR_081519_macaw_masked <- ExG_081519_macaw_masked - ExR_081519_macaw_masked
hist(ExGExR_081519_macaw_masked)
#output
writeRaster(ExGExR_081519_macaw_masked, file.path(path_output, "ExGExR_081519_macaw_masked.tif"))
#calculate the threshold 
temp_arr <- as.array(ExGExR_081519_macaw_masked)
temp_thr <- EBImage::otsu(temp_arr, range = c(min(temp_arr, na.rm = TRUE), max(temp_arr, na.rm = TRUE)), levels = 65536)  #-42245.6
temp_thr
#build the fruit mask
veg_exgexr_081519_macaw_masked <- reclassify(ExGExR_081519_macaw_masked, cbind(-Inf,0,NA))
macaw_081519_exgexrmasked <- raster::mask(macaw_081519_masked, veg_exgexr_081519_macaw_masked)
writeRaster(macaw_081519_exgexrmasked, file.path(path_output, "macaw_081519_exgexrmasked.tif"), overwrite = TRUE)

#0822
#ExR = 1.4Red-Green
ExR_082219_macaw_masked <- macaw_082219$X670*1.4 - macaw_082219$X550
#ExG = 2Green - Red - Blue
ExG_082219_macaw_masked <- macaw_082219$X550*2 - macaw_082219$X670 - macaw_082219$X450
ExGExR_082219_macaw_masked <- ExG_082219_macaw_masked - ExR_082219_macaw_masked
hist(ExGExR_082219_macaw_masked)
#output
writeRaster(ExGExR_082219_macaw_masked, file.path(path_output, "ExGExR_082219_macaw_masked.tif"))
#calculate the threshold 
temp_arr <- as.array(ExGExR_082219_macaw_masked)
temp_thr <- EBImage::otsu(temp_arr, range = c(min(temp_arr, na.rm = TRUE), max(temp_arr, na.rm = TRUE)), levels = 65536)  #-27366.92
#build the fruit mask
veg_exgexr_082219_macaw_masked <- reclassify(ExGExR_082219_macaw_masked, cbind(-Inf,0,NA))
macaw_082219_exgexrmasked <- raster::mask(macaw_082219_masked, veg_exgexr_082219_macaw_masked)
writeRaster(macaw_082219_exgexrmasked, file.path(path_output, "macaw_082219_exgexrmasked.tif"))

```

###after the veg mask 
```{r}
#calculate ExR 


ExR_082219 <- uav_082219_masked0.6$red*1.4 - uav_082219_masked0.6$green
ExG_082219 <- uav_082219_masked0.6$green*2 - uav_082219_masked0.6$red - uav_082219_masked0.6$blue
ExGExR_082219 <- ExG_082219 - ExR_082219
writeRaster(ExR_082219, file.path(path_output_ms, "ExR_082219.tif"),overwrite = TRUE)
writeRaster(ExG_082219, file.path(path_output_ms, "ExG_082219.tif"),overwrite = TRUE)
writeRaster(ExGExR_082219, file.path(path_output_ms, "ExGExR_082219.tif"),overwrite = TRUE)
hist(ExR_082219)
hist(ExGExR_082219)
fruit_thr_082219 <- EBImage::otsu(as.array(ExGExR_082219), range = c(min(as.array(ExGExR_082219), na.rm = TRUE), max(as.array(ExGExR_082219), na.rm = TRUE)),levels = 65536)  #0.0648

#build the fruit mask 
fruit_ms_082219 <- reclassify(ExGExR_082219, cbind(-Inf, 0, NA))
#fruit_ms_082219 <- reclassify(ExGExR_082219, cbind(-Inf, fruit_thr_082219, NA))
writeRaster(fruit_ms_082219, file.path(path_output_ms, "fruit_ms_082219.tif"))
uav_082219_masked0.6_maskedfruit2 <- raster::mask(uav_082219_masked0.6, fruit_ms_082219)
writeRaster(uav_082219_masked0.6_maskedfruit2, file.path(path_output_ms, "uav_082219_masked0.6_maskedfruit2.tif"))

```
###shadow mask 
```{r}
rgbtohsv <- function(r,g,b){
  r = r/65536
  g = g/65536
  b = b/65536
  v = 1/3*(r+g+b)
  s = 1-3/(r+g+b)*min(r,g,b)
  ndi = (s-v)/(s+v)
  return(ndi)
}

hsv_053119 <- rgbtohsv(r = subset(macaw_053119_masked,6), g = subset(macaw_053119_masked, 4), b = subset(macaw_053119_masked, 2))
writeRaster(hsv_053119, file.path(path_output, "hsv_053119.tif"))
hsv_062819 <- rgbtohsv(r = subset(macaw_062819_masked,6), g = subset(macaw_062819_masked, 4), b = subset(macaw_062819_masked, 2))
writeRaster(hsv_062819, file.path(path_output, "hsv_062819.tif"))
hsv_080219 <- rgbtohsv(r = subset(macaw_080219_masked,6), g = subset(macaw_080219_masked, 4), b = subset(macaw_080219_masked, 2))
writeRaster(hsv_080219, file.path(path_output, "hsv_080219.tif"))
hsv_081519 <- rgbtohsv(r = subset(macaw_081519_masked,6), g = subset(macaw_081519_masked, 4), b = subset(macaw_081519_masked, 2))
writeRaster(hsv_081519, file.path(path_output, "hsv_081519.tif"))

hist(hsv_053119)
hist(hsv_062819)
hsv_test1 <- rgbtohsv(r = subset(uav_082219_masked0.6, 3), g = subset(uav_082219_masked0.6, 2), b = subset(uav_082219_masked0.6, 1))
#output
plot(hsv_test1)
hist(hsv_test1)
shadow_thr <- EBImage::otsu(as.array(hsv_test1), range = c(min(as.array(hsv_test1),na.rm = TRUE), max(as.array(hsv_test1), na.rm = TRUE)), levels = 65536) #0.6514
writeRaster(hsv_test1, file.path(path_output_ms, "hsvNDI_082219.tif"))

```


###(Useless currently)Find threshold based on NDVI
```{r}
###convert to array 
ndvi_062819_arr <- raster::as.array(macaw_062819$NDVI)
thr_ndvi_062819 <- EBImage::otsu(ndvi_062819_arr, range = c(min(ndvi_062819_arr, na.rm = TRUE), max(ndvi_062819_arr, na.rm = TRUE)), levels = 256)
thr_ndvi_062819   #0.5313
hist(ndvi_062819_arr, main = "NDVI 2019-06-28", xlab = "NDVI")

ndvi_080219_arr <- raster::as.array(macaw_080219$NDVI)
thr_ndvi_080219 <- EBImage::otsu(ndvi_080219_arr, range = c(min(ndvi_080219_arr, na.rm = TRUE), max(ndvi_080219_arr, na.rm = TRUE)), levels = 256)
thr_ndvi_080219   #0.4882
hist(ndvi_080219_arr,main = "NDVI 2019-08-02", xlab = "NDVI")

ndvi_081019_arr <- raster::as.array(macaw_081019$NDVI)
thr_ndvi_081019 <- EBImage::otsu(ndvi_081019_arr, range = c(min(ndvi_081019_arr, na.rm = TRUE), max(ndvi_081019_arr, na.rm = TRUE)), levels = 256)
thr_ndvi_081019   #0.5586
hist(ndvi_081019_arr, main = "NDVI 2019-08-10", xlab = "NDVI")

ndvi_081519_arr <- raster::as.array(macaw_081519$NDVI)
thr_ndvi_081519 <- EBImage::otsu(ndvi_081519_arr, range = c(min(ndvi_081519_arr, na.rm = TRUE), max(ndvi_081519_arr, na.rm = TRUE)), levels = 256)
thr_ndvi_081519  #0.5745
hist(ndvi_081519_arr, main = "NDVI 2019-08-15", xlab = "NDVI")

ndvi_082219_arr <- raster::as.array(macaw_082219$NDVI)
thr_ndvi_082219 <- EBImage::otsu(ndvi_082219_arr, range = c(min(ndvi_082219_arr, na.rm = TRUE), max(ndvi_082219_arr, na.rm = TRUE)), levels = 256)
thr_ndvi_082219  #0.06599
hist(ndvi_082219_arr)


```

```{r}

```

##(Useless)Read vegetation mask
```{r}
path_pri_server <- "/z0/zt92/Tomato_biomass/tomato_analysis_2019/outputs"
veg_062819 <- raster(file.path(path_pri_server,"veg_062819_ndvi0.7.tif"))
veg_080219 <- raster(file.path(path_pri_server,"veg_080219_ndvi0.7.tif"))
veg_081019 <- raster(file.path(path_pri_server,"veg_081019_ndvi0.7.tif"))
veg_081519 <- raster(file.path(path_pri_server,"veg_081519_ndvi0.7.tif"))
veg_082219 <- raster(file.path(path_pri_server,"veg_082219_ndvi0.7.tif"))

```
##(Useless)Apply mask
```{r}
pri_062819_masked <- raster::mask(pri_062819, resample(veg_062819, pri_062819))
pri_080219_masked <- raster::mask(pri_080219, resample(veg_080219, pri_080219))
pri_081019_masked <- raster::mask(pri_081019, resample(veg_081019, pri_081019))
pri_081519_masked <- raster::mask(pri_081519, resample(veg_081519, pri_081519))
pri_082219_masked <- raster::mask(pri_082219, resample(veg_082219, pri_082219))

```



#Extraction 
##Function
```{r}
#for rowmean extraction
ref_extract <- function(uav,shp, FUN, buff){
  ext_uav <- raster::extract(uav, shp, fun = FUN, na.rm = TRUE, df = TRUE, buffer = buff)
  ext_uav$Treatment <- shp$Treatment
  ext_uav$Side <- shp$Side
  ext_uav$Block <- shp$Block
  ext_uav$Row <- shp$Row
  #ext_uav$Plot <- shp$Plot
  return(ext_uav)
}

#for flagmean extraction 
ref_extract_flag <- function(uav,shp, FUN, buff){
  ext_uav <- raster::extract(uav, shp, fun = FUN, na.rm = TRUE, df = TRUE, buffer = buff)
  ext_uav$Treatment <- shp$Treatment
  ext_uav$Side <- shp$Side
  ext_uav$Block <- shp$Block
  ext_uav$Row <- shp$Row
  ext_uav$id <- shp$id
  ext_uav$Plant <- shp$Plant
  
  #ext_uav$Plot <- shp$Plot
  return(ext_uav)
}

```
##Extract from the plants around the flags
###with vegetation mask
```{r}
#mean with trim 0.1
flagmean_macaw_053119_0.1 <- ref_extract_flag(macaw_053119_masked, shp = flagbuff_2019, FUN = function(x){mean(x, trim = 0.1, na.rm = FALSE)}, buff = 0)
flagmean_macaw_062819_0.1 <- ref_extract_flag(macaw_062819_masked, shp = flagbuff_2019, FUN = function(x){mean(x, trim = 0.1, na.rm = FALSE)}, buff = 0)
flagmean_macaw_080219_0.1 <- ref_extract_flag(macaw_080219_masked, shp = flagbuff_2019, FUN = function(x){mean(x, trim = 0.1, na.rm = FALSE)}, buff = 0)
#flagmean_macaw_081019_0.1 <- ref_extract_flag(macaw_081019_masked, shp = flagbuff_2019, FUN = function(x){mean(x, trim = 0.1, na.rm = FALSE)}, buff = 0)
flagmean_macaw_081519_0.1 <- ref_extract_flag(macaw_081519_masked, shp = flagbuff_2019, FUN = function(x){mean(x, trim = 0.1, na.rm = FALSE)}, buff = 0)
flagmean_macaw_053119_0.1$Date <- "2019-05-31"
flagmean_macaw_062819_0.1$Date <- "2019-06-28"
flagmean_macaw_080219_0.1$Date <- "2019-08-02"
flagmean_macaw_081519_0.1$Date <- "2019-08-15"
#flagmean_macaw_082219_0.1$Date <- "2019-08-22"
flagmean_macaw_0.1 <- rbind(flagmean_macaw_062819_0.1, flagmean_macaw_080219_0.1, flagmean_macaw_081519_0.1)



flagmean_macaw_053119 <- ref_extract_flag(macaw_053119_masked, shp = flagbuff_2019, FUN = mean, buff = 0)
flagmean_macaw_062819 <- ref_extract_flag(macaw_062819_masked, shp = flagbuff_2019, FUN = mean, buff = 0)
flagmean_macaw_080219 <- ref_extract_flag(macaw_080219_masked, shp = flagbuff_2019, FUN = mean, buff = 0)
#flagmean_macaw_081019 <- ref_extract_flag(macaw_081019_masked, shp = flagbuff_2019, FUN = mean, buff = 0)
flagmean_macaw_081519 <- ref_extract_flag(macaw_081519_masked, shp = flagbuff_2019, FUN = mean, buff = 0)
flagmean_macaw_082219 <- ref_extract_flag(macaw_082219_masked, shp = flagbuff_2019, FUN = mean, buff = 0)

#add date
flagmean_macaw_053119$Date <- "2019-05-31"
flagmean_macaw_062819$Date <- "2019-06-28"
flagmean_macaw_080219$Date <- "2019-08-02"
flagmean_macaw_081519$Date <- "2019-08-15"
#flagmean_macaw_082219$Date <- "2019-08-22"

#combine them 
flagmean_macaw <- rbind(flagmean_macaw_062819, flagmean_macaw_080219, flagmean_macaw_081519)
#flagmean_macaw <- rbind(flagmean_macaw_053119, flagmean_macaw_062819, flagmean_macaw_080219, flagmean_macaw_081519, flagmean_macaw_082219)

```
###with fruit mask
```{r}
#flagmean_macaw_frmask_053119 <- ref_extract_flag(macaw_053119_exgexrmasked, shp = flagbuff_2019, FUN = mean, buff = 0)
flagmean_macaw_exgexrmask_062819 <- ref_extract_flag(macaw_062819_exgexrmasked, shp = flagbuff_2019, FUN = mean, buff = 0)
flagmean_macaw_exgexrmask_080219 <- ref_extract_flag(macaw_080219_exgexrmasked, shp = flagbuff_2019, FUN = mean, buff = 0)
#flagmean_macaw_081019 <- ref_extract_flag(macaw_081019_masked, shp = flagbuff_2019, FUN = mean, buff = 0)
flagmean_macaw_exgexrmask_081519 <- ref_extract_flag(macaw_081519_exgexrmasked, shp = flagbuff_2019, FUN = mean, buff = 0)
#$flagmean_macaw_exgexrmask_082219 <- ref_extract_flag(macaw_082219_exgexrmasked, shp = flagbuff_2019, FUN = mean, buff = 0)

#add date
#flagmean_macaw_exgexrmask_053119$Date <- "2019-05-31"
flagmean_macaw_exgexrmask_062819$Date <- "2019-06-28"
flagmean_macaw_exgexrmask_080219$Date <- "2019-08-02"
flagmean_macaw_exgexrmask_081519$Date <- "2019-08-15"
#flagmean_macaw_exgexrmask_082219$Date <- "2019-08-22"

#combine them 
flagmean_macaw_exgexrmask <- rbind(flagmean_macaw_exgexrmask_062819, flagmean_macaw_exgexrmask_080219, flagmean_macaw_exgexrmask_081519)
```


###without mask
```{r}
flagmean_macaw_062819_nomask <- ref_extract_flag(macaw_062819, shp = flagbuff_2019, FUN = mean, buff = 0)
flagmean_macaw_080219_nomask <- ref_extract_flag(macaw_080219, shp = flagbuff_2019, FUN = mean, buff = 0)
#flagmean_macaw_081019_nomask <- ref_extract_flag(macaw_081019, shp = flagbuff_2019, FUN = mean, buff = 0)
flagmean_macaw_081519_nomask <- ref_extract_flag(macaw_081519, shp = flagbuff_2019, FUN = mean, buff = 0)
flagmean_macaw_082219_nomask <- ref_extract_flag(macaw_082219, shp = flagbuff_2019, FUN = mean, buff = 0)

#add date
flagmean_macaw_062819_nomask$Date <- "2019-06-28"
flagmean_macaw_080219_nomask$Date <- "2019-08-02"
flagmean_macaw_081519_nomask$Date <- "2019-08-15"
flagmean_macaw_082219_nomask$Date <- "2019-08-22"

#combine them 
flagmean_macaw_nomask <- rbind(flagmean_macaw_062819_nomask, flagmean_macaw_080219_nomask, flagmean_macaw_081519_nomask, flagmean_macaw_082219_nomask)
```

##Extract from the rows
###053119 only
```{r}
path_df <- "C:/Users/tangz/Box Sync/BIOSTIMULANT TRIAL - SEASON 2/ZHEHAN/dataframes"

#without mask 
rowmean_macaw_053119_nomask <- ref_extract(macaw_053119, shp = rows_2019， FUN = mean, buff = 0)
rowmean_macaw_053119_1ft_nomask <- ref_extract(macaw_053119, shp = rows_2019_cen1ft， FUN = mean, buff = 0)
rowmean_macaw_053119_2ft_nomask <- ref_extract(macaw_053119, shp = rows_2019_cen2ft， FUN = mean, buff = 0)
rowmean_macaw_053119_3ft_nomask <- ref_extract(macaw_053119, shp = rows_2019_cen3ft， FUN = mean, buff = 0)
rowmean_macaw_053119_nomask$Date <- "2019-05-31"
rowmean_macaw_053119_1ft_nomask$Date <- "2019-05-31"
rowmean_macaw_053119_2ft_nomask$Date <- "2019-05-31"
rowmean_macaw_053119_3ft_nomask$Date <- "2019-05-31"

#with mask
rowmean_macaw_053119 <- ref_extract(macaw_053119_masked, shp = rows_2019， FUN = mean, buff = 0)
rowmean_macaw_053119_1ft <- ref_extract(macaw_053119_masked, shp = rows_2019_cen1ft， FUN = mean, buff = 0)
rowmean_macaw_053119_2ft <- ref_extract(macaw_053119_masked, shp = rows_2019_cen2ft， FUN = mean, buff = 0)
rowmean_macaw_053119_3ft <- ref_extract(macaw_053119_masked, shp = rows_2019_cen3ft， FUN = mean, buff = 0)
rowmean_macaw_053119$Date <- "2019-05-31"
rowmean_macaw_053119_1ft$Date <- "2019-05-31"
rowmean_macaw_053119_2ft$Date <- "2019-05-31"
rowmean_macaw_053119_3ft$Date <- "2019-05-31"

#output
##without mask 
write.csv(rowmean_macaw_053119_nomask, file.path(path_df, "rowmean_macaw_053119_nomask.csv"), row.names = FALSE)
write.csv(rowmean_macaw_053119_1ft_nomask, file.path(path_df, "rowmean_macaw_053119_1ft_nomask.csv"), row.names = FALSE)
write.csv(rowmean_macaw_053119_2ft_nomask, file.path(path_df, "rowmean_macaw_053119_2ft_nomask.csv"), row.names = FALSE)
write.csv(rowmean_macaw_053119_3ft_nomask, file.path(path_df, "rowmean_macaw_053119_3ft_nomask.csv"), row.names = FALSE)
##with mask 
write.csv(rowmean_macaw_053119, file.path(path_df, "rowmean_macaw_053119.csv"), row.names = FALSE)
write.csv(rowmean_macaw_053119_1ft, file.path(path_df, "rowmean_macaw_053119_1ft.csv"), row.names = FALSE)
write.csv(rowmean_macaw_053119_2ft, file.path(path_df, "rowmean_macaw_053119_2ft.csv"), row.names = FALSE)
write.csv(rowmean_macaw_053119_3ft, file.path(path_df, "rowmean_macaw_053119_3ft.csv"), row.names = FALSE)


```

###Without masks
```{r}
#rowmean 
rowmean_macaw_053119_nomask <- ref_extract(macaw_053119, shp = rows_2019， FUN = mean, buff = 0)
rowmean_macaw_062819_nomask <- ref_extract(macaw_062819, shp = rows_2019， FUN = mean, buff = 0)
rowmean_macaw_080219_nomask <- ref_extract(macaw_080219, shp = rows_2019， FUN = mean, buff = 0)
#rowmean_macaw_081019_nomask <- ref_extract(macaw_081019, shp = rows_2019， FUN = mean, buff = 0)
rowmean_macaw_081519_nomask <- ref_extract(macaw_081519, shp = rows_2019， FUN = mean, buff = 0)
rowmean_macaw_082219_nomask <- ref_extract(macaw_082219, shp = rows_2019， FUN = mean, buff = 0)

#rowmean 1ft
rowmean_macaw_053119_1ft_nomask <- ref_extract(macaw_053119, shp = rows_2019_cen1ft， FUN = mean, buff = 0)
rowmean_macaw_062819_1ft_nomask <- ref_extract(macaw_062819, shp = rows_2019_cen1ft， FUN = mean, buff = 0)
rowmean_macaw_080219_1ft_nomask <- ref_extract(macaw_080219, shp = rows_2019_cen1ft， FUN = mean, buff = 0)
#rowmean_macaw_081019_1ft_nomask <- ref_extract(macaw_081019, shp = rows_2019_cen1ft， FUN = mean, buff = 0)
rowmean_macaw_081519_1ft_nomask <- ref_extract(macaw_081519, shp = rows_2019_cen1ft， FUN = mean, buff = 0)
rowmean_macaw_082219_1ft_nomask <- ref_extract(macaw_082219, shp = rows_2019_cen1ft， FUN = mean, buff = 0)

#rowmean 2ft
rowmean_macaw_053119_2ft_nomask <- ref_extract(macaw_053119, shp = rows_2019_cen2ft， FUN = mean, buff = 0)
rowmean_macaw_062819_2ft_nomask <- ref_extract(macaw_062819, shp = rows_2019_cen2ft， FUN = mean, buff = 0)
rowmean_macaw_080219_2ft_nomask <- ref_extract(macaw_080219, shp = rows_2019_cen2ft， FUN = mean, buff = 0)
#rowmean_macaw_081019_2ft_nomask <- ref_extract(macaw_081019, shp = rows_2019_cen2ft， FUN = mean, buff = 0)
rowmean_macaw_081519_2ft_nomask <- ref_extract(macaw_081519, shp = rows_2019_cen2ft， FUN = mean, buff = 0)
rowmean_macaw_082219_2ft_nomask <- ref_extract(macaw_082219, shp = rows_2019_cen2ft， FUN = mean, buff = 0)

#rowmean 3ft
rowmean_macaw_053119_3ft_nomask <- ref_extract(macaw_053119, shp = rows_2019_cen3ft， FUN = mean, buff = 0)
rowmean_macaw_062819_3ft_nomask <- ref_extract(macaw_062819, shp = rows_2019_cen3ft， FUN = mean, buff = 0)
rowmean_macaw_080219_3ft_nomask <- ref_extract(macaw_080219, shp = rows_2019_cen3ft， FUN = mean, buff = 0)
#rowmean_macaw_081019_3ft_nomask <- ref_extract(macaw_081019, shp = rows_2019_cen3ft， FUN = mean, buff = 0)
rowmean_macaw_081519_3ft_nomask <- ref_extract(macaw_081519, shp = rows_2019_cen3ft， FUN = mean, buff = 0)
rowmean_macaw_082219_3ft_nomask <- ref_extract(macaw_082219, shp = rows_2019_cen3ft， FUN = mean, buff = 0)


#add date
rowmean_macaw_062819_nomask$Date <- "2019-06-28"
rowmean_macaw_080219_nomask$Date <- "2019-08-02"
rowmean_macaw_081519_nomask$Date <- "2019-08-15"
rowmean_macaw_082219_nomask$Date <- "2019-08-22"
rowmean_macaw_062819_1ft_nomask$Date <- "2019-06-28"
rowmean_macaw_080219_1ft_nomask$Date <- "2019-08-02"
rowmean_macaw_081519_1ft_nomask$Date <- "2019-08-15"
rowmean_macaw_082219_1ft_nomask$Date <- "2019-08-22"
rowmean_macaw_062819_2ft_nomask$Date <- "2019-06-28"
rowmean_macaw_080219_2ft_nomask$Date <- "2019-08-02"
rowmean_macaw_081519_2ft_nomask$Date <- "2019-08-15"
rowmean_macaw_082219_2ft_nomask$Date <- "2019-08-22"
rowmean_macaw_062819_3ft_nomask$Date <- "2019-06-28"
rowmean_macaw_080219_3ft_nomask$Date <- "2019-08-02"
rowmean_macaw_081519_3ft_nomask$Date <- "2019-08-15"
rowmean_macaw_082219_3ft_nomask$Date <- "2019-08-22"

#combine them together
rowmean_macaw_nomask <- rbind(rowmean_macaw_062819_nomask, rowmean_macaw_080219_nomask, rowmean_macaw_081519_nomask, rowmean_macaw_082219_nomask)
rowmean_macaw_1ft_nomask <- rbind(rowmean_macaw_062819_1ft_nomask, rowmean_macaw_080219_1ft_nomask, rowmean_macaw_081519_1ft_nomask, rowmean_macaw_082219_1ft_nomask)
rowmean_macaw_2ft_nomask <- rbind(rowmean_macaw_062819_2ft_nomask, rowmean_macaw_080219_2ft_nomask, rowmean_macaw_081519_2ft_nomask, rowmean_macaw_082219_2ft_nomask)
rowmean_macaw_3ft_nomask <- rbind(rowmean_macaw_062819_3ft_nomask, rowmean_macaw_080219_3ft_nomask, rowmean_macaw_081519_3ft_nomask, rowmean_macaw_082219_3ft_nomask)

#output
write.csv(rowmean_macaw_nomask, file.path(path_df, "rowmean_macaw_nomask.csv"), row.names = FALSE)
write.csv(rowmean_macaw_1ft_nomask, file.path(path_df, "rowmean_macaw_1ft_nomask.csv"), row.names = FALSE)
write.csv(rowmean_macaw_2ft_nomask, file.path(path_df, "rowmean_macaw_2ft_nomask.csv"), row.names = FALSE)
write.csv(rowmean_macaw_3ft_nomask, file.path(path_df, "rowmean_macaw_3ft_nomask.csv"), row.names = FALSE)

```
###With masks
```{r}
rowmean_macaw_053119 <- ref_extract(macaw_053119_masked, shp = rows_2019， FUN = mean, buff = 0)
rowmean_macaw_053119_1ft <- ref_extract(macaw_053119_masked, shp = rows_2019_cen1ft， FUN = mean, buff = 0)
rowmean_macaw_053119_2ft <- ref_extract(macaw_053119_masked, shp = rows_2019_cen2ft， FUN = mean, buff = 0)
rowmean_macaw_053119_3ft <- ref_extract(macaw_053119_masked, shp = rows_2019_cen3ft， FUN = mean, buff = 0)
rowmean_macaw_053119$Date <- "2019-06-28"
rowmean_macaw_053119_1ft$Date <- "2019-06-28"
rowmean_macaw_053119_2ft$Date <- "2019-06-28"
rowmean_macaw_053119_3ft$Date <- "2019-06-28"



#rowmean 
rowmean_macaw_062819 <- ref_extract(macaw_062819_masked, shp = rows_2019， FUN = mean, buff = 0)
rowmean_macaw_080219 <- ref_extract(macaw_080219_masked, shp = rows_2019， FUN = mean, buff = 0)
#rowmean_macaw_081019 <- ref_extract(macaw_081019_masked, shp = rows_2019， FUN = mean, buff = 0)
rowmean_macaw_081519 <- ref_extract(macaw_081519_masked, shp = rows_2019， FUN = mean, buff = 0)
rowmean_macaw_082219 <- ref_extract(macaw_082219_masked, shp = rows_2019， FUN = mean, buff = 0)

#rowmean 1ft
rowmean_macaw_062819_1ft <- ref_extract(macaw_062819_masked, shp = rows_2019_cen1ft， FUN = mean, buff = 0)
rowmean_macaw_080219_1ft <- ref_extract(macaw_080219_masked, shp = rows_2019_cen1ft， FUN = mean, buff = 0)
#rowmean_macaw_081019_1ft <- ref_extract(macaw_081019_masked, shp = rows_2019_cen1ft， FUN = mean, buff = 0)
rowmean_macaw_081519_1ft <- ref_extract(macaw_081519_masked, shp = rows_2019_cen1ft， FUN = mean, buff = 0)
rowmean_macaw_082219_1ft <- ref_extract(macaw_082219_masked, shp = rows_2019_cen1ft， FUN = mean, buff = 0)

#rowmean 2ft
rowmean_macaw_062819_2ft <- ref_extract(macaw_062819_masked, shp = rows_2019_cen2ft， FUN = mean, buff = 0)
rowmean_macaw_080219_2ft <- ref_extract(macaw_080219_masked, shp = rows_2019_cen2ft， FUN = mean, buff = 0)
#rowmean_macaw_081019_2ft <- ref_extract(macaw_081019_masked, shp = rows_2019_cen2ft， FUN = mean, buff = 0)
rowmean_macaw_081519_2ft <- ref_extract(macaw_081519_masked, shp = rows_2019_cen2ft， FUN = mean, buff = 0)
rowmean_macaw_082219_2ft <- ref_extract(macaw_082219_masked, shp = rows_2019_cen2ft， FUN = mean, buff = 0)

#rowmean 3ft
rowmean_macaw_062819_3ft <- ref_extract(macaw_062819_masked, shp = rows_2019_cen3ft， FUN = mean, buff = 0)
rowmean_macaw_080219_3ft <- ref_extract(macaw_080219_masked, shp = rows_2019_cen3ft， FUN = mean, buff = 0)
#rowmean_macaw_081019_3ft <- ref_extract(macaw_081019_masked, shp = rows_2019_cen3ft， FUN = mean, buff = 0)
rowmean_macaw_081519_3ft <- ref_extract(macaw_081519_masked, shp = rows_2019_cen3ft， FUN = mean, buff = 0)
rowmean_macaw_082219_3ft <- ref_extract(macaw_082219_masked, shp = rows_2019_cen3ft， FUN = mean, buff = 0)


#add date
rowmean_macaw_062819$Date <- "2019-06-28"
rowmean_macaw_080219$Date <- "2019-08-02"
rowmean_macaw_081519$Date <- "2019-08-15"
rowmean_macaw_082219$Date <- "2019-08-22"
rowmean_macaw_062819_1ft$Date <- "2019-06-28"
rowmean_macaw_080219_1ft$Date <- "2019-08-02"
rowmean_macaw_081519_1ft$Date <- "2019-08-15"
rowmean_macaw_082219_1ft$Date <- "2019-08-22"
rowmean_macaw_062819_2ft$Date <- "2019-06-28"
rowmean_macaw_080219_2ft$Date <- "2019-08-02"
rowmean_macaw_081519_2ft$Date <- "2019-08-15"
rowmean_macaw_082219_2ft$Date <- "2019-08-22"
rowmean_macaw_062819_3ft$Date <- "2019-06-28"
rowmean_macaw_080219_3ft$Date <- "2019-08-02"
rowmean_macaw_081519_3ft$Date <- "2019-08-15"
rowmean_macaw_082219_3ft$Date <- "2019-08-22"

#combine them together
rowmean_macaw <- rbind(rowmean_macaw_062819, rowmean_macaw_080219, rowmean_macaw_081519, rowmean_macaw_082219)
rowmean_macaw_1ft <- rbind(rowmean_macaw_062819_1ft, rowmean_macaw_080219_1ft, rowmean_macaw_081519_1ft, rowmean_macaw_082219_1ft)
rowmean_macaw_2ft <- rbind(rowmean_macaw_062819_2ft, rowmean_macaw_080219_2ft, rowmean_macaw_081519_2ft, rowmean_macaw_082219_2ft)
rowmean_macaw_3ft <- rbind(rowmean_macaw_062819_3ft, rowmean_macaw_080219_3ft, rowmean_macaw_081519_3ft, rowmean_macaw_082219_3ft)

```


##(Useless currently)Extract row average after mask
```{r}
rowmean_pri_082219_2ft <- ref_extract(pri_082219_masked, shp = rows_2019_cen2ft, FUN = mean, buff = 0)
rowmean_pri_082219_3ft <- ref_extract(pri_082219_masked, shp = rows_2019_cen3ft, FUN = mean, buff = 0)
rowmean_pri_081519_2ft <- ref_extract(pri_081519_masked, shp = rows_2019_cen2ft, FUN = mean, buff = 0)
rowmean_pri_081519_3ft <- ref_extract(pri_081519_masked, shp = rows_2019_cen3ft, FUN = mean, buff = 0)
rowmean_pri_081019_2ft <- ref_extract(pri_081019_masked, shp = rows_2019_cen2ft, FUN = mean, buff = 0)
rowmean_pri_081019_3ft <- ref_extract(pri_081019_masked, shp = rows_2019_cen3ft, FUN = mean, buff = 0)
rowmean_pri_080219_2ft <- ref_extract(pri_080219_masked, shp = rows_2019_cen2ft, FUN = mean, buff = 0)
rowmean_pri_080219_3ft <- ref_extract(pri_080219_masked, shp = rows_2019_cen3ft, FUN = mean, buff = 0)
rowmean_pri_062819_2ft <- ref_extract(pri_062819_masked, shp = rows_2019_cen2ft, FUN = mean, buff = 0)
rowmean_pri_062819_3ft <- ref_extract(pri_062819_masked, shp = rows_2019_cen3ft, FUN = mean, buff = 0)
rowmean_pri_062819_2ft$Date <- as.Date("2019-06-28")
rowmean_pri_062819_3ft$Date <- as.Date("2019-06-28")
rowmean_pri_080219_2ft$Date <- as.Date("2019-08-02")
rowmean_pri_080219_3ft$Date <- as.Date("2019-08-02")
rowmean_pri_081019_2ft$Date <- as.Date("2019-08-10")
rowmean_pri_081019_3ft$Date <- as.Date("2019-08-10")
rowmean_pri_081519_2ft$Date <- as.Date("2019-08-15")
rowmean_pri_081519_3ft$Date <- as.Date("2019-08-15")
rowmean_pri_082219_2ft$Date <- as.Date("2019-08-22")
rowmean_pri_082219_3ft$Date <- as.Date("2019-08-22")
rowmean_pri <- rbind(rowmean_pri_062819, rowmean_pri_080219, rowmean_pri_081019, rowmean_pri_081519, rowmean_pri_082219)
rowmean_pri_1ft <- rbind(rowmean_pri_062819_1ft, rowmean_pri_080219_1ft, rowmean_pri_081019_1ft, rowmean_pri_081519_1ft, rowmean_pri_082219_1ft)
rowmean_pri_2ft <- rbind(rowmean_pri_062819_2ft, rowmean_pri_080219_2ft, rowmean_pri_081019_2ft, rowmean_pri_081519_2ft, rowmean_pri_082219_2ft)
rowmean_pri_3ft <- rbind(rowmean_pri_062819_3ft, rowmean_pri_080219_3ft, rowmean_pri_081019_3ft, rowmean_pri_081519_3ft, rowmean_pri_082219_3ft)
path_df_server <- "/z0/zt92/Tomato_biomass/tomato_analysis_2019/dataframes"
#path_df <- "C:/Users/zt92/Box Sync/BIOSTIMULANT FIELD SCREENING MASTER FOLDER/DRONE/macaw_pri/dataframes"
write.csv(rowmean_pri, file.path(path_df_server, "rowmean_pri.csv"), row.names = FALSE)
write.csv(rowmean_pri_1ft, file.path(path_df_server, "rowmean_pri_1ft.csv"), row.names = FALSE)
write.csv(rowmean_pri_2ft, file.path(path_df_server, "rowmean_pri_2ft.csv"), row.names = FALSE)
write.csv(rowmean_pri_3ft, file.path(path_df_server, "rowmean_pri_3ft.csv"), row.names = FALSE)


#0822
rowmean_pri_082219 <- ref_extract(pri_082219_masked, shp = rows_2019, FUN = mean, buff = 0)
rowmean_pri_082219_1ft <- ref_extract(pri_082219_masked, shp = rows_2019_cen1ft, FUN = mean, buff = 0)
rowmean_pri_082219_2ft <- ref_extract(pri_082219_masked, shp = rows_2019_cen2ft, FUN = mean, buff = 0)
rowmean_pri_082219_3ft <- ref_extract(pri_082219_masked, shp = rows_2019_cen3ft, FUN = mean, buff = 0)
rowmean_pri_082219$Date <- as.Date("2019-08-22")
rowmean_pri_082219_1ft$Date <- as.Date("2019-08-22")
rowmean_pri_082219_2ft$Date <- as.Date("2019-08-22")
rowmean_pri_082219_3ft$Date <- as.Date("2019-08-22")


#0815
rowmean_pri_081519 <- ref_extract(pri_081519_masked, shp = rows_2019, FUN = mean, buff = 0)
rowmean_pri_081519_1ft <- ref_extract(pri_081519_masked, shp = rows_2019_cen1ft, FUN = mean, buff = 0)
rowmean_pri_081519_2ft <- ref_extract(pri_081519_masked, shp = rows_2019_cen2ft, FUN = mean, buff = 0)
rowmean_pri_081519_3ft <- ref_extract(pri_081519_masked, shp = rows_2019_cen3ft, FUN = mean, buff = 0)
rowmean_pri_081519$Date <- as.Date("2019-08-15")
rowmean_pri_081519_1ft$Date <- as.Date("2019-08-15")
rowmean_pri_081519_2ft$Date <- as.Date("2019-08-15")
rowmean_pri_081519_3ft$Date <- as.Date("2019-08-15")
save.image("/z0/zt92/Tomato_biomass/tomato_analysis_2019/dataframes/envir1.RData")


#0810
rowmean_pri_081019 <- ref_extract(pri_081019_masked, shp = rows_2019, FUN = mean, buff = 0)
rowmean_pri_081019_1ft <- ref_extract(pri_081019_masked, shp = rows_2019_cen1ft, FUN = mean, buff = 0)
rowmean_pri_081019_2ft <- ref_extract(pri_081019_masked, shp = rows_2019_cen2ft, FUN = mean, buff = 0)
rowmean_pri_081019_3ft <- ref_extract(pri_081019_masked, shp = rows_2019_cen3ft, FUN = mean, buff = 0)
rowmean_pri_081019$Date <- as.Date("2019-08-10")
rowmean_pri_081019_1ft$Date <- as.Date("2019-08-10")
rowmean_pri_081019_2ft$Date <- as.Date("2019-08-10")
rowmean_pri_081019_3ft$Date <- as.Date("2019-08-10")
save.image("/z0/zt92/Tomato_biomass/tomato_analysis_2019/dataframes/envir2.RData")


#0802
rowmean_pri_080219 <- ref_extract(pri_080219_masked, shp = rows_2019, FUN = mean, buff = 0)
rowmean_pri_080219_1ft <- ref_extract(pri_080219_masked, shp = rows_2019_cen1ft, FUN = mean, buff = 0)
rowmean_pri_080219_2ft <- ref_extract(pri_080219_masked, shp = rows_2019_cen2ft, FUN = mean, buff = 0)
rowmean_pri_080219_3ft <- ref_extract(pri_080219_masked, shp = rows_2019_cen3ft, FUN = mean, buff = 0)
rowmean_pri_080219$Date <- as.Date("2019-08-02")
rowmean_pri_080219_1ft$Date <- as.Date("2019-08-02")
rowmean_pri_080219_2ft$Date <- as.Date("2019-08-02")
rowmean_pri_080219_3ft$Date <- as.Date("2019-08-02")
save.image("/z0/zt92/Tomato_biomass/tomato_analysis_2019/dataframes/envir3.RData")



#0628
rowmean_pri_062819 <- ref_extract(pri_062819_masked, shp = rows_2019, FUN = mean, buff = 0)
rowmean_pri_062819_1ft <- ref_extract(pri_062819_masked, shp = rows_2019_cen1ft, FUN = mean, buff = 0)
rowmean_pri_062819_2ft <- ref_extract(pri_062819_masked, shp = rows_2019_cen2ft, FUN = mean, buff = 0)
rowmean_pri_062819_3ft <- ref_extract(pri_062819_masked, shp = rows_2019_cen3ft, FUN = mean, buff = 0)
rowmean_pri_062819$Date <- as.Date("2019-06-28")
rowmean_pri_062819_1ft$Date <- as.Date("2019-06-28")
rowmean_pri_062819_2ft$Date <- as.Date("2019-06-28")
rowmean_pri_062819_3ft$Date <- as.Date("2019-06-28")
save.image("/z0/zt92/Tomato_biomass/tomato_analysis_2019/dataframes/envir4.RData")

#combine them together
names(rowmean_pri_062819)[2] <- "PRI"
names(rowmean_pri_062819_1ft)[2] <- "PRI"
names(rowmean_pri_062819_2ft)[2] <- "PRI"
names(rowmean_pri_062819_3ft)[2] <- "PRI"
names(rowmean_pri_080219)[2] <- "PRI"
names(rowmean_pri_080219_1ft)[2] <- "PRI"
names(rowmean_pri_080219_2ft)[2] <- "PRI"
names(rowmean_pri_080219_3ft)[2] <- "PRI"
names(rowmean_pri_081019)[2] <- "PRI"
names(rowmean_pri_081019_1ft)[2] <- "PRI"
names(rowmean_pri_081019_2ft)[2] <- "PRI"
names(rowmean_pri_081019_3ft)[2] <- "PRI"
names(rowmean_pri_081519)[2] <- "PRI"
names(rowmean_pri_081519_1ft)[2] <- "PRI"
names(rowmean_pri_081519_2ft)[2] <- "PRI"
names(rowmean_pri_081519_3ft)[2] <- "PRI"
names(rowmean_pri_082219)[2] <- "PRI"
names(rowmean_pri_082219_1ft)[2] <- "PRI"
names(rowmean_pri_082219_2ft)[2] <- "PRI"
names(rowmean_pri_082219_3ft)[2] <- "PRI"



rowmean_pri <- rbind(rowmean_pri_062819, rowmean_pri_080219, rowmean_pri_081019, rowmean_pri_081519, rowmean_pri_082219)
rowmean_pri_1ft <- rbind(rowmean_pri_062819_1ft, rowmean_pri_080219_1ft, rowmean_pri_081019_1ft, rowmean_pri_081519_1ft, rowmean_pri_082219_1ft)
rowmean_pri_2ft <- rbind(rowmean_pri_062819_2ft, rowmean_pri_080219_2ft, rowmean_pri_081019_2ft, rowmean_pri_081519_2ft, rowmean_pri_082219_2ft)
rowmean_pri_3ft <- rbind(rowmean_pri_062819_3ft, rowmean_pri_080219_3ft, rowmean_pri_081019_3ft, rowmean_pri_081519_3ft, rowmean_pri_082219_3ft)

path_df_server <- "/z0/zt92/Tomato_biomass/tomato_analysis_2019/dataframes"
#path_df <- "C:/Users/zt92/Box Sync/BIOSTIMULANT FIELD SCREENING MASTER FOLDER/DRONE/macaw_pri/dataframes"
write.csv(rowmean_pri, file.path(path_df_server, "rowmean_pri.csv"), row.names = FALSE)
write.csv(rowmean_pri_1ft, file.path(path_df_server, "rowmean_pri_1ft.csv"), row.names = FALSE)
write.csv(rowmean_pri_2ft, file.path(path_df_server, "rowmean_pri_2ft.csv"), row.names = FALSE)
write.csv(rowmean_pri_3ft, file.path(path_df_server, "rowmean_pri_3ft.csv"), row.names = FALSE)

```

#Calculate useful vegetation indices
##Functions
```{r}
#Structure Indices 
NDVI <- function(macaw){
  red <- macaw$X670
  nir <- macaw$X800
  ndvi <- (nir-red)/(nir+red)
  return(ndvi)
}

RDVI <- function(macaw){
  red <- macaw$X670
  nir <- macaw$X800
  rdvi <- (nir-red)/(nir+red)^0.5
  return(rdvi)
}

#Chl Indices
MCARI <- function(macaw){
  x700 <- macaw$X700
  x670 <- macaw$X670
  x550 <- macaw$X550
  mcari <- ((x700-x670)-0.2*(x700-x550))*(x700/x670)
  return(mcari)
}

TCARI <- function(macaw){
  x700 <- macaw$X700
  x670 <- macaw$X670
  x550 <- macaw$X550
  tcari <- 3*((x700-x670)-0.2*(x700-x550)*(x700/x670))
  return(tcari)
}

TCARI.OSAVI <- function(macaw){
  x700 <- macaw$X700
  x670 <- macaw$X670
  x550 <- macaw$X550
  X800 <- macaw$X800
  tcari <- 3*((x700-x670)-0.2*(x700-x550)*(x700/x670))
  osavi <- ((1+0.16)*(X800-X670)/(X800+X670+0.16))
  tcari.osavi <- tcari/osavi
  return(tcari.osavi)
}

RER <- function(macaw){
  x700 <- macaw$X700
  x670 <- macaw$X670
  rer <- x700/x670
  return(rer)
}

#xanthophyll Indice

PRI <- function(macaw){
  x530 <- macaw$X530
  x570 <- macaw$X570
  pri <- (x530-x570)/(x530+x570)
  return(pri)
}

PRI550 <- function(macaw){
  x530 <- macaw$X530
  x550 <- macaw$X550
  pri550 <- (x530-x550)/(x530+x550)
  return(pri550)
}

PRInorm <- function(macaw){
  #pri
  x530 <- macaw$X530
  x570 <- macaw$X570
  pri <- (x530-x570)/(x530+x570)
  #rdvi
  red <- macaw$X670
  nir <- macaw$X800
  rdvi <- (nir-red)/(nir+red)^0.5
  #rer
  x700 <- macaw$X700
  x670 <- macaw$X670
  rer <- x700/x670
  #PRInorm
  prinorm <- pri/(rdvi*rer)
  return(prinorm)
}

PRInorm550 <- function(macaw){
  #pri550
  x530 <- macaw$X530
  x550 <- macaw$X550
  pri550 <- (x530-x550)/(x530+x550)
  #rdvi
  red <- macaw$X670
  nir <- macaw$X800
  rdvi <- (nir-red)/(nir+red)^0.5
  #rer
  x700 <- macaw$X700
  x670 <- macaw$X670
  rer <- x700/x670
  #PRInorm
  prinorm550 <- pri550/(rdvi*rer)
  return(prinorm550)
}

#Water Indices
WI <- function(macaw){
  x900 <- macaw$X900
  x970 <- macaw$X970
  wi <- x900/x970
  return(wi)
}

WI.NDVI <- function(macaw){
  x900 <- macaw$X900
  x970 <- macaw$X970
  wi <- x900/x970
  red <- macaw$X670
  nir <- macaw$X800
  ndvi <- (nir-red)/(nir+red)
  return(wi/ndvi)
}

```

##Apply the functions
###with vegetation mask
```{r}
#convert DN to reflectance
flagmean_macaw[,2:13] <- flagmean_macaw[,2:13]/65535
flagmean_macaw$ndvi <- NDVI(flagmean_macaw)
flagmean_macaw$pri <- PRI(flagmean_macaw)
flagmean_macaw$wi <- WI(flagmean_macaw)
flagmean_macaw$wi.ndvi <- WI.NDVI(flagmean_macaw)
flagmean_macaw$mcawi <- MCARI(flagmean_macaw)
flagmean_macaw$tcari.osavi <- TCARI.OSAVI(flagmean_macaw)
flagmean_macaw$tcari <- TCARI(flagmean_macaw)
flagmean_macaw$pri550 <- PRI550(flagmean_macaw)
flagmean_macaw$prinorm <- PRInorm(flagmean_macaw)
flagmean_macaw$prinorm550 <- PRInorm550(flagmean_macaw)
flagmean_macaw$rer <- RER(flagmean_macaw)
flagmean_macaw$rdvi <- RDVI(flagmean_macaw)


#output
write.csv(flagmean_macaw, file.path(path_df, "flagmean_macaw.csv"), row.names = FALSE)
write.csv(rowmean_macaw, file.path(path_df, "rowmean_macaw.csv"), row.names = FALSE)
write.csv(rowmean_macaw_1ft, file.path(path_df, "rowmean_macaw_1ft.csv"), row.names = FALSE)
write.csv(rowmean_macaw_2ft, file.path(path_df, "rowmean_macaw_2ft.csv"), row.names = FALSE)
write.csv(rowmean_macaw_3ft, file.path(path_df, "rowmean_macaw_3ft.csv"), row.names = FALSE)

```
###with fruti mask
```{r}
names(flagmean_macaw_exgexrmask)

flagmean_macaw_exgexrmask[,2:13] <- flagmean_macaw_exgexrmask[,2:13]/65535
flagmean_macaw_exgexrmask$ndvi <- NDVI(flagmean_macaw_exgexrmask)
flagmean_macaw_exgexrmask$pri <- PRI(flagmean_macaw_exgexrmask)
flagmean_macaw_exgexrmask$wi <- WI(flagmean_macaw_exgexrmask)
flagmean_macaw_exgexrmask$wi.ndvi <- WI.NDVI(flagmean_macaw_exgexrmask)
flagmean_macaw_exgexrmask$mcawi <- MCARI(flagmean_macaw_exgexrmask)
flagmean_macaw_exgexrmask$tcari.osavi <- TCARI.OSAVI(flagmean_macaw_exgexrmask)
flagmean_macaw_exgexrmask$tcari <- TCARI(flagmean_macaw_exgexrmask)
flagmean_macaw_exgexrmask$pri550 <- PRI550(flagmean_macaw_exgexrmask)
flagmean_macaw_exgexrmask$prinorm <- PRInorm(flagmean_macaw_exgexrmask)
flagmean_macaw_exgexrmask$prinorm550 <- PRInorm550(flagmean_macaw_exgexrmask)
flagmean_macaw_exgexrmask$rer <- RER(flagmean_macaw_exgexrmask)
flagmean_macaw_exgexrmask$rdvi <- RDVI(flagmean_macaw_exgexrmask)

path_df <- "C:/Users/tangz/Box Sync/BIOSTIMULANT TRIAL - SEASON 2/ZHEHAN/dataframes"
write.csv(flagmean_macaw_exgexrmask, file.path(path_df, "flagmean_macaw_exgexrmask.csv"), row.names = FALSE)
```

#----------Read data from csv-------------------
#Read extracted csv files
```{r}
path_df <- "C:/Users/tangz/Box Sync/BIOSTIMULANT TRIAL - SEASON 2/ZHEHAN/dataframes"
flagmean_macaw <- read.csv(file.path(path_df, "flagmean_macaw.csv"))
head(flagmean_macaw)
flagmean_macaw_exgexrmask <- read.csv(file.path(path_df, "flagmean_macaw_exgexrmask.csv"))
head(flagmean_macaw_exgexrmask)
#merge with the shapefile data to include the plant
path_shp <- "C:/Users/tangz/Box Sync/BIOSTIMULANT TRIAL - SEASON 2/ZHEHAN/shapefiles"
#use the adjusted one
flagbuff_2019 <- shapefile(file.path(path_shp, "flags_tomato_2019_adj_buffer.shp"))
flagmean_macaw <- merge(flagmean_macaw, flagbuff_2019@data[,c("Row","id","Plant")], by = c("Row","id"))
flagmean_macaw_exgexrmask <- merge(flagmean_macaw_exgexrmask, flagbuff_2019@data[,c("Row","id","Plant")], by = c("Row","id"))
#remove 08-22 data
flagmean_macaw <- subs
et(flagmean_macaw, Date!="2019-08-22")
```
#Micasense vs MACAW
##Plot the trend of NDVI
```{r}
ggplot(flagmean_uav_nomask)
```


#Ground Measurements
##Read SWP 
```{r}
path_swp <- "C:/Users/tangz/Box Sync/BIOSTIMULANT TRIAL - SEASON 2/PHYSIOLOGICAL DATA/SWP"
files_swp <- list.files(path_swp, full.names = TRUE)
list_swp <- list()
for(i in 1:length(files_swp)){
  temp_df <- read_xlsx(files_swp[i])[,1:5]
  list_swp[[i]] <- temp_df
}
files_swp
names(list_swp) <- c("2019-05-31","2019-06-11","2019-06-26","2019-07-17","2019-07-25","2019-08-01","2019-08-08","2019-08-14")

#Add date column 
for(i in 1:length(list_swp)){
  list_swp[[i]]$Date <- as.Date(names(list_swp)[i])
}
list_swp[[8]]

#rbind them together
swp_PL <- do.call(rbind, list_swp)
head(swp_PL)
tail(swp_PL)

names(flagmean_macaw)
#change names 
names(swp_PL) <- c("Block","Plot","Treatment","Plant","SWP", "Date")

#aggregate by row
class(swp_PL$SWP)
swp_PL$SWP <- as.numeric(swp_PL$SWP)
sum(is.na(swp_PL$SWP))
dim(swp_PL)  #1070, 6

for(i in 1:dim(swp_PL)[1]){
  if(swp_PL[i,]$Date=="2019-06-26"){
    swp_PL[i,]$Date= "2019-06-28"
  }
  if(swp_PL[i,]$Date=="2019-08-01"){
    swp_PL[i,]$Date="2019-08-02"
  }
  if(swp_PL[i,]$Date=="2019-08-14"){
    swp_PL[i,]$Date="2019-08-15"
  }
}

rowflagmean_swp <- aggregate(swp_PL$SWP, by = list("Block"=swp_PL$Block, "Plot"=swp_PL$Plot, "Treatment"=swp_PL$Treatment, "Date"=swp_PL$Date), FUN = function(x){mean(x, na.rm=TRUE)})
names(rowflagmean_swp)[5] <- "SWP"
#rowflagmean_macaw_swp <- aggregate(swp_PL$SWP, by = list("Block"=swp_PL$Block, "Plot"=swp_PL$Plot, "Treatment"=swp_PL$Treatment, "Date"=swp_PL$Date), FUN = function(x){mean(x, na.rm=TRUE)})
#names(rowflagmean_macaw_swp)[5] <- "SWP"

sum(is.na(rowflagmean_macaw_swp$x))
dim(rowflagmean_macaw_swp) #140, 6

```


##Read LiCOR
```{r}
path_licor <- "C:/Users/tangz/Box Sync/BIOSTIMULANT TRIAL - SEASON 2/ZHEHAN/dataframes/Physiology_Measurement/LICOR"
files_licor <- list.files(path_licor, full.names = TRUE)
files_licor
list_licor <- list()

for(i in 1:length(files_licor)){
  temp_df <- read_xlsx(files_licor[i], sheet = "COMBINED")[,c("Block","Treatment","Plot","Plant.Num","Photo","Cond")]
  list_licor[[i]] <- temp_df
}
names(list_licor) <- c("2019-05-31","2019-06-11","2019-06-26","2019-07-17","2019-07-25","2019-08-01","2019-08-08","2019-08-14")
for(i in 1:length(list_licor)){
  list_licor[[i]]$Date <- as.Date(names(list_licor)[i])
}
licor_PL <- do.call(rbind, list_licor)

names(licor_PL)
names(licor_PL)[4] <- "Plant"

#change date
for(i in 1:dim(licor_PL)[1]){
  if(licor_PL[i,]$Date=="2019-06-26"){
    licor_PL[i,]$Date= "2019-06-28"
  }
  if(licor_PL[i,]$Date=="2019-08-01"){
    licor_PL[i,]$Date="2019-08-02"
  }
  if(licor_PL[i,]$Date=="2019-08-14"){
    licor_PL[i,]$Date="2019-08-15"
  }
}

rowflagmean_licor <- aggregate(licor_PL[5:6], by = list("Block"=licor_PL$Block, "Plot"=licor_PL$Plot, "Treatment"=licor_PL$Treatment, "Date"=licor_PL$Date), FUN = function(x){mean(x, na.rm=TRUE)})
#rowflagmean_macaw_swp <- aggregate(swp_PL$SWP, by = list("Block"=swp_PL$Block, "Plot"=swp_PL$Plot, "Treatment"=swp_PL$Treatment, "Date"=swp_PL$Date), FUN = function(x){mean(x, na.rm=TRUE)})
#sum(is.na(rowflagmean_macaw_swp$x))
#dim(rowflagmean_macaw_swp) #140, 6
#names(rowflagmean_macaw_swp)[5] <- "SWP"

```
##Read Chlorophyll
```{r}
path_chl <- "C:/Users/tangz/Box Sync/BIOSTIMULANT TRIAL - SEASON 2/ZHEHAN/dataframes/Physiology_Measurement/CHL"
files_chl <- list.files(path_chl, full.names = TRUE)
files_chl
list_chl <- list()
for(i in 1:length(files_chl)){
  temp_df <- read_xlsx(files_chl[i], sheet = 1)[,c("PLOT","TREATMENT","PLANT","CHL")]
  list_chl[[i]] <- temp_df
}
names(list_chl) <- c("2019-05-31","2019-06-11","2019-06-25","2019-06-26","2019-07-17","2019-07-25","2019-08-01","2019-08-08","2019-08-14")

for(i in 1:length(list_chl)){
  list_chl[[i]]$Date <- as.Date(names(list_chl)[i])
}
chl_PL <- do.call(rbind, list_chl)
names(chl_PL) <- c("Plot","Treatment","Plant","CHL","Date")
```
##Read IRT
```{r}
path_irt <- "C:/Users/tangz/Box Sync/BIOSTIMULANT TRIAL - SEASON 2/ZHEHAN/dataframes/Physiology_Measurement/IRT"
files_irt <- list.files(path_irt, full.names = TRUE)
files_irt
list_irt <- list()
for(i in 1:length(files_irt)){
  temp_df <- read_xlsx(files_irt[i], sheet = 1)[,c("PLOT","TREATMENT","PLANT","TEMP","EDITED TIME")]
  list_irt[[i]] <- temp_df
}
names(list_irt) <- c("2019-05-31","2019-06-11","2019-06-25","2019-06-25","2019-06-26","2019-07-17","2019-07-25","2019-08-01","2019-08-08","2019-08-14")
for(i in 1:length(list_irt)){
  list_irt[[i]]$Date <- as.Date(names(list_irt)[i])
}
irt_PL <- do.call(rbind, list_irt)
names(irt_PL) <- c("Plot","Treatment","Plant","IRT","MeasureTime","Date")
```
##Combine ground measurement together
```{r}
phys_PL <- merge(swp_PL, licor_PL, by = c("Block","Plot","Treatment","Plant","Date"))
#phys_PL <- merge(phys_PL, chl_PL, by = c("Plot","Treatment","Plant","Date"))
#phys_PL <- merge(phys_PL, irt_PL, by = c("Plot","Treatment","Plant","Date"))
dim(phys_PL)
sum(is.na(phys_PL))
View(phys_PL)

phys_PL <- merge(irt_PL, chl_PL, by = c("Plot","Treatment","Plant","Date"))
head(phys_PL)
dim(phys_PL)  #1360

phys_PL <- merge(phys_PL, licor_PL, by = c("Plot","Treatment","Plant","Date"))
head(phys_PL)
dim(phys_PL)  #1126

phys_PL <- merge(phys_PL, swp_PL, by = c("Block","Plot","Treatment","Plant","Date"))
head(phys_PL)
dim(phys_PL)  #1101
```
##Combine with macaw data
```{r}
#flagmean_macaw$Date <- as.Date(flagmean_macaw$Date)
#unique(flagmean_macaw$Date)
flagmean_macaw_exgexrmask$Date <- as.Date(flagmean_macaw_exgexrmask$Date)
unique(flagmean_macaw_exgexrmask$Date)
unique(phys_PL$Date)

for(i in 1:dim(phys_PL)[1]){
  if(phys_PL[i,]$Date=="2019-06-26"){
    phys_PL[i,]$Date= "2019-06-28"
  }
  if(phys_PL[i,]$Date=="2019-08-01"){
    phys_PL[i,]$Date="2019-08-02"
  }
  if(phys_PL[i,]$Date=="2019-08-14"){
    phys_PL[i,]$Date="2019-08-15"
  }
}

phys_PL$Block <- as.character(phys_PL$Block)
flagmean_macaw_exgexrmask_phys <- base::merge(flagmean_macaw_exgexrmask, phys_PL, by = c("Block","Treatment","Plant","Date"))
head(flagmean_macaw_exgexrmask_phys)
dim(flagmean_macaw_exgexrmask_phys)  #315, 40
dim(subset(flagmean_macaw_exgexrmask_phys, Date=="2019-06-28"))  #120,40
dim(subset(flagmean_macaw_exgexrmask_phys, Date=="2019-08-02")) #120,40
dim(subset(flagmean_macaw_exgexrmask_phys, Date=="2019-08-15")) #75, 40, this is because the phys data only contains 75 rows 


#flagmean_macaw_phys <- base::merge(flagmean_macaw, phys_PL, by = c("Block","Treatment","Plant","Date"))
head(flagmean_macaw_phys)
dim(flagmean_macaw_phys)  #315, 28
unique(flagmean_macaw_phys$Date)  
dim(subset(flagmean_macaw_phys, Date=="2019-06-28"))  #120
dim(subset(flagmean_macaw_phys, Date=="2019-08-02")) #120
dim(subset(flagmean_macaw_phys, Date=="2019-08-15")) #75

View(subset(flagmean_macaw_phys, Date=="2019-06-28"))
head(flagmean_macaw_phys)

#change classes
##veg mask
flagmean_macaw_phys$Block <- as.factor(flagmean_macaw_phys$Block)
flagmean_macaw_phys$Plant <- as.factor(as.character(flagmean_macaw_phys$Plant))
flagmean_macaw_phys$Plot <- as.factor(flagmean_macaw_phys$Plot)
flagmean_macaw_phys$SWP <- as.numeric(flagmean_macaw_phys$SWP)
flagmean_macaw_phys$CHL <- as.numeric(flagmean_macaw_phys$CHL)
##fruit mask
flagmean_macaw_exgexrmask_phys$Block <- as.factor(flagmean_macaw_exgexrmask_phys$Block)
flagmean_macaw_exgexrmask_phys$Plant <- as.factor(as.character(flagmean_macaw_exgexrmask_phys$Plant))
flagmean_macaw_exgexrmask_phys$Plot <- as.factor(flagmean_macaw_exgexrmask_phys$Plot)
flagmean_macaw_exgexrmask_phys$SWP <- as.numeric(flagmean_macaw_exgexrmask_phys$SWP)
flagmean_macaw_exgexrmask_phys$CHL <- as.numeric(flagmean_macaw_exgexrmask_phys$CHL)

```
###Only SWP
```{r}
#flagmean_macaw$Date <- as.Date(flagmean_macaw$Date)
#unique(flagmean_macaw$Date)
flagmean_macaw_exgexrmask$Date <- as.Date(flagmean_macaw_exgexrmask$Date)
unique(flagmean_macaw_exgexrmask$Date)
unique(swp_PL$Date)

for(i in 1:dim(swp_PL)[1]){
  if(swp_PL[i,]$Date=="2019-06-26"){
    swp_PL[i,]$Date= "2019-06-28"
  }
  if(swp_PL[i,]$Date=="2019-08-01"){
    swp_PL[i,]$Date="2019-08-02"
  }
  if(swp_PL[i,]$Date=="2019-08-14"){
    swp_PL[i,]$Date="2019-08-15"
  }
}

swp_PL$Block <- as.character(swp_PL$Block)
flagmean_macaw_exgexrmask_swp <- base::merge(flagmean_macaw_exgexrmask, swp_PL, by = c("Block","Treatment","Plant","Date"))
head(flagmean_macaw_exgexrmask_swp)
dim(flagmean_macaw_exgexrmask_swp)  #315, 40
dim(subset(flagmean_macaw_exgexrmask_swp, Date=="2019-06-28"))  #120,40
dim(subset(flagmean_macaw_exgexrmask_swp, Date=="2019-08-02")) #120,40
dim(subset(flagmean_macaw_exgexrmask_swp, Date=="2019-08-15")) #90, 35

#flagmean_macaw_swp <- base::merge(flagmean_macaw, swp_PL, by = c("Block","Treatment","Plant","Date"))
head(flagmean_macaw_swp)
dim(flagmean_macaw_swp)  #315, 28
unique(flagmean_macaw_swp$Date)  
dim(subset(flagmean_macaw_swp, Date=="2019-06-28"))  #120
dim(subset(flagmean_macaw_swp, Date=="2019-08-02")) #120
dim(subset(flagmean_macaw_swp, Date=="2019-08-15")) #75

View(subset(flagmean_macaw_swp, Date=="2019-06-28"))
head(flagmean_macaw_swp)

#change classes
##veg mask
flagmean_macaw_swp$Block <- as.factor(flagmean_macaw_swp$Block)
flagmean_macaw_swp$Plant <- as.factor(as.character(flagmean_macaw_swp$Plant))
flagmean_macaw_swp$Plot <- as.factor(flagmean_macaw_swp$Plot)
flagmean_macaw_swp$SWP <- as.numeric(flagmean_macaw_swp$SWP)
#flagmean_macaw_swp$CHL <- as.numeric(flagmean_macaw_swp$CHL)
##fruit mask
flagmean_macaw_exgexrmask_swp$Block <- as.factor(flagmean_macaw_exgexrmask_swp$Block)
flagmean_macaw_exgexrmask_swp$Plant <- as.factor(as.character(flagmean_macaw_exgexrmask_swp$Plant))
flagmean_macaw_exgexrmask_swp$Plot <- as.factor(flagmean_macaw_exgexrmask_swp$Plot)
flagmean_macaw_exgexrmask_swp$SWP <- as.numeric(flagmean_macaw_exgexrmask_swp$SWP)
#flagmean_macaw_exgexrmask_swp$CHL <- as.numeric(flagmean_macaw_exgexrmask_swp$CHL)

```

#Add some indices
```{r}

flagmean_macaw_phys$ndvi <- NDVI(flagmean_macaw_phys)
flagmean_macaw_phys$pri <- PRI(flagmean_macaw_phys)
flagmean_macaw_phys$wi <- WI(flagmean_macaw_phys)
flagmean_macaw_phys$wi.ndvi <- WI.NDVI(flagmean_macaw_phys)
flagmean_macaw_phys$mcawi <- MCARI(flagmean_macaw_phys)
flagmean_macaw_phys$tcari.osavi <- TCARI.OSAVI(flagmean_macaw_phys)
flagmean_macaw_phys$tcari <- TCARI(flagmean_macaw_phys)
flagmean_macaw_phys$pri550 <- PRI550(flagmean_macaw_phys)
flagmean_macaw_phys$prinorm <- PRInorm(flagmean_macaw_phys)
flagmean_macaw_phys$prinorm550 <- PRInorm550(flagmean_macaw_phys)
flagmean_macaw_phys$rer <- RER(flagmean_macaw_phys)
flagmean_macaw_phys$rdvi <- RDVI(flagmean_macaw_phys)

```

#Exploratory Plots
##Boxplot & scatterplot
###veg mask 
```{r}
flagmean_macaw_phys$Treatment2 <- factor(flagmean_macaw_phys$Treatment, levels = c("BAYER 16 (SOIL) WW", "CONTROL WW", "CONTROL DDD"), order = TRUE)

#SWP change
ggplot(flagmean_macaw_phys, aes(x = as.factor(Date), y = -SWP, fill = Treatment2)) + geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("Stem Water Potential (Bars)") + scale_fill_tableau() + ggtitle("Stem Water Potential Seasonal Change")

#PRI change
ggplot(flagmean_macaw_phys, aes(x = as.factor(Date), y = pri, fill = Treatment2)) + geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("PRI") + scale_fill_tableau() + ggtitle("PRI")

#NDVI 
ggplot(flagmean_macaw_phys, aes(x = as.factor(Date), y = NDVI, fill = Treatment2)) + geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("NDVI") + scale_fill_tableau() + ggtitle("NDVI")

#TCARI.OSAVI
ggplot(flagmean_macaw_phys, aes(x = as.factor(Date), y = tcari.osavi, fill = Treatment2)) + geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("TCARI/OSAVI") + scale_fill_tableau() + ggtitle("TCARI/OSAVI")

#WI
ggplot(flagmean_macaw_phys, aes(x = as.factor(Date), y = wi, fill = Treatment2)) + geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("WI") + scale_fill_tableau() + ggtitle("WI")


##SWP change
ggplot(flagmean_macaw_phys, aes(x = Date, y = -SWP, color = Treatment)) + geom_point()
flagmean_macaw_phys
lm1 <- lm(flagmean_macaw_phys$SWP ~ flagmean_macaw_phys$pri + flagmean_macaw_phys$Treatment)
anova(lm1)

##Cond
ggplot(flagmean_macaw_phys, aes(x = Date, y = Cond, color = Treatment)) + geom_point()

##Chl
ggplot(flagmean_macaw_phys, aes(x = Date, y = CHL, color = Treatment)) + geom_point()

##PRI change
ggplot(flagmean_macaw_phys, aes(x = Date, y = pri, color = Treatment)) + geom_point() + ylab("PRI")

##NDVI change
ggplot(flagmean_macaw_phys, aes(x = Date, y = ndvi, color = Treatment)) + geom_point() + ylab("NDVI")

##TCARI.OSAVI
ggplot(flagmean_macaw_phys, aes(x = Date, y = tcari.osavi, color = Treatment)) + geom_point() + ylab("TCARI/OSAVI")

##wi
ggplot(flagmean_macaw_phys, aes(x = Date, y = wi, color = Treatment)) + geom_point() + ylab("WI")

##wi.ndvi
ggplot(flagmean_macaw_phys, aes(x = Date, y = wi.ndvi, color = Treatment)) + geom_point() + ylab("WI/NDVI")

##mcari
ggplot(flagmean_macaw_phys, aes(x = Date, y = mcari, color = Treatment)) + geom_point() + ylab("MCARI")

#TCARI.OSAVI vs CHL
ggplot(flagmean_macaw_phys, aes(x = CHL, y = tcari.osavi/ndvi, color = as.factor(Date))) + geom_point() + xlab("PRI") + ylab("TCARI/OSAVI") + geom_smooth(method = "lm") 
ggplot(flagmean_macaw_phys, aes(x = tcari.osavi, y = CHL)) + geom_point(aes(color = as.factor(Date))) + xlab("PRI") + ylab("SWP") + geom_smooth(method = "lm")


##PRI vs SWP
ggplot(flagmean_macaw_phys, aes(x = pri, y = -SWP)) + geom_point() + xlab("PRI from MACAW") + ylab("SWP") + geom_smooth(method = "lm")+ facet_wrap(~Date, scale = "free", nrow = 2)+ theme_pubr(border = TRUE, base_size = 14, base_family = "serif", legend = "none")+theme(legend.title = element_blank())


ggplot(flagmean_macaw_phys, aes(x = pri, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("PRI") + ylab("SWP (Bars)") + geom_smooth(method = "lm", se = FALSE, color = "red") + theme_pubr(border = TRUE, base_size = 14, base_family = "serif", legend = "right")+theme(legend.title = element_blank())
cor(flagmean_macaw_phys$pri, flagmean_macaw_phys$SWP)^2  #0.376
lm1 <- lm(pri~SWP, data = flagmean_macaw_phys)
summary(lm1)
ggplot(flagmean_macaw_phys, aes(x = pri, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("Photochemical Reflectance Index (PRI)") + ylab("SWP (Bars)") + geom_smooth(method = "lm") + theme_bw()+theme(text = element_text(size = 15))


##PRI/NDVI vs SWP
ggplot(flagmean_macaw_phys, aes(x = pri/ndvi, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("PRI/NDVI") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(flagmean_macaw_phys, aes(x = pri/ndvi, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("PRI/NDVI") + ylab("SWP") + geom_smooth(method = "lm")
cor(flagmean_macaw_phys$pri/flagmean_macaw_phys$ndvi, flagmean_macaw_phys$SWP)^2  #0.387
#The difference is due to the 

##PRI550
ggplot(flagmean_macaw_phys, aes(x = pri550, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("PRI550") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(flagmean_macaw_phys, aes(x = pri550, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("PRI550") + ylab("SWP") + geom_smooth(method = "lm")
cor(flagmean_macaw_phys$pri550, flagmean_macaw_phys$SWP)^2  #0.0149

##PRInorm
###SWP
ggplot(flagmean_macaw_phys, aes(x = prinorm, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("PRInorm") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(flagmean_macaw_phys, aes(x = prinorm, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("PRInorm") + ylab("SWP") + geom_smooth(method = "lm")
cor(flagmean_macaw_phys$prinorm, flagmean_macaw_phys$SWP)^2  #0.2703
###Cond
ggplot(flagmean_macaw_phys, aes(x = prinorm, y = Cond, color = as.factor(Date))) + geom_point() + xlab("PRInorm") + ylab("Cond") + geom_smooth(method = "lm") 
ggplot(flagmean_macaw_phys, aes(x = prinorm, y = Cond)) + geom_point(aes(color = as.factor(Date))) + xlab("PRInorm") + ylab("Cond") + geom_smooth(method = "lm")
cor(flagmean_macaw_phys$prinorm, flagmean_macaw_phys$Cond)^2  #0.004


##PRI550norm
ggplot(flagmean_macaw_phys, aes(x = prinorm550, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("PRInorm550") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(flagmean_macaw_phys, aes(x = prinorm550, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("PRInorm550") + ylab("SWP") + geom_smooth(method = "lm")
cor(flagmean_macaw_phys$prinorm550, flagmean_macaw_phys$SWP)^2  #0.0788

##WI
ggplot(flagmean_macaw_phys, aes(x = wi, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("WI") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(flagmean_macaw_phys, aes(x = wi, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("Water Index (WI)") + ylab("SWP (Bars)") + geom_smooth(method = "lm") + theme_bw()+theme(text = element_text(size = 15))
cor(flagmean_macaw_phys$wi, flagmean_macaw_phys$SWP)^2  #0.4004
ggplot(flagmean_macaw_phys, aes(x = wi, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("WI") + ylab("SWP (Bars)") + geom_smooth(method = "lm", se = FALSE, color = "red") + theme_pubr(border = TRUE, base_size = 14, base_family = "serif", legend = "right")+theme(legend.title = element_blank())


##WI/NDVI
ggplot(flagmean_macaw_phys, aes(x = wi.ndvi, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("WI/NDVI") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(flagmean_macaw_phys, aes(x = wi.ndvi, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("WI/NDVI") + ylab("SWP") + geom_smooth(method = "lm")
cor(flagmean_macaw_phys$wi.ndvi, flagmean_macaw_phys$SWP)^2  #0.2169

#Chlorophyll Index
##RER
ggplot(flagmean_macaw_phys, aes(x = rer, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("RER") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(flagmean_macaw_phys, aes(x = rer, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("RER") + ylab("SWP") + geom_smooth(method = "lm")
cor(flagmean_macaw_phys$rer, flagmean_macaw_phys$SWP)^2  #0.024
##TCARI
ggplot(flagmean_macaw_phys, aes(x = tcari, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("TCARI") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(flagmean_macaw_phys, aes(x = tcari, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("TCARI") + ylab("SWP") + geom_smooth(method = "lm")
cor(flagmean_macaw_phys$tcari, flagmean_macaw_phys$SWP)^2  #0.387
##TCARI.OSAVI
ggplot(flagmean_macaw_phys, aes(x = tcari.osavi, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("TCARI/OSAVI") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(flagmean_macaw_phys, aes(x = tcari.osavi, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("TCARI/OSAVI") + ylab("SWP") + geom_smooth(method = "lm")
cor(flagmean_macaw_phys$tcari.osavi, flagmean_macaw_phys$SWP)^2  #0.3349
##MCARI
ggplot(flagmean_macaw_phys, aes(x = mcari, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("MCARI") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(flagmean_macaw_phys, aes(x = mcari, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("MCARI") + ylab("SWP") + geom_smooth(method = "lm")
cor(flagmean_macaw_phys$mcari, flagmean_macaw_phys$SWP)^2  #0.292

#Strucutre Index
##NDVI
ggplot(flagmean_macaw_phys, aes(x = ndvi, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("NDVI") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(flagmean_macaw_phys, aes(x = ndvi, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("NDVI") + ylab("SWP") + geom_smooth(method = "lm")
cor(flagmean_macaw_phys$ndvi, flagmean_macaw_phys$SWP)^2  #0.1849
##RDVI
ggplot(flagmean_macaw_phys, aes(x = rdvi, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("RDVI") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(flagmean_macaw_phys, aes(x = rdvi, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("RDVI") + ylab("SWP") + geom_smooth(method = "lm")
cor(flagmean_macaw_phys$rdvi, flagmean_macaw_phys$SWP)^2  #0.324684





##PRI/(RDVI*TCARI)
ggplot(flagmean_macaw_phys, aes(x = pri/(rdvi*tcari), y = -SWP, color = as.factor(Date))) + geom_point() + xlab("PRI/(RDVI*TCARI)") + ylab("SWP") + geom_smooth(method = "lm") + xlim(-1.5,0)
ggplot(flagmean_macaw_phys, aes(x = pri/(rdvi*tcari), y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("PRI/(RDVI*TCARI)") + ylab("SWP") + geom_smooth(method = "lm")+xlim(-1.5, 0)
cor(flagmean_macaw_phys$pri/(flagmean_macaw_phys$rdvi*flagmean_macaw_phys$tcari), flagmean_macaw_phys$SWP)^2  #0.068



##PRI/(NDVI*TCARI)
ggplot(flagmean_macaw_phys, aes(x = pri/(ndvi*tcari.osavi), y = -SWP, color = as.factor(Date))) + geom_point() + xlab("PRI/(NDVI*TCARI/OSAVI)") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(flagmean_macaw_phys, aes(x = pri/(ndvi*tcari.osavi), y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("PRI/(NDVI*TCARI/OSAVI)") + ylab("SWP") + geom_smooth(method = "lm")
cor(flagmean_macaw_phys$pri/(flagmean_macaw_phys$ndvi*flagmean_macaw_phys$tcari.osavi), flagmean_macaw_phys$SWP)^2  #0.068

##PRI/(NDVI*TCARI)
ggplot(flagmean_macaw_phys, aes(x = pri/(ndvi*tcari), y = -SWP, color = as.factor(Date))) + geom_point() + xlab("PRI/(NDVI*TCARI)") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(flagmean_macaw_phys, aes(x = pri/(ndvi*tcari), y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("PRI/(NDVI*TCARI)") + ylab("SWP") + geom_smooth(method = "lm")
cor(flagmean_macaw_phys$pri/(flagmean_macaw_phys$ndvi*flagmean_macaw_phys$tcari), flagmean_macaw_phys$SWP)^2  #0.068


```
###fruit mask
```{r}
flagmean_macaw_exgexrmask_phys$Treatment2 <- factor(flagmean_macaw_exgexrmask_phys$Treatment, levels = c("BAYER 16 (SOIL) WW", "CONTROL WW", "CONTROL DDD"), order = TRUE)

#SWP change
ggplot(flagmean_macaw_exgexrmask_phys, aes(x = as.factor(Date), y = -SWP, fill = Treatment2)) + geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("Stem Water Potential (Bars)") + scale_fill_tableau() + ggtitle("Stem Water Potential Seasonal Change")
#stomatal conductance
ggplot(flagmean_macaw_exgexrmask_phys, aes(x = as.factor(Date), y = Cond, fill = Treatment2)) + geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("Stomatal Conductance") + scale_fill_tableau() + ggtitle("Stomatal Conductance")


#PRI change
ggplot(flagmean_macaw_exgexrmask_phys, aes(x = as.factor(Date), y = pri, fill = Treatment2)) + geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("PRI") + scale_fill_tableau() + ggtitle("PRI")

#NDVI 
ggplot(flagmean_macaw_exgexrmask_phys, aes(x = as.factor(Date), y = NDVI, fill = Treatment2)) + geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("NDVI") + scale_fill_tableau() + ggtitle("NDVI")

#TCARI.OSAVI
ggplot(flagmean_macaw_exgexrmask_phys, aes(x = as.factor(Date), y = tcari.osavi, fill = Treatment2)) + geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("TCARI/OSAVI") + scale_fill_tableau() + ggtitle("TCARI/OSAVI")

#WI
ggplot(flagmean_macaw_exgexrmask_phys, aes(x = as.factor(Date), y = wi, fill = Treatment2)) + geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("WI") + scale_fill_tableau() + ggtitle("WI")


##SWP change
ggplot(flagmean_macaw_exgexrmask_phys, aes(x = Date, y = -SWP, color = Treatment)) + geom_point()
flagmean_macaw_exgexrmask_phys
lm1 <- lm(flagmean_macaw_exgexrmask_phys$SWP ~ flagmean_macaw_exgexrmask_phys$pri + flagmean_macaw_exgexrmask_phys$Treatment)
anova(lm1)

##Cond
ggplot(flagmean_macaw_exgexrmask_phys, aes(x = Date, y = Cond, color = Treatment)) + geom_point()

##Chl
ggplot(flagmean_macaw_exgexrmask_phys, aes(x = Date, y = CHL, color = Treatment)) + geom_point()

##PRI change
ggplot(flagmean_macaw_exgexrmask_phys, aes(x = Date, y = pri, color = Treatment)) + geom_point() + ylab("PRI")

##NDVI change
ggplot(flagmean_macaw_exgexrmask_phys, aes(x = Date, y = ndvi, color = Treatment)) + geom_point() + ylab("NDVI")

##TCARI.OSAVI
ggplot(flagmean_macaw_exgexrmask_phys, aes(x = Date, y = tcari.osavi, color = Treatment)) + geom_point() + ylab("TCARI/OSAVI")

##wi
ggplot(flagmean_macaw_exgexrmask_phys, aes(x = Date, y = wi, color = Treatment)) + geom_point() + ylab("WI")

##wi.ndvi
ggplot(flagmean_macaw_exgexrmask_phys, aes(x = Date, y = wi.ndvi, color = Treatment)) + geom_point() + ylab("WI/NDVI")

##mcari
ggplot(flagmean_macaw_exgexrmask_phys, aes(x = Date, y = mcari, color = Treatment)) + geom_point() + ylab("MCARI")

#TCARI.OSAVI vs CHL
ggplot(flagmean_macaw_exgexrmask_phys, aes(x = CHL, y = tcari.osavi/ndvi, color = as.factor(Date))) + geom_point() + xlab("PRI") + ylab("TCARI/OSAVI") + geom_smooth(method = "lm") 
ggplot(flagmean_macaw_exgexrmask_phys, aes(x = tcari.osavi, y = CHL)) + geom_point(aes(color = as.factor(Date))) + xlab("PRI") + ylab("SWP") + geom_smooth(method = "lm")


##PRI vs SWP
ggplot(flagmean_macaw_exgexrmask_phys, aes(x = pri, y = -SWP)) + geom_point() + xlab("PRI from MACAW") + ylab("SWP") + geom_smooth(method = "lm")+ facet_wrap(~Date, scale = "free", nrow = 2)+ theme_pubr(border = TRUE, base_size = 14, base_family = "serif", legend = "none")+theme(legend.title = element_blank())


ggplot(flagmean_macaw_exgexrmask_phys, aes(x = pri, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("PRI") + ylab("SWP (Bars)") + geom_smooth(method = "lm", se = FALSE, color = "red") + theme_pubr(border = TRUE, base_size = 14, base_family = "serif", legend = "right")+theme(legend.title = element_blank())
cor(flagmean_macaw_exgexrmask_phys$pri, flagmean_macaw_exgexrmask_phys$SWP)^2  #0.376
lm1 <- lm(pri~SWP, data = flagmean_macaw_exgexrmask_phys)
summary(lm1)
ggplot(flagmean_macaw_exgexrmask_phys, aes(x = pri, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("Photochemical Reflectance Index (PRI)") + ylab("SWP (Bars)") + geom_smooth(method = "lm") + theme_bw()+theme(text = element_text(size = 15))


##PRI/NDVI vs SWP
ggplot(flagmean_macaw_exgexrmask_phys, aes(x = pri/ndvi, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("PRI/NDVI") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(flagmean_macaw_exgexrmask_phys, aes(x = pri/ndvi, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("PRI/NDVI") + ylab("SWP") + geom_smooth(method = "lm")
cor(flagmean_macaw_exgexrmask_phys$pri/flagmean_macaw_exgexrmask_phys$ndvi, flagmean_macaw_exgexrmask_phys$SWP)^2  #0.387
#The difference is due to the 

##PRI550
ggplot(flagmean_macaw_exgexrmask_phys, aes(x = pri550, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("PRI550") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(flagmean_macaw_exgexrmask_phys, aes(x = pri550, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("PRI550") + ylab("SWP") + geom_smooth(method = "lm")
cor(flagmean_macaw_exgexrmask_phys$pri550, flagmean_macaw_exgexrmask_phys$SWP)^2  #0.0149

##PRInorm
###SWP
ggplot(flagmean_macaw_exgexrmask_phys, aes(x = prinorm, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("PRInorm") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(flagmean_macaw_exgexrmask_phys, aes(x = prinorm, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("PRInorm") + ylab("SWP") + geom_smooth(method = "lm")
cor(flagmean_macaw_exgexrmask_phys$prinorm, flagmean_macaw_exgexrmask_phys$SWP)^2  #0.2703
###Cond
ggplot(flagmean_macaw_exgexrmask_phys, aes(x = prinorm, y = Cond, color = as.factor(Date))) + geom_point() + xlab("PRInorm") + ylab("Cond") + geom_smooth(method = "lm") 
ggplot(flagmean_macaw_exgexrmask_phys, aes(x = prinorm, y = Cond)) + geom_point(aes(color = as.factor(Date))) + xlab("PRInorm") + ylab("Cond") + geom_smooth(method = "lm")
cor(flagmean_macaw_exgexrmask_phys$prinorm, flagmean_macaw_exgexrmask_phys$Cond)^2  #0.004


##PRI550norm
ggplot(flagmean_macaw_exgexrmask_phys, aes(x = prinorm550, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("PRInorm550") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(flagmean_macaw_exgexrmask_phys, aes(x = prinorm550, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("PRInorm550") + ylab("SWP") + geom_smooth(method = "lm")
cor(flagmean_macaw_exgexrmask_phys$prinorm550, flagmean_macaw_exgexrmask_phys$SWP)^2  #0.0788

##WI
ggplot(flagmean_macaw_exgexrmask_phys, aes(x = wi, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("WI") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(flagmean_macaw_exgexrmask_phys, aes(x = wi, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("Water Index (WI)") + ylab("SWP (Bars)") + geom_smooth(method = "lm") + theme_bw()+theme(text = element_text(size = 15))
cor(flagmean_macaw_exgexrmask_phys$wi, flagmean_macaw_exgexrmask_phys$SWP)^2  #0.4004
ggplot(flagmean_macaw_exgexrmask_phys, aes(x = wi, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("WI") + ylab("SWP (Bars)") + geom_smooth(method = "lm", se = FALSE, color = "red") + theme_pubr(border = TRUE, base_size = 14, base_family = "serif", legend = "right")+theme(legend.title = element_blank())


##WI/NDVI
ggplot(flagmean_macaw_exgexrmask_phys, aes(x = wi.ndvi, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("WI/NDVI") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(flagmean_macaw_exgexrmask_phys, aes(x = wi.ndvi, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("WI/NDVI") + ylab("SWP") + geom_smooth(method = "lm")
cor(flagmean_macaw_exgexrmask_phys$wi.ndvi, flagmean_macaw_exgexrmask_phys$SWP)^2  #0.2169

#Chlorophyll Index
##RER
ggplot(flagmean_macaw_exgexrmask_phys, aes(x = rer, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("RER") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(flagmean_macaw_exgexrmask_phys, aes(x = rer, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("RER") + ylab("SWP") + geom_smooth(method = "lm")
cor(flagmean_macaw_exgexrmask_phys$rer, flagmean_macaw_exgexrmask_phys$SWP)^2  #0.024
##TCARI
ggplot(flagmean_macaw_exgexrmask_phys, aes(x = tcari, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("TCARI") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(flagmean_macaw_exgexrmask_phys, aes(x = tcari, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("TCARI") + ylab("SWP") + geom_smooth(method = "lm")
cor(flagmean_macaw_exgexrmask_phys$tcari, flagmean_macaw_exgexrmask_phys$SWP)^2  #0.387
##TCARI.OSAVI
ggplot(flagmean_macaw_exgexrmask_phys, aes(x = tcari.osavi, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("TCARI/OSAVI") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(flagmean_macaw_exgexrmask_phys, aes(x = tcari.osavi, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("TCARI/OSAVI") + ylab("SWP") + geom_smooth(method = "lm")
cor(flagmean_macaw_exgexrmask_phys$tcari.osavi, flagmean_macaw_exgexrmask_phys$SWP)^2  #0.3349
##MCARI
ggplot(flagmean_macaw_exgexrmask_phys, aes(x = mcari, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("MCARI") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(flagmean_macaw_exgexrmask_phys, aes(x = mcari, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("MCARI") + ylab("SWP") + geom_smooth(method = "lm")
cor(flagmean_macaw_exgexrmask_phys$mcari, flagmean_macaw_exgexrmask_phys$SWP)^2  #0.292

#Strucutre Index
##NDVI
ggplot(flagmean_macaw_exgexrmask_phys, aes(x = ndvi, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("NDVI") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(flagmean_macaw_exgexrmask_phys, aes(x = ndvi, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("NDVI") + ylab("SWP") + geom_smooth(method = "lm")
cor(flagmean_macaw_exgexrmask_phys$ndvi, flagmean_macaw_exgexrmask_phys$SWP)^2  #0.1849
##RDVI
ggplot(flagmean_macaw_exgexrmask_phys, aes(x = rdvi, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("RDVI") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(flagmean_macaw_exgexrmask_phys, aes(x = rdvi, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("RDVI") + ylab("SWP") + geom_smooth(method = "lm")
cor(flagmean_macaw_exgexrmask_phys$rdvi, flagmean_macaw_exgexrmask_phys$SWP)^2  #0.324684





##PRI/(RDVI*TCARI)
ggplot(flagmean_macaw_exgexrmask_phys, aes(x = pri/(rdvi*tcari), y = -SWP, color = as.factor(Date))) + geom_point() + xlab("PRI/(RDVI*TCARI)") + ylab("SWP") + geom_smooth(method = "lm") + xlim(-1.5,0)
ggplot(flagmean_macaw_exgexrmask_phys, aes(x = pri/(rdvi*tcari), y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("PRI/(RDVI*TCARI)") + ylab("SWP") + geom_smooth(method = "lm")+xlim(-1.5, 0)
cor(flagmean_macaw_exgexrmask_phys$pri/(flagmean_macaw_exgexrmask_phys$rdvi*flagmean_macaw_exgexrmask_phys$tcari), flagmean_macaw_exgexrmask_phys$SWP)^2  #0.068



##PRI/(NDVI*TCARI)
ggplot(flagmean_macaw_exgexrmask_phys, aes(x = pri/(ndvi*tcari.osavi), y = -SWP, color = as.factor(Date))) + geom_point() + xlab("PRI/(NDVI*TCARI/OSAVI)") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(flagmean_macaw_exgexrmask_phys, aes(x = pri/(ndvi*tcari.osavi), y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("PRI/(NDVI*TCARI/OSAVI)") + ylab("SWP") + geom_smooth(method = "lm")
cor(flagmean_macaw_exgexrmask_phys$pri/(flagmean_macaw_exgexrmask_phys$ndvi*flagmean_macaw_exgexrmask_phys$tcari.osavi), flagmean_macaw_exgexrmask_phys$SWP)^2  #0.068

##PRI/(NDVI*TCARI)
ggplot(flagmean_macaw_exgexrmask_phys, aes(x = pri/(ndvi*tcari), y = -SWP, color = as.factor(Date))) + geom_point() + xlab("PRI/(NDVI*TCARI)") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(flagmean_macaw_exgexrmask_phys, aes(x = pri/(ndvi*tcari), y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("PRI/(NDVI*TCARI)") + ylab("SWP") + geom_smooth(method = "lm")
cor(flagmean_macaw_exgexrmask_phys$pri/(flagmean_macaw_exgexrmask_phys$ndvi*flagmean_macaw_exgexrmask_phys$tcari), flagmean_macaw_exgexrmask_phys$SWP)^2  #0.068


```

##Spectral reflectance of different treatment 
###veg mask 
```{r}
unique(flagmean_macaw$Date)
flagmean_macaw_062819 <- subset(flagmean_macaw, Date=="2019-06-28")
flagmean_macaw_080219 <- subset(flagmean_macaw, Date=="2019-08-02")
flagmean_macaw_081519 <- subset(flagmean_macaw, Date=="2019-08-15")
flagmean_macaw_082219 <- subset(flagmean_macaw, Date=="2019-08-22")
names(flagmean_macaw)
wavelen_macaw <- c(450, 480, 530, 550, 570, 670, 700, 720, 740, 800, 900, 970)

ref_flagmean <- gather(flagmean_macaw, wavelen, reflectance, X800:X970, factor_key = FALSE)
#change wavelen to numeric
ref_flagmean$wavelen <- as.numeric(substring(ref_flagmean$wavelen,2))
unique(ref_flagmean$wavelen)

#subset by date
ref_flagmean_062819 <- subset(ref_flagmean, Date=="2019-06-28")
ref_flagmean_080219 <- subset(ref_flagmean, Date=="2019-08-02")
ref_flagmean_081519 <- subset(ref_flagmean, Date=="2019-08-15")
ref_flagmean_082219 <- subset(ref_flagmean, Date=="2019-08-22")

#calculate mean and variance
ref_flagmean_062819_sum <- ref_flagmean_062819 %>% group_by(Treatment, wavelen) %>% summarise(Mean = mean(reflectance), Var = var(reflectance))
ref_flagmean_080219_sum <- ref_flagmean_080219 %>% group_by(Treatment, wavelen) %>% summarise(Mean = mean(reflectance), Var = var(reflectance))
ref_flagmean_081519_sum <- ref_flagmean_081519 %>% group_by(Treatment, wavelen) %>% summarise(Mean = mean(reflectance), Var = var(reflectance))
ref_flagmean_082219_sum <- ref_flagmean_082219 %>% group_by(Treatment, wavelen) %>% summarise(Mean = mean(reflectance), Var = var(reflectance))



#Plot
ggplot(ref_flagmean_062819_sum, aes(x = wavelen, y = Mean, color = Treatment)) + geom_line(size = 1) + xlab("Wavelength(nm)")+ylab("Average Reflectance") + ggtitle("2019-06-28") + theme_pubr(border  =TRUE, base_family = "serif", base_size = 14, legend = "right") + ylim(0,0.6) #+ geom_errorbar(aes(x = wavelen, ymin =  Mean - Var, ymax = Mean + Var, color = Treatment))
ggplot(ref_flagmean_080219_sum, aes(x = wavelen, y = Mean, color = Treatment)) + geom_line(size = 1) + xlab("Wavelength(nm)")+ylab("Average Reflectance") + ggtitle("2019-08-02")+ theme_pubr(border  =TRUE, base_family = "serif", base_size = 14, legend = "right") + ylim(0,0.6)#+ geom_errorbar(aes(x = wavelen, ymin =  Mean - Var, ymax = Mean + Var, color = Treatment))
ggplot(ref_flagmean_081519_sum, aes(x = wavelen, y = Mean, color = Treatment)) + geom_line(size = 1) + xlab("Wavelength(nm)")+ylab("Average Reflectance") + ggtitle("2019-08-15")+ theme_pubr(border  =TRUE, base_family = "serif", base_size = 14, legend = "right") + ylim(0,0.6) #+ geom_errorbar(aes(x = wavelen, ymin =  Mean - Var, ymax = Mean + Var, color = Treatment))
ggplot(ref_flagmean_081519_sum, aes(x = wavelen, y = Mean, color = Treatment)) + geom_line(size = 1) + xlab("Wavelength(nm)")+ylab("Average Reflectance") + ggtitle("2019-08-15") + xlim(450, 800)+ theme_pubr(border  =TRUE, base_family = "serif", base_size = 14, legend = "right") #+ geom_errorbar(aes(x = wavelen, ymin =  Mean - Var, ymax = Mean + Var, color = Treatment))

#ggplot(ref_flagmean_082219_sum, aes(x = wavelen, y = Mean, color = Treatment)) + geom_line(size = 1) + xlab("Wavelength(nm)")+ylab("Average Reflectance") + ggtitle("2019-08-22") #+ geom_errorbar(aes(x = wavelen, ymin =  Mean - Var, ymax = Mean + Var, color = Treatment))

#ggplot(ref_flagmean_062819, aes(x = wavelen, y = reflectance, color = Treatment)) + geom_line(alpha = 0.2, size = 0.2)+ ylab("Average Reflectance")+xlab("Wavelength")#+ geom_line(data = ref_flagmean_062819_sum, aes(x = wavelen, y = Mean, color = Treatment))
#ggplot(ref_flagmean_062819_sum, aes(x = wavelen, y = Mean, color = Treatment)) + geom_line()+ylab("Average Reflectance")+xlab("Wavelength(nm)") 



ggplot(subset(ref_flagmean, Date=="2019-08-02"), aes(x = wavelen, y = reflectance, color = Treatment)) + geom_point() 
head(ref_flagmean)
ref_flagmean_080219 <- data.frame(wavelen = wavelen_macaw, ref = flagmean_macaw_081519[,c])
plot(x = wavelen_macaw, y =  flagmean_macaw_081519[,c(5:15,4)], color = flagmean_macaw_081519$Treatment)

```

##Only 06-28 and 08-02
```{r}
flagmean_macaw_phys2 <- subset(flagmean_macaw_phys, Date!="2019-08-15")
dim(flagmean_macaw_phys2) #240, 41

##PRI vs SWP
ggplot(flagmean_macaw_phys2, aes(x = pri, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("PRI") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(flagmean_macaw_phys2, aes(x = pri, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("PRI") + ylab("SWP (Bars)") + geom_smooth(method = "lm", se = FALSE, color = "red") + theme_pubr(border = TRUE, base_size = 14, base_family = "serif", legend = "right")+theme(legend.title = element_blank())
cor(flagmean_macaw_phys2$pri, flagmean_macaw_phys2$SWP)^2  #0.117
lm1 <- lm(pri~SWP, data = flagmean_macaw_phys2)
summary(lm1)
ggplot(flagmean_macaw_phys2, aes(x = pri, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("Photochemical Reflectance Index (PRI)") + ylab("SWP (Bars)") + geom_smooth(method = "lm") + theme_bw()+theme(text = element_text(size = 15))


##PRI/NDVI vs SWP
ggplot(flagmean_macaw_phys2, aes(x = pri/ndvi, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("PRI/NDVI") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(flagmean_macaw_phys2, aes(x = pri/ndvi, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("PRI/NDVI") + ylab("SWP") + geom_smooth(method = "lm")
cor(flagmean_macaw_phys2$pri/flagmean_macaw_phys2$ndvi, flagmean_macaw_phys2$SWP)^2  #0.387
#The difference is due to the 

##PRI550
ggplot(flagmean_macaw_phys2, aes(x = pri550, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("PRI550") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(flagmean_macaw_phys2, aes(x = pri550, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("PRI550") + ylab("SWP") + geom_smooth(method = "lm")
cor(flagmean_macaw_phys2$pri550, flagmean_macaw_phys2$SWP)^2  #0.0149

##PRInorm
###SWP
ggplot(flagmean_macaw_phys2, aes(x = prinorm, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("PRInorm") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(flagmean_macaw_phys2, aes(x = prinorm, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("PRInorm") + ylab("SWP") + geom_smooth(method = "lm")
cor(flagmean_macaw_phys2$prinorm, flagmean_macaw_phys2$SWP)^2  #0.2703
###Cond
ggplot(flagmean_macaw_phys2, aes(x = prinorm, y = Cond, color = as.factor(Date))) + geom_point() + xlab("PRInorm") + ylab("Cond") + geom_smooth(method = "lm") 
ggplot(flagmean_macaw_phys2, aes(x = prinorm, y = Cond)) + geom_point(aes(color = as.factor(Date))) + xlab("PRInorm") + ylab("Cond") + geom_smooth(method = "lm")
cor(flagmean_macaw_phys2$prinorm, flagmean_macaw_phys2$Cond)^2  #0.004


##PRI550norm
ggplot(flagmean_macaw_phys2, aes(x = prinorm550, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("PRInorm550") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(flagmean_macaw_phys2, aes(x = prinorm550, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("PRInorm550") + ylab("SWP") + geom_smooth(method = "lm")
cor(flagmean_macaw_phys2$prinorm550, flagmean_macaw_phys2$SWP)^2  #0.0788

##WI
ggplot(flagmean_macaw_phys2, aes(x = wi, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("WI") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(flagmean_macaw_phys2, aes(x = wi, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("Water Index (WI)") + ylab("SWP (Bars)") + geom_smooth(method = "lm") + theme_bw()+theme(text = element_text(size = 15))
cor(flagmean_macaw_phys2$wi, flagmean_macaw_phys2$SWP)^2  #0.4004
ggplot(flagmean_macaw_phys2, aes(x = wi, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("WI") + ylab("SWP (Bars)") + geom_smooth(method = "lm", se = FALSE, color = "red") + theme_pubr(border = TRUE, base_size = 14, base_family = "serif", legend = "right")+theme(legend.title = element_blank())


##WI/NDVI
ggplot(flagmean_macaw_phys2, aes(x = wi.ndvi, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("WI/NDVI") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(flagmean_macaw_phys2, aes(x = wi.ndvi, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("WI/NDVI") + ylab("SWP") + geom_smooth(method = "lm")
cor(flagmean_macaw_phys2$wi.ndvi, flagmean_macaw_phys2$SWP)^2  #0.2169

#Chlorophyll Index
##RER
ggplot(flagmean_macaw_phys2, aes(x = rer, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("RER") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(flagmean_macaw_phys2, aes(x = rer, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("RER") + ylab("SWP") + geom_smooth(method = "lm")
cor(flagmean_macaw_phys2$rer, flagmean_macaw_phys2$SWP)^2  #0.024
##TCARI
ggplot(flagmean_macaw_phys2, aes(x = tcari, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("TCARI") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(flagmean_macaw_phys2, aes(x = tcari, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("TCARI") + ylab("SWP") + geom_smooth(method = "lm")
cor(flagmean_macaw_phys2$tcari, flagmean_macaw_phys2$SWP)^2  #0.387
##TCARI.OSAVI
ggplot(flagmean_macaw_phys2, aes(x = tcari.osavi, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("TCARI/OSAVI") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(flagmean_macaw_phys2, aes(x = tcari.osavi, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("TCARI/OSAVI") + ylab("SWP") + geom_smooth(method = "lm")
cor(flagmean_macaw_phys2$tcari.osavi, flagmean_macaw_phys2$SWP)^2  #0.3349
##MCARI
ggplot(flagmean_macaw_phys2, aes(x = mcari, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("MCARI") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(flagmean_macaw_phys2, aes(x = mcari, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("MCARI") + ylab("SWP") + geom_smooth(method = "lm")
cor(flagmean_macaw_phys2$mcari, flagmean_macaw_phys2$SWP)^2  #0.292

#Strucutre Index
##NDVI
ggplot(flagmean_macaw_phys2, aes(x = ndvi, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("NDVI") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(flagmean_macaw_phys2, aes(x = ndvi, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("NDVI") + ylab("SWP") + geom_smooth(method = "lm")
cor(flagmean_macaw_phys2$ndvi, flagmean_macaw_phys2$SWP)^2  #0.1849
##RDVI
ggplot(flagmean_macaw_phys2, aes(x = rdvi, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("RDVI") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(flagmean_macaw_phys2, aes(x = rdvi, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("RDVI") + ylab("SWP") + geom_smooth(method = "lm")
cor(flagmean_macaw_phys2$rdvi, flagmean_macaw_phys2$SWP)^2  #0.324684





##PRI/(RDVI*TCARI)
ggplot(flagmean_macaw_phys2, aes(x = pri/(rdvi*tcari), y = -SWP, color = as.factor(Date))) + geom_point() + xlab("PRI/(RDVI*TCARI)") + ylab("SWP") + geom_smooth(method = "lm") + xlim(-1.5,0)
ggplot(flagmean_macaw_phys2, aes(x = pri/(rdvi*tcari), y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("PRI/(RDVI*TCARI)") + ylab("SWP") + geom_smooth(method = "lm")+xlim(-1.5, 0)
cor(flagmean_macaw_phys2$pri/(flagmean_macaw_phys2$rdvi*flagmean_macaw_phys2$tcari), flagmean_macaw_phys2$SWP)^2  #0.068



##PRI/(NDVI*TCARI)
ggplot(flagmean_macaw_phys2, aes(x = pri/(ndvi*tcari.osavi), y = -SWP, color = as.factor(Date))) + geom_point() + xlab("PRI/(NDVI*TCARI/OSAVI)") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(flagmean_macaw_phys2, aes(x = pri/(ndvi*tcari.osavi), y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("PRI/(NDVI*TCARI/OSAVI)") + ylab("SWP") + geom_smooth(method = "lm")
cor(flagmean_macaw_phys2$pri/(flagmean_macaw_phys2$ndvi*flagmean_macaw_phys2$tcari.osavi), flagmean_macaw_phys2$SWP)^2  #0.068

##PRI/(NDVI*TCARI)
ggplot(flagmean_macaw_phys2, aes(x = pri/(ndvi*tcari), y = -SWP, color = as.factor(Date))) + geom_point() + xlab("PRI/(NDVI*TCARI)") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(flagmean_macaw_phys2, aes(x = pri/(ndvi*tcari), y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("PRI/(NDVI*TCARI)") + ylab("SWP") + geom_smooth(method = "lm")
cor(flagmean_macaw_phys2$pri/(flagmean_macaw_phys2$ndvi*flagmean_macaw_phys2$tcari), flagmean_macaw_phys2$SWP)^2  #0.068

```
#Aggregate by row
##veg mask 
```{r}
rowflagmean_macaw_phys <- aggregate(flagmean_macaw_phys[,c(8:19,22:33,35:39)], by = list("Row"=flagmean_macaw_phys$Row, "Treatment"=flagmean_macaw_phys$Treatment, "Block"=flagmean_macaw_phys$Block, "Date"=flagmean_macaw_phys$Date), FUN = mean)
rowflagmean_macaw_phys2 <- subset(rowflagmean_macaw_phys, Date!="2019-08-15")

##PRI vs SWP
ggplot(rowflagmean_macaw_phys, aes(x = pri, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("PRI") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(rowflagmean_macaw_phys, aes(x = pri, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("PRI") + ylab("SWP (Bars)") + geom_smooth(method = "lm", se = FALSE, color = "red") + theme_pubr(border = TRUE, base_size = 14, base_family = "serif", legend = "right")+theme(legend.title = element_blank())
ggplot(rowflagmean_macaw_phys, aes(x = pri, y = -SWP)) + geom_point() + xlab("PRI from MACAW") + ylab("SWP (Bars)") + geom_smooth(method = "lm") + theme_pubr(border = TRUE, base_size = 14, base_family = "serif", legend = "right")+theme(legend.title = element_blank())+facet_wrap(~Date, nrow = 2, scale = "free")

##PRI vs Cond
ggplot(rowflagmean_macaw_phys, aes(x = pri, y = Cond)) + geom_point() + xlab("PRI from MACAW") + ylab("Stomatal Conductance") + geom_smooth(method = "lm") + theme_pubr(border = TRUE, base_size = 14, base_family = "serif", legend = "right")+theme(legend.title = element_blank())+facet_wrap(~Date, nrow = 2, scale = "free")


cor(rowflagmean_macaw_phys$pri, rowflagmean_macaw_phys$SWP)^2  #0.376
lm1 <- lm(pri~SWP, data = rowflagmean_macaw_phys)
summary(lm1)
ggplot(rowflagmean_macaw_phys, aes(x = pri, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("Photochemical Reflectance Index (PRI)") + ylab("SWP (Bars)") + geom_smooth(method = "lm") + theme_bw()+theme(text = element_text(size = 15))


##PRI/NDVI vs SWP
ggplot(rowflagmean_macaw_phys, aes(x = pri/ndvi, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("PRI/NDVI") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(rowflagmean_macaw_phys, aes(x = pri/ndvi, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("PRI/NDVI") + ylab("SWP") + geom_smooth(method = "lm")
cor(rowflagmean_macaw_phys$pri/rowflagmean_macaw_phys$ndvi, rowflagmean_macaw_phys$SWP)^2  #0.387
#The difference is due to the 

##PRI550
ggplot(rowflagmean_macaw_phys, aes(x = pri550, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("PRI550") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(rowflagmean_macaw_phys, aes(x = pri550, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("PRI550") + ylab("SWP") + geom_smooth(method = "lm")
cor(rowflagmean_macaw_phys$pri550, rowflagmean_macaw_phys$SWP)^2  #0.0149

##PRInorm
###SWP
ggplot(rowflagmean_macaw_phys, aes(x = prinorm, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("PRInorm") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(rowflagmean_macaw_phys, aes(x = prinorm, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("PRInorm") + ylab("SWP") + geom_smooth(method = "lm")
cor(rowflagmean_macaw_phys$prinorm, rowflagmean_macaw_phys$SWP)^2  #0.2703
###Cond
ggplot(rowflagmean_macaw_phys, aes(x = prinorm, y = Cond, color = as.factor(Date))) + geom_point() + xlab("PRInorm") + ylab("Cond") + geom_smooth(method = "lm") 
ggplot(rowflagmean_macaw_phys, aes(x = prinorm, y = Cond)) + geom_point(aes(color = as.factor(Date))) + xlab("PRInorm") + ylab("Cond") + geom_smooth(method = "lm")
cor(rowflagmean_macaw_phys$prinorm, rowflagmean_macaw_phys$Cond)^2  #0.004


##PRI550norm
ggplot(rowflagmean_macaw_phys, aes(x = prinorm550, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("PRInorm550") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(rowflagmean_macaw_phys, aes(x = prinorm550, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("PRInorm550") + ylab("SWP") + geom_smooth(method = "lm")
cor(rowflagmean_macaw_phys$prinorm550, rowflagmean_macaw_phys$SWP)^2  #0.0788

##WI
ggplot(rowflagmean_macaw_phys, aes(x = wi, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("WI") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(rowflagmean_macaw_phys, aes(x = wi, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("Water Index (WI)") + ylab("SWP (Bars)") + geom_smooth(method = "lm") + theme_bw()+theme(text = element_text(size = 15))
cor(rowflagmean_macaw_phys$wi, rowflagmean_macaw_phys$SWP)^2  #0.4004
ggplot(rowflagmean_macaw_phys, aes(x = wi, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("WI") + ylab("SWP (Bars)") + geom_smooth(method = "lm", se = FALSE, color = "red") + theme_pubr(border = TRUE, base_size = 14, base_family = "serif", legend = "right")+theme(legend.title = element_blank())


##WI/NDVI
ggplot(rowflagmean_macaw_phys, aes(x = wi.ndvi, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("WI/NDVI") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(rowflagmean_macaw_phys, aes(x = wi.ndvi, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("WI/NDVI") + ylab("SWP") + geom_smooth(method = "lm")
cor(rowflagmean_macaw_phys$wi.ndvi, rowflagmean_macaw_phys$SWP)^2  #0.2169

#Chlorophyll Index
##RER
ggplot(rowflagmean_macaw_phys, aes(x = rer, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("RER") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(rowflagmean_macaw_phys, aes(x = rer, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("RER") + ylab("SWP") + geom_smooth(method = "lm")
cor(rowflagmean_macaw_phys$rer, rowflagmean_macaw_phys$SWP)^2  #0.024
##TCARI
ggplot(rowflagmean_macaw_phys, aes(x = tcari, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("TCARI") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(rowflagmean_macaw_phys, aes(x = tcari, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("TCARI") + ylab("SWP") + geom_smooth(method = "lm")
cor(rowflagmean_macaw_phys$tcari, rowflagmean_macaw_phys$SWP)^2  #0.387
##TCARI.OSAVI
ggplot(rowflagmean_macaw_phys, aes(x = tcari.osavi, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("TCARI/OSAVI") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(rowflagmean_macaw_phys, aes(x = tcari.osavi, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("TCARI/OSAVI") + ylab("SWP") + geom_smooth(method = "lm")
cor(rowflagmean_macaw_phys$tcari.osavi, rowflagmean_macaw_phys$SWP)^2  #0.3349
##MCARI
ggplot(rowflagmean_macaw_phys, aes(x = mcari, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("MCARI") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(rowflagmean_macaw_phys, aes(x = mcari, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("MCARI") + ylab("SWP") + geom_smooth(method = "lm")
cor(rowflagmean_macaw_phys$mcari, rowflagmean_macaw_phys$SWP)^2  #0.292

#Strucutre Index
##NDVI
ggplot(rowflagmean_macaw_phys, aes(x = ndvi, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("NDVI") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(rowflagmean_macaw_phys, aes(x = ndvi, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("NDVI") + ylab("SWP") + geom_smooth(method = "lm")
cor(rowflagmean_macaw_phys$ndvi, rowflagmean_macaw_phys$SWP)^2  #0.1849
##RDVI
ggplot(rowflagmean_macaw_phys, aes(x = rdvi, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("RDVI") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(rowflagmean_macaw_phys, aes(x = rdvi, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("RDVI") + ylab("SWP") + geom_smooth(method = "lm")
cor(rowflagmean_macaw_phys$rdvi, rowflagmean_macaw_phys$SWP)^2  #0.324684





##PRI/(RDVI*TCARI)
ggplot(rowflagmean_macaw_phys, aes(x = pri/(rdvi*tcari), y = -SWP, color = as.factor(Date))) + geom_point() + xlab("PRI/(RDVI*TCARI)") + ylab("SWP") + geom_smooth(method = "lm") + xlim(-1.5,0)
ggplot(rowflagmean_macaw_phys, aes(x = pri/(rdvi*tcari), y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("PRI/(RDVI*TCARI)") + ylab("SWP") + geom_smooth(method = "lm")+xlim(-1.5, 0)
cor(rowflagmean_macaw_phys$pri/(rowflagmean_macaw_phys$rdvi*rowflagmean_macaw_phys$tcari), rowflagmean_macaw_phys$SWP)^2  #0.068



##PRI/(NDVI*TCARI)
ggplot(rowflagmean_macaw_phys, aes(x = pri/(ndvi*tcari.osavi), y = -SWP, color = as.factor(Date))) + geom_point() + xlab("PRI/(NDVI*TCARI/OSAVI)") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(rowflagmean_macaw_phys, aes(x = pri/(ndvi*tcari.osavi), y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("PRI/(NDVI*TCARI/OSAVI)") + ylab("SWP") + geom_smooth(method = "lm")
cor(rowflagmean_macaw_phys$pri/(rowflagmean_macaw_phys$ndvi*rowflagmean_macaw_phys$tcari.osavi), rowflagmean_macaw_phys$SWP)^2  #0.068

##PRI/(NDVI*TCARI)
ggplot(rowflagmean_macaw_phys, aes(x = pri/(ndvi*tcari), y = -SWP, color = as.factor(Date))) + geom_point() + xlab("PRI/(NDVI*TCARI)") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(rowflagmean_macaw_phys, aes(x = pri/(ndvi*tcari), y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("PRI/(NDVI*TCARI)") + ylab("SWP") + geom_smooth(method = "lm")
cor(rowflagmean_macaw_phys$pri/(rowflagmean_macaw_phys$ndvi*rowflagmean_macaw_phys$tcari), rowflagmean_macaw_phys$SWP)^2  #0.068

```
##fruit mask
###merge rowmean with rowmean
```{r}
rowflagmean_macaw_exgexrmask <- aggregate(flagmean_macaw_exgexrmask[,c(4:15,21:32)], by = list("Row"=flagmean_macaw_exgexrmask$Row, "Treatment"=flagmean_macaw_exgexrmask$Treatment, "Block"=flagmean_macaw_exgexrmask$Block, "Date"=flagmean_macaw_exgexrmask$Date), FUN = mean)
dim(rowflagmean_macaw_exgexrmask)  #45,28
dim(rowflagmean_macaw_swp)  #140,5

for(i in 1:dim(rowflagmean_macaw_swp)[1]){
  if(rowflagmean_macaw_swp[i,]$Date=="2019-06-26"){
    rowflagmean_macaw_swp[i,]$Date= "2019-06-28"
  }
  if(rowflagmean_macaw_swp[i,]$Date=="2019-08-01"){
    rowflagmean_macaw_swp[i,]$Date="2019-08-02"
  }
  if(rowflagmean_macaw_swp[i,]$Date=="2019-08-14"){
    rowflagmean_macaw_swp[i,]$Date="2019-08-15"
  }
}

#rowflagmean_macaw_swp$Block <- as.character(rowflagmean_macaw_swp$Block)
rowflagmean_macaw_exgexrmask_swp <- base::merge(rowflagmean_macaw_exgexrmask, rowflagmean_macaw_swp, by = c("Block","Treatment","Date"))
head(rowflagmean_macaw_exgexrmask_swp)
dim(rowflagmean_macaw_exgexrmask_swp)  #45, 30
dim(subset(rowflagmean_macaw_exgexrmask_swp, Date=="2019-06-28"))  #15,40
dim(subset(rowflagmean_macaw_exgexrmask_swp, Date=="2019-08-02")) #15,40
dim(subset(rowflagmean_macaw_exgexrmask_swp, Date=="2019-08-15")) #15, 40


##Change class
rowflagmean_macaw_exgexrmask_swp$Block <- as.factor(rowflagmean_macaw_exgexrmask_swp$Block)
rowflagmean_macaw_exgexrmask_swp$Plot <- as.factor(rowflagmean_macaw_exgexrmask_swp$Plot)

```
####plots
```{r}
a1 = subset(rowflagmean_macaw_exgexrmask_swp, Date=="2019-06-28")
a2 = subset(rowflagmean_macaw_exgexrmask_swp, Date=="2019-08-02")
a3 = subset(rowflagmean_macaw_exgexrmask_swp, Date=="2019-08-15")
View(a2)
##PRI vs SWP
ggplot(rowflagmean_macaw_exgexrmask_swp, aes(x = pri, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("PRI") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(rowflagmean_macaw_exgexrmask_swp, aes(x = pri, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("PRI") + ylab("SWP (Bars)") + geom_smooth(method = "lm", se = FALSE, color = "red") + theme_pubr(border = TRUE, base_size = 14, base_family = "serif", legend = "right")+theme(legend.title = element_blank())
ggplot(rowflagmean_macaw_exgexrmask_swp, aes(x = pri, y = -SWP)) + geom_point() + xlab("PRI from MACAW") + ylab("SWP (Bars)") + geom_smooth(method = "lm") + theme_pubr(border = TRUE, base_size = 14, base_family = "serif", legend = "right")+theme(legend.title = element_blank())+facet_wrap(~Date, nrow = 2, scale = "free")



cor(rowflagmean_macaw_exgexrmask_swp$pri, rowflagmean_macaw_exgexrmask_swp$SWP)^2  #0.5479
lm1 <- lm(pri~SWP, data = rowflagmean_macaw_exgexrmask_swp)
summary(lm1)
ggplot(rowflagmean_macaw_exgexrmask_swp, aes(x = pri, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("Photochemical Reflectance Index (PRI)") + ylab("SWP (Bars)") + geom_smooth(method = "lm") + theme_bw()+theme(text = element_text(size = 15))


##PRI/NDVI vs SWP
ggplot(rowflagmean_macaw_exgexrmask_swp, aes(x = pri/ndvi, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("PRI/NDVI") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(rowflagmean_macaw_exgexrmask_swp, aes(x = pri/ndvi, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("PRI/NDVI") + ylab("SWP") + geom_smooth(method = "lm")
cor(rowflagmean_macaw_exgexrmask_swp$pri/rowflagmean_macaw_exgexrmask_swp$ndvi, rowflagmean_macaw_exgexrmask_swp$SWP)^2  #0.537
ggplot(rowflagmean_macaw_exgexrmask_swp, aes(x = pri/ndvi, y = -SWP)) + geom_point() + xlab("PRI/NDVI from MACAW") + ylab("SWP (Bars)") + geom_smooth(method = "lm") + theme_pubr(border = TRUE, base_size = 14, base_family = "serif", legend = "right")+theme(legend.title = element_blank())+facet_wrap(~Date, nrow = 2, scale = "free")




##PRI550
ggplot(rowflagmean_macaw_exgexrmask_swp, aes(x = pri550, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("PRI550") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(rowflagmean_macaw_exgexrmask_swp, aes(x = pri550, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("PRI550") + ylab("SWP") + geom_smooth(method = "lm")
cor(rowflagmean_macaw_exgexrmask_swp$pri550, rowflagmean_macaw_exgexrmask_swp$SWP)^2  #0.0004

##PRInorm
###SWP
ggplot(rowflagmean_macaw_exgexrmask_swp, aes(x = prinorm, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("PRInorm") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(rowflagmean_macaw_exgexrmask_swp, aes(x = prinorm, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("PRInorm") + ylab("SWP") + geom_smooth(method = "lm")
cor(rowflagmean_macaw_exgexrmask_swp$prinorm, rowflagmean_macaw_exgexrmask_swp$SWP)^2  #0.402


##PRI550norm
ggplot(rowflagmean_macaw_exgexrmask_swp, aes(x = prinorm550, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("PRInorm550") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(rowflagmean_macaw_exgexrmask_swp, aes(x = prinorm550, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("PRInorm550") + ylab("SWP") + geom_smooth(method = "lm")
cor(rowflagmean_macaw_exgexrmask_swp$prinorm550, rowflagmean_macaw_exgexrmask_swp$SWP)^2  #0.253

##WI
ggplot(rowflagmean_macaw_exgexrmask_swp, aes(x = wi, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("WI") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(rowflagmean_macaw_exgexrmask_swp, aes(x = wi, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("Water Index (WI)") + ylab("SWP (Bars)") + geom_smooth(method = "lm") + theme_bw()+theme(text = element_text(size = 15))
cor(rowflagmean_macaw_exgexrmask_swp$wi, rowflagmean_macaw_exgexrmask_swp$SWP)^2  #0.541
ggplot(rowflagmean_macaw_exgexrmask_swp, aes(x = wi, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("WI") + ylab("SWP (Bars)") + geom_smooth(method = "lm", se = FALSE, color = "red") + theme_pubr(border = TRUE, base_size = 14, base_family = "serif", legend = "right")+theme(legend.title = element_blank())
#ggplot(rowflagmean_macaw_exgexrmask_swp, aes(x = pri/ndvi, y = -SWP)) + geom_point() + xlab("PRI/NDVI from MACAW") + ylab("SWP (Bars)") + geom_smooth(method = "lm") + theme_pubr(border = TRUE, base_size = 14, base_family = "serif", legend = "right")+theme(legend.title = element_blank())+facet_wrap(~Date, nrow = 2, scale = "free")


##WI/NDVI
ggplot(rowflagmean_macaw_exgexrmask_swp, aes(x = wi.ndvi, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("WI/NDVI") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(rowflagmean_macaw_exgexrmask_swp, aes(x = wi.ndvi, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("WI/NDVI") + ylab("SWP") + geom_smooth(method = "lm")
cor(rowflagmean_macaw_exgexrmask_swp$wi.ndvi, rowflagmean_macaw_exgexrmask_swp$SWP)^2  #0.3886

#Chlorophyll Index
##RER
ggplot(rowflagmean_macaw_exgexrmask_swp, aes(x = rer, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("RER") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(rowflagmean_macaw_exgexrmask_swp, aes(x = rer, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("RER") + ylab("SWP") + geom_smooth(method = "lm")
cor(rowflagmean_macaw_exgexrmask_swp$rer, rowflagmean_macaw_exgexrmask_swp$SWP)^2  #0.00345
##TCARI
ggplot(rowflagmean_macaw_exgexrmask_swp, aes(x = tcari, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("TCARI") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(rowflagmean_macaw_exgexrmask_swp, aes(x = tcari, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("TCARI") + ylab("SWP") + geom_smooth(method = "lm")
cor(rowflagmean_macaw_exgexrmask_swp$tcari, rowflagmean_macaw_exgexrmask_swp$SWP)^2  #0.594
##TCARI.OSAVI
ggplot(rowflagmean_macaw_exgexrmask_swp, aes(x = tcari.osavi, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("TCARI/OSAVI") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(rowflagmean_macaw_exgexrmask_swp, aes(x = tcari.osavi, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("TCARI/OSAVI") + ylab("SWP") + geom_smooth(method = "lm")
cor(rowflagmean_macaw_exgexrmask_swp$tcari.osavi, rowflagmean_macaw_exgexrmask_swp$SWP)^2  #0.0102
##MCARI

#Strucutre Index
##NDVI
ggplot(rowflagmean_macaw_exgexrmask_swp, aes(x = ndvi, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("NDVI") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(rowflagmean_macaw_exgexrmask_swp, aes(x = ndvi, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("NDVI") + ylab("SWP") + geom_smooth(method = "lm")
cor(rowflagmean_macaw_exgexrmask_swp$ndvi, rowflagmean_macaw_exgexrmask_swp$SWP)^2  #0.2751
##RDVI
ggplot(rowflagmean_macaw_exgexrmask_swp, aes(x = rdvi, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("RDVI") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(rowflagmean_macaw_exgexrmask_swp, aes(x = rdvi, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("RDVI") + ylab("SWP") + geom_smooth(method = "lm")
cor(rowflagmean_macaw_exgexrmask_swp$rdvi, rowflagmean_macaw_exgexrmask_swp$SWP)^2  #0.5557





##PRI/(RDVI*TCARI)
ggplot(rowflagmean_macaw_exgexrmask_swp, aes(x = pri/(rdvi*tcari), y = -SWP, color = as.factor(Date))) + geom_point() + xlab("PRI/(RDVI*TCARI)") + ylab("SWP") + geom_smooth(method = "lm")# + xlim(-1.5,0)
ggplot(rowflagmean_macaw_exgexrmask_swp, aes(x = pri/(rdvi*tcari), y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("PRI/(RDVI*TCARI)") + ylab("SWP") + geom_smooth(method = "lm")#+xlim(-1.5, 0)
cor(rowflagmean_macaw_exgexrmask_swp$pri/(rowflagmean_macaw_exgexrmask_swp$rdvi*rowflagmean_macaw_exgexrmask_swp$tcari), rowflagmean_macaw_exgexrmask_swp$SWP)^2  #0.1052



##PRI/(NDVI*TCARI)
ggplot(rowflagmean_macaw_exgexrmask_swp, aes(x = pri/(ndvi*tcari.osavi), y = -SWP, color = as.factor(Date))) + geom_point() + xlab("PRI/(NDVI*TCARI/OSAVI)") + ylab("SWP") + geom_smooth(method = "lm")+facet_wrap(~Date)
ggplot(rowflagmean_macaw_exgexrmask_swp, aes(x = pri/(ndvi*tcari.osavi), y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("PRI/(NDVI*TCARI/OSAVI)") + ylab("SWP") + geom_smooth(method = "lm")
cor(rowflagmean_macaw_exgexrmask_swp$pri/(rowflagmean_macaw_exgexrmask_swp$ndvi*rowflagmean_macaw_exgexrmask_swp$tcari.osavi), rowflagmean_macaw_exgexrmask_swp$SWP)^2  #0.591
cor(a1$pri/(a1$ndvi*a1$tcari.osavi), a1$SWP)^2  #0.142
cor(a2$pri/(a2$ndvi*a2$tcari.osavi), a2$SWP)^2  #0.142
cor(a3$pri/(a3$ndvi*a3$tcari.osavi), a3$SWP)^2  #0.142


ggplot(rowflagmean_macaw_exgexrmask_swp, aes(x = pri/(ndvi*tcari.osavi), y = -SWP)) + geom_point(aes(color = Treatment)) + xlab("PRI/NDVI*TCARI from MACAW") + ylab("SWP (Bars)") + geom_smooth(method = "lm") + theme_pubr(border = TRUE, base_size = 14, base_family = "serif", legend = "right")+theme(legend.title = element_blank())+facet_wrap(~Date, nrow = 2, scale = "free")

##PRI/(NDVI*TCARI)
ggplot(rowflagmean_macaw_exgexrmask_swp, aes(x = pri/(ndvi*tcari), y = -SWP, color = as.factor(Date))) + geom_point() + xlab("PRI/(NDVI*TCARI)") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(rowflagmean_macaw_exgexrmask_swp, aes(x = pri/(ndvi*tcari), y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("PRI/(NDVI*TCARI)") + ylab("SWP") + geom_smooth(method = "lm")
cor(rowflagmean_macaw_exgexrmask_swp$pri/(rowflagmean_macaw_exgexrmask_swp$ndvi*rowflagmean_macaw_exgexrmask_swp$tcari), rowflagmean_macaw_exgexrmask_swp$SWP)^2  #0.3456

```

##plots
```{r}
rowflagmean_macaw_exgexrmask_phys <- aggregate(flagmean_macaw_exgexrmask_phys[,c(8:19, 22:33, 37:40)], by = list("Row"=flagmean_macaw_exgexrmask_phys$Row, "Treatment"=flagmean_macaw_exgexrmask_phys$Treatment, "Block"=flagmean_macaw_exgexrmask_phys$Block, "Date"=flagmean_macaw_exgexrmask_phys$Date), FUN = mean)

rowflagmean_macaw_exgexrmask_phys2 <- subset(rowflagmean_macaw_exgexrmask_phys, Date!="2019-08-15")

##PRI vs SWP
ggplot(rowflagmean_macaw_exgexrmask_phys, aes(x = pri, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("PRI") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(rowflagmean_macaw_exgexrmask_phys, aes(x = pri, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("PRI") + ylab("SWP (Bars)") + geom_smooth(method = "lm", se = FALSE, color = "red") + theme_pubr(border = TRUE, base_size = 14, base_family = "serif", legend = "right")+theme(legend.title = element_blank())
ggplot(rowflagmean_macaw_exgexrmask_phys, aes(x = pri, y = -SWP)) + geom_point() + xlab("PRI from MACAW") + ylab("SWP (Bars)") + geom_smooth(method = "lm") + theme_pubr(border = TRUE, base_size = 14, base_family = "serif", legend = "right")+theme(legend.title = element_blank())+facet_wrap(~Date, nrow = 2, scale = "free")

##PRI vs Cond
ggplot(rowflagmean_macaw_exgexrmask_phys, aes(x = pri, y = Cond)) + geom_point() + xlab("PRI from MACAW") + ylab("Stomatal Conductance") + geom_smooth(method = "lm") + theme_pubr(border = TRUE, base_size = 14, base_family = "serif", legend = "right")+theme(legend.title = element_blank())+facet_wrap(~Date, nrow = 2, scale = "free")


cor(rowflagmean_macaw_exgexrmask_phys$pri, rowflagmean_macaw_exgexrmask_phys$SWP)^2  #0.554
lm1 <- lm(pri~SWP, data = rowflagmean_macaw_exgexrmask_phys)
summary(lm1)
ggplot(rowflagmean_macaw_exgexrmask_phys, aes(x = pri, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("Photochemical Reflectance Index (PRI)") + ylab("SWP (Bars)") + geom_smooth(method = "lm") + theme_bw()+theme(text = element_text(size = 15))


##PRI/NDVI vs SWP
ggplot(rowflagmean_macaw_exgexrmask_phys, aes(x = pri/ndvi, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("PRI/NDVI") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(rowflagmean_macaw_exgexrmask_phys, aes(x = pri/ndvi, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("PRI/NDVI") + ylab("SWP") + geom_smooth(method = "lm")
cor(rowflagmean_macaw_exgexrmask_phys$pri/rowflagmean_macaw_exgexrmask_phys$ndvi, rowflagmean_macaw_exgexrmask_phys$SWP)^2  #0.543
#The difference is due to the 

##PRI550
ggplot(rowflagmean_macaw_exgexrmask_phys, aes(x = pri550, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("PRI550") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(rowflagmean_macaw_exgexrmask_phys, aes(x = pri550, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("PRI550") + ylab("SWP") + geom_smooth(method = "lm")
cor(rowflagmean_macaw_exgexrmask_phys$pri550, rowflagmean_macaw_exgexrmask_phys$SWP)^2  #0.00879

##PRInorm
###SWP
ggplot(rowflagmean_macaw_exgexrmask_phys, aes(x = prinorm, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("PRInorm") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(rowflagmean_macaw_exgexrmask_phys, aes(x = prinorm, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("PRInorm") + ylab("SWP") + geom_smooth(method = "lm")
cor(rowflagmean_macaw_exgexrmask_phys$prinorm, rowflagmean_macaw_exgexrmask_phys$SWP)^2  #0.405
###Cond
ggplot(rowflagmean_macaw_exgexrmask_phys, aes(x = prinorm, y = Cond, color = as.factor(Date))) + geom_point() + xlab("PRInorm") + ylab("Cond") + geom_smooth(method = "lm") 
ggplot(rowflagmean_macaw_exgexrmask_phys, aes(x = prinorm, y = Cond)) + geom_point(aes(color = as.factor(Date))) + xlab("PRInorm") + ylab("Cond") + geom_smooth(method = "lm")
cor(rowflagmean_macaw_exgexrmask_phys$prinorm, rowflagmean_macaw_exgexrmask_phys$Cond)^2  #0.004


##PRI550norm
ggplot(rowflagmean_macaw_exgexrmask_phys, aes(x = prinorm550, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("PRInorm550") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(rowflagmean_macaw_exgexrmask_phys, aes(x = prinorm550, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("PRInorm550") + ylab("SWP") + geom_smooth(method = "lm")
cor(rowflagmean_macaw_exgexrmask_phys$prinorm550, rowflagmean_macaw_exgexrmask_phys$SWP)^2  #0.0788

##WI
ggplot(rowflagmean_macaw_exgexrmask_phys, aes(x = wi, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("WI") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(rowflagmean_macaw_exgexrmask_phys, aes(x = wi, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("Water Index (WI)") + ylab("SWP (Bars)") + geom_smooth(method = "lm") + theme_bw()+theme(text = element_text(size = 15))
cor(rowflagmean_macaw_exgexrmask_phys$wi, rowflagmean_macaw_exgexrmask_phys$SWP)^2  #0.4004
ggplot(rowflagmean_macaw_exgexrmask_phys, aes(x = wi, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("WI") + ylab("SWP (Bars)") + geom_smooth(method = "lm", se = FALSE, color = "red") + theme_pubr(border = TRUE, base_size = 14, base_family = "serif", legend = "right")+theme(legend.title = element_blank())


##WI/NDVI
ggplot(rowflagmean_macaw_exgexrmask_phys, aes(x = wi.ndvi, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("WI/NDVI") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(rowflagmean_macaw_exgexrmask_phys, aes(x = wi.ndvi, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("WI/NDVI") + ylab("SWP") + geom_smooth(method = "lm")
cor(rowflagmean_macaw_exgexrmask_phys$wi.ndvi, rowflagmean_macaw_exgexrmask_phys$SWP)^2  #0.2169

#Chlorophyll Index
##RER
ggplot(rowflagmean_macaw_exgexrmask_phys, aes(x = rer, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("RER") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(rowflagmean_macaw_exgexrmask_phys, aes(x = rer, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("RER") + ylab("SWP") + geom_smooth(method = "lm")
cor(rowflagmean_macaw_exgexrmask_phys$rer, rowflagmean_macaw_exgexrmask_phys$SWP)^2  #0.024
##TCARI
ggplot(rowflagmean_macaw_exgexrmask_phys, aes(x = tcari, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("TCARI") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(rowflagmean_macaw_exgexrmask_phys, aes(x = tcari, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("TCARI") + ylab("SWP") + geom_smooth(method = "lm")
cor(rowflagmean_macaw_exgexrmask_phys$tcari, rowflagmean_macaw_exgexrmask_phys$SWP)^2  #0.387
##TCARI.OSAVI
ggplot(rowflagmean_macaw_exgexrmask_phys, aes(x = tcari.osavi, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("TCARI/OSAVI") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(rowflagmean_macaw_exgexrmask_phys, aes(x = tcari.osavi, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("TCARI/OSAVI") + ylab("SWP") + geom_smooth(method = "lm")
cor(rowflagmean_macaw_exgexrmask_phys$tcari.osavi, rowflagmean_macaw_exgexrmask_phys$SWP)^2  #0.3349
##MCARI
ggplot(rowflagmean_macaw_exgexrmask_phys, aes(x = mcari, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("MCARI") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(rowflagmean_macaw_exgexrmask_phys, aes(x = mcari, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("MCARI") + ylab("SWP") + geom_smooth(method = "lm")
cor(rowflagmean_macaw_exgexrmask_phys$mcari, rowflagmean_macaw_exgexrmask_phys$SWP)^2  #0.292

#Strucutre Index
##NDVI
ggplot(rowflagmean_macaw_exgexrmask_phys, aes(x = ndvi, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("NDVI") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(rowflagmean_macaw_exgexrmask_phys, aes(x = ndvi, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("NDVI") + ylab("SWP") + geom_smooth(method = "lm")
cor(rowflagmean_macaw_exgexrmask_phys$ndvi, rowflagmean_macaw_exgexrmask_phys$SWP)^2  #0.1849
##RDVI
ggplot(rowflagmean_macaw_exgexrmask_phys, aes(x = rdvi, y = -SWP, color = as.factor(Date))) + geom_point() + xlab("RDVI") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(rowflagmean_macaw_exgexrmask_phys, aes(x = rdvi, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("RDVI") + ylab("SWP") + geom_smooth(method = "lm")
cor(rowflagmean_macaw_exgexrmask_phys$rdvi, rowflagmean_macaw_exgexrmask_phys$SWP)^2  #0.324684





##PRI/(RDVI*TCARI)
ggplot(rowflagmean_macaw_exgexrmask_phys, aes(x = pri/(rdvi*tcari), y = -SWP, color = as.factor(Date))) + geom_point() + xlab("PRI/(RDVI*TCARI)") + ylab("SWP") + geom_smooth(method = "lm") + xlim(-1.5,0)
ggplot(rowflagmean_macaw_exgexrmask_phys, aes(x = pri/(rdvi*tcari), y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("PRI/(RDVI*TCARI)") + ylab("SWP") + geom_smooth(method = "lm")+xlim(-1.5, 0)
cor(rowflagmean_macaw_exgexrmask_phys$pri/(rowflagmean_macaw_exgexrmask_phys$rdvi*rowflagmean_macaw_exgexrmask_phys$tcari), rowflagmean_macaw_exgexrmask_phys$SWP)^2  #0.068



##PRI/(NDVI*TCARI)
ggplot(rowflagmean_macaw_exgexrmask_phys, aes(x = pri/(ndvi*tcari.osavi), y = -SWP, color = as.factor(Date))) + geom_point() + xlab("PRI/(NDVI*TCARI/OSAVI)") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(rowflagmean_macaw_exgexrmask_phys, aes(x = pri/(ndvi*tcari.osavi), y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("PRI/(NDVI*TCARI/OSAVI)") + ylab("SWP") + geom_smooth(method = "lm")
cor(rowflagmean_macaw_exgexrmask_phys$pri/(rowflagmean_macaw_exgexrmask_phys$ndvi*rowflagmean_macaw_exgexrmask_phys$tcari.osavi), rowflagmean_macaw_exgexrmask_phys$SWP)^2  #0.068

##PRI/(NDVI*TCARI)
ggplot(rowflagmean_macaw_exgexrmask_phys, aes(x = pri/(ndvi*tcari), y = -SWP, color = as.factor(Date))) + geom_point() + xlab("PRI/(NDVI*TCARI)") + ylab("SWP") + geom_smooth(method = "lm") 
ggplot(rowflagmean_macaw_exgexrmask_phys, aes(x = pri/(ndvi*tcari), y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("PRI/(NDVI*TCARI)") + ylab("SWP") + geom_smooth(method = "lm")
cor(rowflagmean_macaw_exgexrmask_phys$pri/(rowflagmean_macaw_exgexrmask_phys$ndvi*rowflagmean_macaw_exgexrmask_phys$tcari), rowflagmean_macaw_exgexrmask_phys$SWP)^2  #0.068

```

#Cross comparison
```{r}
dim(rowflagmean_macaw_phys)

phys_weather_PRI <- read.csv(file.path(path_df, "phys_weather_PRI.csv"))
phys_weather_PRI$Date <- as.Date(phys_weather_PRI$Date)
unique(phys_weather_PRI$Date)
for(i in 1:dim(phys_weather_PRI)[1]){
  if(phys_weather_PRI[i,]$Date=="2019-06-25"){
    phys_weather_PRI[i,]$Date = "2019-06-28"
  }
  if(phys_weather_PRI[i,]$Date=="2019-08-01"){
    phys_weather_PRI[i,]$Date = "2019-08-02"
  }
  if(phys_weather_PRI[i,]$Date=="2019-08-14"){
    phys_weather_PRI[i,]$Date = "2019-08-15"
  }
}
names(phys_weather_PRI)[23:25] <- c("Block","Plot","Treatment")
df_PRI_weather_nona <- read.csv(file.path(path_df, "df_PRI_weather_nona.csv"))
names(df_PRI_weather_nona)[3:4] <- c("Block","Treatment")

cross_comp <- merge(rowflagmean_macaw_phys, df_PRI_weather_nona, by = c("Date","Treatment","Block"))
cross_comp2 <- merge(rowflagmean_macaw_phys, phys_weather_PRI, by = c("Date","Treatment","Block"))


dim(cross_comp)
names(cross_comp)
unique(cross_comp$Date)

#pri
ggplot(cross_comp, aes(x = pri, y = PRIm.ma))+geom_point(size = 2,aes(color = as.factor(Date))) + theme_pubr(border = TRUE, legend = "right", base_size = 14, base_family = "serif") + theme(legend.title = element_blank()) + xlab("PRI from UAV") + ylab("PRI from Stand") + xlim(-0.08,0.025) + ylim(-0.08,0.025) + geom_abline(slope = 1, intercept = 0, color = "blue")+geom_smooth(method = "lm", se = FALSE, color = "red")
cor(cross_comp$pri, cross_comp$PRIm.ma)^2
#ndvi
ggplot(cross_comp, aes(x = ndvi, y = NDVIm))+geom_point(size = 2,aes(color = as.factor(Date))) + theme_pubr(border = TRUE, legend = "right", base_size = 14, base_family = "serif") + theme(legend.title = element_blank()) + xlab("NDVI from UAV") + ylab("NDVI from Stand") + xlim(0.65,0.9) + ylim(0.65,0.9)+ geom_abline(slope = 1, intercept = 0, color = "blue")+geom_smooth(method = "lm", se = FALSE, color = "red")
cor(cross_comp$ndvi, cross_comp$NDVIm)^2

ggplot(cross_comp2, aes(x = pri, y = PRIm.ma))+geom_point(aes(color = as.factor(Date)))
cor(cross_comp$pri, cross_comp$PRIm.ma)^2
ggplot(cross_comp2, aes(x = ndvi, y = NDVIm))+geom_point(aes(color = as.factor(Date)))
cor(cross_comp$ndvi, cross_comp$NDVIm)^2

```

#Machine learning 

##Split into Training and Testing 
###Split randomly
```{r}
set.seed(777)
trainIndex <- caret::createDataPartition(flagmean_macaw_phys$SWP, p = 0.7, list = FALSE)
train_PLr <- flagmean_macaw_phys[trainIndex, ]
test_PLr <- flagmean_macaw_phys[-trainIndex,]

#Use the reflectance only
train_PLr_swp1 <- train_PLr[,c(8:19, 23)]
test_PLr_swp1 <- test_PLr[,c(8:19,23)]
names(train_PLr_swp1)
names(test_PLr_swp1)

#Use the index only 
train_PLr_swp2 <- train_PLr[,c(29:31,33,34, 23)]
test_PLr_swp2 <- test_PLr[,c(29:31,33,34,23)]
names(train_PLr_swp2)
names(test_PLr_swp2)

#Use the optimal index 
train_PLr_swp3 <- train_PLr[,c("pri","rdvi","wi","tcari","SWP")]
test_PLr_swp3 <- test_PLr[,c("pri","rdvi","wi","tcari","SWP")]

#Use the optimal index and reflectance only
train_PLr_swp4 <- train_PLr[,c(8:19, 29:31,33,34, 23)]
test_PLr_swp4 <- test_PLr[,c(8:19, 29:31,33,34, 23)]
names(train_PLr_swp4)
```
####random forest regression
#####reflectance only
```{r}
fitControl <- trainControl(method = "repeatedcv", number = 10, repeats = 3)
rf_swp1_r <- train(x = train_PLr_swp1[,1:12], y = train_PLr_swp1$SWP, trControl = fitControl, method = "rf", verbose = FALSE, importance = TRUE)
rf_swp1_r
#how accurate the model is 
pred <- predict(rf_swp1_r, newdata = test_PLr_swp1)
cor(pred, test_PLr_swp1$SWP)^2  #0.5469
plot(x=pred, y=test_PLr_swp1$SWP,xlab = c("Predict SWP"), ylab = "Observed SWP", xlim=c(2,10),ylim=c(2,10))+lines(x = c(2,10), y = c(2,10), col = "red")
rmse(pred, test_PLr_swp1$SWP)  #1.343
mae(pred, test_PLr_swp1$SWP)  #1.013

qplot(x=-pred, y=-test_PLr_swp1$SWP,xlab = c("Predicted SWP (Bars)"), ylab = "Observed SWP (Bars)", xlim=c(-2,-10),ylim=c(-2,-10)) + geom_abline(slope = 1, color = "red") + theme_bw()

ggplot(varImp(rf_swp1_r))

sample1 <- shapefile(file.path(path_shp, "sample1.shp"))
macaw_062819_sample1 <- raster::crop(macaw_062819, sample1)
plot(macaw_062819_sample1)
for(i in 1:12){
  macaw_062819_sample1[[i]] <- macaw_062819_sample1[[i]]/65535
}
map_rf_swp1_r_062819 <- predict(object = macaw_062819_sample1, model = rf_swp1_r)
#mask out 
veg_062819_sample1 <- reclassify(macaw_062819_sample1$NDVI, cbind(-Inf, 0.6,NA))
map_rf_swp1_r_062819_masked <- raster::mask(map_rf_swp1_r_062819, veg_062819_sample1)
plot(map_rf_swp1_r_062819_masked, col = brewer.pal(5,"RdYlBu"))
path_output <- "D:/MACAW_tomato/Outputs"
writeRaster(map_rf_swp1_r_062819_masked, file.path(path_output,"map_rf_swp1_r_062819_masked.tif"))

#0802
macaw_080219_sample1 <- raster::crop(macaw_080219, sample1)
for(i in 1:12){
  macaw_080219_sample1[[i]] <- macaw_080219_sample1[[i]]/65535
}
map_rf_swp1_r_080219 <- predict(object = macaw_080219_sample1, model = rf_swp1_r)
#mask out 
veg_080219_sample1 <- reclassify(macaw_080219_sample1$NDVI, cbind(-Inf, 0.6,NA))
map_rf_swp1_r_080219_masked <- raster::mask(map_rf_swp1_r_080219, veg_080219_sample1)
plot(map_rf_swp1_r_080219_masked)
path_output <- "D:/MACAW_tomato/Outputs"
writeRaster(map_rf_swp1_r_080219_masked, file.path(path_output,"map_rf_swp1_r_080219_masked.tif"))

#--------------------------------------

#rf_swp4_r
rf_swp4_r <- train(x = train_PLr_swp4[,1:12], y = train_PLr_swp4$SWP, trControl = fitControl, method = "rf", verbose = FALSE, importance = TRUE)
rf_swp4_r
#how accurate the model is 
pred <- predict(rf_swp4_r, newdata = test_PLr_swp4)
cor(pred, test_PLr_swp4$SWP)^2  #0.5469
plot(x=pred, y=test_PLr_swp4$SWP,xlab = c("Predict SWP"), ylab = "Observed SWP", xlim=c(2,10),ylim=c(2,10))+lines(x = c(2,10), y = c(2,10), col = "red")
rmse(pred, test_PLr_swp4$SWP)  #1.343
mae(pred, test_PLr_swp4$SWP)  #1.013

qplot(x=-pred, y=-test_PLr_swp4$SWP,xlab = c("Predicted SWP (Bars)"), ylab = "Observed SWP (Bars)", xlim=c(-2,-10),ylim=c(-2,-10)) + geom_abline(slope = 1, color = "red") + theme_bw()

ggplot(varImp(rf_swp4_r))


```
#####Optimal index only
```{r}
rf_swp3_r <- train(x = train_PLr_swp3[,1:4], y = train_PLr_swp3$SWP, trControl = fitControl, method = "rf", verbose = FALSE, importance = TRUE)
rf_swp3_r

pred <- predict(rf_swp3_r, newdata = test_PLr_swp3)
cor(pred, test_PLr_swp3$SWP)^2  #0.474
plot(x=pred, y=test_PLr_swp3$SWP,xlab = c("Predict SWP"), ylab = "Observed SWP", xlim=c(2,10),ylim=c(2,10))+lines(x = c(2,10), y = c(2,10), col = "red")
rmse(pred, test_PLr_swp3$SWP)  #1.449
mae(pred, test_PLr_swp3$SWP)  #1.10

ggplot(varImp(rf_swp3_r))
```
####Decision Tree
```{r}
dtree_swp1_r <- train(x = train_PLr_swp1[,1:12], y = train_PLr_swp1$SWP, trControl = fitControl, method = "rpart", tuneLength = 10)
rpart.plot(dtree_swp1_r$finalModel)


pred <- predict(dtree_swp1_r, newdata = test_PLr_swp1)
plot(x = pred, y = test_PLr_swp1$SWP)
```
####xgboost
```{r}
xgb_swp3_r <- train(x = train_PLr_swp3[,1:4], y = train_PLr_swp3$SWP, trControl = fitControl, method = "xgbTree", importance = TRUE)
pred <- predict(xgb_swp3_r, newdata = test_PLr_swp3)
rmse(pred, test_PLr_swp3$SWP)  #1.464
cor(pred, test_PLr_swp3$SWP)^2  #0.464
mae(pred, test_PLr_swp3$SWP)  #1.088
plot(x=pred, y=test_PLr_swp3$SWP,xlab = c("Predict SWP"), ylab = "Observed SWP", xlim=c(2,10),ylim=c(2,10))+lines(x = c(2,10), y = c(2,10), col = "red")
ggplot(varImp(xgb_swp3_r))

rf_swp3_r <- train(x = train_PLr_swp3[,1:4], y = train_PLr_swp3$SWP, trControl = fitControl, method = "rf", verbose = FALSE, importance = TRUE)
rf_swp3_r

pred <- predict(rf_swp3_r, newdata = test_PLr_swp3)
cor(pred, test_PLr_swp3$SWP)^2  #0.474
plot(x=pred, y=test_PLr_swp3$SWP,xlab = c("Predict SWP"), ylab = "Observed SWP", xlim=c(2,10),ylim=c(2,10))+lines(x = c(2,10), y = c(2,10), col = "red")
rmse(pred, test_PLr_swp3$SWP)  #1.449
mae(pred, test_PLr_swp3$SWP)  #1.10

ggplot(varImp(rf_swp3_r))

```



###Split by dates
```{r}
train_PL <- subset(flagmean_macaw_phys, Date!="2019-08-02")
test_PL <- subset(flagmean_macaw_phys, Date=="2019-08-02")

#Use the reflectance only
train_PL_swp1 <- train_PL[,c(8:19, 23)]
test_PL_swp1 <- test_PL[,c(8:19,23)]
names(train_PL_swp1)
names(test_PL_swp1)

#Use the index only 
train_PL_swp2 <- train_PL[,c(29:31,33,34, 23)]
test_PL_swp2 <- test_PL[,c(29:31,33,34,23)]
names(train_PL_swp2)
names(test_PL_swp2)

```

##Random forest regression
###Reflectance only
```{r}
fitControl <- trainControl(method = "repeatedcv", number = 10, repeats = 3)
rf_swp1 <- train(x = train_PL_swp1[,1:12], y = train_PL_swp1$SWP, trControl = fitControl, method = "rf", verbose = FALSE)

#how accurate the 
a <- predict(rf_swp1, newdata = test_PL_swp1)
cor(a, test_PL_swp1$SWP)
plot(a, test_PL_swp1$SWP)
```
###Index only
```{r}
rf_swp2 <- train(x = train_PL_swp2[,1:5], y = train_PL_swp2$SWP, trControl = fitControl, method = "rf", verbose = FALSE)

#how accurate the 
a <- predict(rf_swp2, newdata = test_PL_swp2)
cor(a, test_PL_swp2$SWP)

```


```{r}
path_df <- "C:/Users/tangz/Box Sync/BIOSTIMULANT TRIAL - SEASON 2/ZHEHAN/dataframes"
SWP_PL <- read.csv(file.path(path_df, "SWP_Plants.csv"))
head(SWP_PL)
CHL_PL <- read.csv(file.path(path_df, "Chl_Plants.csv"))
tail(CHL_PL)
IRT_PL <- read.csv(file.path(path_df, "IRT_Plants.csv"))
tail(IRT_PL)

unique(SWP_PL$PLOT)
unique(CHL_PL$PLOT)
unique(IRT_PL$PLOT)
dim(SWP_PL)
dim(SWP_PL)

#Row and Block 

```

```{r}
path_phys <- "C:/Users/tangz/Box Sync/BIOSTIMULANT TRIAL - SEASON 2/ZHEHAN/Physiology"
SWP_BA <- read_excel(file.path(path_phys, "SWP_2019_BlockAve.xlsx"))
NPQ_BA <- read_excel(file.path(path_phys, "NPQ_2019_BlockAve.xlsx"))
LICOR_BA <- read_excel(file.path(path_phys, "LICOR_2019_BlockAve.xlsx"))
FAPAR_BA <- read_excel(file.path(path_phys, "FAPAR_2019_BlockAve.xlsx"))
CHL_BA <- read_excel(file.path(path_phys, "CHL_2019_BlockAve.xlsx"))

#merge them together
phys_BA <- merge(SWP_BA, LICOR_BA, by = c("Date","BLOCK","PLOT","TREATMENT"))
phys_BA <- merge(phys_BA, FAPAR_BA, by = c("Date","BLOCK","PLOT","TREATMENT"))
phys_BA <- merge(phys_BA, CHL_BA, by = c("Date","BLOCK","PLOT","TREATMENT"))
phys_BA <- merge(phys_BA, NPQ_BA, by = c("Date","BLOCK","PLOT","TREATMENT"))
head(phys_BA)
dim(phys_BA)
str(phys_BA)

#change format
phys_BA$Date <- as.Date(phys_BA$Date)
phys_BA$BLOCK <- as.factor(phys_BA$BLOCK)
phys_BA$PLOT <- as.factor(phys_BA$PLOT)
phys_BA$TREATMENT <- as.factor(phys_BA$TREATMENT)

#add ID column
phys_BA$ID <- paste(phys_BA$BLOCK, phys_BA$TREATMENT, sep = " ")

#change date
unique(phys_BA$Date)
unique(flagmean_macaw$Date)

#combine them together
head(flagmean_macaw)
head(phys_BA)
flagmean_macaw_phys <- merge(phys_BA, flagmean_macaw, by = c("Date","Row"))
```
#Output the MACAW-based indices
```{r}
path_output <- "D:/MACAW_tomato/Outputs"
path_shp <- "C:/Users/tangz/Box Sync/BIOSTIMULANT TRIAL - SEASON 2/ZHEHAN/shapefiles"
BND <- shapefile(file.path(path_shp, "tomato_BND_2019.shp"))
#ndvi_081019 <- raster::crop(ndvi_081019, BND)

#PRI 
macaw_053119_PRI <- (macaw_053119_masked$X530 - macaw_053119_masked$X570)/(macaw_053119_masked$X530 + macaw_053119_masked$X570)
macaw_062819_PRI <- (macaw_062819_masked$X530 - macaw_062819_masked$X570)/(macaw_062819_masked$X530 + macaw_062819_masked$X570)
macaw_080219_PRI <- (macaw_080219_masked$X530 - macaw_080219_masked$X570)/(macaw_080219_masked$X530 + macaw_080219_masked$X570)
macaw_081519_PRI <- (macaw_081519_masked$X530 - macaw_081519_masked$X570)/(macaw_081519_masked$X530 + macaw_081519_masked$X570)
macaw_053119_PRI <- raster::crop(macaw_053119_PRI, BND)
macaw_062819_PRI <- raster::crop(macaw_062819_PRI, BND)
macaw_080219_PRI <- raster::crop(macaw_080219_PRI, BND)
macaw_081519_PRI <- raster::crop(macaw_081519_PRI, BND)

#output 
writeRaster(macaw_053119_PRI, file.path(path_output, "macaw_053119_PRI.tif"), overwrite = TRUE)
writeRaster(macaw_062819_PRI, file.path(path_output, "macaw_062819_PRI.tif"), overwrite = TRUE)
writeRaster(macaw_080219_PRI, file.path(path_output, "macaw_080219_PRI.tif"), overwrite = TRUE)
writeRaster(macaw_081519_PRI, file.path(path_output, "macaw_081519_PRI.tif"), overwrite = TRUE)

#PRInorm
##need to /65535
PRInorm_map <- function(macaw){
  #pri
  x530 <- macaw$X530/65535
  x570 <- macaw$X570/65535
  pri <- (x530-x570)/(x530+x570)
  #rdvi
  red <- macaw$X670/65535
  nir <- macaw$X800/65535
  rdvi <- (nir-red)/(nir+red)^0.5
  #rer
  x700 <- macaw$X700/65535
  x670 <- macaw$X670/65535
  rer <- x700/x670
  #PRInorm
  prinorm <- pri/(rdvi*rer)
  return(prinorm)
}
macaw_053119_PRInorm <- PRInorm_map(macaw_053119_masked)
macaw_062819_PRInorm <- PRInorm_map(macaw_062819_masked)
macaw_080219_PRInorm <- PRInorm_map(macaw_080219_masked)
macaw_081519_PRInorm <- PRInorm_map(macaw_081519_masked)
macaw_053119_PRInorm <- raster::crop(macaw_053119_PRInorm, BND)
macaw_062819_PRInorm <- raster::crop(macaw_062819_PRInorm, BND)
macaw_080219_PRInorm <- raster::crop(macaw_080219_PRInorm, BND)
macaw_081519_PRInorm <- raster::crop(macaw_081519_PRInorm, BND)

#output
writeRaster(macaw_053119_PRInorm, file.path(path_output, "macaw_053119_PRInorm.tif"), overwrite = TRUE)
writeRaster(macaw_062819_PRInorm, file.path(path_output, "macaw_062819_PRInorm.tif"), overwrite = TRUE)
writeRaster(macaw_080219_PRInorm, file.path(path_output, "macaw_080219_PRInorm.tif"), overwrite = TRUE)
writeRaster(macaw_081519_PRInorm, file.path(path_output, "macaw_081519_PRInorm.tif"), overwrite = TRUE)

#writeRaster(map_rf_swp1_r_080219_masked, file.path(path_output,"map_rf_swp1_r_080219_masked.tif"))

```

#Use the row average extracted from MACAW
##Read row average
```{r}
path_df <- "C:/Users/tangz/Box Sync/BIOSTIMULANT TRIAL - SEASON 2/ZHEHAN/dataframes"
list.files(path_df)

rowmean_macaw <- read.csv(file.path(path_df, "rowmean_macaw.csv"))
rowmean_macaw_1ft <- read.csv(file.path(path_df, "rowmean_macaw_1ft.csv"))
rowmean_macaw_2ft <- read.csv(file.path(path_df, "rowmean_macaw_2ft.csv"))
rowmean_macaw_3ft <- read.csv(file.path(path_df, "rowmean_macaw_3ft.csv"))

View(rowmean_macaw)
names(rowmean_macaw)

names(rowmean_macaw_1ft)

```
##calculate indices
```{r}
#rowmean_macaw
rowmean_macaw[,2:13] <- rowmean_macaw[,2:13]/65535
rowmean_macaw$ndvi <- NDVI(rowmean_macaw)
rowmean_macaw$pri <- PRI(rowmean_macaw)
rowmean_macaw$wi <- WI(rowmean_macaw)
rowmean_macaw$wi.ndvi <- WI.NDVI(rowmean_macaw)
rowmean_macaw$mcawi <- MCARI(rowmean_macaw)
rowmean_macaw$tcari.osavi <- TCARI.OSAVI(rowmean_macaw)
rowmean_macaw$tcari <- TCARI(rowmean_macaw)
rowmean_macaw$pri550 <- PRI550(rowmean_macaw)
rowmean_macaw$prinorm <- PRInorm(rowmean_macaw)
rowmean_macaw$prinorm550 <- PRInorm550(rowmean_macaw)
rowmean_macaw$rer <- RER(rowmean_macaw)
rowmean_macaw$rdvi <- RDVI(rowmean_macaw)

#rowmean_macaw_1ft
rowmean_macaw_1ft[,2:13] <- rowmean_macaw_1ft[,2:13]/65535
rowmean_macaw_1ft$ndvi <- NDVI(rowmean_macaw_1ft)
rowmean_macaw_1ft$pri <- PRI(rowmean_macaw_1ft)
rowmean_macaw_1ft$wi <- WI(rowmean_macaw_1ft)
rowmean_macaw_1ft$wi.ndvi <- WI.NDVI(rowmean_macaw_1ft)
rowmean_macaw_1ft$mcawi <- MCARI(rowmean_macaw_1ft)
rowmean_macaw_1ft$tcari.osavi <- TCARI.OSAVI(rowmean_macaw_1ft)
rowmean_macaw_1ft$tcari <- TCARI(rowmean_macaw_1ft)
rowmean_macaw_1ft$pri550 <- PRI550(rowmean_macaw_1ft)
rowmean_macaw_1ft$prinorm <- PRInorm(rowmean_macaw_1ft)
rowmean_macaw_1ft$prinorm550 <- PRInorm550(rowmean_macaw_1ft)
rowmean_macaw_1ft$rer <- RER(rowmean_macaw_1ft)
rowmean_macaw_1ft$rdvi <- RDVI(rowmean_macaw_1ft)


#rowmean_macaw_2ft
rowmean_macaw_2ft[,2:13] <- rowmean_macaw_2ft[,2:13]/65535
rowmean_macaw_2ft$ndvi <- NDVI(rowmean_macaw_2ft)
rowmean_macaw_2ft$pri <- PRI(rowmean_macaw_2ft)
rowmean_macaw_2ft$wi <- WI(rowmean_macaw_2ft)
rowmean_macaw_2ft$wi.ndvi <- WI.NDVI(rowmean_macaw_2ft)
rowmean_macaw_2ft$mcawi <- MCARI(rowmean_macaw_2ft)
rowmean_macaw_2ft$tcari.osavi <- TCARI.OSAVI(rowmean_macaw_2ft)
rowmean_macaw_2ft$tcari <- TCARI(rowmean_macaw_2ft)
rowmean_macaw_2ft$pri550 <- PRI550(rowmean_macaw_2ft)
rowmean_macaw_2ft$prinorm <- PRInorm(rowmean_macaw_2ft)
rowmean_macaw_2ft$prinorm550 <- PRInorm550(rowmean_macaw_2ft)
rowmean_macaw_2ft$rer <- RER(rowmean_macaw_2ft)
rowmean_macaw_2ft$rdvi <- RDVI(rowmean_macaw_2ft)

#rowmean_macaw_3ft
rowmean_macaw_3ft[,2:13] <- rowmean_macaw_3ft[,2:13]/65535
rowmean_macaw_3ft$ndvi <- NDVI(rowmean_macaw_3ft)
rowmean_macaw_3ft$pri <- PRI(rowmean_macaw_3ft)
rowmean_macaw_3ft$wi <- WI(rowmean_macaw_3ft)
rowmean_macaw_3ft$wi.ndvi <- WI.NDVI(rowmean_macaw_3ft)
rowmean_macaw_3ft$mcawi <- MCARI(rowmean_macaw_3ft)
rowmean_macaw_3ft$tcari.osavi <- TCARI.OSAVI(rowmean_macaw_3ft)
rowmean_macaw_3ft$tcari <- TCARI(rowmean_macaw_3ft)
rowmean_macaw_3ft$pri550 <- PRI550(rowmean_macaw_3ft)
rowmean_macaw_3ft$prinorm <- PRInorm(rowmean_macaw_3ft)
rowmean_macaw_3ft$prinorm550 <- PRInorm550(rowmean_macaw_3ft)
rowmean_macaw_3ft$rer <- RER(rowmean_macaw_3ft)
rowmean_macaw_3ft$rdvi <- RDVI(rowmean_macaw_3ft)

#remove 0822 
rowmean_macaw <- subset(rowmean_macaw, Date!="2019-08-22")
rowmean_macaw_1ft <- subset(rowmean_macaw_1ft, Date!="2019-08-22")
rowmean_macaw_2ft <- subset(rowmean_macaw_2ft, Date!="2019-08-22")
rowmean_macaw_3ft <- subset(rowmean_macaw_3ft, Date!="2019-08-22")

```
##Convert Treatment to D, DD, WW
```{r}
#rowmean_macaw$DW <- rowmean_macaw$Treatment
```

##Subset Treatment
```{r}
rowmean_macaw_sb <- subset(rowmean_macaw, Treatment %in% c("CONTROL DDD","CONTROL WW","BAYER 16 (SOIL) WW") & Block != "CHBIO")
rowmean_macaw_1ft_sb <- subset(rowmean_macaw_1ft, Treatment %in% c("CONTROL DDD","CONTROL WW","BAYER 16 (SOIL) WW") & Block != "CHBIO")
rowmean_macaw_2ft_sb <- subset(rowmean_macaw_2ft, Treatment %in% c("CONTROL DDD","CONTROL WW","BAYER 16 (SOIL) WW") & Block != "CHBIO")
rowmean_macaw_3ft_sb <- subset(rowmean_macaw_3ft, Treatment %in% c("CONTROL DDD","CONTROL WW","BAYER 16 (SOIL) WW") & Block != "CHBIO")

#change the order of the treatment
rowmean_macaw_sb$Treatment <- factor(rowmean_macaw_sb$Treatment, levels = c("BAYER 16 (SOIL) WW", "CONTROL WW", "CONTROL DDD"), order = TRUE)
rowmean_macaw_1ft_sb$Treatment <- factor(rowmean_macaw_1ft_sb$Treatment, levels = c("BAYER 16 (SOIL) WW", "CONTROL WW", "CONTROL DDD"), order = TRUE)
rowmean_macaw_2ft_sb$Treatment <- factor(rowmean_macaw_2ft_sb$Treatment, levels = c("BAYER 16 (SOIL) WW", "CONTROL WW", "CONTROL DDD"), order = TRUE)
rowmean_macaw_3ft_sb$Treatment <- factor(rowmean_macaw_3ft_sb$Treatment, levels = c("BAYER 16 (SOIL) WW", "CONTROL WW", "CONTROL DDD"), order = TRUE)


dim(rowmean_macaw_sb)  #45,31

```

##Boxplot change over time
###flagmean_macaw with new corrected shapefile
```{r}
#change orders of the 
flagmean_macaw$Treatment <- factor(flagmean_macaw$Treatment, levels = c("BAYER 16 (SOIL) WW", "CONTROL WW", "CONTROL DDD"), order = TRUE)


#dotplot 
ggplot(subset(flagmean_macaw,Date!="2019-05-31"), aes(x = Date, y =  pri, fill=Treatment))+ geom_dotplot(binaxis = 'y', stackdir = 'center', position = position_dodge(0.75))
ggplot(subset(flagmean_macaw, Date == "2019-08-15"), aes(x = as.factor(Row), y  = pri, color = Treatment)) + geom_point()+theme_bw()+scale_color_tableau() + xlab("Row") + ylab("PRI")
ggplot(subset(rowmean_macaw_sb, Date == "2019-08-15"), aes(x = as.factor(Row), y  = pri, color = Treatment)) + geom_point()+theme_bw()+scale_color_tableau() + xlab("Row") + ylab("PRI")
ggplot(subset(rowmean_macaw_sb, Date == "2019-08-15"), aes(x = Date, y  = pri, color = Treatment)) + geom_boxplot()+theme_bw()+scale_color_tableau() + xlab("Row") + ylab("PRI")
ggplot(subset(rowmean_macaw_sb, Date == "2019-08-15"), aes(x = Date, y  = ndvi, color = Treatment)) + geom_boxplot()+theme_bw()+scale_color_tableau() + xlab("Row") + ylab("NDVI")


#boxplot
ggplot(flagmean_macaw, aes(x = Date, y =  pri, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("PRI") + scale_fill_tableau() + ggtitle("PRI Plant Average")
ggplot(flagmean_macaw, aes(x = Date, y =  ndvi, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("NDVI") + scale_fill_tableau() + ggtitle("NDVI Plant Average")
ggplot(flagmean_macaw, aes(x = Date, y =  wi, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("WI") + scale_fill_tableau() + ggtitle("WI Plant Average")
ggplot(flagmean_macaw, aes(x = Date, y =  wi.ndvi, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("WI/NDVI") + scale_fill_tableau() + ggtitle("WI/NDVI Plant Average")
ggplot(flagmean_macaw, aes(x = Date, y =  tcari.osavi, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("TCARI/OSAVI") + scale_fill_tableau() + ggtitle("TCARI/OSAVI Plant Average")
ggplot(flagmean_macaw, aes(x = Date, y =  tcari, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("TCARI") + scale_fill_tableau() + ggtitle("TCARI Plant Average")
ggplot(flagmean_macaw, aes(x = Date, y =  prinorm, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("PRInorm") + scale_fill_tableau() + ggtitle("PRInorm Plant Average")  #this looks the best so far 
ggplot(flagmean_macaw, aes(x = Date, y =  pri550, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("PRI550") + scale_fill_tableau() + ggtitle("PRI550 Plant Average")  
ggplot(flagmean_macaw, aes(x = Date, y =  prinorm550, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("PRInorm550") + scale_fill_tableau() + ggtitle("PRInorm550 Plant Average")  
ggplot(flagmean_macaw, aes(x = Date, y =  rer, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("RER") + scale_fill_tableau() + ggtitle("RER Plant Average")  
ggplot(flagmean_macaw, aes(x = Date, y =  rdvi, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("RDVI") + scale_fill_tableau() + ggtitle("RDVI Plant Average")  
ggplot(flagmean_macaw, aes(x = Date, y =  pri/ndvi, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("PRI/NDVI") + scale_fill_tableau() + ggtitle("PRI/NDVI Plant Average")  
ggplot(flagmean_macaw, aes(x = Date, y =  pri/rdvi, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("PRI/RDVI") + scale_fill_tableau() + ggtitle("PRI/RDVI Plant Average")  
ggplot(flagmean_macaw, aes(x = Date, y =  pri/ndvi/tcari.osavi, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("PRI/NDVI/TCARI.OSAVI") + scale_fill_tableau() + ggtitle("PRI/NDVI/TCARI.OSAVI Plant Average")  

#all the band
ggplot(flagmean_macaw, aes(x = Date, y =  X970, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("Band 970") + scale_fill_tableau() + ggtitle("Band 970 Plant Average")  
ggplot(flagmean_macaw, aes(x = Date, y =  X900, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("Band 900") + scale_fill_tableau() + ggtitle("Band 900 Plant Average")  
ggplot(flagmean_macaw, aes(x = Date, y =  X740, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("Band 740") + scale_fill_tableau() + ggtitle("Band 740 Plant Average")  
ggplot(flagmean_macaw, aes(x = Date, y =  X720, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("Band 720") + scale_fill_tableau() + ggtitle("Band 720 Plant Average")  
ggplot(flagmean_macaw, aes(x = Date, y =  X700, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("Band 700") + scale_fill_tableau() + ggtitle("Band 700 Plant Average")  
ggplot(flagmean_macaw, aes(x = Date, y =  X670, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("Band 670") + scale_fill_tableau() + ggtitle("Band 670 Plant Average")  
ggplot(flagmean_macaw, aes(x = Date, y =  X570, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("Band 570") + scale_fill_tableau() + ggtitle("Band 570 Plant Average")  
ggplot(flagmean_macaw, aes(x = Date, y =  X550, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("Band 550") + scale_fill_tableau() + ggtitle("Band 550 Plant Average")  
ggplot(flagmean_macaw, aes(x = Date, y =  X530, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("Band 530") + scale_fill_tableau() + ggtitle("Band 530 Plant Average")  
ggplot(flagmean_macaw, aes(x = Date, y =  X480, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("Band 480") + scale_fill_tableau() + ggtitle("Band 480 Plant Average")  
ggplot(flagmean_macaw, aes(x = Date, y =  X450, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("Band 450") + scale_fill_tableau() + ggtitle("Band 450 Plant Average")  
ggplot(flagmean_macaw, aes(x = Date, y =  X800, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("Band 800") + scale_fill_tableau() + ggtitle("Band 800 Plant Average")  

```

###rowmean_macaw
```{r}
ggplot(rowmean_macaw_sb, aes(x = Date, y =  pri, fill=Treatment))+ geom_dotplot(binaxis = 'y', stackdir = 'center', position = position_dodge(0.6))
ggplot(rowmean_macaw_sb, aes(x = Date, y =  prinorm, fill=Treatment))+ geom_dotplot(binaxis = 'y', stackdir = 'center', position = position_dodge(0.6))

ggplot(rowmean_macaw_sb, aes(x = Date, y =  ndvi, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("NDVI") + scale_fill_tableau() + ggtitle("NDVI Row Average")

#how the indices change over time
ggplot(rowmean_macaw_sb, aes(x = Date, y =  pri, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("PRI") + scale_fill_tableau() + ggtitle("PRI Row Average")
ggplot(rowmean_macaw_sb, aes(x = Date, y =  ndvi, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("NDVI") + scale_fill_tableau() + ggtitle("NDVI Row Average")
ggplot(rowmean_macaw_sb, aes(x = Date, y =  wi, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("WI") + scale_fill_tableau() + ggtitle("WI Row Average")
ggplot(rowmean_macaw_sb, aes(x = Date, y =  wi.ndvi, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("WI/NDVI") + scale_fill_tableau() + ggtitle("WI/NDVI Row Average")
ggplot(rowmean_macaw_sb, aes(x = Date, y =  tcari.osavi, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("TCARI/OSAVI") + scale_fill_tableau() + ggtitle("TCARI/OSAVI Row Average")
ggplot(rowmean_macaw_sb, aes(x = Date, y =  tcari, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("TCARI") + scale_fill_tableau() + ggtitle("TCARI Row Average")
ggplot(rowmean_macaw_sb, aes(x = Date, y =  prinorm, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("PRInorm") + scale_fill_tableau() + ggtitle("PRInorm Row Average")  #this looks the best so far 
ggplot(rowmean_macaw_sb, aes(x = Date, y =  pri550, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("PRI550") + scale_fill_tableau() + ggtitle("PRI550 Row Average")  
ggplot(rowmean_macaw_sb, aes(x = Date, y =  prinorm550, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("PRInorm550") + scale_fill_tableau() + ggtitle("PRInorm550 Row Average")  
ggplot(rowmean_macaw_sb, aes(x = Date, y =  rer, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("RER") + scale_fill_tableau() + ggtitle("RER Row Average")  
ggplot(rowmean_macaw_sb, aes(x = Date, y =  rdvi, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("RDVI") + scale_fill_tableau() + ggtitle("RDVI Row Average")  
ggplot(rowmean_macaw_sb, aes(x = Date, y =  pri/ndvi, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("PRI/NDVI") + scale_fill_tableau() + ggtitle("PRI/NDVI Row Average")  
ggplot(rowmean_macaw_sb, aes(x = Date, y =  pri/rdvi, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("PRI/RDVI") + scale_fill_tableau() + ggtitle("PRI/RDVI Row Average")  
ggplot(rowmean_macaw_sb, aes(x = Date, y =  pri/ndvi/tcari.osavi, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("PRI/NDVI/TCARI.OSAVI") + scale_fill_tableau() + ggtitle("PRI/NDVI/TCARI.OSAVI Row Average")  

#all the band
ggplot(rowmean_macaw_sb, aes(x = Date, y =  X970, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("Band 970") + scale_fill_tableau() + ggtitle("Band 970 Row Average")  
ggplot(rowmean_macaw_sb, aes(x = Date, y =  X900, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("Band 900") + scale_fill_tableau() + ggtitle("Band 900 Row Average")  
ggplot(rowmean_macaw_sb, aes(x = Date, y =  X740, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("Band 740") + scale_fill_tableau() + ggtitle("Band 740 Row Average")  
ggplot(rowmean_macaw_sb, aes(x = Date, y =  X720, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("Band 720") + scale_fill_tableau() + ggtitle("Band 720 Row Average")  
ggplot(rowmean_macaw_sb, aes(x = Date, y =  X700, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("Band 700") + scale_fill_tableau() + ggtitle("Band 700 Row Average")  
ggplot(rowmean_macaw_sb, aes(x = Date, y =  X670, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("Band 670") + scale_fill_tableau() + ggtitle("Band 670 Row Average")  
ggplot(rowmean_macaw_sb, aes(x = Date, y =  X570, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("Band 570") + scale_fill_tableau() + ggtitle("Band 570 Row Average")  
ggplot(rowmean_macaw_sb, aes(x = Date, y =  X550, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("Band 550") + scale_fill_tableau() + ggtitle("Band 550 Row Average")  
ggplot(rowmean_macaw_sb, aes(x = Date, y =  X530, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("Band 530") + scale_fill_tableau() + ggtitle("Band 530 Row Average")  
ggplot(rowmean_macaw_sb, aes(x = Date, y =  X480, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("Band 480") + scale_fill_tableau() + ggtitle("Band 480 Row Average")  
ggplot(rowmean_macaw_sb, aes(x = Date, y =  X450, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("Band 450") + scale_fill_tableau() + ggtitle("Band 450 Row Average")  
ggplot(rowmean_macaw_sb, aes(x = Date, y =  X800, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("Band 800") + scale_fill_tableau() + ggtitle("Band 800 Row Average")  




#ggplot(flagmean_macaw_exgexrmask_phys, aes(x = as.factor(Date), y = wi, fill = Treatment2)) + geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("WI") + scale_fill_tableau() + ggtitle("WI")

```
###rowmean_macaw_1ft
```{r}
#how the indices change over time
ggplot(rowmean_macaw_1ft_sb, aes(x = Date, y =  pri, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("PRI") + scale_fill_tableau() + ggtitle("PRI 1ft Row Average")
ggplot(rowmean_macaw_1ft_sb, aes(x = Date, y =  ndvi, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("NDVI") + scale_fill_tableau() + ggtitle("NDVI 1ft Row Average")
ggplot(rowmean_macaw_1ft_sb, aes(x = Date, y =  wi, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("WI") + scale_fill_tableau() + ggtitle("WI 1ft Row Average")
ggplot(rowmean_macaw_1ft_sb, aes(x = Date, y =  wi.ndvi, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("WI/NDVI") + scale_fill_tableau() + ggtitle("WI/NDVI 1ft Row Average")
ggplot(rowmean_macaw_1ft_sb, aes(x = Date, y =  tcari.osavi, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("TCARI/OSAVI") + scale_fill_tableau() + ggtitle("TCARI/OSAVI 1ft Row Average")
ggplot(rowmean_macaw_1ft_sb, aes(x = Date, y =  tcari, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("TCARI") + scale_fill_tableau() + ggtitle("TCARI 1ft Row Average")
ggplot(rowmean_macaw_1ft_sb, aes(x = Date, y =  prinorm, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("PRInorm") + scale_fill_tableau() + ggtitle("PRInorm 1ft Row Average")  #this looks the best so far 
ggplot(rowmean_macaw_1ft_sb, aes(x = Date, y =  pri550, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("PRI550") + scale_fill_tableau() + ggtitle("PRI550 1ft Row Average")  
ggplot(rowmean_macaw_1ft_sb, aes(x = Date, y =  prinorm550, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("PRInorm550") + scale_fill_tableau() + ggtitle("PRInorm550 1ft Row Average")  
ggplot(rowmean_macaw_1ft_sb, aes(x = Date, y =  rer, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("RER") + scale_fill_tableau() + ggtitle("RER 1ft Row Average")  
ggplot(rowmean_macaw_1ft_sb, aes(x = Date, y =  rdvi, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("RDVI") + scale_fill_tableau() + ggtitle("RDVI 1ft Row Average")  
ggplot(rowmean_macaw_1ft_sb, aes(x = Date, y =  pri/ndvi, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("PRI/NDVI") + scale_fill_tableau() + ggtitle("PRI/NDVI 1ft Row Average")  
ggplot(rowmean_macaw_1ft_sb, aes(x = Date, y =  pri/rdvi, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("PRI/RDVI") + scale_fill_tableau() + ggtitle("PRI/RDVI 1ft Row Average")  
ggplot(rowmean_macaw_1ft_sb, aes(x = Date, y =  pri/ndvi/tcari.osavi, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("PRI/NDVI/TCARI.OSAVI") + scale_fill_tableau() + ggtitle("PRI/NDVI/TCARI.OSAVI 1ft Row Average")  

#all the band
ggplot(rowmean_macaw_1ft_sb, aes(x = Date, y =  X970, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("Band 970") + scale_fill_tableau() + ggtitle("Band 970 1ft Row Average")  
ggplot(rowmean_macaw_1ft_sb, aes(x = Date, y =  X900, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("Band 900") + scale_fill_tableau() + ggtitle("Band 900 1ft Row Average")  
ggplot(rowmean_macaw_1ft_sb, aes(x = Date, y =  X740, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("Band 740") + scale_fill_tableau() + ggtitle("Band 740 1ft Row Average")  
ggplot(rowmean_macaw_1ft_sb, aes(x = Date, y =  X720, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("Band 720") + scale_fill_tableau() + ggtitle("Band 720 1ft Row Average")  
ggplot(rowmean_macaw_1ft_sb, aes(x = Date, y =  X700, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("Band 700") + scale_fill_tableau() + ggtitle("Band 700 1ft Row Average")  
ggplot(rowmean_macaw_1ft_sb, aes(x = Date, y =  X670, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("Band 670") + scale_fill_tableau() + ggtitle("Band 670 1ft Row Average")  
ggplot(rowmean_macaw_1ft_sb, aes(x = Date, y =  X570, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("Band 570") + scale_fill_tableau() + ggtitle("Band 570 1ft Row Average")  
ggplot(rowmean_macaw_1ft_sb, aes(x = Date, y =  X550, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("Band 550") + scale_fill_tableau() + ggtitle("Band 550 1ft Row Average")  
ggplot(rowmean_macaw_1ft_sb, aes(x = Date, y =  X530, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("Band 530") + scale_fill_tableau() + ggtitle("Band 530 1ft Row Average")  
ggplot(rowmean_macaw_1ft_sb, aes(x = Date, y =  X480, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("Band 480") + scale_fill_tableau() + ggtitle("Band 480 1ft Row Average")  
ggplot(rowmean_macaw_1ft_sb, aes(x = Date, y =  X450, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("Band 450") + scale_fill_tableau() + ggtitle("Band 450 1ft Row Average")  
ggplot(rowmean_macaw_1ft_sb, aes(x = Date, y =  X800, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("Band 800") + scale_fill_tableau() + ggtitle("Band 800 1ft Row Average")  

```
###rowmean_macaw_2ft
```{r}
#how the indices change over time
ggplot(rowmean_macaw_2ft_sb, aes(x = Date, y =  pri, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("PRI") + scale_fill_tableau() + ggtitle("PRI 2ft Row Average")
ggplot(rowmean_macaw_2ft_sb, aes(x = Date, y =  ndvi, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("NDVI") + scale_fill_tableau() + ggtitle("NDVI 2ft Row Average")
ggplot(rowmean_macaw_2ft_sb, aes(x = Date, y =  wi, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("WI") + scale_fill_tableau() + ggtitle("WI 2ft Row Average")
ggplot(rowmean_macaw_2ft_sb, aes(x = Date, y =  wi.ndvi, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("WI/NDVI") + scale_fill_tableau() + ggtitle("WI/NDVI 2ft Row Average")
ggplot(rowmean_macaw_2ft_sb, aes(x = Date, y =  tcari.osavi, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("TCARI/OSAVI") + scale_fill_tableau() + ggtitle("TCARI/OSAVI 2ft Row Average")
ggplot(rowmean_macaw_2ft_sb, aes(x = Date, y =  tcari, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("TCARI") + scale_fill_tableau() + ggtitle("TCARI 2ft Row Average")
ggplot(rowmean_macaw_2ft_sb, aes(x = Date, y =  prinorm, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("PRInorm") + scale_fill_tableau() + ggtitle("PRInorm 2ft Row Average")  #this looks the best so far 
ggplot(rowmean_macaw_2ft_sb, aes(x = Date, y =  pri550, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("PRI550") + scale_fill_tableau() + ggtitle("PRI550 2ft Row Average")  
ggplot(rowmean_macaw_2ft_sb, aes(x = Date, y =  prinorm550, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("PRInorm550") + scale_fill_tableau() + ggtitle("PRInorm550 2ft Row Average")  
ggplot(rowmean_macaw_2ft_sb, aes(x = Date, y =  rer, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("RER") + scale_fill_tableau() + ggtitle("RER 2ft Row Average")  
ggplot(rowmean_macaw_2ft_sb, aes(x = Date, y =  rdvi, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("RDVI") + scale_fill_tableau() + ggtitle("RDVI 2ft Row Average")  
ggplot(rowmean_macaw_2ft_sb, aes(x = Date, y =  pri/ndvi, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("PRI/NDVI") + scale_fill_tableau() + ggtitle("PRI/NDVI 2ft Row Average")  
ggplot(rowmean_macaw_2ft_sb, aes(x = Date, y =  pri/rdvi, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("PRI/RDVI") + scale_fill_tableau() + ggtitle("PRI/RDVI 2ft Row Average")  
ggplot(rowmean_macaw_2ft_sb, aes(x = Date, y =  pri/ndvi/tcari.osavi, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("PRI/NDVI/TCARI.OSAVI") + scale_fill_tableau() + ggtitle("PRI/NDVI/TCARI.OSAVI 2ft Row Average")  

#all the band
ggplot(rowmean_macaw_2ft_sb, aes(x = Date, y =  X970, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("Band 970") + scale_fill_tableau() + ggtitle("Band 970 2ft Row Average")  
ggplot(rowmean_macaw_2ft_sb, aes(x = Date, y =  X900, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("Band 900") + scale_fill_tableau() + ggtitle("Band 900 2ft Row Average")  
ggplot(rowmean_macaw_2ft_sb, aes(x = Date, y =  X740, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("Band 740") + scale_fill_tableau() + ggtitle("Band 740 2ft Row Average")  
ggplot(rowmean_macaw_2ft_sb, aes(x = Date, y =  X720, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("Band 720") + scale_fill_tableau() + ggtitle("Band 720 2ft Row Average")  
ggplot(rowmean_macaw_2ft_sb, aes(x = Date, y =  X700, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("Band 700") + scale_fill_tableau() + ggtitle("Band 700 2ft Row Average")  
ggplot(rowmean_macaw_2ft_sb, aes(x = Date, y =  X670, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("Band 670") + scale_fill_tableau() + ggtitle("Band 670 2ft Row Average")  
ggplot(rowmean_macaw_2ft_sb, aes(x = Date, y =  X570, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("Band 570") + scale_fill_tableau() + ggtitle("Band 570 2ft Row Average")  
ggplot(rowmean_macaw_2ft_sb, aes(x = Date, y =  X550, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("Band 550") + scale_fill_tableau() + ggtitle("Band 550 2ft Row Average")  
ggplot(rowmean_macaw_2ft_sb, aes(x = Date, y =  X530, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("Band 530") + scale_fill_tableau() + ggtitle("Band 530 2ft Row Average")  
ggplot(rowmean_macaw_2ft_sb, aes(x = Date, y =  X480, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("Band 480") + scale_fill_tableau() + ggtitle("Band 480 2ft Row Average")  
ggplot(rowmean_macaw_2ft_sb, aes(x = Date, y =  X450, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("Band 450") + scale_fill_tableau() + ggtitle("Band 450 2ft Row Average")  
ggplot(rowmean_macaw_2ft_sb, aes(x = Date, y =  X800, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("Band 800") + scale_fill_tableau() + ggtitle("Band 800 2ft Row Average")  

```
###rowmean_macaw_3ft
```{r}
#how the indices change over time
ggplot(rowmean_macaw_3ft_sb, aes(x = Date, y =  pri, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("PRI") + scale_fill_tableau() + ggtitle("PRI 3ft Row Average")
ggplot(rowmean_macaw_3ft_sb, aes(x = Date, y =  ndvi, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("NDVI") + scale_fill_tableau() + ggtitle("NDVI 3ft Row Average")
ggplot(rowmean_macaw_3ft_sb, aes(x = Date, y =  wi, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("WI") + scale_fill_tableau() + ggtitle("WI 3ft Row Average")
ggplot(rowmean_macaw_3ft_sb, aes(x = Date, y =  wi.ndvi, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("WI/NDVI") + scale_fill_tableau() + ggtitle("WI/NDVI 3ft Row Average")
ggplot(rowmean_macaw_3ft_sb, aes(x = Date, y =  tcari.osavi, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("TCARI/OSAVI") + scale_fill_tableau() + ggtitle("TCARI/OSAVI 3ft Row Average")
ggplot(rowmean_macaw_3ft_sb, aes(x = Date, y =  tcari, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("TCARI") + scale_fill_tableau() + ggtitle("TCARI 3ft Row Average")
ggplot(rowmean_macaw_3ft_sb, aes(x = Date, y =  prinorm, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("PRInorm") + scale_fill_tableau() + ggtitle("PRInorm 3ft Row Average")  #this looks the best so far 
ggplot(rowmean_macaw_3ft_sb, aes(x = Date, y =  pri550, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("PRI550") + scale_fill_tableau() + ggtitle("PRI550 3ft Row Average")  
ggplot(rowmean_macaw_3ft_sb, aes(x = Date, y =  prinorm550, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("PRInorm550") + scale_fill_tableau() + ggtitle("PRInorm550 3ft Row Average")  
ggplot(rowmean_macaw_3ft_sb, aes(x = Date, y =  rer, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("RER") + scale_fill_tableau() + ggtitle("RER 3ft Row Average")  
ggplot(rowmean_macaw_3ft_sb, aes(x = Date, y =  rdvi, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("RDVI") + scale_fill_tableau() + ggtitle("RDVI 3ft Row Average")  
ggplot(rowmean_macaw_3ft_sb, aes(x = Date, y =  pri/ndvi, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("PRI/NDVI") + scale_fill_tableau() + ggtitle("PRI/NDVI 3ft Row Average")  
ggplot(rowmean_macaw_3ft_sb, aes(x = Date, y =  pri/rdvi, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("PRI/RDVI") + scale_fill_tableau() + ggtitle("PRI/RDVI 3ft Row Average")  
ggplot(rowmean_macaw_3ft_sb, aes(x = Date, y =  pri/ndvi/tcari.osavi, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("PRI/NDVI/TCARI.OSAVI") + scale_fill_tableau() + ggtitle("PRI/NDVI/TCARI.OSAVI 3ft Row Average")  

#all the band
ggplot(rowmean_macaw_3ft_sb, aes(x = Date, y =  X970, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("Band 970") + scale_fill_tableau() + ggtitle("Band 970 3ft Row Average")  
ggplot(rowmean_macaw_3ft_sb, aes(x = Date, y =  X900, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("Band 900") + scale_fill_tableau() + ggtitle("Band 900 3ft Row Average")  
ggplot(rowmean_macaw_3ft_sb, aes(x = Date, y =  X740, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("Band 740") + scale_fill_tableau() + ggtitle("Band 740 3ft Row Average")  
ggplot(rowmean_macaw_3ft_sb, aes(x = Date, y =  X720, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("Band 720") + scale_fill_tableau() + ggtitle("Band 720 3ft Row Average")  
ggplot(rowmean_macaw_3ft_sb, aes(x = Date, y =  X700, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("Band 700") + scale_fill_tableau() + ggtitle("Band 700 3ft Row Average")  
ggplot(rowmean_macaw_3ft_sb, aes(x = Date, y =  X670, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("Band 670") + scale_fill_tableau() + ggtitle("Band 670 3ft Row Average")  
ggplot(rowmean_macaw_3ft_sb, aes(x = Date, y =  X570, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("Band 570") + scale_fill_tableau() + ggtitle("Band 570 3ft Row Average")  
ggplot(rowmean_macaw_3ft_sb, aes(x = Date, y =  X550, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("Band 550") + scale_fill_tableau() + ggtitle("Band 550 3ft Row Average")  
ggplot(rowmean_macaw_3ft_sb, aes(x = Date, y =  X530, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("Band 530") + scale_fill_tableau() + ggtitle("Band 530 3ft Row Average")  
ggplot(rowmean_macaw_3ft_sb, aes(x = Date, y =  X480, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("Band 480") + scale_fill_tableau() + ggtitle("Band 480 3ft Row Average")  
ggplot(rowmean_macaw_3ft_sb, aes(x = Date, y =  X450, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("Band 450") + scale_fill_tableau() + ggtitle("Band 450 3ft Row Average")  
ggplot(rowmean_macaw_3ft_sb, aes(x = Date, y =  X800, fill=Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("Band 800") + scale_fill_tableau() + ggtitle("Band 800 3ft Row Average")  

```
##Combine with SWP
```{r}
rowmean_macaw_swp <- base::merge(rowmean_macaw, rowflagmean_swp, by = c("Block","Treatment","Date"))

names(rowflagmean_swp)
names(rowmean_macaw) 
```
#--------------------------------------------------
#Get rid of the Control WW group
##Flagmean 
###SWP
```{r}
names(flagmean_macaw)

unique(swp_PL$Block)
unique(flagmean_macaw$Block)
unique(swp_PL$Treatment)
unique(flagmean_macaw$Treatment)
unique(flagmean_macaw$Date)
unique(swp_PL$Date)
flagmean_macaw_swp <- base::merge(flagmean_macaw, swp_PL, by = c("Block","Treatment","Plant","Date"))
dim(flagmean_macaw_swp)  #330, 35
dim(flagmean_macaw)  #360, 33
dim(swp_PL)  #1070, 6
dim(subset(swp_PL, Date=="2019-06-28")) #120,6
dim(subset(swp_PL, Date=="2019-08-02")) #160,6
dim(subset(swp_PL, Date=="2019-08-15")) #150,6

names(flagmean_macaw_swp)

flagmean_macaw_swp$Treatment2 = flagmean_macaw_swp$Treatment
for(i in 1:nrow(flagmean_macaw_swp)){
  if(flagmean_macaw_swp[i,]$Treatment2 == "CONTROL DDD"){
    flagmean_macaw_swp[i,]$Treatment2 = "35% ET"
  }
  if(flagmean_macaw_swp[i,]$Treatment2 == "CONTROL WW"){
    flagmean_macaw_swp[i,]$Treatment2 = "70% ET"
  }
  if(flagmean_macaw_swp[i,]$Treatment2 == "BAYER 16 (SOIL) WW"){
    flagmean_macaw_swp[i,]$Treatment2 = "100% ET"
  }
}

#get rid of control ww group 
flagmean_macaw_swp_sb <- subset(flagmean_macaw_swp, Treatment != "CONTROL WW")
#flagmean_macaw_swp_sb$Treatment2 <- flagmean_macaw_swp_sb$Treatment
#flagmean_macaw_swp_sb$Treatment2

ggplot(subset(flagmean_macaw_swp, Treatment != "CONTROL WW" & Date == "2019-08-15"), aes(x = pri, y = -SWP, col = as.factor(Treatment))) + geom_point() #+ facet_wrap(~Date, nrow = 3, scales  = "free")
```
####Plots
```{r}
#Two Treatments
#PRI boxplot
##PRI per plant
ggplot(flagmean_macaw_swp_sb, aes(x = as.factor(Date), y = pri, fill = Treatment2))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("PRI") + scale_fill_tableau() + ggtitle("PRI Per Plant") 
##PRInorm per plant
ggplot(flagmean_macaw_swp_sb, aes(x = as.factor(Date), y = prinorm, fill = Treatment2))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("PRInorm") + scale_fill_tableau() + ggtitle("PRInorm Per Plant") 
#SWP boxplot
ggplot(flagmean_macaw_swp_sb, aes(x = as.factor(Date), y = -SWP, fill = Treatment2))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("SWP (Bars)") + scale_fill_tableau() + ggtitle("SWP Per Plant") 
#PRI vs SWP
ggplot(flagmean_macaw_swp_sb, aes(x = prinorm, y = -SWP)) + geom_point(aes(shape = as.factor(Date))) + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("PRInorm") + ylab("SWP (Bars)")  + ggtitle("SWP vs PRInorm") + geom_smooth(method = "lm", se = FALSE)+ scale_shape_discrete(name = "Date") #+ theme(legend.title = element_text("Date"))# + facet_wrap(~Date, nrow = 3, scales = "free")
ggplot(flagmean_macaw_swp_sb, aes(x = pri, y = -SWP)) + geom_point(aes(shape = as.factor(Date))) + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("PRI") + ylab("SWP (Bars)") + scale_fill_tableau() + ggtitle("SWP vs PRI") + geom_smooth(method = "lm", se = FALSE)+ scale_shape_discrete(name = "Date") #+ theme(legend.title = element_text("Date"))# + facet_wrap(~Date, nrow = 3, scales = "free")
ggplot(subset(flagmean_macaw_swp_sb, Date == "2019-08-15"), aes(x = pri, y = -SWP)) + geom_point(aes(shape = as.factor(Date))) + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("PRI") + ylab("SWP (Bars)") + scale_fill_tableau() + ggtitle("SWP vs PRI") + geom_smooth(method = "lm", se = FALSE)+ labs(fill = "Date") #+ theme(legend.title = element_text("Date"))# + facet_wrap(~Date, nrow = 3, scales = "free")



#Three Treatments
#PRI boxplot
##PRI per plant
ggplot(flagmean_macaw_swp, aes(x = as.factor(Date), y = pri, fill = Treatment2))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("PRI") + scale_fill_tableau() + ggtitle("PRI Per Plant") 
##PRInorm per plant
ggplot(flagmean_macaw_swp, aes(x = as.factor(Date), y = prinorm, fill = Treatment2))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("PRInorm") + scale_fill_tableau() + ggtitle("PRInorm Per Plant") 
#SWP boxplot
ggplot(flagmean_macaw_swp, aes(x = as.factor(Date), y = -SWP, fill = Treatment2))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("SWP (Bars)") + scale_fill_tableau() + ggtitle("SWP Per Plant") 
#PRI vs SWP
ggplot(flagmean_macaw_swp, aes(x = prinorm, y = -SWP)) + geom_point(aes(shape = as.factor(Date))) + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("PRInorm") + ylab("SWP (Bars)")  + ggtitle("SWP vs PRInorm") + geom_smooth(method = "lm", se = FALSE)+ scale_shape_discrete(name = "Date") #+ theme(legend.title = element_text("Date"))# + facet_wrap(~Date, nrow = 3, scales = "free")
ggplot(flagmean_macaw_swp, aes(x = pri, y = -SWP)) + geom_point(aes(shape = as.factor(Date))) + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("PRI") + ylab("SWP (Bars)") + scale_fill_tableau() + ggtitle("SWP vs PRI") + geom_smooth(method = "lm", se = FALSE)+ scale_shape_discrete(name = "Date") #+ theme(legend.title = element_text("Date"))# + facet_wrap(~Date, nrow = 3, scales = "free")
ggplot(subset(flagmean_macaw_swp, Date == "2019-08-15"), aes(x = pri, y = -SWP)) + geom_point(aes(shape = as.factor(Date))) + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("PRI") + ylab("SWP (Bars)") + scale_fill_tableau() + ggtitle("SWP vs PRI") + geom_smooth(method = "lm", se = FALSE)+ labs(fill = "Date") #+ theme(legend.title = element_text("Date"))# + facet_wrap(~Date, nrow = 3, scales = "free")



##PRInorm
p1 = ggplot(subset(flagmean_macaw_swp_sb, Date == "2019-06-28"), aes(x = prinorm, y = -SWP)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("PRInorm") + ylab(expression(paste(Psi["stem"]," (Bars)"))) + scale_fill_tableau() + ggtitle("06-28") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
p2 = ggplot(subset(flagmean_macaw_swp_sb, Date == "2019-08-02"), aes(x = prinorm, y = -SWP)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("PRInorm") + ylab(expression(paste(Psi["stem"]," (Bars)"))) + scale_fill_tableau() + ggtitle("08-02") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
p3 = ggplot(subset(flagmean_macaw_swp_sb, Date == "2019-08-15"), aes(x = prinorm, y = -SWP)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("PRInorm") + ylab(expression(paste(Psi["stem"]," (Bars)"))) + scale_fill_tableau() + ggtitle("08-15") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
p4 = ggplot(subset(flagmean_macaw_swp_sb), aes(x = prinorm, y = -SWP)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("PRInorm") + ylab(expression(paste(Psi["stem"]," (Bars)"))) + scale_fill_tableau() + ggtitle("06-28 + 08-02 + 08-15") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
ggarrange(p1,p2,p3,p4, nrow = 2, ncol = 2)
##PRI
p1 = ggplot(subset(flagmean_macaw_swp_sb, Date == "2019-06-28"), aes(x = pri, y = -SWP)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("PRI") + ylab(expression(paste(Psi["stem"]," (Bars)"))) + scale_fill_tableau() + ggtitle("06-28") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
p2 = ggplot(subset(flagmean_macaw_swp_sb, Date == "2019-08-02"), aes(x = pri, y = -SWP)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("PRI") + ylab(expression(paste(Psi["stem"]," (Bars)"))) + scale_fill_tableau() + ggtitle("08-02") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
p3 = ggplot(subset(flagmean_macaw_swp_sb, Date == "2019-08-15"), aes(x = pri, y = -SWP)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("PRI") + ylab(expression(paste(Psi["stem"]," (Bars)"))) + scale_fill_tableau() + ggtitle("08-15") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
p4 = ggplot(subset(flagmean_macaw_swp_sb), aes(x = pri, y = -SWP)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("PRI") + ylab(expression(paste(Psi["stem"]," (Bars)"))) + scale_fill_tableau() + ggtitle("06-28 + 08-02 + 08-15") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
ggarrange(p1,p2,p3,p4, nrow = 2, ncol = 2)
##NDVI
p1 = ggplot(subset(flagmean_macaw_swp_sb, Date == "2019-06-28"), aes(x = ndvi, y = -SWP)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("NDVI") + ylab(expression(paste(Psi["stem"]," (Bars)"))) + scale_fill_tableau() + ggtitle("06-28") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
p2 = ggplot(subset(flagmean_macaw_swp_sb, Date == "2019-08-02"), aes(x = ndvi, y = -SWP)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("NDVI") + ylab(expression(paste(Psi["stem"]," (Bars)"))) + scale_fill_tableau() + ggtitle("08-02") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
p3 = ggplot(subset(flagmean_macaw_swp_sb, Date == "2019-08-15"), aes(x = ndvi, y = -SWP)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("NDVI") + ylab(expression(paste(Psi["stem"]," (Bars)"))) + scale_fill_tableau() + ggtitle("08-15") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
p4 = ggplot(subset(flagmean_macaw_swp_sb), aes(x = ndvi, y = -SWP)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("NDVI") + ylab(expression(paste(Psi["stem"]," (Bars)"))) + scale_fill_tableau() + ggtitle("06-28 + 08-02 + 08-15") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
ggarrange(p1,p2,p3,p4, nrow = 2, ncol = 2)
##RDVI
p1 = ggplot(subset(flagmean_macaw_swp_sb, Date == "2019-06-28"), aes(x = rdvi, y = -SWP)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("RDVI") + ylab(expression(paste(Psi["stem"]," (Bars)"))) + scale_fill_tableau() + ggtitle("06-28") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
p2 = ggplot(subset(flagmean_macaw_swp_sb, Date == "2019-08-02"), aes(x = rdvi, y = -SWP)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("RDVI") + ylab(expression(paste(Psi["stem"]," (Bars)"))) + scale_fill_tableau() + ggtitle("08-02") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
p3 = ggplot(subset(flagmean_macaw_swp_sb, Date == "2019-08-15"), aes(x = rdvi, y = -SWP)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("RDVI") + ylab(expression(paste(Psi["stem"]," (Bars)"))) + scale_fill_tableau() + ggtitle("08-15") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
p4 = ggplot(subset(flagmean_macaw_swp_sb), aes(x = rdvi, y = -SWP)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("RDVI") + ylab(expression(paste(Psi["stem"]," (Bars)"))) + scale_fill_tableau() + ggtitle("06-28 + 08-02 + 08-15") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
ggarrange(p1,p2,p3,p4, nrow = 2, ncol = 2)
##RER
p1 = ggplot(subset(flagmean_macaw_swp_sb, Date == "2019-06-28"), aes(x = rer, y = -SWP)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("RER") + ylab(expression(paste(Psi["stem"]," (Bars)"))) + scale_fill_tableau() + ggtitle("06-28") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
p2 = ggplot(subset(flagmean_macaw_swp_sb, Date == "2019-08-02"), aes(x = rer, y = -SWP)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("RER") + ylab(expression(paste(Psi["stem"]," (Bars)"))) + scale_fill_tableau() + ggtitle("08-02") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
p3 = ggplot(subset(flagmean_macaw_swp_sb, Date == "2019-08-15"), aes(x = rer, y = -SWP)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("RER") + ylab(expression(paste(Psi["stem"]," (Bars)"))) + scale_fill_tableau() + ggtitle("08-15") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
p4 = ggplot(subset(flagmean_macaw_swp_sb), aes(x = rer, y = -SWP)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("RER") + ylab(expression(paste(Psi["stem"]," (Bars)"))) + scale_fill_tableau() + ggtitle("06-28 + 08-02 + 08-15") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
ggarrange(p1,p2,p3,p4, nrow = 2, ncol = 2)
#TCARI
p1 = ggplot(subset(flagmean_macaw_swp_sb, Date == "2019-06-28"), aes(x = tcari, y = -SWP)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("TCARI") + ylab(expression(paste(Psi["stem"]," (Bars)"))) + scale_fill_tableau() + ggtitle("06-28") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
p2 = ggplot(subset(flagmean_macaw_swp_sb, Date == "2019-08-02"), aes(x = tcari, y = -SWP)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("TCARI") + ylab(expression(paste(Psi["stem"]," (Bars)"))) + scale_fill_tableau() + ggtitle("08-02") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
p3 = ggplot(subset(flagmean_macaw_swp_sb, Date == "2019-08-15"), aes(x = tcari, y = -SWP)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("TCARI") + ylab(expression(paste(Psi["stem"]," (Bars)"))) + scale_fill_tableau() + ggtitle("08-15") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
p4 = ggplot(subset(flagmean_macaw_swp_sb), aes(x = tcari, y = -SWP)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("TCARI") + ylab(expression(paste(Psi["stem"]," (Bars)"))) + scale_fill_tableau() + ggtitle("06-28 + 08-02 + 08-15") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
ggarrange(p1,p2,p3,p4, nrow = 2, ncol = 2)
#WI
p1 = ggplot(subset(flagmean_macaw_swp_sb, Date == "2019-06-28"), aes(x = wi, y = -SWP)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("WI") + ylab(expression(paste(Psi["stem"]," (Bars)"))) + scale_fill_tableau() + ggtitle("06-28") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
p2 = ggplot(subset(flagmean_macaw_swp_sb, Date == "2019-08-02"), aes(x = wi, y = -SWP)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("WI") + ylab(expression(paste(Psi["stem"]," (Bars)"))) + scale_fill_tableau() + ggtitle("08-02") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
p3 = ggplot(subset(flagmean_macaw_swp_sb, Date == "2019-08-15"), aes(x = wi, y = -SWP)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("WI") + ylab(expression(paste(Psi["stem"]," (Bars)"))) + scale_fill_tableau() + ggtitle("08-15") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
p4 = ggplot(subset(flagmean_macaw_swp_sb), aes(x = wi, y = -SWP)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("WI") + ylab(expression(paste(Psi["stem"]," (Bars)"))) + scale_fill_tableau() + ggtitle("06-28 + 08-02 + 08-15") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
ggarrange(p1,p2,p3,p4, nrow = 2, ncol = 2)


ggplot(subset(flagmean_macaw_swp_sb), aes(x = rdvi, y = -SWP)) + geom_point(aes(color = as.factor(Date)))+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("RDVI") + ylab(expression(paste(Psi["stem"]," (Bars)"))) + scale_fill_tableau() + ggtitle("06-28 + 08-02 + 08-15") + geom_smooth(method = "lm", se = FALSE) + labs(color = "Date") #+ facet_wrap(~Date, nrow = 3, scales  = "free")
ggplot(subset(flagmean_macaw_swp_sb), aes(x = ndvi, y = -SWP)) + geom_point(aes(color = as.factor(Date)))+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("NDVI") + ylab(expression(paste(Psi["stem"]," (Bars)"))) + scale_fill_tableau() + ggtitle("06-28 + 08-02 + 08-15") + geom_smooth(method = "lm", se = FALSE) + labs(color = "Date")#+ facet_wrap(~Date, nrow = 3, scales  = "free")

```
####Quantitative analysis
#####t-test
```{r}
#three treatments 
lm6 <- lm(SWP~Treatment, data = subset(flagmean_macaw_swp, Date == "2019-06-28")) 
lm6
hsd1 <- HSD.test(lm6, "Treatment", group = TRUE)
hsd1

lm7 <- lm(SWP~Treatment, data = subset(flagmean_macaw_swp, Date == "2019-08-02")) 
lm7
hsd2 <- HSD.test(lm7, "Treatment", group = TRUE)
hsd2

lm8 <- lm(SWP~Treatment, data = subset(flagmean_macaw_swp, Date == "2019-08-15")) 
lm8
hsd3 <- HSD.test(lm8, "Treatment", group = TRUE)
hsd3

#two treatments
lm6 <- lm(SWP~Treatment, data = subset(flagmean_macaw_swp_sb, Date == "2019-06-28")) 
lm6
hsd1 <- HSD.test(lm6, "Treatment", group = TRUE)
hsd1

lm7 <- lm(SWP~Treatment, data = subset(flagmean_macaw_swp_sb, Date == "2019-08-02")) 
lm7
hsd2 <- HSD.test(lm7, "Treatment", group = TRUE)
hsd2

lm8 <- lm(SWP~Treatment, data = subset(flagmean_macaw_swp_sb, Date == "2019-08-15")) 
lm8
hsd3 <- HSD.test(lm8, "Treatment", group = TRUE)
hsd3

```
#####Correlations and linear 
######Two treatments
```{r}
dim(flagmean_macaw_swp_sb) #220,36
dim(subset(flagmean_macaw_swp_sb, Date=="2019-06-28")) #80,36
dim(subset(flagmean_macaw_swp_sb, Date=="2019-08-02")) #80,36
dim(subset(flagmean_macaw_swp_sb, Date=="2019-08-15")) #60,36
#PRI
cor(flagmean_macaw_swp_sb$pri, flagmean_macaw_swp_sb$SWP)^2  #0.453
lm1 <- lm(pri~SWP, data = flagmean_macaw_swp_sb)
summary(lm1)  #***
cor(subset(flagmean_macaw_swp_sb, Date=="2019-06-28")$pri, subset(flagmean_macaw_swp_sb, Date=="2019-06-28")$SWP)^2  #0.0066
lm2 <- lm(pri~SWP, data = subset(flagmean_macaw_swp_sb, Date=="2019-06-28"))
summary(lm2)  #
cor(subset(flagmean_macaw_swp_sb, Date=="2019-08-02")$pri, subset(flagmean_macaw_swp_sb, Date=="2019-08-02")$SWP)^2  #0.0167
lm3 <- lm(pri~SWP, data = subset(flagmean_macaw_swp_sb, Date=="2019-08-02"))
summary(lm3)  #
cor(subset(flagmean_macaw_swp_sb, Date=="2019-08-15")$pri, subset(flagmean_macaw_swp_sb, Date=="2019-08-15")$SWP)^2  #0.3165
lm4 <- lm(pri~SWP, data = subset(flagmean_macaw_swp_sb, Date=="2019-08-15"))
summary(lm4)  #***

#ndvi
cor(flagmean_macaw_swp_sb$ndvi, flagmean_macaw_swp_sb$SWP)^2  #0.304
lm1 <- lm(ndvi~SWP, data = flagmean_macaw_swp_sb)
summary(lm1)  #***
cor(subset(flagmean_macaw_swp_sb, Date=="2019-06-28")$ndvi, subset(flagmean_macaw_swp_sb, Date=="2019-06-28")$SWP)^2  #0.029
lm2 <- lm(ndvi~SWP, data = subset(flagmean_macaw_swp_sb, Date=="2019-06-28"))
summary(lm2)  #
cor(subset(flagmean_macaw_swp_sb, Date=="2019-08-02")$ndvi, subset(flagmean_macaw_swp_sb, Date=="2019-08-02")$SWP)^2  #0.117
lm3 <- lm(ndvi~SWP, data = subset(flagmean_macaw_swp_sb, Date=="2019-08-02"))
summary(lm3)  #**
cor(subset(flagmean_macaw_swp_sb, Date=="2019-08-15")$ndvi, subset(flagmean_macaw_swp_sb, Date=="2019-08-15")$SWP)^2  #0.355
lm4 <- lm(ndvi~SWP, data = subset(flagmean_macaw_swp_sb, Date=="2019-08-15"))
summary(lm4)  #***

#rdvi
cor(flagmean_macaw_swp_sb$rdvi, flagmean_macaw_swp_sb$SWP)^2  #0.182
lm1 <- lm(rdvi~SWP, data = flagmean_macaw_swp_sb)
summary(lm1)  #***
cor(subset(flagmean_macaw_swp_sb, Date=="2019-06-28")$rdvi, subset(flagmean_macaw_swp_sb, Date=="2019-06-28")$SWP)^2  #0.038
lm2 <- lm(rdvi~SWP, data = subset(flagmean_macaw_swp_sb, Date=="2019-06-28"))
summary(lm2)  #.
cor(subset(flagmean_macaw_swp_sb, Date=="2019-08-02")$rdvi, subset(flagmean_macaw_swp_sb, Date=="2019-08-02")$SWP)^2  #0.165
lm3 <- lm(rdvi~SWP, data = subset(flagmean_macaw_swp_sb, Date=="2019-08-02"))
summary(lm3)  #***
cor(subset(flagmean_macaw_swp_sb, Date=="2019-08-15")$rdvi, subset(flagmean_macaw_swp_sb, Date=="2019-08-15")$SWP)^2  #0.4356
lm4 <- lm(rdvi~SWP, data = subset(flagmean_macaw_swp_sb, Date=="2019-08-15"))
summary(lm4)  #***

#tcari
cor(flagmean_macaw_swp_sb$tcari, flagmean_macaw_swp_sb$SWP)^2  #0.286
lm1 <- lm(tcari~SWP, data = flagmean_macaw_swp_sb)
summary(lm1)  #***
cor(subset(flagmean_macaw_swp_sb, Date=="2019-06-28")$tcari, subset(flagmean_macaw_swp_sb, Date=="2019-06-28")$SWP)^2  #0.0156
lm2 <- lm(tcari~SWP, data = subset(flagmean_macaw_swp_sb, Date=="2019-06-28"))
summary(lm2)  #
cor(subset(flagmean_macaw_swp_sb, Date=="2019-08-02")$tcari, subset(flagmean_macaw_swp_sb, Date=="2019-08-02")$SWP)^2  #0.044
lm3 <- lm(tcari~SWP, data = subset(flagmean_macaw_swp_sb, Date=="2019-08-02"))
summary(lm3)  #.
cor(subset(flagmean_macaw_swp_sb, Date=="2019-08-15")$tcari, subset(flagmean_macaw_swp_sb, Date=="2019-08-15")$SWP)^2  #0.0195
lm4 <- lm(tcari~SWP, data = subset(flagmean_macaw_swp_sb, Date=="2019-08-15"))
summary(lm4)  #

#rer
cor(flagmean_macaw_swp_sb$rer, flagmean_macaw_swp_sb$SWP)^2  #0.084
lm1 <- lm(rer~SWP, data = flagmean_macaw_swp_sb)
summary(lm1)  #***
cor(subset(flagmean_macaw_swp_sb, Date=="2019-06-28")$rer, subset(flagmean_macaw_swp_sb, Date=="2019-06-28")$SWP)^2  #0.0176
lm2 <- lm(rer~SWP, data = subset(flagmean_macaw_swp_sb, Date=="2019-06-28"))
summary(lm2)  #
cor(subset(flagmean_macaw_swp_sb, Date=="2019-08-02")$rer, subset(flagmean_macaw_swp_sb, Date=="2019-08-02")$SWP)^2  #0.0478
lm3 <- lm(rer~SWP, data = subset(flagmean_macaw_swp_sb, Date=="2019-08-02"))
summary(lm3)  #.
cor(subset(flagmean_macaw_swp_sb, Date=="2019-08-15")$rer, subset(flagmean_macaw_swp_sb, Date=="2019-08-15")$SWP)^2  #0.2995
lm4 <- lm(rer~SWP, data = subset(flagmean_macaw_swp_sb, Date=="2019-08-15"))
summary(lm4)  #***

#tcari.osavi
cor(flagmean_macaw_swp_sb$tcari.osavi, flagmean_macaw_swp_sb$SWP)^2  #0.286
lm1 <- lm(tcari.osavi~SWP, data = flagmean_macaw_swp_sb)
summary(lm1)  #***
cor(subset(flagmean_macaw_swp_sb, Date=="2019-06-28")$tcari.osavi, subset(flagmean_macaw_swp_sb, Date=="2019-06-28")$SWP)^2  #0.001
lm2 <- lm(tcari.osavi~SWP, data = subset(flagmean_macaw_swp_sb, Date=="2019-06-28"))
summary(lm2)  #
cor(subset(flagmean_macaw_swp_sb, Date=="2019-08-02")$tcari.osavi, subset(flagmean_macaw_swp_sb, Date=="2019-08-02")$SWP)^2  #0.0019
lm3 <- lm(tcari.osavi~SWP, data = subset(flagmean_macaw_swp_sb, Date=="2019-08-02"))
summary(lm3)  #
cor(subset(flagmean_macaw_swp_sb, Date=="2019-08-15")$tcari.osavi, subset(flagmean_macaw_swp_sb, Date=="2019-08-15")$SWP)^2  #0.0421
lm4 <- lm(tcari.osavi~SWP, data = subset(flagmean_macaw_swp_sb, Date=="2019-08-15"))
summary(lm4)  #

#pri550
cor(flagmean_macaw_swp_sb$pri550, flagmean_macaw_swp_sb$SWP)^2  #0.0284
lm1 <- lm(pri550~SWP, data = flagmean_macaw_swp_sb)
summary(lm1)  #*
cor(subset(flagmean_macaw_swp_sb, Date=="2019-06-28")$pri550, subset(flagmean_macaw_swp_sb, Date=="2019-06-28")$SWP)^2  #0.000
lm2 <- lm(pri550~SWP, data = subset(flagmean_macaw_swp_sb, Date=="2019-06-28"))
summary(lm2)  #
cor(subset(flagmean_macaw_swp_sb, Date=="2019-08-02")$pri550, subset(flagmean_macaw_swp_sb, Date=="2019-08-02")$SWP)^2  #0.0202
lm3 <- lm(pri550~SWP, data = subset(flagmean_macaw_swp_sb, Date=="2019-08-02"))
summary(lm3)  #
cor(subset(flagmean_macaw_swp_sb, Date=="2019-08-15")$pri550, subset(flagmean_macaw_swp_sb, Date=="2019-08-15")$SWP)^2  #0.012
lm4 <- lm(pri550~SWP, data = subset(flagmean_macaw_swp_sb, Date=="2019-08-15"))
summary(lm4)  #

#wi
cor(flagmean_macaw_swp_sb$wi, flagmean_macaw_swp_sb$SWP)^2  #0.3325
lm1 <- lm(wi~SWP, data = flagmean_macaw_swp_sb)
summary(lm1)  #***
cor(subset(flagmean_macaw_swp_sb, Date=="2019-06-28")$wi, subset(flagmean_macaw_swp_sb, Date=="2019-06-28")$SWP)^2  #0.052
lm2 <- lm(wi~SWP, data = subset(flagmean_macaw_swp_sb, Date=="2019-06-28"))
summary(lm2)  #*
cor(subset(flagmean_macaw_swp_sb, Date=="2019-08-02")$wi, subset(flagmean_macaw_swp_sb, Date=="2019-08-02")$SWP)^2  #0.0071
lm3 <- lm(wi~SWP, data = subset(flagmean_macaw_swp_sb, Date=="2019-08-02"))
summary(lm3)  #
cor(subset(flagmean_macaw_swp_sb, Date=="2019-08-15")$wi, subset(flagmean_macaw_swp_sb, Date=="2019-08-15")$SWP)^2  #0.0689
lm4 <- lm(wi~SWP, data = subset(flagmean_macaw_swp_sb, Date=="2019-08-15"))
summary(lm4)  #*

#wi.ndvi
cor(flagmean_macaw_swp_sb$wi.ndvi, flagmean_macaw_swp_sb$SWP)^2  #0.121
lm1 <- lm(wi.ndvi~SWP, data = flagmean_macaw_swp_sb)
summary(lm1)  #***
cor(subset(flagmean_macaw_swp_sb, Date=="2019-06-28")$wi.ndvi, subset(flagmean_macaw_swp_sb, Date=="2019-06-28")$SWP)^2  #0.06
lm2 <- lm(wi.ndvi~SWP, data = subset(flagmean_macaw_swp_sb, Date=="2019-06-28"))
summary(lm2)  #*
cor(subset(flagmean_macaw_swp_sb, Date=="2019-08-02")$wi.ndvi, subset(flagmean_macaw_swp_sb, Date=="2019-08-02")$SWP)^2  #0.0466
lm3 <- lm(wi.ndvi~SWP, data = subset(flagmean_macaw_swp_sb, Date=="2019-08-02"))
summary(lm3)  #.
cor(subset(flagmean_macaw_swp_sb, Date=="2019-08-15")$wi.ndvi, subset(flagmean_macaw_swp_sb, Date=="2019-08-15")$SWP)^2  #0.118
lm4 <- lm(wi.ndvi~SWP, data = subset(flagmean_macaw_swp_sb, Date=="2019-08-15"))
summary(lm4)  #**


#PRInorm
cor(flagmean_macaw_swp_sb$prinorm, flagmean_macaw_swp_sb$SWP)^2  #0.402
lm1 <- lm(prinorm~SWP, data = flagmean_macaw_swp_sb)
summary(lm1)  #***
cor(subset(flagmean_macaw_swp_sb, Date=="2019-06-28")$prinorm, subset(flagmean_macaw_swp_sb, Date=="2019-06-28")$SWP)^2  #0.02297
lm2 <- lm(prinorm~SWP, data = subset(flagmean_macaw_swp_sb, Date=="2019-06-28"))
summary(lm2)  #
cor(subset(flagmean_macaw_swp_sb, Date=="2019-08-02")$prinorm, subset(flagmean_macaw_swp_sb, Date=="2019-08-02")$SWP)^2  #0.0698
lm3 <- lm(prinorm~SWP, data = subset(flagmean_macaw_swp_sb, Date=="2019-08-02"))
summary(lm3)  #*
cor(subset(flagmean_macaw_swp_sb, Date=="2019-08-15")$prinorm, subset(flagmean_macaw_swp_sb, Date=="2019-08-15")$SWP)^2  #0.413
lm4 <- lm(prinorm~SWP, data = subset(flagmean_macaw_swp_sb, Date=="2019-08-15"))
summary(lm4)  #***

#PRI/NDVI
cor(flagmean_macaw_swp_sb$pri/flagmean_macaw_swp_sb$ndvi, flagmean_macaw_swp_sb$SWP)^2  #0.470
lm1 <- lm(pri/ndvi~SWP, data = flagmean_macaw_swp_sb)
summary(lm1)  #***
cor(subset(flagmean_macaw_swp_sb, Date=="2019-06-28")$pri/subset(flagmean_macaw_swp_sb, Date=="2019-06-28")$ndvi, subset(flagmean_macaw_swp_sb, Date=="2019-06-28")$SWP)^2  #0.008
lm2 <- lm(pri/ndvi~SWP, data = subset(flagmean_macaw_swp_sb, Date=="2019-06-28"))
summary(lm2)  #
cor(subset(flagmean_macaw_swp_sb, Date=="2019-08-02")$pri/subset(flagmean_macaw_swp_sb, Date=="2019-08-02")$ndvi, subset(flagmean_macaw_swp_sb, Date=="2019-08-02")$SWP)^2  #0.0279
lm3 <- lm(pri/ndvi~SWP, data = subset(flagmean_macaw_swp_sb, Date=="2019-08-02"))
summary(lm3)  #
cor(subset(flagmean_macaw_swp_sb, Date=="2019-08-15")$pri/subset(flagmean_macaw_swp_sb, Date=="2019-08-15")$ndvi, subset(flagmean_macaw_swp_sb, Date=="2019-08-15")$SWP)^2  #0.347
lm4 <- lm(pri/ndvi~SWP, data = subset(flagmean_macaw_swp_sb, Date=="2019-08-15"))
summary(lm4)  #***



#PRI/(ndvi*rer)
cor(flagmean_macaw_swp_sb$pri/flagmean_macaw_swp_sb$ndvi/flagmean_macaw_swp_sb$rer, flagmean_macaw_swp_sb$SWP)^2  #0.480
lm1 <- lm(pri/ndvi/rer~SWP, data = flagmean_macaw_swp_sb)
summary(lm1)  #***
cor(subset(flagmean_macaw_swp_sb, Date=="2019-06-28")$pri/subset(flagmean_macaw_swp_sb, Date=="2019-06-28")$ndvi/subset(flagmean_macaw_swp_sb, Date=="2019-06-28")$rer, subset(flagmean_macaw_swp_sb, Date=="2019-06-28")$SWP)^2  #0.017
lm2 <- lm(pri/ndvi/rer~SWP, data = subset(flagmean_macaw_swp_sb, Date=="2019-06-28"))
summary(lm2)  #
cor(subset(flagmean_macaw_swp_sb, Date=="2019-08-02")$pri/subset(flagmean_macaw_swp_sb, Date=="2019-08-02")$ndvi/subset(flagmean_macaw_swp_sb, Date=="2019-08-02")$rer, subset(flagmean_macaw_swp_sb, Date=="2019-08-02")$SWP)^2  #0.056
lm3 <- lm(pri/ndvi/rer~SWP, data = subset(flagmean_macaw_swp_sb, Date=="2019-08-02"))
summary(lm3)  #*
cor(subset(flagmean_macaw_swp_sb, Date=="2019-08-15")$pri/subset(flagmean_macaw_swp_sb, Date=="2019-08-15")$ndvi/subset(flagmean_macaw_swp_sb, Date=="2019-08-15")$rer, subset(flagmean_macaw_swp_sb, Date=="2019-08-15")$SWP)^2  #0.386
lm4 <- lm(pri/ndvi/rer~SWP, data = subset(flagmean_macaw_swp_sb, Date=="2019-08-15"))
summary(lm4)  #***

```

######Three treatments
```{r}
#PRI
cor(flagmean_macaw_swp$pri, flagmean_macaw_swp$SWP)^2  #0.471
lm1 <- lm(pri~SWP, data = flagmean_macaw_swp)
summary(lm1)  #***
cor(subset(flagmean_macaw_swp, Date=="2019-06-28")$pri, subset(flagmean_macaw_swp, Date=="2019-06-28")$SWP)^2  #0.025
lm2 <- lm(pri~SWP, data = subset(flagmean_macaw_swp, Date=="2019-06-28"))
summary(lm2)  #.
cor(subset(flagmean_macaw_swp, Date=="2019-08-02")$pri, subset(flagmean_macaw_swp, Date=="2019-08-02")$SWP)^2  #0.018
lm3 <- lm(pri~SWP, data = subset(flagmean_macaw_swp, Date=="2019-08-02"))
summary(lm3)  #
cor(subset(flagmean_macaw_swp, Date=="2019-08-15")$pri, subset(flagmean_macaw_swp, Date=="2019-08-15")$SWP)^2  #0.245
lm4 <- lm(pri~SWP, data = subset(flagmean_macaw_swp, Date=="2019-08-15"))
summary(lm4)  #***

#NDVI
cor(flagmean_macaw_swp$ndvi, flagmean_macaw_swp$SWP)^2  #0.338
lm1 <- lm(ndvi~SWP, data = flagmean_macaw_swp)
summary(lm1)  #***
cor(subset(flagmean_macaw_swp, Date=="2019-06-28")$ndvi, subset(flagmean_macaw_swp, Date=="2019-06-28")$SWP)^2  #0.058
lm2 <- lm(ndvi~SWP, data = subset(flagmean_macaw_swp, Date=="2019-06-28"))
summary(lm2)  #**
cor(subset(flagmean_macaw_swp, Date=="2019-08-02")$ndvi, subset(flagmean_macaw_swp, Date=="2019-08-02")$SWP)^2  #0.085
lm3 <- lm(ndvi~SWP, data = subset(flagmean_macaw_swp, Date=="2019-08-02"))
summary(lm3)  #**
cor(subset(flagmean_macaw_swp, Date=="2019-08-15")$ndvi, subset(flagmean_macaw_swp, Date=="2019-08-15")$SWP)^2  #0.342
lm4 <- lm(ndvi~SWP, data = subset(flagmean_macaw_swp, Date=="2019-08-15"))
summary(lm4)  #***


```

```{r}
#cor(rowflagmean_macaw_phys$pri, rowflagmean_macaw_phys$SWP)^2  #0.376
#lm1 <- lm(pri~SWP, data = rowflagmean_macaw_phys)
#summary(lm1)
#ggplot(rowflagmean_macaw_phys, aes(x = pri, y = -SWP)) + geom_point(aes(color = as.factor(Date))) + xlab("Photochemical Reflectance Index (PRI)") + ylab("SWP (Bars)") + geom_smooth(method = "lm") + theme_bw()+theme(text = element_text(size = 15))


#Two treatments
##PRI
cor(flagmean_macaw_swp_sb$pri, flagmean_macaw_swp_sb$SWP)^2 #0.453
cor(subset(flagmean_macaw_swp_sb, Date == "2019-08-15")$pri, subset(flagmean_macaw_swp_sb, Date == "2019-08-15")$SWP)^2  #0.3165
cor(subset(flagmean_macaw_swp_sb, Date == "2019-08-02")$pri, subset(flagmean_macaw_swp_sb, Date == "2019-08-02")$SWP)^2  #0.0167
cor(subset(flagmean_macaw_swp_sb, Date == "2019-06-28")$pri, subset(flagmean_macaw_swp_sb, Date == "2019-06-28")$SWP)^2  #0.00660
cor(subset(flagmean_macaw_swp_sb, Treatment2 == "100% ET")$pri, subset(flagmean_macaw_swp_sb, Treatment2 == "100% ET")$SWP)^2  #0.3363
cor(subset(flagmean_macaw_swp_sb, Treatment2 == "35% ET")$pri, subset(flagmean_macaw_swp_sb, Treatment2 == "35% ET")$SWP)^2  #0.5256
##PRInorm
cor(flagmean_macaw_swp_sb$prinorm, flagmean_macaw_swp_sb$SWP)^2 #0.402
cor(subset(flagmean_macaw_swp_sb, Date == "2019-08-15")$prinorm, subset(flagmean_macaw_swp_sb, Date == "2019-08-15")$SWP)^2  #0.413
cor(subset(flagmean_macaw_swp_sb, Date == "2019-08-02")$prinorm, subset(flagmean_macaw_swp_sb, Date == "2019-08-02")$SWP)^2  #0.070
cor(subset(flagmean_macaw_swp_sb, Date == "2019-06-28")$prinorm, subset(flagmean_macaw_swp_sb, Date == "2019-06-28")$SWP)^2  #0.023
cor(subset(flagmean_macaw_swp_sb, Treatment2 == "100% ET")$prinorm, subset(flagmean_macaw_swp_sb, Treatment2 == "100% ET")$SWP)^2  #0.196
cor(subset(flagmean_macaw_swp_sb, Treatment2 == "35% ET")$prinorm, subset(flagmean_macaw_swp_sb, Treatment2 == "35% ET")$SWP)^2  #0.488


#three treatments
cor(flagmean_macaw_swp$prinorm, flagmean_macaw_swp$SWP)^2 #0.408
cor(subset(flagmean_macaw_swp, Date == "2019-08-15")$prinorm, subset(flagmean_macaw_swp, Date == "2019-08-15")$SWP)^2  #0.366
cor(subset(flagmean_macaw_swp, Date == "2019-08-02")$prinorm, subset(flagmean_macaw_swp, Date == "2019-08-02")$SWP)^2  #0.069
cor(subset(flagmean_macaw_swp, Date == "2019-06-28")$prinorm, subset(flagmean_macaw_swp, Date == "2019-06-28")$SWP)^2  #0.0229
cor(subset(flagmean_macaw_swp, Treatment2 == "100% ET")$prinorm, subset(flagmean_macaw_swp, Treatment2 == "100% ET")$SWP)^2  #0.1963
cor(subset(flagmean_macaw_swp, Treatment2 == "35% ET")$prinorm, subset(flagmean_macaw_swp, Treatment2 == "35% ET")$SWP)^2  #0.4885


cor(flagmean_macaw_swp_sb$ndvi, flagmean_macaw_swp_sb$SWP)^2 #0.303
cor(subset(flagmean_macaw_swp_sb, Date == "2019-08-15")$ndvi, subset(flagmean_macaw_swp_sb, Date == "2019-08-15")$SWP)^2  #0.3547
cor(subset(flagmean_macaw_swp_sb, Date == "2019-08-02")$ndvi, subset(flagmean_macaw_swp_sb, Date == "2019-08-02")$SWP)^2  #0.1173
cor(subset(flagmean_macaw_swp_sb, Date == "2019-06-28")$ndvi, subset(flagmean_macaw_swp_sb, Date == "2019-06-28")$SWP)^2  #0.0293
cor(subset(flagmean_macaw_swp_sb, Treatment2 == "100% ET")$ndvi, subset(flagmean_macaw_swp_sb, Treatment2 == "100% ET")$SWP)^2  #0.1021
cor(subset(flagmean_macaw_swp_sb, Treatment2 == "35% ET")$ndvi, subset(flagmean_macaw_swp_sb, Treatment2 == "35% ET")$SWP)^2  #0.3892



cor(subset(flagmean_macaw_swp_sb, Date =))
```
#####Predictions 
```{r}

```

###Licor
```{r}
flagmean_macaw_licor <- base::merge(flagmean_macaw, licor_PL, by = c("Block","Treatment","Plant","Date"))
dim(flagmean_macaw_licor)  #330, 36
dim(flagmean_macaw)  #360, 33
dim(licor_PL)  #1070, 7
dim(subset(licor_PL, Date=="2019-06-28")) #120,7
dim(subset(licor_PL, Date=="2019-08-02")) #160,7
dim(subset(licor_PL, Date=="2019-08-15")) #150,7

names(flagmean_macaw_licor)

#get rid of control ww group 
flagmean_macaw_licor_sb <- subset(flagmean_macaw_licor, Treatment != "CONTROL WW")
flagmean_macaw_licor_sb$Treatment2 <- flagmean_macaw_licor_sb$Treatment
flagmean_macaw_licor_sb$Treatment2
for(i in 1:nrow(flagmean_macaw_licor_sb)){
  if(flagmean_macaw_licor_sb[i,]$Treatment2 == "CONTROL DDD"){
    flagmean_macaw_licor_sb[i,]$Treatment2 = "35% ET"
  }
  if(flagmean_macaw_licor_sb[i,]$Treatment2 == "BAYER 16 (SOIL) WW"){
    flagmean_macaw_licor_sb[i,]$Treatment2 = "100% ET"
  }
}
ggplot(subset(flagmean_macaw_licor, Treatment != "CONTROL WW" & Date == "2019-08-15"), aes(x = pri, y = Cond, col = as.factor(Treatment))) + geom_point() #+ facet_wrap(~Date, nrow = 3, scales  = "free")

```

##Flag-row mean
###Licor
####Plots
```{r}
rowflagmean_macaw_licor <- aggregate(flagmean_macaw_licor[,c(6:17, 22:33, 35:36)], by = list("Block" = flagmean_macaw_licor$Block, "Treatment" = flagmean_macaw_licor$Treatment, "Date" = flagmean_macaw_licor$Date, "Plot" = flagmean_macaw_licor$Plot), FUN = function(x){mean(x, na.rm = TRUE)})
dim(rowflagmean_macaw_licor)  #45, 30

rowflagmean_macaw_licor_sb <- aggregate(flagmean_macaw_licor_sb[,c(6:17, 22:33, 35:36)], by = list("Block" = flagmean_macaw_licor_sb$Block, "Treatment" = flagmean_macaw_licor_sb$Treatment, "Date" = flagmean_macaw_licor_sb$Date, "Plot" = flagmean_macaw_licor_sb$Plot), FUN = function(x){mean(x, na.rm = TRUE)})
dim(rowflagmean_macaw_licor_sb)  #30, 30
dim(subset(rowflagmean_macaw_licor, Date=="2019-06-28"))  #15.30
dim(subset(rowflagmean_macaw_licor, Date=="2019-08-02"))  #15.30
dim(subset(rowflagmean_macaw_licor, Date=="2019-08-15"))  #15.30


##PRI
p1 = ggplot(subset(rowflagmean_macaw_licor_sb, Date == "2019-06-28"), aes(x = pri, y = Cond)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("PRI") + ylab(expression(paste("G"[s], " (mol∙m"^"-2","s"^"-1",")"))) + scale_fill_tableau() + ggtitle("06-28") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
p2 = ggplot(subset(rowflagmean_macaw_licor_sb, Date == "2019-08-02"), aes(x = pri, y = Cond)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("PRI") + ylab(expression(paste("G"[s], " (mol∙m"^"-2","s"^"-1",")"))) + scale_fill_tableau() + ggtitle("08-02") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
p3 = ggplot(subset(rowflagmean_macaw_licor_sb, Date == "2019-08-15"), aes(x = pri, y = Cond)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("PRI") + ylab(expression(paste("G"[s], " (mol∙m"^"-2","s"^"-1",")"))) + scale_fill_tableau() + ggtitle("08-15") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
p4 = ggplot(subset(rowflagmean_macaw_licor_sb), aes(x = pri, y = Cond)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("PRI") + ylab(expression(paste("G"[s], " (mol∙m"^"-2","s"^"-1",")"))) + scale_fill_tableau() + ggtitle("06-28 + 08-02 + 08-15") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
ggarrange(p1,p2,p3,p4, nrow = 2, ncol = 2)
##PRInorm
p1 = ggplot(subset(rowflagmean_macaw_licor_sb, Date == "2019-06-28"), aes(x = prinorm, y = Cond)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("PRInorm") + ylab(expression(paste("G"[s], " (mol∙m"^"-2","s"^"-1",")"))) + scale_fill_tableau() + ggtitle("06-28") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
p2 = ggplot(subset(rowflagmean_macaw_licor_sb, Date == "2019-08-02"), aes(x = prinorm, y = Cond)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("PRInorm") + ylab(expression(paste("G"[s], " (mol∙m"^"-2","s"^"-1",")"))) + scale_fill_tableau() + ggtitle("08-02") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
p3 = ggplot(subset(rowflagmean_macaw_licor_sb, Date == "2019-08-15"), aes(x = prinorm, y = Cond)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("PRInorm") + ylab(expression(paste("G"[s], " (mol∙m"^"-2","s"^"-1",")"))) + scale_fill_tableau() + ggtitle("08-15") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
p4 = ggplot(subset(rowflagmean_macaw_licor_sb), aes(x = prinorm, y = Cond)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("PRInorm") + ylab(expression(paste("G"[s], " (mol∙m"^"-2","s"^"-1",")"))) + scale_fill_tableau() + ggtitle("06-28 + 08-02 + 08-15") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
ggarrange(p1,p2,p3,p4, nrow = 2, ncol = 2)

##NDVI
p1 = ggplot(subset(rowflagmean_macaw_licor_sb, Date == "2019-06-28"), aes(x = ndvi, y = Cond)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("NDVI") + ylab(expression(paste("G"[s], " (mol∙m"^"-2","s"^"-1",")"))) + scale_fill_tableau() + ggtitle("06-28") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
p2 = ggplot(subset(rowflagmean_macaw_licor_sb, Date == "2019-08-02"), aes(x = ndvi, y = Cond)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("NDVI") + ylab(expression(paste("G"[s], " (mol∙m"^"-2","s"^"-1",")"))) + scale_fill_tableau() + ggtitle("08-02") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
p3 = ggplot(subset(rowflagmean_macaw_licor_sb, Date == "2019-08-15"), aes(x = ndvi, y = Cond)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("NDVI") + ylab(expression(paste("G"[s], " (mol∙m"^"-2","s"^"-1",")"))) + scale_fill_tableau() + ggtitle("08-15") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
p4 = ggplot(subset(rowflagmean_macaw_licor_sb), aes(x = ndvi, y = Cond)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("NDVI") + ylab(expression(paste("G"[s], " (mol∙m"^"-2","s"^"-1",")"))) + scale_fill_tableau() + ggtitle("06-28 + 08-02 + 08-15") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
ggarrange(p1,p2,p3,p4, nrow = 2, ncol = 2)
##RDVI
p1 = ggplot(subset(rowflagmean_macaw_licor_sb, Date == "2019-06-28"), aes(x = rdvi, y = Cond)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("RDVI") + ylab(expression(paste("G"[s], " (mol∙m"^"-2","s"^"-1",")"))) + scale_fill_tableau() + ggtitle("06-28") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
p2 = ggplot(subset(rowflagmean_macaw_licor_sb, Date == "2019-08-02"), aes(x = rdvi, y = Cond)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("RDVI") + ylab(expression(paste("G"[s], " (mol∙m"^"-2","s"^"-1",")"))) + scale_fill_tableau() + ggtitle("08-02") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
p3 = ggplot(subset(rowflagmean_macaw_licor_sb, Date == "2019-08-15"), aes(x = rdvi, y = Cond)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("RDVI") + ylab(expression(paste("G"[s], " (mol∙m"^"-2","s"^"-1",")"))) + scale_fill_tableau() + ggtitle("08-15") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
p4 = ggplot(subset(rowflagmean_macaw_licor_sb), aes(x = rdvi, y = Cond)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("RDVI") + ylab(expression(paste("G"[s], " (mol∙m"^"-2","s"^"-1",")"))) + scale_fill_tableau() + ggtitle("06-28 + 08-02 + 08-15") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
ggarrange(p1,p2,p3,p4, nrow = 2, ncol = 2)
##RER
p1 = ggplot(subset(rowflagmean_macaw_licor_sb, Date == "2019-06-28"), aes(x = rer, y = Cond)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("RER") + ylab(expression(paste("G"[s], " (mol∙m"^"-2","s"^"-1",")"))) + scale_fill_tableau() + ggtitle("06-28") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
p2 = ggplot(subset(rowflagmean_macaw_licor_sb, Date == "2019-08-02"), aes(x = rer, y = Cond)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("RER") + ylab(expression(paste("G"[s], " (mol∙m"^"-2","s"^"-1",")"))) + scale_fill_tableau() + ggtitle("08-02") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
p3 = ggplot(subset(rowflagmean_macaw_licor_sb, Date == "2019-08-15"), aes(x = rer, y = Cond)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("RER") + ylab(expression(paste("G"[s], " (mol∙m"^"-2","s"^"-1",")"))) + scale_fill_tableau() + ggtitle("08-15") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
p4 = ggplot(subset(rowflagmean_macaw_licor_sb), aes(x = rer, y = Cond)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("RER") + ylab(expression(paste("G"[s], " (mol∙m"^"-2","s"^"-1",")"))) + scale_fill_tableau() + ggtitle("06-28 + 08-02 + 08-15") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
ggarrange(p1,p2,p3,p4, nrow = 2, ncol = 2)
#TCARI
p1 = ggplot(subset(rowflagmean_macaw_licor_sb, Date == "2019-06-28"), aes(x = tcari, y = Cond)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("TCARI") + ylab(expression(paste("G"[s], " (mol∙m"^"-2","s"^"-1",")"))) + scale_fill_tableau() + ggtitle("06-28") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
p2 = ggplot(subset(rowflagmean_macaw_licor_sb, Date == "2019-08-02"), aes(x = tcari, y = Cond)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("TCARI") + ylab(expression(paste("G"[s], " (mol∙m"^"-2","s"^"-1",")"))) + scale_fill_tableau() + ggtitle("08-02") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
p3 = ggplot(subset(rowflagmean_macaw_licor_sb, Date == "2019-08-15"), aes(x = tcari, y = Cond)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("TCARI") + ylab(expression(paste("G"[s], " (mol∙m"^"-2","s"^"-1",")"))) + scale_fill_tableau() + ggtitle("08-15") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
p4 = ggplot(subset(rowflagmean_macaw_licor_sb), aes(x = tcari, y = Cond)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("TCARI") + ylab(expression(paste("G"[s], " (mol∙m"^"-2","s"^"-1",")"))) + scale_fill_tableau() + ggtitle("06-28 + 08-02 + 08-15") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
ggarrange(p1,p2,p3,p4, nrow = 2, ncol = 2)
#WI
p1 = ggplot(subset(rowflagmean_macaw_licor_sb, Date == "2019-06-28"), aes(x = wi, y = Cond)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("WI") + ylab(expression(paste("G"[s], " (mol∙m"^"-2","s"^"-1",")"))) + scale_fill_tableau() + ggtitle("06-28") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
p2 = ggplot(subset(rowflagmean_macaw_licor_sb, Date == "2019-08-02"), aes(x = wi, y = Cond)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("WI") + ylab(expression(paste("G"[s], " (mol∙m"^"-2","s"^"-1",")"))) + scale_fill_tableau() + ggtitle("08-02") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
p3 = ggplot(subset(rowflagmean_macaw_licor_sb, Date == "2019-08-15"), aes(x = wi, y = Cond)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("WI") + ylab(expression(paste("G"[s], " (mol∙m"^"-2","s"^"-1",")"))) + scale_fill_tableau() + ggtitle("08-15") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
p4 = ggplot(subset(rowflagmean_macaw_licor_sb), aes(x = wi, y = Cond)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("WI") + ylab(expression(paste("G"[s], " (mol∙m"^"-2","s"^"-1",")"))) + scale_fill_tableau() + ggtitle("06-28 + 08-02 + 08-15") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
ggarrange(p1,p2,p3,p4, nrow = 2, ncol = 2)


ggplot(subset(rowflagmean_macaw_licor_sb), aes(x = rdvi, y = Cond)) + geom_point(aes(color = as.factor(Date)))+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("RDVI") + ylab(expression(paste("G"[s], " (mol∙m"^"-2","s"^"-1",")"))) + scale_fill_tableau() + ggtitle("06-28 + 08-02 + 08-15") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
ggplot(subset(rowflagmean_macaw_licor_sb), aes(x = ndvi, y = Cond)) + geom_point(aes(color = as.factor(Date)))+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("NDVI") + ylab(expression(paste("G"[s], " (mol∙m"^"-2","s"^"-1",")"))) + scale_fill_tableau() + ggtitle("06-28 + 08-02 + 08-15") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
ggplot(subset(rowflagmean_macaw_licor_sb), aes(x = rer, y = Cond)) + geom_point(aes(color = as.factor(Date)))+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("RER") + ylab(expression(paste("G"[s], " (mol∙m"^"-2","s"^"-1",")"))) + scale_fill_tableau() + ggtitle("06-28 + 08-02 + 08-15") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
ggplot(subset(rowflagmean_macaw_licor_sb), aes(x = prinorm, y = Cond)) + geom_point(aes(color = as.factor(Date)))+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("PRInorm") + ylab(expression(paste("G"[s], " (mol∙m"^"-2","s"^"-1",")"))) + scale_fill_tableau() + ggtitle("06-28 + 08-02 + 08-15") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")

```
####Quantitative analysis
#####t-test
```{r}
#three treatments 
ggplot(rowflagmean_macaw_licor, aes(x = as.factor(Date), y = Cond, fill = Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab(expression(paste("G"[s], " (mol∙m"^"-2","s"^"-1",")"))) + scale_fill_tableau() + ggtitle("Stomatal Conductance Row Average") 
lm6 <- lm(Cond~Treatment, data = subset(rowflagmean_macaw_licor, Date == "2019-06-28")) 
lm6
hsd1 <- HSD.test(lm6, "Treatment", group = TRUE)
hsd1

lm7 <- lm(Cond~Treatment, data = subset(rowflagmean_macaw_licor, Date == "2019-08-02")) 
lm7
hsd2 <- HSD.test(lm7, "Treatment", group = TRUE)
hsd2

lm8 <- lm(Cond~Treatment, data = subset(rowflagmean_macaw_licor, Date == "2019-08-15")) 
lm8
hsd3 <- HSD.test(lm8, "Treatment", group = TRUE)
hsd3

#two treatments
ggplot(rowflagmean_macaw_licor_sb, aes(x = as.factor(Date), y = Cond, fill = Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab(expression(paste("G"[s], " (mol∙m"^"-2","s"^"-1",")"))) + scale_fill_tableau() + ggtitle("Stomatal Conductance Row Average") 

lm6 <- lm(Cond~Treatment, data = subset(rowflagmean_macaw_licor_sb, Date == "2019-06-28")) 
lm6
hsd1 <- HSD.test(lm6, "Treatment", group = TRUE)
hsd1

lm7 <- lm(Cond~Treatment, data = subset(rowflagmean_macaw_licor_sb, Date == "2019-08-02")) 
lm7
hsd2 <- HSD.test(lm7, "Treatment", group = TRUE)
hsd2

lm8 <- lm(Cond~Treatment, data = subset(rowflagmean_macaw_licor_sb, Date == "2019-08-15")) 
lm8
hsd3 <- HSD.test(lm8, "Treatment", group = TRUE)
hsd3

```
#####Two treatments
```{r}
#PRI
cor(rowflagmean_macaw_licor_sb$pri, rowflagmean_macaw_licor_sb$Cond)^2  #0.036
lm1 <- lm(pri~Cond, data = rowflagmean_macaw_licor_sb)
summary(lm1)  #
cor(subset(rowflagmean_macaw_licor_sb, Date=="2019-06-28")$pri, subset(rowflagmean_macaw_licor_sb, Date=="2019-06-28")$Cond)^2  #0.247
lm2 <- lm(pri~Cond, data = subset(rowflagmean_macaw_licor_sb, Date=="2019-06-28"))
summary(lm2)  #
cor(subset(rowflagmean_macaw_licor_sb, Date=="2019-08-02")$pri, subset(rowflagmean_macaw_licor_sb, Date=="2019-08-02")$Cond)^2  #0.0244
lm3 <- lm(pri~Cond, data = subset(rowflagmean_macaw_licor_sb, Date=="2019-08-02"))
summary(lm3)  #
cor(subset(rowflagmean_macaw_licor_sb, Date=="2019-08-15")$pri, subset(rowflagmean_macaw_licor_sb, Date=="2019-08-15")$Cond)^2  #0.380
lm4 <- lm(pri~Cond, data = subset(rowflagmean_macaw_licor_sb, Date=="2019-08-15"))
summary(lm4)  #.

#ndvi
cor(rowflagmean_macaw_licor_sb$ndvi, rowflagmean_macaw_licor_sb$Cond)^2  #0.267
lm1 <- lm(ndvi~Cond, data = rowflagmean_macaw_licor_sb)
summary(lm1)  #**
cor(subset(rowflagmean_macaw_licor_sb, Date=="2019-06-28")$ndvi, subset(rowflagmean_macaw_licor_sb, Date=="2019-06-28")$Cond)^2  #0.616
lm2 <- lm(ndvi~Cond, data = subset(rowflagmean_macaw_licor_sb, Date=="2019-06-28"))
summary(lm2)  #**
cor(subset(rowflagmean_macaw_licor_sb, Date=="2019-08-02")$ndvi, subset(rowflagmean_macaw_licor_sb, Date=="2019-08-02")$Cond)^2  #0.637
lm3 <- lm(ndvi~Cond, data = subset(rowflagmean_macaw_licor_sb, Date=="2019-08-02"))
summary(lm3)  #**
cor(subset(rowflagmean_macaw_licor_sb, Date=="2019-08-15")$ndvi, subset(rowflagmean_macaw_licor_sb, Date=="2019-08-15")$Cond)^2  #0.513
lm4 <- lm(ndvi~Cond, data = subset(rowflagmean_macaw_licor_sb, Date=="2019-08-15"))
summary(lm4)  #*

#rdvi
cor(rowflagmean_macaw_licor_sb$rdvi, rowflagmean_macaw_licor_sb$Cond)^2  #0.131
lm1 <- lm(rdvi~Cond, data = rowflagmean_macaw_licor_sb)
summary(lm1)  #*
cor(subset(rowflagmean_macaw_licor_sb, Date=="2019-06-28")$rdvi, subset(rowflagmean_macaw_licor_sb, Date=="2019-06-28")$Cond)^2  #0.432
lm2 <- lm(rdvi~Cond, data = subset(rowflagmean_macaw_licor_sb, Date=="2019-06-28"))
summary(lm2)  #*
cor(subset(rowflagmean_macaw_licor_sb, Date=="2019-08-02")$rdvi, subset(rowflagmean_macaw_licor_sb, Date=="2019-08-02")$Cond)^2  #0.714
lm3 <- lm(rdvi~Cond, data = subset(rowflagmean_macaw_licor_sb, Date=="2019-08-02"))
summary(lm3)  #**
cor(subset(rowflagmean_macaw_licor_sb, Date=="2019-08-15")$rdvi, subset(rowflagmean_macaw_licor_sb, Date=="2019-08-15")$Cond)^2  #0.696
lm4 <- lm(rdvi~Cond, data = subset(rowflagmean_macaw_licor_sb, Date=="2019-08-15"))
summary(lm4)  #**

#tcari
cor(rowflagmean_macaw_licor_sb$tcari, rowflagmean_macaw_licor_sb$Cond)^2  #0.002
lm1 <- lm(tcari~Cond, data = rowflagmean_macaw_licor_sb)
summary(lm1)  #
cor(subset(rowflagmean_macaw_licor_sb, Date=="2019-06-28")$tcari, subset(rowflagmean_macaw_licor_sb, Date=="2019-06-28")$Cond)^2  #0.126
lm2 <- lm(tcari~Cond, data = subset(rowflagmean_macaw_licor_sb, Date=="2019-06-28"))
summary(lm2)  #
cor(subset(rowflagmean_macaw_licor_sb, Date=="2019-08-02")$tcari, subset(rowflagmean_macaw_licor_sb, Date=="2019-08-02")$Cond)^2  #0.195
lm3 <- lm(tcari~Cond, data = subset(rowflagmean_macaw_licor_sb, Date=="2019-08-02"))
summary(lm3)  #
cor(subset(rowflagmean_macaw_licor_sb, Date=="2019-08-15")$tcari, subset(rowflagmean_macaw_licor_sb, Date=="2019-08-15")$Cond)^2  #0.042
lm4 <- lm(tcari~Cond, data = subset(rowflagmean_macaw_licor_sb, Date=="2019-08-15"))
summary(lm4)  #

#rer
cor(rowflagmean_macaw_licor_sb$rer, rowflagmean_macaw_licor_sb$Cond)^2  #0.167
lm1 <- lm(rer~Cond, data = rowflagmean_macaw_licor_sb)
summary(lm1)  #*
cor(subset(rowflagmean_macaw_licor_sb, Date=="2019-06-28")$rer, subset(rowflagmean_macaw_licor_sb, Date=="2019-06-28")$Cond)^2  #0.433
lm2 <- lm(rer~Cond, data = subset(rowflagmean_macaw_licor_sb, Date=="2019-06-28"))
summary(lm2)  #*
cor(subset(rowflagmean_macaw_licor_sb, Date=="2019-08-02")$rer, subset(rowflagmean_macaw_licor_sb, Date=="2019-08-02")$Cond)^2  #0.343
lm3 <- lm(rer~Cond, data = subset(rowflagmean_macaw_licor_sb, Date=="2019-08-02"))
summary(lm3)  #.
cor(subset(rowflagmean_macaw_licor_sb, Date=="2019-08-15")$rer, subset(rowflagmean_macaw_licor_sb, Date=="2019-08-15")$Cond)^2  #0.450
lm4 <- lm(rer~Cond, data = subset(rowflagmean_macaw_licor_sb, Date=="2019-08-15"))
summary(lm4)  #*

#tcari.osavi
cor(rowflagmean_macaw_licor_sb$tcari.osavi, rowflagmean_macaw_licor_sb$Cond)^2  #0.057
lm1 <- lm(tcari.osavi~Cond, data = rowflagmean_macaw_licor_sb)
summary(lm1)  #
cor(subset(rowflagmean_macaw_licor_sb, Date=="2019-06-28")$tcari.osavi, subset(rowflagmean_macaw_licor_sb, Date=="2019-06-28")$Cond)^2  #0.072
lm2 <- lm(tcari.osavi~Cond, data = subset(rowflagmean_macaw_licor_sb, Date=="2019-06-28"))
summary(lm2)  #
cor(subset(rowflagmean_macaw_licor_sb, Date=="2019-08-02")$tcari.osavi, subset(rowflagmean_macaw_licor_sb, Date=="2019-08-02")$Cond)^2  #0.028
lm3 <- lm(tcari.osavi~Cond, data = subset(rowflagmean_macaw_licor_sb, Date=="2019-08-02"))
summary(lm3)  #
cor(subset(rowflagmean_macaw_licor_sb, Date=="2019-08-15")$tcari.osavi, subset(rowflagmean_macaw_licor_sb, Date=="2019-08-15")$Cond)^2  #0.038
lm4 <- lm(tcari.osavi~Cond, data = subset(rowflagmean_macaw_licor_sb, Date=="2019-08-15"))
summary(lm4)  #

#pri550
cor(rowflagmean_macaw_licor_sb$pri550, rowflagmean_macaw_licor_sb$Cond)^2  #0.061
lm1 <- lm(pri550~Cond, data = rowflagmean_macaw_licor_sb)
summary(lm1)  #
cor(subset(rowflagmean_macaw_licor_sb, Date=="2019-06-28")$pri550, subset(rowflagmean_macaw_licor_sb, Date=="2019-06-28")$Cond)^2  #0.098
lm2 <- lm(pri550~Cond, data = subset(rowflagmean_macaw_licor_sb, Date=="2019-06-28"))
summary(lm2)  #
cor(subset(rowflagmean_macaw_licor_sb, Date=="2019-08-02")$pri550, subset(rowflagmean_macaw_licor_sb, Date=="2019-08-02")$Cond)^2  #0.172
lm3 <- lm(pri550~Cond, data = subset(rowflagmean_macaw_licor_sb, Date=="2019-08-02"))
summary(lm3)  #
cor(subset(rowflagmean_macaw_licor_sb, Date=="2019-08-15")$pri550, subset(rowflagmean_macaw_licor_sb, Date=="2019-08-15")$Cond)^2  #0.133
lm4 <- lm(pri550~Cond, data = subset(rowflagmean_macaw_licor_sb, Date=="2019-08-15"))
summary(lm4)  #

#wi
cor(rowflagmean_macaw_licor_sb$wi, rowflagmean_macaw_licor_sb$Cond)^2  #0.003
lm1 <- lm(wi~Cond, data = rowflagmean_macaw_licor_sb)
summary(lm1)  #
cor(subset(rowflagmean_macaw_licor_sb, Date=="2019-06-28")$wi, subset(rowflagmean_macaw_licor_sb, Date=="2019-06-28")$Cond)^2  #0.213
lm2 <- lm(wi~Cond, data = subset(rowflagmean_macaw_licor_sb, Date=="2019-06-28"))
summary(lm2)  #
cor(subset(rowflagmean_macaw_licor_sb, Date=="2019-08-02")$wi, subset(rowflagmean_macaw_licor_sb, Date=="2019-08-02")$Cond)^2  #0.194
lm3 <- lm(wi~Cond, data = subset(rowflagmean_macaw_licor_sb, Date=="2019-08-02"))
summary(lm3)  #
cor(subset(rowflagmean_macaw_licor_sb, Date=="2019-08-15")$wi, subset(rowflagmean_macaw_licor_sb, Date=="2019-08-15")$Cond)^2  #0.012
lm4 <- lm(wi~Cond, data = subset(rowflagmean_macaw_licor_sb, Date=="2019-08-15"))
summary(lm4)  #

#wi.ndvi
cor(rowflagmean_macaw_licor_sb$wi.ndvi, rowflagmean_macaw_licor_sb$Cond)^2  #0.0502
lm1 <- lm(wi.ndvi~Cond, data = rowflagmean_macaw_licor_sb)
summary(lm1)  #
cor(subset(rowflagmean_macaw_licor_sb, Date=="2019-06-28")$wi.ndvi, subset(rowflagmean_macaw_licor_sb, Date=="2019-06-28")$Cond)^2  #0.346
lm2 <- lm(wi.ndvi~Cond, data = subset(rowflagmean_macaw_licor_sb, Date=="2019-06-28"))
summary(lm2)  #.
cor(subset(rowflagmean_macaw_licor_sb, Date=="2019-08-02")$wi.ndvi, subset(rowflagmean_macaw_licor_sb, Date=="2019-08-02")$Cond)^2  #0.382
lm3 <- lm(wi.ndvi~Cond, data = subset(rowflagmean_macaw_licor_sb, Date=="2019-08-02"))
summary(lm3)  #.
cor(subset(rowflagmean_macaw_licor_sb, Date=="2019-08-15")$wi.ndvi, subset(rowflagmean_macaw_licor_sb, Date=="2019-08-15")$Cond)^2  #0.341
lm4 <- lm(wi.ndvi~Cond, data = subset(rowflagmean_macaw_licor_sb, Date=="2019-08-15"))
summary(lm4)  #.


#PRInorm
cor(rowflagmean_macaw_licor_sb$prinorm, rowflagmean_macaw_licor_sb$Cond)^2  #0.120
lm1 <- lm(prinorm~Cond, data = rowflagmean_macaw_licor_sb)
summary(lm1)  #.
cor(subset(rowflagmean_macaw_licor_sb, Date=="2019-06-28")$prinorm, subset(rowflagmean_macaw_licor_sb, Date=="2019-06-28")$Cond)^2  #0.0114
lm2 <- lm(prinorm~Cond, data = subset(rowflagmean_macaw_licor_sb, Date=="2019-06-28"))
summary(lm2)  #
cor(subset(rowflagmean_macaw_licor_sb, Date=="2019-08-02")$prinorm, subset(rowflagmean_macaw_licor_sb, Date=="2019-08-02")$Cond)^2  #0.2815
lm3 <- lm(prinorm~Cond, data = subset(rowflagmean_macaw_licor_sb, Date=="2019-08-02"))
summary(lm3)  #
cor(subset(rowflagmean_macaw_licor_sb, Date=="2019-08-15")$prinorm, subset(rowflagmean_macaw_licor_sb, Date=="2019-08-15")$Cond)^2  #0.509
lm4 <- lm(prinorm~Cond, data = subset(rowflagmean_macaw_licor_sb, Date=="2019-08-15"))
summary(lm4)  #*

#PRI/NDVI
cor(rowflagmean_macaw_licor_sb$pri/rowflagmean_macaw_licor_sb$ndvi, rowflagmean_macaw_licor_sb$Cond)^2  #0.0513
lm1 <- lm(pri/ndvi~Cond, data = rowflagmean_macaw_licor_sb)
summary(lm1)  #
cor(subset(rowflagmean_macaw_licor_sb, Date=="2019-06-28")$pri/subset(rowflagmean_macaw_licor_sb, Date=="2019-06-28")$ndvi, subset(rowflagmean_macaw_licor_sb, Date=="2019-06-28")$Cond)^2  #0.192
lm2 <- lm(pri/ndvi~Cond, data = subset(rowflagmean_macaw_licor_sb, Date=="2019-06-28"))
summary(lm2)  #
cor(subset(rowflagmean_macaw_licor_sb, Date=="2019-08-02")$pri/subset(rowflagmean_macaw_licor_sb, Date=="2019-08-02")$ndvi, subset(rowflagmean_macaw_licor_sb, Date=="2019-08-02")$Cond)^2  #0.0065
lm3 <- lm(pri/ndvi~Cond, data = subset(rowflagmean_macaw_licor_sb, Date=="2019-08-02"))
summary(lm3)  #
cor(subset(rowflagmean_macaw_licor_sb, Date=="2019-08-15")$pri/subset(rowflagmean_macaw_licor_sb, Date=="2019-08-15")$ndvi, subset(rowflagmean_macaw_licor_sb, Date=="2019-08-15")$Cond)^2  #0.412
lm4 <- lm(pri/ndvi~Cond, data = subset(rowflagmean_macaw_licor_sb, Date=="2019-08-15"))
summary(lm4)  #*


#PRI/(ndvi*rer)
cor(rowflagmean_macaw_licor_sb$pri/rowflagmean_macaw_licor_sb$ndvi/rowflagmean_macaw_licor_sb$rer, rowflagmean_macaw_licor_sb$Cond)^2  #0.081
lm1 <- lm(pri/ndvi/rer~Cond, data = rowflagmean_macaw_licor_sb)
summary(lm1)  #
cor(subset(rowflagmean_macaw_licor_sb, Date=="2019-06-28")$pri/subset(rowflagmean_macaw_licor_sb, Date=="2019-06-28")$ndvi/subset(rowflagmean_macaw_licor_sb, Date=="2019-06-28")$rer, subset(rowflagmean_macaw_licor_sb, Date=="2019-06-28")$Cond)^2  #0.0288
lm2 <- lm(pri/ndvi/rer~Cond, data = subset(rowflagmean_macaw_licor_sb, Date=="2019-06-28"))
summary(lm2)  #
cor(subset(rowflagmean_macaw_licor_sb, Date=="2019-08-02")$pri/subset(rowflagmean_macaw_licor_sb, Date=="2019-08-02")$ndvi/subset(rowflagmean_macaw_licor_sb, Date=="2019-08-02")$rer, subset(rowflagmean_macaw_licor_sb, Date=="2019-08-02")$Cond)^2  #0.161
lm3 <- lm(pri/ndvi/rer~Cond, data = subset(rowflagmean_macaw_licor_sb, Date=="2019-08-02"))
summary(lm3)  #
cor(subset(rowflagmean_macaw_licor_sb, Date=="2019-08-15")$pri/subset(rowflagmean_macaw_licor_sb, Date=="2019-08-15")$ndvi/subset(rowflagmean_macaw_licor_sb, Date=="2019-08-15")$rer, subset(rowflagmean_macaw_licor_sb, Date=="2019-08-15")$Cond)^2  #0.465
lm4 <- lm(pri/ndvi/rer~Cond, data = subset(rowflagmean_macaw_licor_sb, Date=="2019-08-15"))
summary(lm4)  #*


```

###SWP
####Scatter Plots
```{r}
#rowflagmean_swp <- aggregate(swp_PL$SWP, by = list("Block"=swp_PL$Block, "Plot"=swp_PL$Plot, "Treatment"=swp_PL$Treatment, "Date"=swp_PL$Date), FUN = function(x){mean(x, na.rm=TRUE)})
#names(rowflagmean_swp)[5] <- "SWP"
rowflagmean_macaw_swp <- aggregate(flagmean_macaw_swp[,c(6:17,22:33,35)], by = list("Block"  = flagmean_macaw_swp$Block, "Treatment" = flagmean_macaw_swp$Treatment, "Date" = flagmean_macaw_swp$Date, "Plot" = flagmean_macaw_swp$Plot), FUN = function(x){mean(x, na.rm = TRUE)})
rowflagmean_macaw_swp_sb <- aggregate(flagmean_macaw_swp_sb[,c(6:17,22:33,35)], by = list("Block"  = flagmean_macaw_swp_sb$Block, "Treatment" = flagmean_macaw_swp_sb$Treatment2, "Date" = flagmean_macaw_swp_sb$Date, "Plot" = flagmean_macaw_swp_sb$Plot), FUN = function(x){mean(x, na.rm = TRUE)})  #

dim(subset(rowflagmean_macaw_swp, Date == "2019-06-28")) #15,29
dim(subset(rowflagmean_macaw_swp, Date == "2019-08-02")) #15,29
dim(subset(rowflagmean_macaw_swp, Date == "2019-08-15")) #15,29
dim(subset(rowflagmean_macaw_swp_sb, Date == "2019-06-28")) #10,29
dim(subset(rowflagmean_macaw_swp_sb, Date == "2019-08-02")) #10,29
dim(subset(rowflagmean_macaw_swp_sb, Date == "2019-08-15")) #10,29



ggplot(rowflagmean_macaw_swp, aes(x = pri, y = -SWP, col = as.factor(Treatment))) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("PRI") + ylab(expression(paste(Psi["stem"]," (Bars)"))) + scale_fill_tableau() + ggtitle("SWP vs PRI Row Average") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
ggplot(rowflagmean_macaw_swp, aes(x = pri, y = -SWP, col = as.factor(Date))) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("PRI") + ylab(expression(paste(Psi["stem"]," (Bars)"))) + scale_fill_tableau() + ggtitle("SWP vs PRI Row Average") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")

ggplot(rowflagmean_macaw_swp, aes(x = prinorm, y = -SWP, col = as.factor(Treatment))) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("PRInorm") + ylab(expression(paste(Psi["stem"]," (Bars)"))) + scale_fill_tableau() + ggtitle("SWP vs PRInorm Row Average") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
ggplot(rowflagmean_macaw_swp, aes(x = prinorm, y = -SWP, col = as.factor(Date))) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("PRInorm") + ylab(expression(paste(Psi["stem"]," (Bars)"))) + scale_fill_tableau() + ggtitle("SWP vs PRInorm Row Average") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")


#subset to different dates
##PRInorm
p1 = ggplot(subset(rowflagmean_macaw_swp_sb, Date == "2019-06-28"), aes(x = prinorm, y = -SWP)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("PRInorm") + ylab(expression(paste(Psi["stem"]," (Bars)"))) + scale_fill_tableau() + ggtitle("06-28") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
p2 = ggplot(subset(rowflagmean_macaw_swp_sb, Date == "2019-08-02"), aes(x = prinorm, y = -SWP)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("PRInorm") + ylab(expression(paste(Psi["stem"]," (Bars)"))) + scale_fill_tableau() + ggtitle("08-02") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
p3 = ggplot(subset(rowflagmean_macaw_swp_sb, Date == "2019-08-15"), aes(x = prinorm, y = -SWP)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("PRInorm") + ylab(expression(paste(Psi["stem"]," (Bars)"))) + scale_fill_tableau() + ggtitle("08-15") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
p4 = ggplot(subset(rowflagmean_macaw_swp_sb), aes(x = prinorm, y = -SWP)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("PRInorm") + ylab(expression(paste(Psi["stem"]," (Bars)"))) + scale_fill_tableau() + ggtitle("06-28 + 08-02 + 08-15") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
ggarrange(p1,p2,p3,p4, nrow = 2, ncol = 2)
##PRI
p1 = ggplot(subset(rowflagmean_macaw_swp_sb, Date == "2019-06-28"), aes(x = pri, y = -SWP)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("PRI") + ylab(expression(paste(Psi["stem"]," (Bars)"))) + scale_fill_tableau() + ggtitle("06-28") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
p2 = ggplot(subset(rowflagmean_macaw_swp_sb, Date == "2019-08-02"), aes(x = pri, y = -SWP)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("PRI") + ylab(expression(paste(Psi["stem"]," (Bars)"))) + scale_fill_tableau() + ggtitle("08-02") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
p3 = ggplot(subset(rowflagmean_macaw_swp_sb, Date == "2019-08-15"), aes(x = pri, y = -SWP)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("PRI") + ylab(expression(paste(Psi["stem"]," (Bars)"))) + scale_fill_tableau() + ggtitle("08-15") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
p4 = ggplot(subset(rowflagmean_macaw_swp_sb), aes(x = pri, y = -SWP)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("PRI") + ylab(expression(paste(Psi["stem"]," (Bars)"))) + scale_fill_tableau() + ggtitle("06-28 + 08-02 + 08-15") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
ggarrange(p1,p2,p3,p4, nrow = 2, ncol = 2)
##NDVI
p1 = ggplot(subset(rowflagmean_macaw_swp_sb, Date == "2019-06-28"), aes(x = ndvi, y = -SWP)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("NDVI") + ylab(expression(paste(Psi["stem"]," (Bars)"))) + scale_fill_tableau() + ggtitle("06-28") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
p2 = ggplot(subset(rowflagmean_macaw_swp_sb, Date == "2019-08-02"), aes(x = ndvi, y = -SWP)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("NDVI") + ylab(expression(paste(Psi["stem"]," (Bars)"))) + scale_fill_tableau() + ggtitle("08-02") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
p3 = ggplot(subset(rowflagmean_macaw_swp_sb, Date == "2019-08-15"), aes(x = ndvi, y = -SWP)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("NDVI") + ylab(expression(paste(Psi["stem"]," (Bars)"))) + scale_fill_tableau() + ggtitle("08-15") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
p4 = ggplot(subset(rowflagmean_macaw_swp_sb), aes(x = ndvi, y = -SWP)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("NDVI") + ylab(expression(paste(Psi["stem"]," (Bars)"))) + scale_fill_tableau() + ggtitle("06-28 + 08-02 + 08-15") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
ggarrange(p1,p2,p3,p4, nrow = 2, ncol = 2)
##RDVI
p1 = ggplot(subset(rowflagmean_macaw_swp_sb, Date == "2019-06-28"), aes(x = rdvi, y = -SWP)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("RDVI") + ylab(expression(paste(Psi["stem"]," (Bars)"))) + scale_fill_tableau() + ggtitle("06-28") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
p2 = ggplot(subset(rowflagmean_macaw_swp_sb, Date == "2019-08-02"), aes(x = rdvi, y = -SWP)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("RDVI") + ylab(expression(paste(Psi["stem"]," (Bars)"))) + scale_fill_tableau() + ggtitle("08-02") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
p3 = ggplot(subset(rowflagmean_macaw_swp_sb, Date == "2019-08-15"), aes(x = rdvi, y = -SWP)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("RDVI") + ylab(expression(paste(Psi["stem"]," (Bars)"))) + scale_fill_tableau() + ggtitle("08-15") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
p4 = ggplot(subset(rowflagmean_macaw_swp_sb), aes(x = rdvi, y = -SWP)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("RDVI") + ylab(expression(paste(Psi["stem"]," (Bars)"))) + scale_fill_tableau() + ggtitle("06-28 + 08-02 + 08-15") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
ggarrange(p1,p2,p3,p4, nrow = 2, ncol = 2)
##RER
p1 = ggplot(subset(rowflagmean_macaw_swp_sb, Date == "2019-06-28"), aes(x = rer, y = -SWP)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("RER") + ylab(expression(paste(Psi["stem"]," (Bars)"))) + scale_fill_tableau() + ggtitle("06-28") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
p2 = ggplot(subset(rowflagmean_macaw_swp_sb, Date == "2019-08-02"), aes(x = rer, y = -SWP)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("RER") + ylab(expression(paste(Psi["stem"]," (Bars)"))) + scale_fill_tableau() + ggtitle("08-02") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
p3 = ggplot(subset(rowflagmean_macaw_swp_sb, Date == "2019-08-15"), aes(x = rer, y = -SWP)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("RER") + ylab(expression(paste(Psi["stem"]," (Bars)"))) + scale_fill_tableau() + ggtitle("08-15") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
p4 = ggplot(subset(rowflagmean_macaw_swp_sb), aes(x = rer, y = -SWP)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("RER") + ylab(expression(paste(Psi["stem"]," (Bars)"))) + scale_fill_tableau() + ggtitle("06-28 + 08-02 + 08-15") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
ggarrange(p1,p2,p3,p4, nrow = 2, ncol = 2)
#TCARI
p1 = ggplot(subset(rowflagmean_macaw_swp_sb, Date == "2019-06-28"), aes(x = tcari, y = -SWP)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("TCARI") + ylab(expression(paste(Psi["stem"]," (Bars)"))) + scale_fill_tableau() + ggtitle("06-28") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
p2 = ggplot(subset(rowflagmean_macaw_swp_sb, Date == "2019-08-02"), aes(x = tcari, y = -SWP)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("TCARI") + ylab(expression(paste(Psi["stem"]," (Bars)"))) + scale_fill_tableau() + ggtitle("08-02") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
p3 = ggplot(subset(rowflagmean_macaw_swp_sb, Date == "2019-08-15"), aes(x = tcari, y = -SWP)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("TCARI") + ylab(expression(paste(Psi["stem"]," (Bars)"))) + scale_fill_tableau() + ggtitle("08-15") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
p4 = ggplot(subset(rowflagmean_macaw_swp_sb), aes(x = tcari, y = -SWP)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("TCARI") + ylab(expression(paste(Psi["stem"]," (Bars)"))) + scale_fill_tableau() + ggtitle("06-28 + 08-02 + 08-15") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
ggarrange(p1,p2,p3,p4, nrow = 2, ncol = 2)
#WI
p1 = ggplot(subset(rowflagmean_macaw_swp_sb, Date == "2019-06-28"), aes(x = wi, y = -SWP)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("WI") + ylab(expression(paste(Psi["stem"]," (Bars)"))) + scale_fill_tableau() + ggtitle("06-28") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
p2 = ggplot(subset(rowflagmean_macaw_swp_sb, Date == "2019-08-02"), aes(x = wi, y = -SWP)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("WI") + ylab(expression(paste(Psi["stem"]," (Bars)"))) + scale_fill_tableau() + ggtitle("08-02") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
p3 = ggplot(subset(rowflagmean_macaw_swp_sb, Date == "2019-08-15"), aes(x = wi, y = -SWP)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("WI") + ylab(expression(paste(Psi["stem"]," (Bars)"))) + scale_fill_tableau() + ggtitle("08-15") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
p4 = ggplot(subset(rowflagmean_macaw_swp_sb), aes(x = wi, y = -SWP)) + geom_point()+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("WI") + ylab(expression(paste(Psi["stem"]," (Bars)"))) + scale_fill_tableau() + ggtitle("06-28 + 08-02 + 08-15") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
ggarrange(p1,p2,p3,p4, nrow = 2, ncol = 2)


ggplot(subset(rowflagmean_macaw_swp_sb), aes(x = rdvi, y = -SWP)) + geom_point(aes(color = as.factor(Date)))+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("RDVI") + ylab(expression(paste(Psi["stem"]," (Bars)"))) + scale_fill_tableau() + ggtitle("06-28 + 08-02 + 08-15") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
ggplot(subset(rowflagmean_macaw_swp_sb), aes(x = ndvi, y = -SWP)) + geom_point(aes(color = as.factor(Date)))+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("NDVI") + ylab(expression(paste(Psi["stem"]," (Bars)"))) + scale_fill_tableau() + ggtitle("06-28 + 08-02 + 08-15") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
ggplot(subset(rowflagmean_macaw_swp_sb), aes(x = pri, y = -SWP)) + geom_point(aes(color = as.factor(Date)))+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("PRI") + ylab(expression(paste(Psi["stem"]," (Bars)"))) + scale_fill_tableau() + ggtitle("06-28 + 08-02 + 08-15") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
ggplot(subset(rowflagmean_macaw_swp_sb), aes(x = prinorm2, y = -SWP)) + geom_point(aes(color = as.factor(Date)))+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("PRInorm") + ylab(expression(paste(Psi["stem"]," (Bars)"))) + scale_fill_tableau() + ggtitle("06-28 + 08-02 + 08-15") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")
ggplot(subset(rowflagmean_macaw_swp_sb), aes(x = rer, y = -SWP)) + geom_point(aes(color = as.factor(Date)))+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("RER") + ylab(expression(paste(Psi["stem"]," (Bars)"))) + scale_fill_tableau() + ggtitle("06-28 + 08-02 + 08-15") + geom_smooth(method = "lm", se = FALSE)#+ facet_wrap(~Date, nrow = 3, scales  = "free")


```
####Boxplot of indices 
```{r}
ggplot(rowflagmean_macaw_swp_sb, aes(x = as.factor(Date), y = pri, fill = Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("PRI") + scale_fill_tableau() + ggtitle("PRI Row Average") 
ggplot(rowflagmean_macaw_swp_sb, aes(x = as.factor(Date), y = prinorm, fill = Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("PRInorm") + scale_fill_tableau() + ggtitle("PRInorm Row Average") 
ggplot(rowflagmean_macaw_swp_sb, aes(x = as.factor(Date), y = ndvi, fill = Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("NDVI") + scale_fill_tableau() + ggtitle("NDVI Row Average") 
ggplot(rowflagmean_macaw_swp_sb, aes(x = as.factor(Date), y = rdvi, fill = Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("RDVI") + scale_fill_tableau() + ggtitle("RDVI Row Average") 
ggplot(rowflagmean_macaw_swp_sb, aes(x = as.factor(Date), y = rer, fill = Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("RER") + scale_fill_tableau() + ggtitle("RER Row Average") 
ggplot(rowflagmean_macaw_swp_sb, aes(x = as.factor(Date), y = tcari, fill = Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("TCARI") + scale_fill_tableau() + ggtitle("TCARI Row Average") 
ggplot(rowflagmean_macaw_swp_sb, aes(x = as.factor(Date), y = mcawi, fill = Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("MCARI") + scale_fill_tableau() + ggtitle("MCARI Row Average") 
ggplot(rowflagmean_macaw_swp_sb, aes(x = as.factor(Date), y = wi, fill = Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("WI") + scale_fill_tableau() + ggtitle("WI Row Average") 
ggplot(rowflagmean_macaw_swp_sb, aes(x = as.factor(Date), y = wi.ndvi, fill = Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("WI/NDVI") + scale_fill_tableau() + ggtitle("WI/NDVI Row Average") 

```

####Quantitative analysis
#####t-test
```{r}
#three treatments 
ggplot(rowflagmean_macaw_swp, aes(x = as.factor(Date), y = -SWP, fill = Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab(expression(paste(Psi["stem"]," (Bars)"))) + scale_fill_tableau() + ggtitle("SWP Row Average") 
lm6 <- lm(SWP~Treatment, data = subset(rowflagmean_macaw_swp, Date == "2019-06-28")) 
lm6
hsd1 <- HSD.test(lm6, "Treatment", group = TRUE)
hsd1

lm7 <- lm(SWP~Treatment, data = subset(rowflagmean_macaw_swp, Date == "2019-08-02")) 
lm7
hsd2 <- HSD.test(lm7, "Treatment", group = TRUE)
hsd2

lm8 <- lm(SWP~Treatment, data = subset(rowflagmean_macaw_swp, Date == "2019-08-15")) 
lm8
hsd3 <- HSD.test(lm8, "Treatment", group = TRUE)
hsd3

#two treatments
ggplot(rowflagmean_macaw_swp_sb, aes(x = as.factor(Date), y = -SWP, fill = Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab(expression(paste(Psi["stem"]," (Bars)"))) + scale_fill_tableau() + ggtitle("SWP Row Average") 

lm6 <- lm(SWP~Treatment, data = subset(rowflagmean_macaw_swp_sb, Date == "2019-06-28")) 
lm6
hsd1 <- HSD.test(lm6, "Treatment", group = TRUE)
hsd1

lm7 <- lm(SWP~Treatment, data = subset(rowflagmean_macaw_swp_sb, Date == "2019-08-02")) 
lm7
hsd2 <- HSD.test(lm7, "Treatment", group = TRUE)
hsd2

lm8 <- lm(SWP~Treatment, data = subset(rowflagmean_macaw_swp_sb, Date == "2019-08-15")) 
lm8
hsd3 <- HSD.test(lm8, "Treatment", group = TRUE)
hsd3

```
####Corelations and linear 
#####Three treatments
```{r}
cor(rowflagmean_macaw_swp$pri, rowflagmean_macaw_swp$SWP)^2  #0.671
lm1 <- lm(pri~SWP, data = rowflagmean_macaw_swp)
summary(lm1)  #***
cor(subset(rowflagmean_macaw_swp, Date=="2019-06-28")$pri, subset(rowflagmean_macaw_swp, Date=="2019-06-28")$SWP)^2  #0.021
lm2 <- lm(pri~SWP, data = subset(rowflagmean_macaw_swp, Date=="2019-06-28"))
summary(lm2)  #
cor(subset(rowflagmean_macaw_swp, Date=="2019-08-02")$pri, subset(rowflagmean_macaw_swp, Date=="2019-08-02")$SWP)^2  #0.015
lm3 <- lm(pri~SWP, data = subset(rowflagmean_macaw_swp, Date=="2019-08-02"))
summary(lm3)  #
cor(subset(rowflagmean_macaw_swp, Date=="2019-08-15")$pri, subset(rowflagmean_macaw_swp, Date=="2019-08-15")$SWP)^2  #0.425
lm4 <- lm(pri~SWP, data = subset(rowflagmean_macaw_swp, Date=="2019-08-15"))
summary(lm4)  #**

```
#####Two treatments
```{r}
#PRI
cor(rowflagmean_macaw_swp_sb$pri, rowflagmean_macaw_swp_sb$SWP)^2  #0.683
lm1 <- lm(pri~SWP, data = rowflagmean_macaw_swp_sb)
summary(lm1)  #***
cor(subset(rowflagmean_macaw_swp_sb, Date=="2019-06-28")$pri, subset(rowflagmean_macaw_swp_sb, Date=="2019-06-28")$SWP)^2  #0.0262
lm2 <- lm(pri~SWP, data = subset(rowflagmean_macaw_swp_sb, Date=="2019-06-28"))
summary(lm2)  #
cor(subset(rowflagmean_macaw_swp_sb, Date=="2019-08-02")$pri, subset(rowflagmean_macaw_swp_sb, Date=="2019-08-02")$SWP)^2  #0.020
lm3 <- lm(pri~SWP, data = subset(rowflagmean_macaw_swp_sb, Date=="2019-08-02"))
summary(lm3)  #
cor(subset(rowflagmean_macaw_swp_sb, Date=="2019-08-15")$pri, subset(rowflagmean_macaw_swp_sb, Date=="2019-08-15")$SWP)^2  #0.785
lm4 <- lm(pri~SWP, data = subset(rowflagmean_macaw_swp_sb, Date=="2019-08-15"))
summary(lm4)  #***

#ndvi
cor(rowflagmean_macaw_swp_sb$ndvi, rowflagmean_macaw_swp_sb$SWP)^2  #0.649
lm1 <- lm(ndvi~SWP, data = rowflagmean_macaw_swp_sb)
summary(lm1)  #***
cor(subset(rowflagmean_macaw_swp_sb, Date=="2019-06-28")$ndvi, subset(rowflagmean_macaw_swp_sb, Date=="2019-06-28")$SWP)^2  #0.453
lm2 <- lm(ndvi~SWP, data = subset(rowflagmean_macaw_swp_sb, Date=="2019-06-28"))
summary(lm2)  #*
cor(subset(rowflagmean_macaw_swp_sb, Date=="2019-08-02")$ndvi, subset(rowflagmean_macaw_swp_sb, Date=="2019-08-02")$SWP)^2  #0.641
lm3 <- lm(ndvi~SWP, data = subset(rowflagmean_macaw_swp_sb, Date=="2019-08-02"))
summary(lm3)  #**
cor(subset(rowflagmean_macaw_swp_sb, Date=="2019-08-15")$ndvi, subset(rowflagmean_macaw_swp_sb, Date=="2019-08-15")$SWP)^2  #0.749
lm4 <- lm(ndvi~SWP, data = subset(rowflagmean_macaw_swp_sb, Date=="2019-08-15"))
summary(lm4)  #**

#rdvi
cor(rowflagmean_macaw_swp_sb$rdvi, rowflagmean_macaw_swp_sb$SWP)^2  #0.282
lm1 <- lm(rdvi~SWP, data = rowflagmean_macaw_swp_sb)
summary(lm1)  #**
cor(subset(rowflagmean_macaw_swp_sb, Date=="2019-06-28")$rdvi, subset(rowflagmean_macaw_swp_sb, Date=="2019-06-28")$SWP)^2  #0.248
lm2 <- lm(rdvi~SWP, data = subset(rowflagmean_macaw_swp_sb, Date=="2019-06-28"))
summary(lm2)  #
cor(subset(rowflagmean_macaw_swp_sb, Date=="2019-08-02")$rdvi, subset(rowflagmean_macaw_swp_sb, Date=="2019-08-02")$SWP)^2  #0.476
lm3 <- lm(rdvi~SWP, data = subset(rowflagmean_macaw_swp_sb, Date=="2019-08-02"))
summary(lm3)  #*
cor(subset(rowflagmean_macaw_swp_sb, Date=="2019-08-15")$rdvi, subset(rowflagmean_macaw_swp_sb, Date=="2019-08-15")$SWP)^2  #0.845
lm4 <- lm(rdvi~SWP, data = subset(rowflagmean_macaw_swp_sb, Date=="2019-08-15"))
summary(lm4)  #***

#tcari
cor(rowflagmean_macaw_swp_sb$tcari, rowflagmean_macaw_swp_sb$SWP)^2  #0.462
lm1 <- lm(tcari~SWP, data = rowflagmean_macaw_swp_sb)
summary(lm1)  #***
cor(subset(rowflagmean_macaw_swp_sb, Date=="2019-06-28")$tcari, subset(rowflagmean_macaw_swp_sb, Date=="2019-06-28")$SWP)^2  #0.175
lm2 <- lm(tcari~SWP, data = subset(rowflagmean_macaw_swp_sb, Date=="2019-06-28"))
summary(lm2)  #
cor(subset(rowflagmean_macaw_swp_sb, Date=="2019-08-02")$tcari, subset(rowflagmean_macaw_swp_sb, Date=="2019-08-02")$SWP)^2  #0.110
lm3 <- lm(tcari~SWP, data = subset(rowflagmean_macaw_swp_sb, Date=="2019-08-02"))
summary(lm3)  #
cor(subset(rowflagmean_macaw_swp_sb, Date=="2019-08-15")$tcari, subset(rowflagmean_macaw_swp_sb, Date=="2019-08-15")$SWP)^2  #0.08
lm4 <- lm(tcari~SWP, data = subset(rowflagmean_macaw_swp_sb, Date=="2019-08-15"))
summary(lm4)  #

#rer
cor(rowflagmean_macaw_swp_sb$rer, rowflagmean_macaw_swp_sb$SWP)^2  #0.364
lm1 <- lm(rer~SWP, data = rowflagmean_macaw_swp_sb)
summary(lm1)  #***
cor(subset(rowflagmean_macaw_swp_sb, Date=="2019-06-28")$rer, subset(rowflagmean_macaw_swp_sb, Date=="2019-06-28")$SWP)^2  #0.444
lm2 <- lm(rer~SWP, data = subset(rowflagmean_macaw_swp_sb, Date=="2019-06-28"))
summary(lm2)  #*
cor(subset(rowflagmean_macaw_swp_sb, Date=="2019-08-02")$rer, subset(rowflagmean_macaw_swp_sb, Date=="2019-08-02")$SWP)^2  #0.678
lm3 <- lm(rer~SWP, data = subset(rowflagmean_macaw_swp_sb, Date=="2019-08-02"))
summary(lm3)  #**
cor(subset(rowflagmean_macaw_swp_sb, Date=="2019-08-15")$rer, subset(rowflagmean_macaw_swp_sb, Date=="2019-08-15")$SWP)^2  #0.585
lm4 <- lm(rer~SWP, data = subset(rowflagmean_macaw_swp_sb, Date=="2019-08-15"))
summary(lm4)  #**

#tcari.osavi
cor(rowflagmean_macaw_swp_sb$tcari.osavi, rowflagmean_macaw_swp_sb$SWP)^2  #0.504
lm1 <- lm(tcari.osavi~SWP, data = rowflagmean_macaw_swp_sb)
summary(lm1)  #***
cor(subset(rowflagmean_macaw_swp_sb, Date=="2019-06-28")$tcari.osavi, subset(rowflagmean_macaw_swp_sb, Date=="2019-06-28")$SWP)^2  #0.000
lm2 <- lm(tcari.osavi~SWP, data = subset(rowflagmean_macaw_swp_sb, Date=="2019-06-28"))
summary(lm2)  #
cor(subset(rowflagmean_macaw_swp_sb, Date=="2019-08-02")$tcari.osavi, subset(rowflagmean_macaw_swp_sb, Date=="2019-08-02")$SWP)^2  #0.0369
lm3 <- lm(tcari.osavi~SWP, data = subset(rowflagmean_macaw_swp_sb, Date=="2019-08-02"))
summary(lm3)  #
cor(subset(rowflagmean_macaw_swp_sb, Date=="2019-08-15")$tcari.osavi, subset(rowflagmean_macaw_swp_sb, Date=="2019-08-15")$SWP)^2  #0.0429
lm4 <- lm(tcari.osavi~SWP, data = subset(rowflagmean_macaw_swp_sb, Date=="2019-08-15"))
summary(lm4)  #

#pri550
cor(rowflagmean_macaw_swp_sb$pri550, rowflagmean_macaw_swp_sb$SWP)^2  #0.064
lm1 <- lm(pri550~SWP, data = rowflagmean_macaw_swp_sb)
summary(lm1)  #
cor(subset(rowflagmean_macaw_swp_sb, Date=="2019-06-28")$pri550, subset(rowflagmean_macaw_swp_sb, Date=="2019-06-28")$SWP)^2  #0.172
lm2 <- lm(pri550~SWP, data = subset(rowflagmean_macaw_swp_sb, Date=="2019-06-28"))
summary(lm2)  #
cor(subset(rowflagmean_macaw_swp_sb, Date=="2019-08-02")$pri550, subset(rowflagmean_macaw_swp_sb, Date=="2019-08-02")$SWP)^2  #0.247
lm3 <- lm(pri550~SWP, data = subset(rowflagmean_macaw_swp_sb, Date=="2019-08-02"))
summary(lm3)  #
cor(subset(rowflagmean_macaw_swp_sb, Date=="2019-08-15")$pri550, subset(rowflagmean_macaw_swp_sb, Date=="2019-08-15")$SWP)^2  #0.015
lm4 <- lm(pri550~SWP, data = subset(rowflagmean_macaw_swp_sb, Date=="2019-08-15"))
summary(lm4)  #

#wi
cor(rowflagmean_macaw_swp_sb$wi, rowflagmean_macaw_swp_sb$SWP)^2  #0.456
lm1 <- lm(wi~SWP, data = rowflagmean_macaw_swp_sb)
summary(lm1)  #***
cor(subset(rowflagmean_macaw_swp_sb, Date=="2019-06-28")$wi, subset(rowflagmean_macaw_swp_sb, Date=="2019-06-28")$SWP)^2  #0.468
lm2 <- lm(wi~SWP, data = subset(rowflagmean_macaw_swp_sb, Date=="2019-06-28"))
summary(lm2)  #*
cor(subset(rowflagmean_macaw_swp_sb, Date=="2019-08-02")$wi, subset(rowflagmean_macaw_swp_sb, Date=="2019-08-02")$SWP)^2  #0.030
lm3 <- lm(wi~SWP, data = subset(rowflagmean_macaw_swp_sb, Date=="2019-08-02"))
summary(lm3)  #
cor(subset(rowflagmean_macaw_swp_sb, Date=="2019-08-15")$wi, subset(rowflagmean_macaw_swp_sb, Date=="2019-08-15")$SWP)^2  #0.105
lm4 <- lm(wi~SWP, data = subset(rowflagmean_macaw_swp_sb, Date=="2019-08-15"))
summary(lm4)  #

#wi.ndvi
cor(rowflagmean_macaw_swp_sb$wi.ndvi, rowflagmean_macaw_swp_sb$SWP)^2  #0.201
lm1 <- lm(wi.ndvi~SWP, data = rowflagmean_macaw_swp_sb)
summary(lm1)  #*
cor(subset(rowflagmean_macaw_swp_sb, Date=="2019-06-28")$wi.ndvi, subset(rowflagmean_macaw_swp_sb, Date=="2019-06-28")$SWP)^2  #0.556
lm2 <- lm(wi.ndvi~SWP, data = subset(rowflagmean_macaw_swp_sb, Date=="2019-06-28"))
summary(lm2)  #*
cor(subset(rowflagmean_macaw_swp_sb, Date=="2019-08-02")$wi.ndvi, subset(rowflagmean_macaw_swp_sb, Date=="2019-08-02")$SWP)^2  #0.158
lm3 <- lm(wi.ndvi~SWP, data = subset(rowflagmean_macaw_swp_sb, Date=="2019-08-02"))
summary(lm3)  #
cor(subset(rowflagmean_macaw_swp_sb, Date=="2019-08-15")$wi.ndvi, subset(rowflagmean_macaw_swp_sb, Date=="2019-08-15")$SWP)^2  #0.299
lm4 <- lm(wi.ndvi~SWP, data = subset(rowflagmean_macaw_swp_sb, Date=="2019-08-15"))
summary(lm4)  #


#PRInorm
cor(rowflagmean_macaw_swp_sb$prinorm, rowflagmean_macaw_swp_sb$SWP)^2  #0.702
lm1 <- lm(prinorm~SWP, data = rowflagmean_macaw_swp_sb)
summary(lm1)  #***
cor(subset(rowflagmean_macaw_swp_sb, Date=="2019-06-28")$prinorm, subset(rowflagmean_macaw_swp_sb, Date=="2019-06-28")$SWP)^2  #0.056
lm2 <- lm(prinorm~SWP, data = subset(rowflagmean_macaw_swp_sb, Date=="2019-06-28"))
summary(lm2)  #
cor(subset(rowflagmean_macaw_swp_sb, Date=="2019-08-02")$prinorm, subset(rowflagmean_macaw_swp_sb, Date=="2019-08-02")$SWP)^2  #0.229
lm3 <- lm(prinorm~SWP, data = subset(rowflagmean_macaw_swp_sb, Date=="2019-08-02"))
summary(lm3)  #
cor(subset(rowflagmean_macaw_swp_sb, Date=="2019-08-15")$prinorm, subset(rowflagmean_macaw_swp_sb, Date=="2019-08-15")$SWP)^2  #0.870
lm4 <- lm(prinorm~SWP, data = subset(rowflagmean_macaw_swp_sb, Date=="2019-08-15"))
summary(lm4)  #***

#PRI/NDVI
cor(rowflagmean_macaw_swp_sb$pri/rowflagmean_macaw_swp_sb$ndvi, rowflagmean_macaw_swp_sb$SWP)^2  #0.702
lm1 <- lm(pri/ndvi~SWP, data = rowflagmean_macaw_swp_sb)
summary(lm1)  #***
cor(subset(rowflagmean_macaw_swp_sb, Date=="2019-06-28")$pri/subset(rowflagmean_macaw_swp_sb, Date=="2019-06-28")$ndvi, subset(rowflagmean_macaw_swp_sb, Date=="2019-06-28")$SWP)^2  #0.011
lm2 <- lm(pri/ndvi~SWP, data = subset(rowflagmean_macaw_swp_sb, Date=="2019-06-28"))
summary(lm2)  #
cor(subset(rowflagmean_macaw_swp_sb, Date=="2019-08-02")$pri/subset(rowflagmean_macaw_swp_sb, Date=="2019-08-02")$ndvi, subset(rowflagmean_macaw_swp_sb, Date=="2019-08-02")$SWP)^2  #0.054
lm3 <- lm(pri/ndvi~SWP, data = subset(rowflagmean_macaw_swp_sb, Date=="2019-08-02"))
summary(lm3)  #
cor(subset(rowflagmean_macaw_swp_sb, Date=="2019-08-15")$pri/subset(rowflagmean_macaw_swp_sb, Date=="2019-08-15")$ndvi, subset(rowflagmean_macaw_swp_sb, Date=="2019-08-15")$SWP)^2  #0.812
lm4 <- lm(pri/ndvi~SWP, data = subset(rowflagmean_macaw_swp_sb, Date=="2019-08-15"))
summary(lm4)  #***



#PRI/(ndvi*rer)
cor(rowflagmean_macaw_swp_sb$pri/rowflagmean_macaw_swp_sb$ndvi/rowflagmean_macaw_swp_sb$rer, rowflagmean_macaw_swp_sb$SWP)^2  #0.733
lm1 <- lm(pri/ndvi/rer~SWP, data = rowflagmean_macaw_swp_sb)
summary(lm1)  #***
cor(subset(rowflagmean_macaw_swp_sb, Date=="2019-06-28")$pri/subset(rowflagmean_macaw_swp_sb, Date=="2019-06-28")$ndvi/subset(rowflagmean_macaw_swp_sb, Date=="2019-06-28")$rer, subset(rowflagmean_macaw_swp_sb, Date=="2019-06-28")$SWP)^2  #0.0259
lm2 <- lm(pri/ndvi/rer~SWP, data = subset(rowflagmean_macaw_swp_sb, Date=="2019-06-28"))
summary(lm2)  #
cor(subset(rowflagmean_macaw_swp_sb, Date=="2019-08-02")$pri/subset(rowflagmean_macaw_swp_sb, Date=="2019-08-02")$ndvi/subset(rowflagmean_macaw_swp_sb, Date=="2019-08-02")$rer, subset(rowflagmean_macaw_swp_sb, Date=="2019-08-02")$SWP)^2  #0.192
lm3 <- lm(pri/ndvi/rer~SWP, data = subset(rowflagmean_macaw_swp_sb, Date=="2019-08-02"))
summary(lm3)  #
cor(subset(rowflagmean_macaw_swp_sb, Date=="2019-08-15")$pri/subset(rowflagmean_macaw_swp_sb, Date=="2019-08-15")$ndvi/subset(rowflagmean_macaw_swp_sb, Date=="2019-08-15")$rer, subset(rowflagmean_macaw_swp_sb, Date=="2019-08-15")$SWP)^2  #0.841
lm4 <- lm(pri/ndvi/rer~SWP, data = subset(rowflagmean_macaw_swp_sb, Date=="2019-08-15"))
summary(lm4)  #***


```
###Predictions
####Univariable regression
```{r}
#pri/ndvi/rer
rowflagmean_macaw_swp_sb$prinorm2 <- rowflagmean_macaw_swp_sb$pri/rowflagmean_macaw_swp_sb$ndvi/rowflagmean_macaw_swp_sb$rer
lm10 <- lm(SWP~prinorm2, data = rowflagmean_macaw_swp_sb)
lm10 #-190.745 * prinorm2 + 1.774
summary(lm10)  #R2=0.7331

#boxplot
ggplot(rowflagmean_macaw_swp_sb, aes(x = as.factor(Date), y = prinorm2, fill = Treatment))+ geom_boxplot(position = position_dodge(0.75))  + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("Date") + ylab("PRI/(NDVI*RER)") + scale_fill_tableau() + ggtitle("PRI/(NDVI*RER) Row Average") 
#scatter plot
ggplot(subset(rowflagmean_macaw_swp_sb), aes(x = prinorm2, y = -SWP)) + geom_point(aes(color = as.factor(Date)))+ theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right")+  xlab("NDVI") + ylab(expression(paste(Psi["stem"]," (Bars)"))) + scale_fill_tableau() + ggtitle("06-28 + 08-02 + 08-15") + geom_smooth(method = "lm", se = FALSE) + labs(color = "Date")#+ facet_wrap(~Date, nrow = 3, scales  = "free")

#PRInorm2 function 
PRInorm2_map <- function(macaw){
  #pri
  x530 <- macaw$X530/65535
  x570 <- macaw$X570/65535
  pri <- (x530-x570)/(x530+x570)
  #ndvi
  red <- macaw$X670/65535
  nir <- macaw$X800/65535
  ndvi <- (nir-red)/(nir+red)
  #rer
  x700 <- macaw$X700/65535
  x670 <- macaw$X670/65535
  rer <- x700/x670
  #PRInorm
  prinorm2 <- pri/(ndvi*rer)
  return(prinorm2)
}

macaw_081519_PRInorm2 <- PRInorm2_map(macaw_081519_masked)
predswp_macaw_081519_prinorm2 <- (-190.745)*macaw_081519_PRInorm2 + 1.774
predswp_macaw_081519_prinorm2_masked <- reclassify(predswp_macaw_081519_prinorm2, rbind(c(-Inf, 0, NA), c(10,Inf,NA)))
writeRaster(predswp_macaw_081519_prinorm2, filename = file.path(path_output, "predswp_macaw_081519_prinorm2.tif"))
writeRaster(predswp_macaw_081519_prinorm2_masked, filename = file.path(path_output, "predswp_macaw_081519_prinorm2_masked.tif"))

macaw_080219_PRInorm2 <- PRInorm2_map(macaw_080219_masked)
predswp_macaw_080219_prinorm2 <- (-190.745)*macaw_080219_PRInorm2 + 1.774
predswp_macaw_080219_prinorm2_masked <- reclassify(predswp_macaw_080219_prinorm2, rbind(c(-Inf, 0, NA), c(10,Inf,NA)))
writeRaster(predswp_macaw_080219_prinorm2, filename = file.path(path_output, "predswp_macaw_080219_prinorm2.tif"))
writeRaster(predswp_macaw_080219_prinorm2_masked, filename = file.path(path_output, "predswp_macaw_080219_prinorm2_masked.tif"))

macaw_062819_PRInorm2 <- PRInorm2_map(macaw_062819_masked)
predswp_macaw_062819_prinorm2 <- (-190.745)*macaw_062819_PRInorm2 + 1.774
predswp_macaw_062819_prinorm2_masked <- reclassify(predswp_macaw_062819_prinorm2, rbind(c(-Inf, 0, NA), c(10,Inf,NA)))
writeRaster(predswp_macaw_062819_prinorm2, filename = file.path(path_output, "predswp_macaw_062819_prinorm2.tif"))
writeRaster(predswp_macaw_062819_prinorm2_masked, filename = file.path(path_output, "predswp_macaw_062819_prinorm2_masked.tif"))

#predlin_macaw_081519_masked <- reclassify(predlin_macaw_081519, rbind(c(-Inf, 0, NA), c(10,Inf,NA)))




lm3 <- lm(SWP~pri, data = subset(rowflagmean_macaw_swp_sb, Date=="2019-08-15"))
lm3 #-125.080*PRI + 0.275
summary(lm3)
ggplot(subset(rowflagmean_macaw_swp_sb, Date=="2019-08-15"), aes(x = SWP, y = pri)) + geom_point()
predlin_macaw_081519_PRI <- (-125.08)*macaw_081519_PRI + 0.275
writeRaster(predlin_macaw_081519_PRI, filename = file.path(path_output, "predlin_macaw_081519_PRI.tif"))


lm4 <- lm(SWP~prinorm, data = subset(rowflagmean_macaw_swp_sb, Date=="2019-08-15"))
lm4 #-107.621*PRInorm + 2.984
summary(lm4) 
predlin_macaw_081519_PRInorm <- (-107.621)*macaw_081519_PRInorm + 2.984
writeRaster(predlin_macaw_081519_PRInorm, filename = file.path(path_output, "predlin_macaw_081519_PRInorm.tif"),overwrite = TRUE)
#remove the outliers
predlin_macaw_081519_PRInorm <- reclassify(predlin_macaw_081519_PRInorm, rbind(c(-Inf, 0, NA), c(12,Inf,NA)))
predlin_macaw_081519_PRInorm
plot(predlin_macaw_081519_PRInorm)

lm5 <- lm(SWP ~ pri + ndvi + rer, data = rowflagmean_macaw_swp_sb)
lm5 #28.744 - 71.929*pri -25.275 * ndvi - 1.652 * rer
summary(lm5)  #
nrow(rowflagmean_macaw_swp_sb)  #30
rowflagmean_macaw_swp_sb$SWP_predlin <- predict(lm5,rowflagmean_macaw_swp_sb)
ggplot(rowflagmean_macaw_swp_sb, aes(x = SWP, y = SWP_predlin))+geom_point(aes(color = as.factor(Date)))+geom_smooth(method = "lm",se = FALSE) + theme_pubr(base_size = 14, base_family = "serif", border = TRUE, legend = "right") + xlab("Observed SWP") + ylab("Predicted SWP")


cor(predict(lm5, rowflagmean_macaw_swp_sb), rowflagmean_macaw_swp_sb$SWP)^2  #0.7847
cor(predict(lm5, subset(rowflagmean_macaw_swp_sb, Date == "2019-08-15")), subset(rowflagmean_macaw_swp_sb, Date == "2019-08-15")$SWP)^2  #0.856
cor(predict(lm5, subset(rowflagmean_macaw_swp_sb, Date == "2019-08-02")), subset(rowflagmean_macaw_swp_sb, Date == "2019-08-02")$SWP)^2  #0.483
cor(predict(lm5, subset(rowflagmean_macaw_swp_sb, Date == "2019-06-28")), subset(rowflagmean_macaw_swp_sb, Date == "2019-06-28")$SWP)^2  #0.284
#map
predlin_macaw_081519 <- 28.744 - 71.929*PRI(macaw_081519_masked) - 25.275*NDVI(macaw_081519_masked) - 1.652 * RER(macaw_081519_masked) 
predlin_macaw_081519
#remove the outliers
predlin_macaw_081519_masked <- reclassify(predlin_macaw_081519, rbind(c(-Inf, 0, NA), c(10,Inf,NA)))
#output
writeRaster(predlin_macaw_081519, filename = file.path(path_output, "predlin_macaw_081519_raw.tif"))
writeRaster(predlin_macaw_081519_masked, filename = file.path(path_output, "predlin_macaw_081519_masked.tif"))
plot(predlin_macaw_081519_masked)

```

####Stepwise regression 
```{r}
library(MASS)
names(rowflagmean_macaw_swp_sb)
fullmodel_rowflagmean <- lm(SWP~pri + ndvi + wi  + mcawi + tcari.osavi + tcari + pri550  + rer , data = rowflagmean_macaw_swp_sb)
stepmodel_rowflagmean <- stepAIC(fullmodel_rowflagmean, direction = "both", trace = FALSE)
stepmodel_rowflagmean
summary(stepmodel_rowflagmean)
stepmodel_rowflagmean$coefficients

library(leaps)
stepmodel_rowflagmean_2 <- regsubsets(SWP ~ pri + ndvi + wi  + mcawi + tcari.osavi + tcari + pri550  + rer , data = rowflagmean_macaw_swp_sb, nvmax = 5, method = "seqrep")
summary(stepmodel_rowflagmean_2)
stepmodel_rowflagmean_2$nbest

library(caret)
set.seed(777)
trainIndex <- sample.split(rowflagmean_macaw_swp_sb, SplitRatio = 0.7, group = rowflagmean_macaw_swp_sb$Treatment)
train_rowflagmean_macaw_swp_sb <- rowflagmean_macaw_swp_sb[trainIndex, ]
test_rowflagmean_macaw_swp_sb <- rowflagmean_macaw_swp_sb[!trainIndex, ]
table(train_rowflagmean_macaw_swp_sb$Date) #7,7,7
table(test_rowflagmean_macaw_swp_sb$Date) #3,3,3


#train_PLr <- flagmean_macaw_phys[trainIndex, ]
#test_PLr <- flagmean_macaw_phys[-trainIndex,]

train.control <- trainControl(method = "cv", number = 3)
stepmodel_rowflagmean_3 <- train(SWP ~ pri + ndvi + wi  + mcawi + tcari.osavi + tcari + pri550  + rer , data = train_rowflagmean_macaw_swp_sb, method = "leapSeq")
stepmodel_rowflagmean_3$bestTune  #4 
summary(stepmodel_rowflagmean_3$finalModel)
pred_SWP_3 <- predict(stepmodel_rowflagmean_3, test_rowflagmean_macaw_swp_sb)
cor(pred_SWP_3, test_rowflagmean_macaw_swp_sb$SWP)^2  #0.746
RMSE(pred_SWP_3, test_rowflagmean_macaw_swp_sb$SWP) #0.872
MAE(pred_SWP_3, test_rowflagmean_macaw_swp_sb$SWP) #0.675

stepmodel_rowflagmean_3 <- train(SWP ~ pri + ndvi + wi  + mcawi + tcari.osavi + tcari + pri550  + rer , data = train_rowflagmean_macaw_swp_sb, method = "leapSeq", trControl = train.control)
stepmodel_rowflagmean_3$bestTune  #4 
summary(stepmodel_rowflagmean_3$finalModel)
pred_SWP_3 <- predict(stepmodel_rowflagmean_3, test_rowflagmean_macaw_swp_sb)
cor(pred_SWP_3, test_rowflagmean_macaw_swp_sb$SWP)^2  #0.746
RMSE(pred_SWP_3, test_rowflagmean_macaw_swp_sb$SWP) #0.872
MAE(pred_SWP_3, test_rowflagmean_macaw_swp_sb$SWP) #0.675

stepmodel_rowflagmean_5 <- train(SWP ~ pri + ndvi + wi + tcari.osavi  + rer + prinorm + prinorm2 , data = train_rowflagmean_macaw_swp_sb, method = "leapSeq")
stepmodel_rowflagmean_5$bestTune  #2
summary(stepmodel_rowflagmean_5$finalModel)
stepmodel_rowflagmean_5  
pred_SWP_5 <- predict(stepmodel_rowflagmean_5, test_rowflagmean_macaw_swp_sb)
cor(pred_SWP_5, test_rowflagmean_macaw_swp_sb$SWP)^2  #0.778
RMSE(pred_SWP_5, test_rowflagmean_macaw_swp_sb$SWP) #0.900
MAE(pred_SWP_5, test_rowflagmean_macaw_swp_sb$SWP) #0.730
df5 <- data.frame("Observed" = c(train_rowflagmean_macaw_swp_sb$SWP, test_rowflagmean_macaw_swp_sb$SWP), "Predicted" = c(predict(stepmodel_rowflagmean_5, train_rowflagmean_macaw_swp_sb), pred_SWP_5), "Group" = c(rep("Training", length(train_rowflagmean_macaw_swp_sb$SWP)), rep("Testing", length(test_rowflagmean_macaw_swp_sb$SWP))))
ggplot(df5, aes(x = Observed, y = Predicted, col = Group)) + geom_point() + geom_smooth(method = "lm", se = FALSE) + theme_bw() + ggtitle("Stepwise Regression")

#lm11 <- lm(SWP ~ pri, data = train_rowflagmean_macaw_swp_sb)
#pred_lm11 <- predict(lm11, test_rowflagmean_macaw_swp_sb)
#summary(lm11)  #r2 = 0.
#cor(pred_lm11, test_rowflagmean_macaw_swp_sb$SWP)^2 #0.762


stepmodel_rowflagmean_4 <- train(SWP ~ X800 + X450 + X480 + X530 + X550 + X570 + X670 + X700 + X720 + X740 + X900 + X970, data = train_rowflagmean_macaw_swp_sb, method = "leapSeq", trControl = train.control)
stepmodel_rowflagmean_4
summary(stepmodel_rowflagmean_4)
stepmodel_rowflagmean_4$results
stepmodel_rowflagmean_4$bestTune
summary(stepmodel_rowflagmean_4$finalModel)  #X550, X670
pred_SWP_4 <- predict(stepmodel_rowflagmean_4, test_rowflagmean_macaw_swp_sb)
cor(pred_SWP_4, test_rowflagmean_macaw_swp_sb$SWP)^2  #0.878
RMSE(pred_SWP_4, test_rowflagmean_macaw_swp_sb$SWP) #0.581
MAE(pred_SWP_4, test_rowflagmean_macaw_swp_sb$SWP) #0.478

stepmodel_rowflagmean_4$finalModel
```


###Analysis of the prediction
```{r}
lm5 <- lm(SWP ~ pri + ndvi + rer, data = rowflagmean_macaw_swp_sb)
lm5 #28.744 - 71.929*pri -25.275 * ndvi - 1.652 * rer

#1ft
rowmean_macaw_1ft$DW <- stringi::stri_extract_last_words(rowmean_macaw_1ft$Treatment)
unique(stringi::stri_extract_first_words(rowmean_macaw_1ft$Treatment))
for(i in 1:nrow(rowmean_macaw_1ft)){
  if(rowmean_macaw_1ft$DW[i] %in% c("1.0","0.25","0.5")){
    rowmean_macaw_1ft$DW[i] = "WW"
  }
}
rowmean_macaw_1ft$DW <- as.factor(rowmean_macaw_1ft$DW)

swppred_prilin_1ft <- predict(lm5, rowmean_macaw_1ft)
swppred_prilin_1ft <- cbind(rowmean_macaw_1ft, swppred_prilin_1ft)
swppred_prilin_1ft_081519 <- subset(swppred_prilin_1ft, Date == "2019-08-15" & DW!= "BUFFER")

dim(swppred_prilin_1ft_081519)
ggplot(swppred_prilin_1ft_081519, aes(x = DW, y = swppred_prilin_1ft)) + geom_boxplot()

lm6 <- lm(swppred_prilin_1ft~DW, data = swppred_prilin_1ft_081519)
anova(lm6)
anova_lm6 <- aov(swppred_prilin_1ft~DW, data = swppred_prilin_1ft_081519)
anova_lm6
a <- HSD.test(anova_lm6, "DW", group = TRUE)
a
kruskal.test(swppred_prilin_1ft~DW, data = swppred_prilin_1ft_081519)

```

##Rowmean
```{r}
unique(rowmean_macaw$Treatment)
rowmean_macaw$DW <- stringi::stri_extract_last_words(rowmean_macaw$Treatment)
unique(stringi::stri_extract_first_words(rowmean_macaw$Treatment))
for(i in 1:nrow(rowmean_macaw)){
  if(rowmean_macaw$DW[i] %in% c("1.0","0.25","0.5")){
    rowmean_macaw$DW[i] = "WW"
  }
}
rowmean_macaw$DW <- as.factor(rowmean_macaw$DW)

swppred_prinorm <- predict(lm4, rowmean_macaw)
swppred_prinorm <- cbind(rowmean_macaw, swppred_prinorm)
swppred_prinorm_081519 <- subset(swppred_prinorm, Date == "2019-08-15" & DW != "BUFFER")
dim(swppred_prinorm_081519)
ggplot(swppred_prinorm_081519, aes(x = DW, y = swppred_prinorm)) + geom_boxplot()

lm5 <- lm(swppred_prinorm~DW, data = swppred_prinorm_081519)
anova(lm5)
anova_lm5 <- aov(swppred_prinorm~DW, data = swppred_prinorm_081519)
anova_lm5
a <- HSD.test(anova_lm5, "DW", group = TRUE)
kruskal.test(swppred_prinorm~DW, data = swppred_prinorm_081519)

names(rowmean_macaw) 

for(i in 1:dim(rowflagmean_macaw_swp)[1]){
  if(rowflagmean_macaw_swp[i,]$Date=="2019-06-26"){
    rowflagmean_macaw_swp[i,]$Date= "2019-06-28"
  }
  if(rowflagmean_macaw_swp[i,]$Date=="2019-08-01"){
    rowflagmean_macaw_swp[i,]$Date="2019-08-02"
  }
  if(rowflagmean_macaw_swp[i,]$Date=="2019-08-14"){
    rowflagmean_macaw_swp[i,]$Date="2019-08-15"
  }
}


rowflagmean_swp$Treatment <- as.factor(rowflagmean_swp$Treatment)
rowflagmean_swp$Block <- as.factor(rowflagmean_swp$Block)
rowflagmean_swp$Date <- as.Date(rowflagmean_swp$Date)
rowmean_macaw_sb$Date <- as.Date(rowmean_macaw_sb$Date)
rowflagmean_swp$Treatment <- factor(rowflagmean_swp$Treatment, levels = c("BAYER 16 (SOIL) WW", "CONTROL WW", "CONTROL DDD"), order = TRUE)
#flagmean_macaw$Treatment <- factor(flagmean_macaw$Treatment, levels = c("BAYER 16 (SOIL) WW", "CONTROL WW", "CONTROL DDD"), order = TRUE)

rowflagmean_macaw_swp <- base::merge(rowmean_macaw_sb, rowflagmean_swp, by = c("Block","Treatment","Date"))
dim(rowmean_macaw)  #1242,31
dim(rowflagmean_swp) #140,5
dim(rowflagmean_macaw_swp) #0,33


```

#Cross-Calibration between dates 
##from MACAW
```{r}
#shapefiles
path_shp <- "C:/Users/tangz/Box Sync/BIOSTIMULANT TRIAL - SEASON 2/ZHEHAN/shapefiles"
panel_0628 <- shapefile(file.path(path_shp, "panel_macaw_0628.shp"))
panel_0802 <- shapefile(file.path(path_shp, "panel_macaw_0802.shp"))
panel_0815 <- shapefile(file.path(path_shp, "panel_macaw_0815.shp"))
plot(panel_0628)
plot(panel_0802)
plot(panel_0815)
#unmasked files
path_12band <- "D:/MACAW_tomato"
macaw_081519 <- read_12band(path_12band, "agisoft_20190815_12bands_withgcps.tif")
macaw_080219 <- read_12band(path_12band, "agisoft_20190802_12bands_withgcps.tif")
macaw_062819 <- read_12band(path_12band, "agisoft_20190628_12bands_withgcps.tif")

panel_macaw_0628 <- raster::extract(macaw_062819,panel_0628, mean, df = TRUE)
panel_macaw_0802 <- raster::extract(macaw_080219,panel_0802, mean, df = TRUE)
panel_macaw_0815 <- raster::extract(macaw_081519,panel_0815, mean, df = TRUE)
panel_macaw_0628$Color <- panel_0628$Color
panel_macaw_0802$Color <- panel_0802$Color
panel_macaw_0815$Color <- panel_0815$Color
panel_macaw_0628$Date <- "0628"
panel_macaw_0802$Date <- "0802"
panel_macaw_0815$Date <- "0815"
panel_macaw <- rbind(panel_macaw_0628, panel_macaw_0802)
panel_macaw <- rbind(panel_macaw, panel_macaw_0815)
panel_macaw

#convert wide to long 
panel_macaw_long <- tidyr::gather(panel_macaw, wavelength, reflectance, X800:X970, factor_key = TRUE)
head(panel_macaw_long)
dim(panel_macaw_long)
panel_macaw_long$wavelength <- sub(".","",panel_macaw_long$wavelength)
panel_macaw_long$wavelength <- as.numeric(panel_macaw_long$wavelength)
panel_macaw_long$ID <- NULL
panel_macaw_long$Color <- as.factor(panel_macaw_long$Color)
panel_macaw_long$Date <- as.factor(panel_macaw_long$Date)
str(panel_macaw_long)
panel_macaw_long$reflectance <- panel_macaw_long$reflectance/65535
#plot
ggplot(panel_macaw_long, aes(x = wavelength, y = reflectance, color = Date, shape = Color)) + geom_point(aes(shape = Color)) + geom_line(aes(linetype =Color)) + theme_bw()
#The reflectance from the white panel saturated in the visible region 
ggplot(subset(panel_macaw_long, Color!= "White"), aes(x = wavelength, y = reflectance, color = Date, shape = Color)) + geom_point(aes(shape = Color)) + geom_line(aes(linetype =Color)) + theme_bw()

```

#equations for each band
```{r}
#set 0802 as standard 
#split into different bands
ls_equations <- list()
ls_marix <- list()
ls_bands <- split(panel_macaw_long, panel_macaw_long$wavelength)
for(i in 1:12){
  ls_matrix[[i]] <- 
}
```

##from Micasense
```{r}
#read data
path_uav <- "C:/Users/tangz/Box Sync/BIOSTIMULANT TRIAL - SEASON 2/ZHEHAN/UAV processed images"
uav_062819 <- read_uav(path_uav, "tomato_062819_stacks2.tif")
uav_080219 <- read_uav(path_uav, "tomato_080219_stacks2.tif")
uav_081519 <- read_uav(path_uav, "tomato_081519_stacks2.tif")
#remove -10000
#values(uav_062819)[values(uav_062819) == -10000] <- NA
#values(uav_080219)[values(uav_080219) == -10000] <- NA
#values(uav_081519)[values(uav_081519) == -10000] <- NA
#rowflagmean_macaw_swp_sb <- aggregate(flagmean_macaw_swp_sb[,c(6:17,22:33,35)], by = list("Block"  = flagmean_macaw_swp_sb$Block, "Treatment" = flagmean_macaw_swp_sb$Treatment2, "Date" = flagmean_macaw_swp_sb$Date, "Plot" = flagmean_macaw_swp_sb$Plot), FUN = function(x){mean(x, na.rm = TRUE)})  #

panel_uav_0628 <- raster::extract(uav_062819, panel_0628, fun=function(x){mean(values(x)[values(x)>-10000])}, df = TRUE)
panel_uav_0802 <- raster::extract(uav_080219, panel_0802, fun=mean, df = TRUE)
panel_uav_0815 <- raster::extract(uav_081519, panel_0815, fun=mean, df = TRUE)
panel_uav_0628$Color <- panel_0628$Color
panel_uav_0802$Color <- panel_0802$Color
panel_uav_0815$Color <- panel_0815$Color
panel_uav_0628$Date <- "0628"
panel_uav_0802$Date <- "0802"
panel_uav_0815$Date <- "0815"
panel_uav <- rbind(panel_uav_0628, panel_uav_0802)
panel_uav <- rbind(panel_uav, panel_uav_0815)
panel_uav



```

#---------Useless----------------------------------

##Calculate PRI
```{r}
##raw PRI
rowmean_macaw <- rowmean_macaw %>% mutate(pri = (p530-p570)/(p530+p570))
rowmean_macaw_1ft <- rowmean_macaw_1ft %>% mutate(pri = (p530-p570)/(p530+p570))
rowmean_macaw_2ft <- rowmean_macaw_2ft %>% mutate(pri = (p530-p570)/(p530+p570))
rowmean_macaw_3ft <- rowmean_macaw_3ft %>% mutate(pri = (p530-p570)/(p530+p570))

path_df <- "C:/Users/zt92/Box Sync/BIOSTIMULANT FIELD SCREENING MASTER FOLDER/DRONE/macaw_pri/dataframes"
write.csv(rowmean_macaw, file.path(path_df, "rowmean_macaw.csv"), row.names = FALSE)
write.csv(rowmean_macaw_1ft, file.path(path_df, "rowmean_macaw_1ft.csv"), row.names = FALSE)
write.csv(rowmean_macaw_2ft, file.path(path_df, "rowmean_macaw_2ft.csv"), row.names = FALSE)
write.csv(rowmean_macaw_3ft, file.path(path_df, "rowmean_macaw_3ft.csv"), row.names = FALSE)

##corrected PRI
```

#Calculate boxplots 
```{r}
#subset
rowmean_macaw_bayer <- rowmean_macaw[grepl("BAYER", rowmean_macaw$Treatment),]
##dd, ww, ddd
rowmean_macaw_ddd <- rowmean_macaw[grepl("DDD", rowmean_macaw$Treatment),]
rowmean_macaw$DW <- (rowmean_macaw$Treatment)

#0822
temp <- subset(rowmean_macaw_bayer, Date == "2019-08-22")
ggplot(temp, aes(x = Treatment, y = pri, color = Treatment)) + geom_boxplot()+ggtitle("08-22")
#0815
temp <- subset(rowmean_macaw_bayer, Date == "2019-08-15")
ggplot(temp, aes(x = Treatment, y = pri, color = Treatment)) + geom_boxplot()+ggtitle("08-15")

ggplot(rowmean_macaw_bayer, aes(x = Date, y = pri, color = Treatment)) + geom_point()

```

